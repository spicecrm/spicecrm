/*!
 * 
 *                     SpiceCRM
 *
 *                     release: 2024.01.001
 *
 *                     date: 2024-05-28 17:40:40
 *
 *                     build: 2024.01.001.1716910840504
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["default-src_include_spiceattachments_spiceattachments_ts"],{27778:(t,e,s)=>{s.d(e,{E:()=>_});var i=s(62585),l=s(54438),a=s(48849),n=s(50531),o=s(41081),d=s(13562),c=s(66031),r=s(57363),m=s(60177),h=s(25863),p=s(67469);function u(t,e){if(1&t&&l.nrm(0,"system-file-icon",10),2&t){const t=l.XpG();l.Y8G("filename",t.file.filename)("filemimetype",t.file.file_mime_type)}}function f(t,e){if(1&t&&(l.j41(0,"div"),l.nrm(1,"img",11),l.k0s()),2&t){const t=l.XpG();l.R7$(),l.Y8G("src","data:image/jpg;base64,"+t.file.thumbnail,l.B4B)}}function g(t,e){if(1&t){const t=l.RV6();l.j41(0,"div",12)(1,"button",13),l.bIt("click",(function(){l.eBV(t);const e=l.XpG();return l.Njj(e.deleteFile())})),l.nrm(2,"system-button-icon",14),l.k0s()()}}function b(t,e){if(1&t&&(l.j41(0,"div",15)(1,"ul",16)(2,"li",17),l.EFF(3),l.k0s(),l.j41(4,"li",17),l.EFF(5),l.k0s()()()),2&t){const t=l.XpG();l.R7$(3),l.JRh(t.filedate),l.R7$(2),l.JRh(t.humanFileSize)}}function y(t,e){if(1&t&&(l.j41(0,"div",4)(1,"div",18)(2,"span",19)(3,"span",20),l.EFF(4,"Progress: 25%"),l.k0s()()(),l.j41(5,"div",21),l.EFF(6),l.k0s()()),2&t){const t=l.XpG();l.R7$(2),l.Y8G("ngStyle",t.progressbarstyle),l.R7$(4),l.SpI(" ",t.file.uploadprogress," % ")}}let _=(()=>{class SpiceAttachmentFile{constructor(t,e,s,i,l,a,n,o){this.attachmentsPanelComponent=t,this.userpreferences=e,this.modal=s,this.toast=i,this.helper=l,this.injector=a,this.navigationtab=n,this.router=o,this.file={},this.editmode=!0,this.disabled=!1,this.forceModalPreview=!1}get humanFileSize(){return this.modelattachments.humanFileSize(this.file.filesize)}get filedate(){return this.file.date?this.file.date.format(this.userpreferences.getDateFormat()):""}get uploading(){return this.file.hasOwnProperty("uploadprogress")}get progressbarstyle(){return{width:this.file.uploadprogress+"%"}}downloadFile(){this.uploading||this.modelattachments.downloadAttachment(this.file.id,this.file.filename)}preview(t){this.forceModalPreview?this.previewFile(t):this.openInTab()}openInTab(){if(this.disabled)return;let t=this.file.file_mime_type.toLowerCase().split("/");const e="application"==t[0]&&"pdf"!=t[1]&&"msg"!=t[1],s="text"==t[0]&&"csv"==t[1];if(e||s)return this.downloadFile();let i="";this.navigationtab?.tabid&&(i="/tab/"+this.navigationtab.tabid),this.router.navigate([`${i}/attachment/${this.file.id}/${this.modelattachments.module}/${this.modelattachments.id}`])}previewFile(t){if(!this.disabled)if(t.preventDefault(),t.stopPropagation(),this.uploading)this.toast.sendToast("upload still in progress","info");else if(this.file.file_mime_type){let t=this.file.file_mime_type.toLowerCase().split("/");switch(t[0].trim()){case"image":if("svg+xml"===t[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((t=>{t.instance.name=this.file.filename,t.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:e=>{t.instance.data=atob(e)},error:e=>{t.instance.loadingerror=!0}})}));else this.modal.openModal("SystemImagePreviewModal").subscribe((t=>{t.instance.imgname=this.file.filename,t.instance.imgtype=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:e=>{t.instance.imgsrc="data:"+this.file.file_mime_type.toLowerCase()+";base64,"+e},error:e=>{t.instance.loadingerror=!0}})}));break;case"text":case"audio":case"video":this.modal.openModal("SystemObjectPreviewModal").subscribe((t=>{t.instance.name=this.file.filename,t.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:e=>{t.instance.data=atob(e)},error:e=>{t.instance.loadingerror=!0}})}));break;case"application":if("pdf"===t[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((t=>{t.instance.name=this.file.filename,t.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:e=>{t.instance.data=atob(e)},error:e=>{t.instance.loadingerror=!0}})}));else{if("msg"===this.file.filename.split(".").splice(-1,1)[0].toLowerCase())this.modal.openModal("EmailPreviewModal",!0,this.injector).subscribe((t=>{t.instance.name=this.file.filename,t.instance.type=this.file.file_mime_type.toLowerCase(),t.instance.file=this.file}));else this.downloadFile()}break;default:this.downloadFile()}}}deleteFile(){this.editmode&&(this.modelattachments.deleteAttachment(this.file.id),this.attachmentsPanelComponent.loadFiles())}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentFile)(l.rXU(i.X),l.rXU(a.S),l.rXU(n.y),l.rXU(o.o),l.rXU(d.d),l.rXU(l.zZn),l.rXU(c._),l.rXU(r.Ix))};static#e=this.ɵcmp=l.VBU({type:SpiceAttachmentFile,selectors:[["spice-attachment-file"]],inputs:{file:"file",editmode:"editmode",modelattachments:"modelattachments",disabled:"disabled",forceModalPreview:"forceModalPreview"},features:[l.Jv_([i.X])],decls:11,vars:6,consts:[[1,"slds-m-right--x-small","slds-align--absolute-center",2,"width","30px","height","30px"],["divClass","","size","small",3,"filename","filemimetype",4,"ngIf"],[4,"ngIf"],[1,"slds-media__body"],[1,"slds-grid","slds-grid_vertical-align-center","slds-grid--align-spread","slds-has-flexi-truncate"],[1,"slds-truncate","slds-text-heading--x-small","slds-p-right--xxx-small",3,"click"],["href","javascript:void(0);"],["class","slds-shrink-none",4,"ngIf"],["class","slds-tile__detail slds-text-body--small",4,"ngIf"],["class","slds-grid slds-grid_vertical-align-center slds-grid--align-spread slds-has-flexi-truncate",4,"ngIf"],["divClass","","size","small",3,"filename","filemimetype"],[3,"src"],[1,"slds-shrink-none"],[1,"slds-button","slds-button--icon",3,"click"],["icon","clear"],[1,"slds-tile__detail","slds-text-body--small"],[1,"slds-list--horizontal","slds-has-dividers--left"],[1,"slds-item"],[1,"slds-progress-bar"],[1,"slds-progress-bar__value",3,"ngStyle"],[1,"slds-assistive-text"],[1,"slds-text-align--right",2,"width","50px"]],template:function(t,e){1&t&&(l.j41(0,"div",0),l.DNE(1,u,1,2,"system-file-icon",1)(2,f,2,1,"div",2),l.k0s(),l.j41(3,"div",3)(4,"div",4)(5,"h3",5),l.bIt("click",(function(t){return e.preview(t)})),l.j41(6,"a",6),l.EFF(7),l.k0s()(),l.DNE(8,g,3,0,"div",7),l.k0s(),l.DNE(9,b,6,2,"div",8)(10,y,7,2,"div",9),l.k0s()),2&t&&(l.R7$(),l.Y8G("ngIf",!e.file.thumbnail),l.R7$(),l.Y8G("ngIf",e.file.thumbnail),l.R7$(5),l.JRh(e.file.filename),l.R7$(),l.Y8G("ngIf",!e.uploading&&e.editmode),l.R7$(),l.Y8G("ngIf",!e.uploading),l.R7$(),l.Y8G("ngIf",e.uploading))},dependencies:[m.bT,m.B3,h.t,p.z],encapsulation:2})}return SpiceAttachmentFile})()},62585:(t,e,s)=>{s.d(e,{X:()=>A});var i=s(54438),l=s(74547),a=s(66031),n=s(18359),o=s(69904),d=s(50531),c=s(35911),r=s(41731),m=s(41081),h=s(83935),p=s(40553),u=s(49722),f=s(53584);const g=["fileupload"];function b(t,e){if(1&t&&i.nrm(0,"spice-attachment-file",7),2&t){const t=e.$implicit,s=i.XpG(2);i.Y8G("modelattachments",s.modelattachments)("file",t)("editmode",s.editing)("forceModalPreview",s.forceModalPreview)}}function y(t,e){1&t&&(i.j41(0,"div",8)(1,"div",9),i.nrm(2,"system-spinner",10)(3,"system-label",11),i.k0s()())}function _(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",20),i.bIt("click",(function(){i.eBV(t);const e=i.XpG(3);return i.Njj(e.selectFile())})),i.nrm(1,"system-label",21),i.k0s()}}function v(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",20),i.bIt("click",(function(){i.eBV(t);const e=i.XpG(3);return i.Njj(e.addImage())})),i.nrm(1,"system-label",22),i.k0s()}}function S(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",23),i.bIt("click",(function(){i.eBV(t);const e=i.XpG(3);return i.Njj(e.addFromRecord())})),i.nrm(1,"system-label",24),i.k0s()}if(2&t){const t=i.XpG(3);i.Y8G("disabled","Tasks"==t._modelattachments.module)}}function F(t,e){if(1&t){const t=i.RV6();i.j41(0,"div",12)(1,"div",13),i.nrm(2,"system-label",14),i.k0s(),i.j41(3,"div",13),i.nrm(4,"system-label",15),i.k0s(),i.DNE(5,_,2,0,"button",16),i.j41(6,"div",13),i.nrm(7,"system-label",15),i.k0s(),i.DNE(8,v,2,0,"button",16),i.j41(9,"input",17,18),i.bIt("click",(function(){i.eBV(t);const e=i.sdS(10);return i.Njj(e.value=null)}))("change",(function(){i.eBV(t);const e=i.XpG(2);return i.Njj(e.uploadFile())})),i.k0s(),i.j41(11,"div",13),i.nrm(12,"system-label",15),i.k0s(),i.DNE(13,S,2,1,"button",19),i.k0s()}if(2&t){const t=i.XpG(2);i.R7$(5),i.Y8G("ngIf",!t.componentconfig.disableupload),i.R7$(3),i.Y8G("ngIf",!t.componentconfig.disableupload),i.R7$(5),i.Y8G("ngIf",!t.componentconfig.disableupload)}}function x(t,e){if(1&t&&(i.j41(0,"div",25)(1,"div",26),i.nrm(2,"system-label",27),i.EFF(3),i.k0s()()),2&t){const t=i.XpG(2);i.R7$(3),i.Lme(" ",t.totalFileSize," / ",t.maxUpload,"")}}function k(t,e){if(1&t){const t=i.RV6();i.j41(0,"div",1),i.bIt("system-drop-file",(function(e){i.eBV(t);const s=i.XpG();return i.Njj(s.fileDrop(e))})),i.j41(1,"div")(2,"div",2),i.DNE(3,b,1,4,"spice-attachment-file",3),i.k0s(),i.DNE(4,y,4,0,"div",4),i.k0s(),i.DNE(5,F,14,3,"div",5)(6,x,4,2,"div",6),i.k0s()}if(2&t){const t=i.XpG();i.R7$(3),i.Y8G("ngForOf",t.modelattachments.files),i.R7$(),i.Y8G("ngIf",t.modelattachments.loading),i.R7$(),i.Y8G("ngIf",t.editing&&!t.componentconfig.disableupload&&!t.modelattachments.loading),i.R7$(),i.Y8G("ngIf","Emails"==t.model.module)}}let A=(()=>{class SpiceAttachmentsPanel{constructor(t,e,s,l,a,o,d,c,r,m,h,p,u,f,g,b){this._modelattachments=t,this.parentmodelattachments=e,this.language=s,this.modal=l,this.model=a,this.view=o,this.renderer=d,this.toast=c,this.metadata=r,this.modalservice=m,this.injector=h,this.parentModel=p,this.navigationtab=u,this.broadcast=f,this.backend=g,this.configuration=b,this.uploadfiles=[],this.uploadfilesExist=!1,this.attachmentsLoaded=new i.bkB,this.forceModalPreview=!1,this.componentconfig={},this.subscriptions=new n.yU,this._modelattachments.module=this.model.module,this._modelattachments.id=this.model.id,this.setUploadSettings(this.model.getField("mailbox_id")),this.model.observeFieldChanges("mailbox_id").subscribe((t=>this.setUploadSettings(t)))}get isHidden(){return!!this.componentconfig.requiredmodelstate&&!this.model.checkModelState(this.componentconfig.requiredmodelstate)}get modelattachments(){return this.parentmodelattachments&&this.parentmodelattachments.module==this.model.module&&this.parentmodelattachments.id==this.model.id?this.parentmodelattachments:this._modelattachments}get editing(){return this.model.isEditing&&(!this.view||this.view.isEditable)}setUploadSettings(t){t&&this.backend.getRequest("module/Mailboxes/scope").subscribe((e=>{const s=e.find((e=>e.value==t));this.maxUploadBytes=s.max_upload,this.maxUpload=this.modelattachments.humanFileSize(this.maxUploadBytes)}))}loadFiles(){this.modelattachments.getAttachments(this.componentconfig.systemCateogryId).subscribe((t=>{this.attachmentsLoaded.emit(!0),this.loadInputFiles(),this.countSize()}))}countSize(){let t=0;if(this.modelattachments.files.forEach((e=>{t+=parseInt(e.filesize)})),this.totalFileSize=this.modelattachments.humanFileSize(t),t>this.maxUploadBytes){let t="LBL_ERROR",e=this.language.getLabelFormatted("LBL_EXCEEDS_MAX_ATTACHMENTS",[this.totalFileSize,this.maxUpload]);this.modal.info(e,t)}this.model.setField("attachments_size",t),this.model.setField("attachments_count",this.modelattachments.files.length)}loadInputFiles(){this.uploadfilesExist?this.modelattachments.addFiles(this.uploadfiles):this.modelattachments.uploadAttachmentsBase64FromArray(this.uploadfiles)}setUploadFiles(t){for(let t of this.uploadfiles){let e=this._modelattachments.files.find((e=>e.filename==t.name));e&&this._modelattachments.deleteAttachment(e.id)}this.uploadfiles=t,this.loadInputFiles()}ngAfterViewInit(){this.parentmodelattachments||setTimeout((()=>this.loadFiles()),10)}preventdefault(t){(t.dataTransfer.items.length>=1&&this.hasOneItemsFile(t.dataTransfer.items)||t.dataTransfer.files.length>0)&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy")}hasOneItemsFile(t){for(let e of t)if("file"==e.kind)return!0;return!1}onDrop(t){this.preventdefault(t);let e=t.dataTransfer.files;e&&e.length>=1&&this.doupload(e)}fileDrop(t){t&&t.length>=1&&this.doupload(t)}selectFile(){let t=new MouseEvent("click",{bubbles:!0});this.fileupload.element.nativeElement.dispatchEvent(t)}uploadFile(){let t=this.fileupload.element.nativeElement.files;this.doupload(t)}doupload(t){this.modelattachments.uploadAttachmentsBase64(t,this.componentconfig.systemCateogryId).subscribe({next:()=>{this.broadcastUpload(),this.loadFiles()}})}addImage(){this.modal.openModal("SpiceAttachmentAddImageModal",!0,this.injector).subscribe((t=>{t.instance.systemCategoryId=this.componentconfig.systemCateogryId,t.instance.responseSubject.subscribe({next:()=>{this.broadcastUpload(),this.loadFiles()}})}))}addFromRecord(){this.modal.openModal("SpiceAttachmentAddFromRecordModal",!0,this.injector).subscribe((t=>{t.instance.parent=this.parentModel}))}broadcastUpload(){this._modelattachments.broadcast.broadcastMessage("attachments.uploaded",{uploadedFiles:this._modelattachments.files,uniqueID:this._modelattachments.httpRequestsRefID,reload:!0})}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsPanel)(i.rXU(l.S),i.rXU(l.S,12),i.rXU(o.B),i.rXU(d.y),i.rXU(c.g),i.rXU(r.U,8),i.rXU(i.sFG),i.rXU(m.o),i.rXU(h.yu),i.rXU(d.y),i.rXU(i.zZn),i.rXU(c.g,4),i.rXU(a._),i.rXU(p.m),i.rXU(u.H),i.rXU(f.i))};static#e=this.ɵcmp=i.VBU({type:SpiceAttachmentsPanel,selectors:[["spice-attachments-panel"]],viewQuery:function(t,e){if(1&t&&i.GBs(g,5,i.c1b),2&t){let t;i.mGM(t=i.lsd())&&(e.fileupload=t.first)}},inputs:{forceModalPreview:"forceModalPreview"},outputs:{attachmentsLoaded:"attachmentsLoaded"},features:[i.Jv_([l.S,a._])],decls:1,vars:1,consts:[["class","slds-box slds-m-around--xx-small",3,"system-drop-file",4,"ngIf"],[1,"slds-box","slds-m-around--xx-small",3,"system-drop-file"],[1,"slds-card__body--inner","slds-grid","slds-wrap","slds-grid--pull-padded"],["class","slds-media slds-size--1-of-1",3,"modelattachments","file","editmode","forceModalPreview",4,"ngFor","ngForOf"],["class","slds-p-around--x-small slds-align--absolute-center",4,"ngIf"],["class","slds-grid slds-grid--align-center slds-grid--vertical-align-center slds-gutters_direct-xx-small",4,"ngIf"],["class","slds-card__body--inner slds-grid slds-wrap slds-grid--pull-padded slds-grid--align-spread slds-m-top--small",4,"ngIf"],[1,"slds-media","slds-size--1-of-1",3,"modelattachments","file","editmode","forceModalPreview"],[1,"slds-p-around--x-small","slds-align--absolute-center"],[1,"slds-grid","slds-grid--vertical-align-center"],["size","14"],["label","LBL_INITIALIZING",1,"slds-p-left--x-small"],[1,"slds-grid","slds-grid--align-center","slds-grid--vertical-align-center","slds-gutters_direct-xx-small"],[1,"slds-col"],["label","LBL_DROP_FILES"],["label","LBL_OR"],["class","slds-col slds-button slds-button--neutral",3,"click",4,"ngIf"],["type","file","multiple","",2,"display","none",3,"click","change"],["fileupload",""],["class","slds-col slds-button slds-button--neutral",3,"disabled","click",4,"ngIf"],[1,"slds-col","slds-button","slds-button--neutral",3,"click"],["label","LBL_UPLOAD_FILES"],["label","LBL_ADD_IMAGE"],[1,"slds-col","slds-button","slds-button--neutral",3,"disabled","click"],["label","LBL_ADD_FROM_RECORD"],[1,"slds-card__body--inner","slds-grid","slds-wrap","slds-grid--pull-padded","slds-grid--align-spread","slds-m-top--small"],[1,"slds-m-left--small"],["label","LBL_TOTAL_ATTACHMENTS_SIZE"]],template:function(t,e){1&t&&i.DNE(0,k,7,4,"div",0),2&t&&i.Y8G("ngIf",!e.isHidden)},encapsulation:2})}return SpiceAttachmentsPanel})()},28618:(t,e,s)=>{s.r(e),s.d(e,{ModuleSpiceAttachments:()=>Gt});var i=s(60177),l=s(84341),a=s(71341),n=s(7745),o=s(12948),d=s(37328),c=s(70569),r=s(62585),m=s(74547),h=s(54438),p=s(35911),u=s(69904),f=s(40553),g=s(32062);function b(t,e){if(1&t&&(h.j41(0,"span",3),h.EFF(1),h.k0s()),2&t){const t=h.XpG();h.R7$(),h.JRh(t.attachmentcount)}}let y=(()=>{class SpiceAttachmentsPanelHeader{constructor(t,e,s,i){this.model=t,this.modelattachments=e,this.language=s,this.broadcast=i,this.broadcastSubscription={},this.attachmentcount=0,this.broadcastSubscription=this.broadcast.message$.subscribe((t=>{this.handleMessage(t)}))}ngOnInit(){this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id,this.modelattachments.getCount().subscribe((t=>{this.attachmentcount=t}))}get hasAttachments(){return this.attachmentcount>0}handleMessage(t){if(t.messagedata.module===this.model.module||t.messagedata.id===this.model.id)switch(t.messagetype){case"attachments.loaded":case"attachments.cloned":this.attachmentcount=t.messagedata.attachmentcount}}ngOnDestroy(){this.broadcastSubscription.unsubscribe()}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsPanelHeader)(h.rXU(p.g),h.rXU(m.S),h.rXU(u.B),h.rXU(f.m))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsPanelHeader,selectors:[["spice-attachments-panel-header"]],features:[h.Jv_([m.S])],decls:4,vars:1,consts:[[1,"slds-grid","slds-grid--vertical-align-center"],["label","LBL_FILES"],["class","slds-theme_warning slds-m-horizontal--xx-small slds-align--absolute-center spice-counter",4,"ngIf"],[1,"slds-theme_warning","slds-m-horizontal--xx-small","slds-align--absolute-center","spice-counter"]],template:function(t,e){1&t&&(h.j41(0,"div",0)(1,"span"),h.nrm(2,"system-label",1),h.k0s(),h.DNE(3,b,2,1,"span",2),h.k0s()),2&t&&(h.R7$(3),h.Y8G("ngIf",e.hasAttachments))},dependencies:[i.bT,g.W],encapsulation:2})}return SpiceAttachmentsPanelHeader})();var _=s(27778);function v(t,e){if(1&t&&h.nrm(0,"spice-attachment-file",3),2&t){const t=e.$implicit,s=h.XpG(2);h.Y8G("modelattachments",s.modelattachments)("file",t)("editmode",!1)("ngClass",s.getItemClass())}}function S(t,e){if(1&t&&(h.j41(0,"div",1),h.DNE(1,v,1,4,"spice-attachment-file",2),h.k0s()),2&t){const t=h.XpG();h.Y8G("ngStyle",t.getCompStyle())("ngClass",t.componentconfig.addClasses),h.R7$(),h.Y8G("ngForOf",t.modelattachments.files)}}let F=(()=>{class SpiceAttachmentsList{constructor(t,e,s,i){this.modelattachments=t,this.language=e,this.model=s,this.cdRef=i,this.componentconfig={},this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}loadFiles(){this.modelattachments.getAttachments().subscribe((t=>{this.cdRef.detectChanges()}))}ngAfterViewInit(){setTimeout((()=>this.loadFiles()),10)}getCompStyle(){return{marginRight:this.componentconfig.horizontal?"-16px":void 0,marginBottom:this.componentconfig.horizontal?"-8px":void 0}}getItemClass(){return this.componentconfig.horizontal?"slds-m-right_medium slds-m-bottom_x-small":"slds-size--1-of-1"}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsList)(h.rXU(m.S),h.rXU(u.B),h.rXU(p.g),h.rXU(h.gRc))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsList,selectors:[["spice-attachments-list"]],features:[h.Jv_([m.S])],decls:1,vars:1,consts:[["class","slds-m-vertical--xx-small slds-card__body--inner slds-grid slds-wrap slds-grid--pull-padded",3,"ngStyle","ngClass",4,"ngIf"],[1,"slds-m-vertical--xx-small","slds-card__body--inner","slds-grid","slds-wrap","slds-grid--pull-padded",3,"ngStyle","ngClass"],["class","slds-media",3,"modelattachments","file","editmode","ngClass",4,"ngFor","ngForOf"],[1,"slds-media",3,"modelattachments","file","editmode","ngClass"]],template:function(t,e){1&t&&h.DNE(0,S,2,3,"div",0),2&t&&h.Y8G("ngIf",e.modelattachments.files.length>0)},dependencies:[i.YU,i.Sq,i.bT,i.B3,_.E],encapsulation:2,changeDetection:0})}return SpiceAttachmentsList})();function x(t,e){if(1&t&&(h.j41(0,"div",2),h.nrm(1,"spice-attachment-file",3),h.k0s()),2&t){const t=e.$implicit,s=h.XpG();h.R7$(),h.Y8G("file",t)("modelattachments",s.modelattachments)("editmode",!1)}}let k=(()=>{class SpiceAttachmentsPopupList{constructor(t,e,s){this.modelattachments=t,this.language=e,this.model=s,this.componentconfig={},this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}ngOnInit(){this.modelattachments.getAttachments()}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsPopupList)(h.rXU(m.S),h.rXU(u.B),h.rXU(p.g))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsPopupList,selectors:[["spice-attachments-popup-list"]],features:[h.Jv_([m.S])],decls:2,vars:1,consts:[[1,"slds-p-around--x-small"],["class","slds-p-vertical--x-small",4,"ngFor","ngForOf"],[1,"slds-p-vertical--x-small"],[1,"slds-media","slds-size--1-of-1",3,"file","modelattachments","editmode"]],template:function(t,e){1&t&&(h.j41(0,"div",0),h.DNE(1,x,2,3,"div",1),h.k0s()),2&t&&(h.R7$(),h.Y8G("ngForOf",e.modelattachments.files))},dependencies:[i.Sq,_.E],encapsulation:2})}return SpiceAttachmentsPopupList})();var A=s(28114),I=s(21413),R=s(40713),j=s(25028),L=s(88418),X=s(83524);let C=(()=>{class SpiceAttachmentAddImageModal{constructor(t,e){this.language=t,this.modelattachments=e,this.filecontent="",this.imagedata=new h.bkB,this.systemCategoryId="",this.responseSubject=new I.B}close(){this.self.destroy()}add(){let t=this.inputMedia.mediaMetaData;this.modelattachments.uploadFileBase64(this.filecontent,t.filename,t.mimetype,this.systemCategoryId).subscribe((()=>{this.responseSubject.next(!0),this.responseSubject.complete()})),this.self.destroy()}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentAddImageModal)(h.rXU(u.B),h.rXU(m.S))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentAddImageModal,selectors:[["spice-attachment-add-image-modal"]],viewQuery:function(t,e){if(1&t&&h.GBs(A.A,5),2&t){let t;h.mGM(t=h.lsd())&&(e.inputMedia=t.first)}},outputs:{imagedata:"imagedata"},decls:10,vars:2,consts:[[3,"close"],["margin","xx-small"],[3,"ngModel","ngModelChange"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--brand",3,"disabled","click"],["label","LBL_ADD"]],template:function(t,e){1&t&&(h.j41(0,"system-modal")(1,"system-modal-header",0),h.bIt("close",(function(){return e.close()})),h.EFF(2,"Add Image"),h.k0s(),h.j41(3,"system-modal-content",1)(4,"system-input-media",2),h.mxI("ngModelChange",(function(t){return h.DH7(e.filecontent,t)||(e.filecontent=t),t})),h.k0s()(),h.j41(5,"system-modal-footer")(6,"button",3),h.bIt("click",(function(){return e.close()})),h.nrm(7,"system-label",4),h.k0s(),h.j41(8,"button",5),h.bIt("click",(function(){return e.add()})),h.nrm(9,"system-label",6),h.k0s()()()),2&t&&(h.R7$(4),h.R50("ngModel",e.filecontent),h.R7$(4),h.Y8G("disabled",!e.filecontent))},dependencies:[l.BC,l.vS,g.W,R.D,j.I,L.Q,X.C,A.A],encapsulation:2})}return SpiceAttachmentAddImageModal})();var w=s(18359),U=s(83935),E=s(18521);function G(t,e){1&t&&h.nrm(0,"system-utility-icon",1)}let M=(()=>{class SpiceAttachmentsCount{constructor(t,e,s,i,l,a){this.metadata=t,this.modelattachments=e,this.parentmodelattachments=s,this.language=i,this.model=l,this.cdRef=a,this.subscriptions=new w.yU,this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}ngAfterViewInit(){this.modelHasAttachmentcount()||(this.parentmodelattachments?this.subscriptions.add(this.parentmodelattachments.getCount().subscribe((t=>{this.cdRef.detectChanges()}))):this.subscriptions.add(this.modelattachments.getCount().subscribe((t=>{this.cdRef.detectChanges()}))))}modelHasAttachmentcount(){return!!this.metadata.getModuleFields(this.model.module).attachments_count}ngOnDestroy(){this.subscriptions.unsubscribe()}get count(){return this.modelHasAttachmentcount()?this.model.getField("attachments_count"):this.parentmodelattachments?this.parentmodelattachments.count:this.modelattachments.count}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsCount)(h.rXU(U.yu),h.rXU(m.S),h.rXU(m.S,12),h.rXU(u.B),h.rXU(p.g),h.rXU(h.gRc))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsCount,selectors:[["spice-attachments-count"]],features:[h.Jv_([m.S])],decls:1,vars:1,consts:[["icon","attach","size","xx-small",4,"ngIf"],["icon","attach","size","xx-small"]],template:function(t,e){1&t&&h.DNE(0,G,1,0,"system-utility-icon",0),2&t&&h.Y8G("ngIf",e.count>0)},dependencies:[i.bT,E.B],encapsulation:2,changeDetection:0})}return SpiceAttachmentsCount})();var D=s(13921),B=s(41731),$=s(57363),Y=s(766),T=s(66935),O=s(1510);function N(t,e){if(1&t&&h.nrm(0,"field-label",3),2&t){const t=h.XpG();h.Y8G("fieldname",t.fieldname)("fieldconfig",t.fieldconfig)}}const z=(t,e)=>({injector:t,componentset:e});let V=(()=>{class fieldSpiceAttachmentsCount extends D.s{constructor(t,e,s,i,l,a){super(t,e,s,i,l),this.model=t,this.view=e,this.language=s,this.metadata=i,this.router=l,this.injector=a}get popovercomponentset(){return this.fieldconfig.popovercomponentset}static#t=this.ɵfac=function(t){return new(t||fieldSpiceAttachmentsCount)(h.rXU(p.g),h.rXU(B.U),h.rXU(u.B),h.rXU(U.yu),h.rXU($.Ix),h.rXU(h.zZn))};static#e=this.ɵcmp=h.VBU({type:fieldSpiceAttachmentsCount,selectors:[["field-spice-attachments-count"]],features:[h.Vt3],decls:4,vars:8,consts:[[3,"fieldname","fieldconfig",4,"ngIf"],[3,"fielddisplayclass","fieldconfig","editable"],[3,"system-pop-over"],[3,"fieldname","fieldconfig"]],template:function(t,e){1&t&&(h.DNE(0,N,1,2,"field-label",0),h.j41(1,"field-generic-display",1)(2,"div",2),h.nrm(3,"spice-attachments-count"),h.k0s()()),2&t&&(h.Y8G("ngIf",e.displayLabel),h.R7$(),h.Y8G("fielddisplayclass",e.fielddisplayclass)("fieldconfig",e.fieldconfig)("editable",!1),h.R7$(),h.Y8G("system-pop-over",h.l_i(5,z,e.injector,e.popovercomponentset)))},dependencies:[i.bT,Y.b,T.K,O.m,M],encapsulation:2})}return fieldSpiceAttachmentsCount})();var P=s(53584),H=s(41081),J=s(49722),q=s(55480),W=s(79413),Q=s(22465);function Z(t,e){if(1&t&&(h.j41(0,"div",20)(1,"system-checkbox-group-checkbox",21),h.nrm(2,"system-label",22),h.k0s()()),2&t){const t=e.$implicit;h.Y8G("system-title",t.label),h.R7$(),h.Y8G("value",t.id),h.R7$(),h.Y8G("label",t.label)}}let K=(()=>{class SpiceAttachmentsEditModal{constructor(t,e,s,i,l){this.configurationService=t,this.toast=e,this.language=s,this.model=i,this.backend=l,this.attachment={},this.inputData={},this.categories=[],this.self={}}ngOnInit(){if(this.configurationService.getData("spiceattachments_categories"))return this.categories=this.configurationService.getData("spiceattachments_categories");this.backend.getRequest("common/spiceattachments/categories/"+this.model.module).subscribe((t=>{t&&Array.isArray(t)&&(this.categories=t,this.configurationService.setData("spiceattachments_categories",t))}))}close(){this.self.destroy()}save(){const t={category_ids:this.inputData.category_ids.join(","),text:this.inputData.text,display_name:this.inputData.display_name?this.inputData.display_name:""};this.backend.postRequest("common/spiceattachments/"+this.attachment.id,{},t).subscribe((t=>{t&&t.success?(this.inputData.category_ids&&this.inputData.category_ids.join(",")!=this.attachment.category_ids&&(this.attachment.category_ids=this.inputData.category_ids.join(",")),this.inputData.text!=this.attachment.text&&(this.attachment.text=this.inputData.text),this.inputData.display_name!=this.attachment.display_name&&(this.attachment.display_name=this.inputData.display_name),this.toast.sendToast(this.language.getLabel("LBL_DATA_SAVED"),"success")):this.toast.sendToast(this.language.getLabel("ERR_FAILED_TO_EXECUTE"),"error"),this.self.destroy()}),(()=>{this.toast.sendToast(this.language.getLabel("ERR_NETWORK"),"error"),this.self.destroy()}))}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsEditModal)(h.rXU(P.i),h.rXU(H.o),h.rXU(u.B),h.rXU(p.g),h.rXU(J.H))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsEditModal,selectors:[["spice-attachments-edit-modal"]],decls:30,vars:5,consts:[[3,"close"],["label","LBL_EDIT"],[1,"slds-form-element"],[1,"slds-form-element__label"],["label","LBL_FILENAME"],[1,"slds-form-element__control"],["type","text","disabled","",1,"slds-input",3,"ngModel","ngModelChange"],["label","LBL_DISPLAY_NAME"],["type","text",1,"slds-input",3,"ngModel","ngModelChange"],[1,"slds-form-element","slds-p-horizontal--xx-small"],["label","LBL_CATEGORIES"],[3,"ngModel","ngModelChange"],["class","slds-large-size--1-of-3 slds-medium-size--1-of-1 slds-truncate",3,"system-title",4,"ngFor","ngForOf"],["label","LBL_TEXT"],[1,"slds-textarea","slds-scrollable--y","slds-m-vertical--xx-small",2,"height","250px",3,"ngModel","ngModelChange"],[1,"slds-grid"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--brand",3,"click"],["label","LBL_SAVE"],[1,"slds-large-size--1-of-3","slds-medium-size--1-of-1","slds-truncate",3,"system-title"],[3,"value"],[1,"slds-m-left--xx-small",3,"label"]],template:function(t,e){1&t&&(h.j41(0,"system-modal")(1,"system-modal-header",0),h.bIt("close",(function(){return e.close()})),h.nrm(2,"system-label",1),h.k0s(),h.j41(3,"system-modal-content")(4,"div",2)(5,"label",3),h.nrm(6,"system-label",4),h.k0s(),h.j41(7,"div",5)(8,"input",6),h.mxI("ngModelChange",(function(t){return h.DH7(e.attachment.filename,t)||(e.attachment.filename=t),t})),h.k0s()()(),h.j41(9,"div",2)(10,"label",3),h.nrm(11,"system-label",7),h.k0s(),h.j41(12,"div",5)(13,"input",8),h.mxI("ngModelChange",(function(t){return h.DH7(e.inputData.display_name,t)||(e.inputData.display_name=t),t})),h.k0s()()(),h.j41(14,"div",9)(15,"label",3),h.nrm(16,"system-label",10),h.k0s(),h.j41(17,"system-checkbox-group",11),h.mxI("ngModelChange",(function(t){return h.DH7(e.inputData.category_ids,t)||(e.inputData.category_ids=t),t})),h.DNE(18,Z,3,3,"div",12),h.k0s()(),h.j41(19,"div",9)(20,"label",3),h.nrm(21,"system-label",13),h.k0s(),h.j41(22,"div",5)(23,"textarea",14),h.mxI("ngModelChange",(function(t){return h.DH7(e.inputData.text,t)||(e.inputData.text=t),t})),h.k0s()()()(),h.j41(24,"system-modal-footer")(25,"div",15)(26,"button",16),h.bIt("click",(function(){return e.close()})),h.nrm(27,"system-label",17),h.k0s(),h.j41(28,"button",18),h.bIt("click",(function(){return e.save()})),h.nrm(29,"system-label",19),h.k0s()()()()),2&t&&(h.R7$(8),h.R50("ngModel",e.attachment.filename),h.R7$(5),h.R50("ngModel",e.inputData.display_name),h.R7$(4),h.R50("ngModel",e.inputData.category_ids),h.R7$(),h.Y8G("ngForOf",e.categories),h.R7$(5),h.R50("ngModel",e.inputData.text))},dependencies:[i.Sq,l.me,l.BC,l.vS,q.G,W.h,g.W,R.D,j.I,L.Q,X.C,Q.L],encapsulation:2,changeDetection:0})}return SpiceAttachmentsEditModal})();var tt=s(96697),et=s(50531),st=s(25863);function it(t,e){if(1&t&&(h.j41(0,"tr")(1,"td")(2,"div",13),h.EFF(3),h.k0s()(),h.j41(4,"td",20)(5,"div",13),h.EFF(6),h.k0s()()()),2&t){const t=e.$implicit;h.R7$(3),h.JRh(t.module),h.R7$(3),h.JRh(t.count)}}function lt(t,e){if(1&t&&(h.j41(0,"tr")(1,"td")(2,"div",13),h.nrm(3,"system-label",24),h.k0s()(),h.j41(4,"td",20)(5,"div",13),h.EFF(6),h.k0s()()()),2&t){const t=e.$implicit,s=h.XpG();h.R7$(3),h.Y8G("label",s.missingFiles[t].label),h.R7$(3),h.JRh(s.missingFiles[t].count)}}let at=(()=>{class SpiceAttachmentStats{constructor(t,e){this.backend=t,this.modal=e,this.analysisresults=[],this.missingFilesTotalcount=0,this.fileAreas=[],this.analyze(),this.getMissingFiles()}analyze(){this.analysisresults=[],this.backend.getRequest("common/spiceattachments/admin").pipe((0,tt.s)(1)).subscribe((t=>{for(let e in t)this.analysisresults.push({module:e,count:t[e]})}))}get totalcount(){let t=0;for(let e of this.analysisresults)t+=parseInt(e.count,10);return t}delete(){this.modal.confirm("Are you sure you want to delete the data of all orphaned File Attachments?","Delete Orphaned Attachments?","warning").pipe((0,tt.s)(1)).subscribe((t=>{t&&this.backend.postRequest("common/spiceattachments/admin/cleanup").pipe((0,tt.s)(1)).subscribe((t=>{this.analyze()}))}))}getMissingFiles(){this.fileAreas=[],this.missingFilesTotalcount=0,this.backend.getRequest("common/spiceattachments/admin/missingfiles").pipe((0,tt.s)(1)).subscribe((t=>{this.missingFiles=t;for(let t in this.missingFiles)this.fileAreas.push(t),this.missingFilesTotalcount+=this.missingFiles[t].count}))}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentStats)(h.rXU(J.H),h.rXU(et.y))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentStats,selectors:[["spice-attachments-stats"]],decls:48,vars:4,consts:[[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--small"],[1,"slds-text-heading_medium"],["label","LBL_ATTACHMENTSTATISTICS"],[1,"slds-col--bump-left","slds-button","slds-button_icon","slds-button_icon-border-filled",3,"click"],["icon","delete"],[1,"slds-button","slds-button_icon","slds-button_icon-border-filled",3,"click"],["icon","refresh"],[1,"slds-border--top","system-to-bottom"],[1,"slds-text-heading--small","slds-p-around--small"],["label","LBL_SPICEATTACHMENTS_ORPHANED"],[1,"slds-table","slds-table_bordered","slds-table_cell-buffer","slds-table--header-fixed"],[1,"slds-text-title_caps"],["scope","col"],[1,"slds-truncate"],["label","LBL_MODULE"],["scope","col",1,"slds-text-align--right"],["label","LBL_RECORDS"],[4,"ngFor","ngForOf"],[1,"slds-theme--alt-inverse"],["label","LBL_TOTAL"],[1,"slds-text-align--right"],["label","LBL_MISSING_FILES"],["label","LBL_AREA"],["label","LBL_FILES"],[3,"label"]],template:function(t,e){1&t&&(h.j41(0,"div",0)(1,"h2",1),h.nrm(2,"system-label",2),h.k0s(),h.j41(3,"button",3),h.bIt("click",(function(){return e.delete()})),h.nrm(4,"system-button-icon",4),h.k0s(),h.j41(5,"button",5),h.bIt("click",(function(){return e.analyze(),e.getMissingFiles()})),h.nrm(6,"system-button-icon",6),h.k0s()(),h.j41(7,"div",7)(8,"h3",8),h.nrm(9,"system-label",9),h.k0s(),h.j41(10,"table",10)(11,"thead")(12,"tr",11)(13,"th",12)(14,"div",13),h.nrm(15,"system-label",14),h.k0s()(),h.j41(16,"th",15)(17,"div",13),h.nrm(18,"system-label",16),h.k0s()()()(),h.j41(19,"tbody"),h.DNE(20,it,7,2,"tr",17),h.j41(21,"tr",18)(22,"td")(23,"div",13),h.nrm(24,"system-label",19),h.k0s()(),h.j41(25,"td",20)(26,"div",13),h.EFF(27),h.k0s()()()()(),h.j41(28,"h3",8),h.nrm(29,"system-label",21),h.k0s(),h.j41(30,"table",10)(31,"thead")(32,"tr",11)(33,"th",12)(34,"div",13),h.nrm(35,"system-label",22),h.k0s()(),h.j41(36,"th",15)(37,"div",13),h.nrm(38,"system-label",23),h.k0s()()()(),h.j41(39,"tbody"),h.DNE(40,lt,7,2,"tr",17),h.j41(41,"tr",18)(42,"td")(43,"div",13),h.nrm(44,"system-label",19),h.k0s()(),h.j41(45,"td",20)(46,"div",13),h.EFF(47),h.k0s()()()()()()),2&t&&(h.R7$(20),h.Y8G("ngForOf",e.analysisresults),h.R7$(7),h.JRh(e.totalcount),h.R7$(13),h.Y8G("ngForOf",e.fileAreas),h.R7$(7),h.JRh(e.missingFilesTotalcount))},dependencies:[i.Sq,st.t,g.W],encapsulation:2})}return SpiceAttachmentStats})();var nt=s(13562),ot=s(89166),dt=s(68823),ct=s(67469),rt=s(30012);const mt=["fileupload"];function ht(t,e){if(1&t&&h.nrm(0,"field-label",3),2&t){const t=h.XpG();h.Y8G("fieldname",t.fieldname)("fieldconfig",t.fieldconfig)}}function pt(t,e){if(1&t&&h.nrm(0,"system-file-icon",9),2&t){const t=h.XpG(2);h.Y8G("filemimetype",t.model.getField("file_mime_type"))("filename",t.value)}}function ut(t,e){if(1&t){const t=h.RV6();h.j41(0,"field-generic-display",4)(1,"div",5),h.DNE(2,pt,1,2,"system-file-icon",6),h.j41(3,"div",7)(4,"a",8),h.bIt("click",(function(e){h.eBV(t);const s=h.XpG();return h.Njj(s.previewFile(e))})),h.EFF(5),h.k0s()()()()}if(2&t){const t=h.XpG();h.Y8G("fielddisplayclass",t.fielddisplayclass)("editable",t.isEditable())("fieldconfig",t.fieldconfig)("title",t.value)("fieldid",t.fieldid),h.R7$(2),h.Y8G("ngIf",t.value),h.R7$(3),h.JRh(t.value)}}function ft(t,e){if(1&t){const t=h.RV6();h.j41(0,"div",15)(1,"div",16)(2,"span",17)(3,"span",18),h.nrm(4,"system-icon",19),h.k0s()(),h.j41(5,"a",20)(6,"span",21),h.EFF(7),h.k0s()(),h.j41(8,"button",22),h.bIt("click",(function(){h.eBV(t);const e=h.XpG(2);return h.Njj(e.removeFile())})),h.nrm(9,"system-button-icon",23),h.k0s()()()}if(2&t){const t=h.XpG(2);h.R7$(4),h.Y8G("icon",t.helper.determineFileIcon(t.mime_type)),h.R7$(3),h.JRh(t.value)}}function gt(t,e){if(1&t&&(h.j41(0,"div",24)(1,"div",25),h.nrm(2,"span",26),h.k0s(),h.j41(3,"div",27),h.EFF(4),h.k0s()()),2&t){const t=h.XpG(2);h.R7$(2),h.Y8G("ngStyle",t.progressbarstyle),h.R7$(2),h.SpI(" ",t.file.uploadprogress," % ")}}function bt(t,e){if(1&t){const t=h.RV6();h.j41(0,"div",28)(1,"div",29),h.bIt("system-drop-file",(function(e){h.eBV(t);const s=h.XpG(2);return h.Njj(s.onDrop(e))})),h.j41(2,"input",30,31),h.bIt("click",(function(){h.eBV(t);const e=h.sdS(3);return h.Njj(e.value=null)}))("change",(function(){h.eBV(t);const e=h.XpG(2);return h.Njj(e.uploadFile())})),h.k0s(),h.j41(4,"label",32)(5,"span",33),h.nrm(6,"system-button-icon",34)(7,"system-label",35),h.k0s(),h.j41(8,"span",36),h.nrm(9,"system-label",37)(10,"system-label",38),h.k0s()()()()}if(2&t){const t=h.XpG(2);h.R7$(2),h.Y8G("id",t.fieldid),h.R7$(2),h.BMQ("for",t.fieldid),h.R7$(2),h.Y8G("icon","upload")}}function yt(t,e){if(1&t&&(h.j41(0,"div",10),h.DNE(1,ft,10,2,"div",11)(2,gt,5,2,"div",12)(3,bt,11,3,"div",13),h.nrm(4,"field-messages",14),h.k0s()),2&t){const t=h.XpG();h.Y8G("ngClass",t.getFieldClass()),h.R7$(),h.Y8G("ngIf",t.value),h.R7$(),h.Y8G("ngIf",t.uploading),h.R7$(),h.Y8G("ngIf",!t.value&&!t.uploading),h.R7$(),h.Y8G("fieldname",t.fieldname)}}let _t=(()=>{class fieldModelAttachment extends D.s{constructor(t,e,s,i,l,a,n,o,d,c){super(t,e,s,i,l),this.model=t,this.view=e,this.language=s,this.metadata=i,this.router=l,this.injector=a,this.modelattachments=n,this.modal=o,this.helper=d,this.backend=c}get file(){return this.modelattachments.files[0]}get uploading(){return this.file?.hasOwnProperty("uploadprogress")}get progressbarstyle(){return{width:this.file.uploadprogress+"%"}}get mime_type(){return this.model.getFieldValue(this.prefix+"_mime_type")}get prefix(){return"filename"==this.fieldname?"file":this.fieldname.substring(0,this.fieldname.length-5)}getAttachment(){let t=new I.B;return this.backend.getRequest(`common/spiceattachments/module/${this.model.module}/${this.model.id}/byfield/${this.prefix}`).subscribe((e=>{t.next(e.file),t.complete()}),(e=>{t.error(e),t.complete()})),t.asObservable()}previewFile(t){if(t.preventDefault(),t.stopPropagation(),this.mime_type){let t=this.mime_type.toLowerCase().split("/");switch(t[0].trim()){case"image":this.modal.openModal("SystemImagePreviewModal").subscribe((t=>{t.instance.imgname=this.value,t.instance.imgtype=this.mime_type.toLowerCase(),this.getAttachment().subscribe((e=>{t.instance.imgsrc="data:"+this.mime_type.toLowerCase()+";base64,"+e}),(e=>{t.instance.loadingerror=!0}))}));break;case"text":case"audio":case"video":this.modal.openModal("SystemObjectPreviewModal").subscribe((t=>{t.instance.name=this.value,t.instance.type=this.mime_type.toLowerCase(),this.getAttachment().subscribe((e=>{t.instance.data=atob(e)}),(e=>{t.instance.loadingerror=!0}))}));break;case"application":if("pdf"===t[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((t=>{t.instance.name=this.value,t.instance.type=this.mime_type.toLowerCase(),this.getAttachment().subscribe((e=>{t.instance.data=atob(e)}),(e=>{t.instance.loadingerror=!0}))}));else this.downloadFile();break;default:this.downloadFile()}}else this.downloadFile()}removeFile(){this.modelattachments.files.length>0&&(this.modelattachments.files=[]);let t={};t[this.fieldname]=void 0,t[this.prefix+"_size"]=void 0,t[this.prefix+"_mime_type"]=void 0,t[this.prefix+"_md5"]=void 0,this.model.setFields(t)}onDrop(t){t&&t.length>=1&&this.doupload(t)}uploadFile(){let t=this.fileupload.element.nativeElement.files;this.doupload(t)}downloadFile(){this.modelattachments.downloadAttachmentForField(this.model.module,this.model.id,this.prefix,this.value)}doupload(t){this.modelattachments.uploadAttachmentsBase64(t).subscribe((t=>{}),(t=>{}),(()=>{let t=this.modelattachments.files[0],e={};e[this.fieldname]=t.filename,e[this.prefix+"_size"]=t.filesize,e[this.prefix+"_mime_type"]=t.file_mime_type,e[this.prefix+"_md5"]=t.filemd5,this.model.setFields(e)}))}static#t=this.ɵfac=function(t){return new(t||fieldModelAttachment)(h.rXU(p.g),h.rXU(B.U),h.rXU(u.B),h.rXU(U.yu),h.rXU($.Ix),h.rXU(h.zZn),h.rXU(m.S),h.rXU(et.y),h.rXU(nt.d),h.rXU(J.H))};static#e=this.ɵcmp=h.VBU({type:fieldModelAttachment,selectors:[["field-model-attachment"]],viewQuery:function(t,e){if(1&t&&h.GBs(mt,5,h.c1b),2&t){let t;h.mGM(t=h.lsd())&&(e.fileupload=t.first)}},features:[h.Jv_([m.S]),h.Vt3],decls:3,vars:3,consts:[[3,"fieldname","fieldconfig",4,"ngIf"],[3,"fielddisplayclass","editable","fieldconfig","title","fieldid",4,"ngIf"],["class","slds-form-element__control slds-p-vertical--xxx-small",3,"ngClass",4,"ngIf"],[3,"fieldname","fieldconfig"],[3,"fielddisplayclass","editable","fieldconfig","title","fieldid"],[1,"slds-grid","slds-grid--vertical-align-center"],["divClass","slds-p-right--xx-small","size","x-small",3,"filemimetype","filename",4,"ngIf"],[1,"slds-truncate","slds-grow"],["href","javascript:void(0);",3,"click"],["divClass","slds-p-right--xx-small","size","x-small",3,"filemimetype","filename"],[1,"slds-form-element__control","slds-p-vertical--xxx-small",3,"ngClass"],["class","slds-pill_container slds-size--1-of-1 slds-m-vertical--xxx-small",4,"ngIf"],["class","slds-p-around--x-small slds-grid slds-grid_vertical-align-center slds-grid--align-spread slds-has-flexi-truncate",4,"ngIf"],["class","slds-file-selector slds-file-selector_files",4,"ngIf"],[3,"fieldname"],[1,"slds-pill_container","slds-size--1-of-1","slds-m-vertical--xxx-small"],[1,"slds-pill","slds-pill_link","slds-size--1-of-1"],[1,"slds-pill__icon_container"],["title","Account",1,"slds-icon_container","slds-icon-standard-account"],["divClass","","sprite","doctype","size","x-small",3,"icon"],["href","javascript:void(0);",1,"slds-pill__action"],[1,"slds-pill__label"],["title","Remove",1,"slds-button","slds-button_icon","slds-button_icon","slds-pill__remove",3,"click"],["icon","close"],[1,"slds-p-around--x-small","slds-grid","slds-grid_vertical-align-center","slds-grid--align-spread","slds-has-flexi-truncate"],[1,"slds-progress-bar"],[1,"slds-progress-bar__value",3,"ngStyle"],[1,"slds-text-align--right",2,"width","50px"],[1,"slds-file-selector","slds-file-selector_files"],[1,"slds-file-selector__dropzone",3,"system-drop-file"],["type","file",1,"slds-file-selector__input","slds-assistive-text",3,"id","click","change"],["fileupload",""],[1,"slds-file-selector__body"],[1,"slds-file-selector__button","slds-button","slds-button_neutral"],[3,"icon"],["label","LBL_UPLOAD_FILES"],[1,"slds-file-selector__text","slds-medium-show"],["label","LBL_OR"],["label","LBL_DROP_FILES"]],template:function(t,e){1&t&&h.DNE(0,ht,1,2,"field-label",0)(1,ut,6,7,"field-generic-display",1)(2,yt,5,5,"div",2),2&t&&(h.Y8G("ngIf",e.displayLabel),h.R7$(),h.Y8G("ngIf",!e.isEditMode()),h.R7$(),h.Y8G("ngIf",e.isEditable()&&e.isEditMode()))},dependencies:[i.YU,i.bT,i.B3,Y.b,T.K,ot.A,st.t,dt.J,ct.z,g.W,rt.H],encapsulation:2})}return fieldModelAttachment})();var vt=s(66031),St=s(98217),Ft=s(81473);function xt(t,e){if(1&t&&h.nrm(0,"system-object-preview",4),2&t){const t=h.XpG(2);h.Y8G("data",t.blobFile)("type",t.type)}}function kt(t,e){if(1&t&&h.nrm(0,"system-image-preview",5),2&t){const t=h.XpG(2);h.Y8G("data",t.imgData)}}function At(t,e){if(1&t&&(h.qex(0,1),h.DNE(1,xt,1,2,"system-object-preview",2)(2,kt,1,1,"system-image-preview",3),h.bVm()),2&t){const t=h.XpG();h.Y8G("ngSwitch",t.fileType),h.R7$(),h.Y8G("ngSwitchCase","notImage"),h.R7$(),h.Y8G("ngSwitchCase","image")}}let It=(()=>{class SpiceAttachmentsContainer{constructor(t,e,s,i){this.navigationtab=t,this.modelattachments=e,this.helper=s,this.modal=i,this.module="",this.id="",this.loadingerror=!1,this.componentSubscriptions=new w.yU,this.file={},this.blobFile="",this.componentSubscriptions.add(this.navigationtab.activeRoute$.subscribe((t=>{this.initialize(t.params)})))}get fileType(){if(!this.type)return"";let t=this.type.split("/");return"image"===t[0]?t[0]:"notImage"}ngOnDestroy(){URL.revokeObjectURL(this.helper.blobUrl),this.componentSubscriptions.unsubscribe(),this.navigationtab.closeTab()}initialize(t){this.modelattachments.module=t.module,this.modelattachments.id=t.id,this.modelattachments.getAttachmentData(t.attachmentId).subscribe({next:t=>{this.file=t,this.type=this.file.file_mime_type.toLowerCase(),this.blobFile=atob(this.file.file),this.setTabTitle(),"image"==this.fileType&&(this.imgData="data:"+this.file.file_mime_type.toLowerCase()+";base64,"+this.file.file)},error:()=>{this.loadingerror=!0}})}setTabTitle(){const t={displayname:this.file.filename,displayicon:"attach"};this.navigationtab.setTabInfo(t)}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentsContainer)(h.rXU(vt._),h.rXU(m.S),h.rXU(nt.d),h.rXU(et.y))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentsContainer,selectors:[["spice-attachments-container"]],features:[h.Jv_([m.S])],decls:1,vars:1,consts:[[3,"ngSwitch",4,"ngIf"],[3,"ngSwitch"],[3,"data","type",4,"ngSwitchCase"],[3,"data",4,"ngSwitchCase"],[3,"data","type"],[3,"data"]],template:function(t,e){1&t&&h.DNE(0,At,3,3,"ng-container",0),2&t&&h.Y8G("ngIf",e.type)},dependencies:[i.bT,i.ux,i.e1,St.$,Ft.L],encapsulation:2})}return SpiceAttachmentsContainer})();function Rt(t,e){1&t&&(h.qex(0),h.j41(1,"div",9)(2,"system-illustration-no-records"),h.nrm(3,"system-label",10),h.k0s()(),h.bVm())}const jt=t=>({"slds-theme_shade":t});function Lt(t,e){if(1&t){const t=h.RV6();h.j41(0,"div",15),h.bIt("click",(function(){const e=h.eBV(t).$implicit,s=h.XpG(2);return h.Njj(s.toggleSelectFile(e))})),h.j41(1,"div")(2,"system-checkbox",16),h.bIt("click",(function(){const e=h.eBV(t).$implicit,s=h.XpG(2);return h.Njj(s.toggleSelectFile(e))})),h.k0s()(),h.nrm(3,"spice-attachment-file",17),h.k0s()}if(2&t){const t=e.$implicit,s=h.XpG(2);h.Y8G("ngClass",h.eq3(7,jt,t.selected)),h.R7$(2),h.Y8G("ngModel",t.selected)("disabled",!1),h.R7$(),h.Y8G("modelattachments",s.modelattachments)("file",t)("editmode",!1)("disabled",!0)}}function Xt(t,e){if(1&t){const t=h.RV6();h.j41(0,"div",11)(1,"system-checkbox",12),h.mxI("ngModelChange",(function(e){h.eBV(t);const s=h.XpG();return h.DH7(s.selectAll,e)||(s.selectAll=e),h.Njj(e)})),h.nrm(2,"system-label",13),h.k0s()(),h.DNE(3,Lt,4,9,"div",14)}if(2&t){const t=h.XpG();h.R7$(),h.R50("ngModel",t.selectAll),h.Y8G("indeterminate",t.selectedFilesCount>0&&!t.selectAll),h.R7$(2),h.Y8G("ngForOf",t.modelattachments.files)}}let Ct=(()=>{class SpiceAttachmentAddFromRecordModal{constructor(t,e,s,i,l,a,n,o,d,c){this.attachmentsPanelComponent=t,this.emailAttachments=e,this.modelattachments=s,this.language=i,this.model=l,this.backend=a,this.toast=n,this.modal=o,this.cdRef=d,this.broadcast=c,this.selectedFilesCount=0,this.files=[]}ngAfterViewInit(){this.setModelData(),this.loadFiles()}save(){this.modal.openModal("SystemLoadingModal").subscribe((t=>{const e=this.modelattachments.files.filter((t=>t.selected));this.cloneAttachmentsFromBean(this.parent,e).subscribe((e=>{this.attachmentsPanelComponent.loadFiles(),t.instance.self.destroy(),this.close(),e?this.toast.sendToast("LBL_SUCCESS","success"):this.toast.sendToast("LBL_ERROR","error")}))}))}cloneAttachmentsFromBean(t,e,s){let i=new I.B;const l={categoryId:s,selectedFiles:e};return this.backend.postRequest(`common/spiceattachments/module/${this.parent.module}/${this.parent.id}/clone/${this.parent.data.parent_type}/${this.parent.data.parent_id}`,{},l,this.modelattachments.httpRequestsRefID).subscribe({next:t=>{for(let e in t)this.modelattachments.files.find((t=>t.id==e))||(t[e].date=new moment(t[e].date),this.files.push(t[e]));i.next(this.files),i.complete()},error:t=>{i.error(t),i.complete()}}),i.asObservable()}set selectAll(t){this.modelattachments.files.forEach((e=>e.selected=t)),this.selectedFilesCount=t?this.modelattachments.files.filter((t=>t.selected)).length:0}get selectAll(){return this.modelattachments.files.length==this.selectedFilesCount}loadFiles(){this.modelattachments.getAttachments().subscribe((t=>{this.cdRef.detectChanges(),this.files=t}))}setModelData(){this.modelattachments.module=this.parent.data.parent_type,this.modelattachments.id=this.parent.data.parent_id}close(){this.self.destroy()}toggleSelectFile(t){t.selected=!t.selected,t.selected?this.selectedFilesCount++:this.selectedFilesCount--}static#t=this.ɵfac=function(t){return new(t||SpiceAttachmentAddFromRecordModal)(h.rXU(r.X),h.rXU(m.S,4),h.rXU(m.S),h.rXU(u.B),h.rXU(p.g),h.rXU(J.H),h.rXU(H.o),h.rXU(et.y),h.rXU(h.gRc),h.rXU(f.m))};static#e=this.ɵcmp=h.VBU({type:SpiceAttachmentAddFromRecordModal,selectors:[["spice-attachment-add-from-record-modal"]],features:[h.Jv_([m.S])],decls:12,vars:2,consts:[[3,"close"],["label","LBL_ADD_FROM_RECORD"],["margin","xx-small"],[4,"ngIf","ngIfElse"],["showAttachments",""],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-col--bump-left","slds-button","slds-button--brand",3,"click"],["label","LBL_SAVE"],[1,"slds-align--absolute-center","slds-p-around--small"],["label","LBL_NO_RECORDS_FOUND"],[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--xx-small"],[3,"ngModel","indeterminate","ngModelChange"],["label","LBL_SELECT_ALL"],["class","slds-grid slds-grid_vertical-align-center slds-p-around--xx-small",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--xx-small",3,"ngClass","click"],[3,"ngModel","disabled","click"],[1,"slds-media",2,"pointer-events","none",3,"modelattachments","file","editmode","disabled"]],template:function(t,e){if(1&t&&(h.j41(0,"system-modal")(1,"system-modal-header",0),h.bIt("close",(function(){return e.close()})),h.nrm(2,"system-label",1),h.k0s(),h.j41(3,"system-modal-content",2),h.DNE(4,Rt,4,0,"ng-container",3)(5,Xt,4,3,"ng-template",null,4,h.C5r),h.k0s(),h.j41(7,"system-modal-footer")(8,"button",5),h.bIt("click",(function(){return e.close()})),h.nrm(9,"system-label",6),h.k0s(),h.j41(10,"button",7),h.bIt("click",(function(){return e.save()})),h.nrm(11,"system-label",8),h.k0s()()()),2&t){const t=h.sdS(6);h.R7$(4),h.Y8G("ngIf",0==e.modelattachments.files.length)("ngIfElse",t)}},encapsulation:2,changeDetection:0})}return SpiceAttachmentAddFromRecordModal})();var wt=s(48717),Ut=s(84359),Et=s(58461);let Gt=(()=>{class ModuleSpiceAttachments{static#t=this.ɵfac=function(t){return new(t||ModuleSpiceAttachments)};static#e=this.ɵmod=h.$C({type:ModuleSpiceAttachments});static#s=this.ɵinj=h.G2t({imports:[i.MD,l.YN,n.ObjectFields,o.GlobalComponents,d.ObjectComponents,c.SystemComponents,a.h]})}return ModuleSpiceAttachments})();("undefined"==typeof ngJitMode||ngJitMode)&&h.Obh(Gt,{declarations:[r.X,y,_.E,C,F,k,M,V,K,at,_t,It,Ct],imports:[i.MD,l.YN,n.ObjectFields,o.GlobalComponents,d.ObjectComponents,c.SystemComponents,a.h],exports:[F,_.E]}),h.wjB(r.X,[i.Sq,i.bT,g.W,wt.P,rt.H,_.E],[]),h.wjB(Ct,[i.YU,i.Sq,i.bT,l.BC,l.vS,Ut.f,Et.b,g.W,R.D,j.I,L.Q,X.C,_.E],[])}}]);