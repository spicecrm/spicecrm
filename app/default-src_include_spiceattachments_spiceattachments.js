/*!
 * 
 *                     aacService
 *
 *                     release: 2023.03.001
 *
 *                     date: 2024-01-09 16:51:03
 *
 *                     build: 2023.03.001.1704815463270
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["default-src_include_spiceattachments_spiceattachments_ts"],{46346:(e,t,s)=>{s.d(t,{I:()=>_});var i=s(62242),l=s(62422),a=s(44044),n=s(13278),o=s(93441),d=s(17017),c=s(83348),m=s(44755),r=s(72656),h=s(87693);function p(e,t){if(1&e&&i._UZ(0,"system-file-icon",10),2&e){const e=i.oxw();i.Q6J("filename",e.file.filename)("filemimetype",e.file.file_mime_type)}}function u(e,t){if(1&e&&(i.TgZ(0,"div"),i._UZ(1,"img",11),i.qZA()),2&e){const e=i.oxw();i.xp6(1),i.Q6J("src","data:image/jpg;base64,"+e.file.thumbnail,i.LSH)}}function f(e,t){if(1&e){const e=i.EpF();i.TgZ(0,"div",12)(1,"button",13),i.NdJ("click",(function(){i.CHM(e);const t=i.oxw();return i.KtG(t.deleteFile())})),i._UZ(2,"system-button-icon",14),i.qZA()()}}function g(e,t){if(1&e&&(i.TgZ(0,"div",15)(1,"ul",16)(2,"li",17),i._uU(3),i.qZA(),i.TgZ(4,"li",17),i._uU(5),i.qZA()()()),2&e){const e=i.oxw();i.xp6(3),i.Oqu(e.filedate),i.xp6(2),i.Oqu(e.humanFileSize)}}function b(e,t){if(1&e&&(i.TgZ(0,"div",4)(1,"div",18)(2,"span",19)(3,"span",20),i._uU(4,"Progress: 25%"),i.qZA()()(),i.TgZ(5,"div",21),i._uU(6),i.qZA()()),2&e){const e=i.oxw();i.xp6(2),i.Q6J("ngStyle",e.progressbarstyle),i.xp6(4),i.hij(" ",e.file.uploadprogress," % ")}}let _=(()=>{class SpiceAttachmentFile{userpreferences;modal;toast;helper;injector;navigationtab;router;file={};editmode=!0;modelattachments;disabled=!1;forceModalPreview=!1;constructor(e,t,s,i,l,a,n){this.userpreferences=e,this.modal=t,this.toast=s,this.helper=i,this.injector=l,this.navigationtab=a,this.router=n}get humanFileSize(){return this.modelattachments.humanFileSize(this.file.filesize)}get filedate(){return this.file.date?this.file.date.format(this.userpreferences.getDateFormat()):""}get uploading(){return this.file.hasOwnProperty("uploadprogress")}get progressbarstyle(){return{width:this.file.uploadprogress+"%"}}downloadFile(){this.uploading||this.modelattachments.downloadAttachment(this.file.id,this.file.filename)}preview(e){this.forceModalPreview?this.previewFile(e):this.openInTab()}openInTab(){if(this.disabled)return;let e=this.file.file_mime_type.toLowerCase().split("/");const t="application"==e[0]&&"pdf"!=e[1]&&"msg"!=e[1],s="text"==e[0]&&"csv"==e[1];if(t||s)return this.downloadFile();let i="";this.navigationtab?.tabid&&(i="/tab/"+this.navigationtab.tabid),this.router.navigate([`${i}/attachment/${this.file.id}/${this.modelattachments.module}/${this.modelattachments.id}`])}previewFile(e){if(!this.disabled)if(e.preventDefault(),e.stopPropagation(),this.uploading)this.toast.sendToast("upload still in progress","info");else if(this.file.file_mime_type){let e=this.file.file_mime_type.toLowerCase().split("/");switch(e[0].trim()){case"image":if("svg+xml"===e[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((e=>{e.instance.name=this.file.filename,e.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:t=>{e.instance.data=atob(t)},error:t=>{e.instance.loadingerror=!0}})}));else this.modal.openModal("SystemImagePreviewModal").subscribe((e=>{e.instance.imgname=this.file.filename,e.instance.imgtype=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:t=>{e.instance.imgsrc="data:"+this.file.file_mime_type.toLowerCase()+";base64,"+t},error:t=>{e.instance.loadingerror=!0}})}));break;case"text":case"audio":case"video":this.modal.openModal("SystemObjectPreviewModal").subscribe((e=>{e.instance.name=this.file.filename,e.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:t=>{e.instance.data=atob(t)},error:t=>{e.instance.loadingerror=!0}})}));break;case"application":if("pdf"===e[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((e=>{e.instance.name=this.file.filename,e.instance.type=this.file.file_mime_type.toLowerCase(),this.modelattachments.getAttachment(this.file.id).subscribe({next:t=>{e.instance.data=atob(t)},error:t=>{e.instance.loadingerror=!0}})}));else{if("msg"===this.file.filename.split(".").splice(-1,1)[0].toLowerCase())this.modal.openModal("EmailPreviewModal",!0,this.injector).subscribe((e=>{e.instance.name=this.file.filename,e.instance.type=this.file.file_mime_type.toLowerCase(),e.instance.file=this.file}));else this.downloadFile()}break;default:this.downloadFile()}}}deleteFile(){this.editmode&&this.modelattachments.deleteAttachment(this.file.id)}static ɵfac=function(e){return new(e||SpiceAttachmentFile)(i.Y36(l.z),i.Y36(a.o),i.Y36(n.A),i.Y36(o._),i.Y36(i.zs3),i.Y36(d.d),i.Y36(c.F0))};static ɵcmp=i.Xpm({type:SpiceAttachmentFile,selectors:[["spice-attachment-file"]],inputs:{file:"file",editmode:"editmode",modelattachments:"modelattachments",disabled:"disabled",forceModalPreview:"forceModalPreview"},decls:11,vars:6,consts:[[1,"slds-m-right--x-small","slds-align--absolute-center",2,"width","30px","height","30px"],["divClass","","size","small",3,"filename","filemimetype",4,"ngIf"],[4,"ngIf"],[1,"slds-media__body"],[1,"slds-grid","slds-grid_vertical-align-center","slds-grid--align-spread","slds-has-flexi-truncate"],[1,"slds-truncate","slds-text-heading--x-small","slds-p-right--xxx-small",3,"click"],["href","javascript:void(0);"],["class","slds-shrink-none",4,"ngIf"],["class","slds-tile__detail slds-text-body--small",4,"ngIf"],["class","slds-grid slds-grid_vertical-align-center slds-grid--align-spread slds-has-flexi-truncate",4,"ngIf"],["divClass","","size","small",3,"filename","filemimetype"],[3,"src"],[1,"slds-shrink-none"],[1,"slds-button","slds-button--icon",3,"click"],["icon","clear"],[1,"slds-tile__detail","slds-text-body--small"],[1,"slds-list--horizontal","slds-has-dividers--left"],[1,"slds-item"],[1,"slds-progress-bar"],[1,"slds-progress-bar__value",3,"ngStyle"],[1,"slds-assistive-text"],[1,"slds-text-align--right",2,"width","50px"]],template:function(e,t){1&e&&(i.TgZ(0,"div",0),i.YNc(1,p,1,2,"system-file-icon",1),i.YNc(2,u,2,1,"div",2),i.qZA(),i.TgZ(3,"div",3)(4,"div",4)(5,"h3",5),i.NdJ("click",(function(e){return t.preview(e)})),i.TgZ(6,"a",6),i._uU(7),i.qZA()(),i.YNc(8,f,3,0,"div",7),i.qZA(),i.YNc(9,g,6,2,"div",8),i.YNc(10,b,7,2,"div",9),i.qZA()),2&e&&(i.xp6(1),i.Q6J("ngIf",!t.file.thumbnail),i.xp6(1),i.Q6J("ngIf",t.file.thumbnail),i.xp6(5),i.Oqu(t.file.filename),i.xp6(1),i.Q6J("ngIf",!t.uploading&&t.editmode),i.xp6(1),i.Q6J("ngIf",!t.uploading),i.xp6(1),i.Q6J("ngIf",t.uploading))},dependencies:[m.O5,m.PC,r.J,h.T],encapsulation:2})}return SpiceAttachmentFile})()},3719:(e,t,s)=>{s.r(t),s.d(t,{ModuleSpiceAttachments:()=>Be});var i=s(44755),l=s(95030),a=s(84357),n=s(53190),o=s(34826),d=s(19784),c=s(57239),m=s(62242),r=s(50323),h=s(17017),p=s(50727),u=s(55329),f=s(44044),g=s(55710),b=s(32294),_=s(13278),y=s(4154),x=s(33369),v=s(83463),A=s(94664),Z=s(69774),w=s(46346);const F=["fileupload"];function C(e,t){if(1&e&&m._UZ(0,"spice-attachment-file",6),2&e){const e=t.$implicit,s=m.oxw(2);m.Q6J("modelattachments",s.modelattachments)("file",e)("editmode",s.editing)("forceModalPreview",s.forceModalPreview)}}function S(e,t){1&e&&(m.TgZ(0,"div",7)(1,"div",8),m._UZ(2,"system-spinner",9)(3,"system-label",10),m.qZA()())}function M(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"button",19),m.NdJ("click",(function(){m.CHM(e);const t=m.oxw(3);return m.KtG(t.selectFile())})),m._UZ(1,"system-label",20),m.qZA()}}function T(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"button",19),m.NdJ("click",(function(){m.CHM(e);const t=m.oxw(3);return m.KtG(t.addImage())})),m._UZ(1,"system-label",21),m.qZA()}}function L(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"button",22),m.NdJ("click",(function(){m.CHM(e);const t=m.oxw(3);return m.KtG(t.addFromRecord())})),m._UZ(1,"system-label",23),m.qZA()}if(2&e){const e=m.oxw(3);m.Q6J("disabled","Tasks"==e._modelattachments.module)}}function I(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",11)(1,"div",12),m._UZ(2,"system-label",13),m.qZA(),m.TgZ(3,"div",12),m._UZ(4,"system-label",14),m.qZA(),m.YNc(5,M,2,0,"button",15),m.TgZ(6,"div",12),m._UZ(7,"system-label",14),m.qZA(),m.YNc(8,T,2,0,"button",15),m.TgZ(9,"input",16,17),m.NdJ("click",(function(){m.CHM(e);const t=m.MAs(10);return m.KtG(t.value=null)}))("change",(function(){m.CHM(e);const t=m.oxw(2);return m.KtG(t.uploadFile())})),m.qZA(),m.TgZ(11,"div",12),m._UZ(12,"system-label",14),m.qZA(),m.YNc(13,L,2,1,"button",18),m.qZA()}if(2&e){const e=m.oxw(2);m.xp6(5),m.Q6J("ngIf",!e.componentconfig.disableupload),m.xp6(3),m.Q6J("ngIf",!e.componentconfig.disableupload),m.xp6(5),m.Q6J("ngIf",!e.componentconfig.disableupload)}}function q(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",1),m.NdJ("system-drop-file",(function(t){m.CHM(e);const s=m.oxw();return m.KtG(s.fileDrop(t))})),m.TgZ(1,"div")(2,"div",2),m.YNc(3,C,1,4,"spice-attachment-file",3),m.qZA(),m.YNc(4,S,4,0,"div",4),m.qZA(),m.YNc(5,I,14,3,"div",5),m.qZA()}if(2&e){const e=m.oxw();m.xp6(3),m.Q6J("ngForOf",e.modelattachments.files),m.xp6(1),m.Q6J("ngIf",e.modelattachments.loading),m.xp6(1),m.Q6J("ngIf",e.editing&&!e.componentconfig.disableupload&&!e.modelattachments.loading)}}let J=(()=>{class SpiceAttachmentsPanel{_modelattachments;parentmodelattachments;language;modal;model;view;renderer;toast;metadata;modalservice;injector;parentModel;navigationtab;broadcast;fileupload;uploadfiles=[];uploadfilesExist=!1;attachmentsLoaded=new m.vpe;forceModalPreview=!1;componentconfig={};subscriptions=new p.w0;constructor(e,t,s,i,l,a,n,o,d,c,m,r,h,p){this._modelattachments=e,this.parentmodelattachments=t,this.language=s,this.modal=i,this.model=l,this.view=a,this.renderer=n,this.toast=o,this.metadata=d,this.modalservice=c,this.injector=m,this.parentModel=r,this.navigationtab=h,this.broadcast=p,this._modelattachments.module=this.model.module,this._modelattachments.id=this.model.id}get isHidden(){return!!this.componentconfig.requiredmodelstate&&!this.model.checkModelState(this.componentconfig.requiredmodelstate)}get modelattachments(){return this.parentmodelattachments&&this.parentmodelattachments.module==this.model.module&&this.parentmodelattachments.id==this.model.id?this.parentmodelattachments:this._modelattachments}get editing(){return this.model.isEditing&&(!this.view||this.view.isEditable)}loadFiles(){this.modelattachments.getAttachments(this.componentconfig.systemCateogryId).subscribe((e=>{this.attachmentsLoaded.emit(!0),this.loadInputFiles()}))}loadInputFiles(){this.uploadfilesExist?this.modelattachments.addFiles(this.uploadfiles):this.modelattachments.uploadAttachmentsBase64FromArray(this.uploadfiles)}setUploadFiles(e){for(let e of this.uploadfiles){let t=this._modelattachments.files.find((t=>t.filename==e.name));t&&this._modelattachments.deleteAttachment(t.id)}this.uploadfiles=e,this.loadInputFiles()}ngAfterViewInit(){this.parentmodelattachments||setTimeout((()=>this.loadFiles()),10)}preventdefault(e){(e.dataTransfer.items.length>=1&&this.hasOneItemsFile(e.dataTransfer.items)||e.dataTransfer.files.length>0)&&(e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy")}hasOneItemsFile(e){for(let t of e)if("file"==t.kind)return!0;return!1}onDrop(e){this.preventdefault(e);let t=e.dataTransfer.files;t&&t.length>=1&&this.doupload(t)}fileDrop(e){e&&e.length>=1&&this.doupload(e)}selectFile(){let e=new MouseEvent("click",{bubbles:!0});this.fileupload.element.nativeElement.dispatchEvent(e)}uploadFile(){let e=this.fileupload.element.nativeElement.files;this.doupload(e)}doupload(e){this.modelattachments.uploadAttachmentsBase64(e,this.componentconfig.systemCateogryId).subscribe({next:()=>{this.broadcastUpload()}})}addImage(){this.modal.openModal("SpiceAttachmentAddImageModal",!0,this.injector).subscribe((e=>{e.instance.systemCategoryId=this.componentconfig.systemCateogryId,e.instance.responseSubject.subscribe({next:()=>{this.broadcastUpload()}})}))}addFromRecord(){this.modal.openModal("SpiceAttachmentAddFromRecordModal",!0,this.injector).subscribe((e=>{e.instance.parent=this.parentModel}))}broadcastUpload(){this._modelattachments.broadcast.broadcastMessage("attachments.uploaded",{uploadedFiles:this._modelattachments.files,uniqueID:this._modelattachments.httpRequestsRefID,reload:!0})}static ɵfac=function(e){return new(e||SpiceAttachmentsPanel)(m.Y36(r.H),m.Y36(r.H,12),m.Y36(u.d),m.Y36(f.o),m.Y36(g.o),m.Y36(b.e,8),m.Y36(m.Qsj),m.Y36(_.A),m.Y36(y.Pu),m.Y36(f.o),m.Y36(m.zs3),m.Y36(g.o,4),m.Y36(h.d),m.Y36(x.f))};static ɵcmp=m.Xpm({type:SpiceAttachmentsPanel,selectors:[["spice-attachments-panel"]],viewQuery:function(e,t){if(1&e&&m.Gf(F,5,m.s_b),2&e){let e;m.iGM(e=m.CRH())&&(t.fileupload=e.first)}},inputs:{forceModalPreview:"forceModalPreview"},outputs:{attachmentsLoaded:"attachmentsLoaded"},features:[m._Bn([r.H,h.d])],decls:1,vars:1,consts:[["class","slds-box slds-m-around--xx-small",3,"system-drop-file",4,"ngIf"],[1,"slds-box","slds-m-around--xx-small",3,"system-drop-file"],[1,"slds-card__body--inner","slds-grid","slds-wrap","slds-grid--pull-padded"],["class","slds-media slds-size--1-of-1",3,"modelattachments","file","editmode","forceModalPreview",4,"ngFor","ngForOf"],["class","slds-p-around--x-small slds-align--absolute-center",4,"ngIf"],["class","slds-grid slds-grid--align-center slds-grid--vertical-align-center slds-gutters_direct-xx-small",4,"ngIf"],[1,"slds-media","slds-size--1-of-1",3,"modelattachments","file","editmode","forceModalPreview"],[1,"slds-p-around--x-small","slds-align--absolute-center"],[1,"slds-grid","slds-grid--vertical-align-center"],["size","14"],["label","LBL_INITIALIZING",1,"slds-p-left--x-small"],[1,"slds-grid","slds-grid--align-center","slds-grid--vertical-align-center","slds-gutters_direct-xx-small"],[1,"slds-col"],["label","LBL_DROP_FILES"],["label","LBL_OR"],["class","slds-col slds-button slds-button--neutral",3,"click",4,"ngIf"],["type","file","multiple","",2,"display","none",3,"click","change"],["fileupload",""],["class","slds-col slds-button slds-button--neutral",3,"disabled","click",4,"ngIf"],[1,"slds-col","slds-button","slds-button--neutral",3,"click"],["label","LBL_UPLOAD_FILES"],["label","LBL_ADD_IMAGE"],[1,"slds-col","slds-button","slds-button--neutral",3,"disabled","click"],["label","LBL_ADD_FROM_RECORD"]],template:function(e,t){1&e&&m.YNc(0,q,6,3,"div",0),2&e&&m.Q6J("ngIf",!t.isHidden)},dependencies:[i.sg,i.O5,v._,A.W,Z.M,w.I],encapsulation:2})}return SpiceAttachmentsPanel})();function Y(e,t){if(1&e&&(m.TgZ(0,"span",3),m._uU(1),m.qZA()),2&e){const e=m.oxw();m.xp6(1),m.Oqu(e.attachmentcount)}}let O=(()=>{class SpiceAttachmentsPanelHeader{model;modelattachments;language;broadcast;broadcastSubscription={};attachmentcount=0;constructor(e,t,s,i){this.model=e,this.modelattachments=t,this.language=s,this.broadcast=i,this.broadcastSubscription=this.broadcast.message$.subscribe((e=>{this.handleMessage(e)}))}ngOnInit(){this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id,this.modelattachments.getCount().subscribe((e=>{this.attachmentcount=e}))}get hasAttachments(){return this.attachmentcount>0}handleMessage(e){if(e.messagedata.module===this.model.module||e.messagedata.id===this.model.id)switch(e.messagetype){case"attachments.loaded":case"attachments.cloned":this.attachmentcount=e.messagedata.attachmentcount}}ngOnDestroy(){this.broadcastSubscription.unsubscribe()}static ɵfac=function(e){return new(e||SpiceAttachmentsPanelHeader)(m.Y36(g.o),m.Y36(r.H),m.Y36(u.d),m.Y36(x.f))};static ɵcmp=m.Xpm({type:SpiceAttachmentsPanelHeader,selectors:[["spice-attachments-panel-header"]],features:[m._Bn([r.H])],decls:4,vars:1,consts:[[1,"slds-grid","slds-grid--vertical-align-center"],["label","LBL_FILES"],["class","slds-theme_warning slds-m-horizontal--xx-small slds-align--absolute-center spice-counter",4,"ngIf"],[1,"slds-theme_warning","slds-m-horizontal--xx-small","slds-align--absolute-center","spice-counter"]],template:function(e,t){1&e&&(m.TgZ(0,"div",0)(1,"span"),m._UZ(2,"system-label",1),m.qZA(),m.YNc(3,Y,2,1,"span",2),m.qZA()),2&e&&(m.xp6(3),m.Q6J("ngIf",t.hasAttachments))},dependencies:[i.O5,v._],encapsulation:2})}return SpiceAttachmentsPanelHeader})();function k(e,t){if(1&e&&m._UZ(0,"spice-attachment-file",3),2&e){const e=t.$implicit,s=m.oxw(2);m.Q6J("modelattachments",s.modelattachments)("file",e)("editmode",!1)("ngClass",s.getItemClass())}}function U(e,t){if(1&e&&(m.TgZ(0,"div",1),m.YNc(1,k,1,4,"spice-attachment-file",2),m.qZA()),2&e){const e=m.oxw();m.Q6J("ngStyle",e.getCompStyle())("ngClass",e.componentconfig.addClasses),m.xp6(1),m.Q6J("ngForOf",e.modelattachments.files)}}let N=(()=>{class SpiceAttachmentsList{modelattachments;language;model;cdRef;componentconfig={};constructor(e,t,s,i){this.modelattachments=e,this.language=t,this.model=s,this.cdRef=i,this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}loadFiles(){this.modelattachments.getAttachments().subscribe((e=>{this.cdRef.detectChanges()}))}ngAfterViewInit(){setTimeout((()=>this.loadFiles()),10)}getCompStyle(){return{marginRight:this.componentconfig.horizontal?"-16px":void 0,marginBottom:this.componentconfig.horizontal?"-8px":void 0}}getItemClass(){return this.componentconfig.horizontal?"slds-m-right_medium slds-m-bottom_x-small":"slds-size--1-of-1"}static ɵfac=function(e){return new(e||SpiceAttachmentsList)(m.Y36(r.H),m.Y36(u.d),m.Y36(g.o),m.Y36(m.sBO))};static ɵcmp=m.Xpm({type:SpiceAttachmentsList,selectors:[["spice-attachments-list"]],features:[m._Bn([r.H])],decls:1,vars:1,consts:[["class","slds-m-vertical--xx-small slds-card__body--inner slds-grid slds-wrap slds-grid--pull-padded",3,"ngStyle","ngClass",4,"ngIf"],[1,"slds-m-vertical--xx-small","slds-card__body--inner","slds-grid","slds-wrap","slds-grid--pull-padded",3,"ngStyle","ngClass"],["class","slds-media",3,"modelattachments","file","editmode","ngClass",4,"ngFor","ngForOf"],[1,"slds-media",3,"modelattachments","file","editmode","ngClass"]],template:function(e,t){1&e&&m.YNc(0,U,2,3,"div",0),2&e&&m.Q6J("ngIf",t.modelattachments.files.length>0)},dependencies:[i.mk,i.sg,i.O5,i.PC,w.I],encapsulation:2,changeDetection:0})}return SpiceAttachmentsList})();function Q(e,t){if(1&e&&(m.TgZ(0,"div",2),m._UZ(1,"spice-attachment-file",3),m.qZA()),2&e){const e=t.$implicit,s=m.oxw();m.xp6(1),m.Q6J("file",e)("modelattachments",s.modelattachments)("editmode",!1)}}let E=(()=>{class SpiceAttachmentsPopupList{modelattachments;language;model;componentconfig={};constructor(e,t,s){this.modelattachments=e,this.language=t,this.model=s,this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}ngOnInit(){this.modelattachments.getAttachments()}static ɵfac=function(e){return new(e||SpiceAttachmentsPopupList)(m.Y36(r.H),m.Y36(u.d),m.Y36(g.o))};static ɵcmp=m.Xpm({type:SpiceAttachmentsPopupList,selectors:[["spice-attachments-popup-list"]],features:[m._Bn([r.H])],decls:2,vars:1,consts:[[1,"slds-p-around--x-small"],["class","slds-p-vertical--x-small",4,"ngFor","ngForOf"],[1,"slds-p-vertical--x-small"],[1,"slds-media","slds-size--1-of-1",3,"file","modelattachments","editmode"]],template:function(e,t){1&e&&(m.TgZ(0,"div",0),m.YNc(1,Q,2,3,"div",1),m.qZA()),2&e&&(m.xp6(1),m.Q6J("ngForOf",t.modelattachments.files))},dependencies:[i.sg,w.I],encapsulation:2})}return SpiceAttachmentsPopupList})();var D=s(82547),R=s(77579),B=s(59621),H=s(83499),P=s(75767),z=s(1916);let j=(()=>{class SpiceAttachmentAddImageModal{language;modelattachments;self;inputMedia;filecontent="";imagedata=new m.vpe;systemCategoryId="";responseSubject=new R.x;constructor(e,t){this.language=e,this.modelattachments=t}close(){this.self.destroy()}add(){let e=this.inputMedia.mediaMetaData;this.modelattachments.uploadFileBase64(this.filecontent,e.filename,e.mimetype,this.systemCategoryId),this.responseSubject.next(!0),this.responseSubject.complete(),this.self.destroy()}static ɵfac=function(e){return new(e||SpiceAttachmentAddImageModal)(m.Y36(u.d),m.Y36(r.H))};static ɵcmp=m.Xpm({type:SpiceAttachmentAddImageModal,selectors:[["spice-attachment-add-image-modal"]],viewQuery:function(e,t){if(1&e&&m.Gf(D.l,5),2&e){let e;m.iGM(e=m.CRH())&&(t.inputMedia=e.first)}},outputs:{imagedata:"imagedata"},decls:10,vars:2,consts:[[3,"close"],["margin","xx-small"],[3,"ngModel","ngModelChange"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--brand",3,"disabled","click"],["label","LBL_ADD"]],template:function(e,t){1&e&&(m.TgZ(0,"system-modal")(1,"system-modal-header",0),m.NdJ("close",(function(){return t.close()})),m._uU(2,"Add Image"),m.qZA(),m.TgZ(3,"system-modal-content",1)(4,"system-input-media",2),m.NdJ("ngModelChange",(function(e){return t.filecontent=e})),m.qZA()(),m.TgZ(5,"system-modal-footer")(6,"button",3),m.NdJ("click",(function(){return t.close()})),m._UZ(7,"system-label",4),m.qZA(),m.TgZ(8,"button",5),m.NdJ("click",(function(){return t.add()})),m._UZ(9,"system-label",6),m.qZA()()()),2&e&&(m.xp6(4),m.Q6J("ngModel",t.filecontent),m.xp6(4),m.Q6J("disabled",!t.filecontent))},dependencies:[l.JJ,l.On,v._,B.j,H.x,P.p,z.y,D.l],encapsulation:2})}return SpiceAttachmentAddImageModal})();var G=s(78859);function $(e,t){1&e&&m._UZ(0,"system-utility-icon",1)}let K=(()=>{class SpiceAttachmentsCount{metadata;modelattachments;parentmodelattachments;language;model;cdRef;subscriptions=new p.w0;constructor(e,t,s,i,l,a){this.metadata=e,this.modelattachments=t,this.parentmodelattachments=s,this.language=i,this.model=l,this.cdRef=a,this.modelattachments.module=this.model.module,this.modelattachments.id=this.model.id}ngAfterViewInit(){this.modelHasAttachmentcount()||(this.parentmodelattachments?this.subscriptions.add(this.parentmodelattachments.getCount().subscribe((e=>{this.cdRef.detectChanges()}))):this.subscriptions.add(this.modelattachments.getCount().subscribe((e=>{this.cdRef.detectChanges()}))))}modelHasAttachmentcount(){return!!this.metadata.getModuleFields(this.model.module).attachments_count}ngOnDestroy(){this.subscriptions.unsubscribe()}get count(){return this.modelHasAttachmentcount()?this.model.getField("attachments_count"):this.parentmodelattachments?this.parentmodelattachments.count:this.modelattachments.count}static ɵfac=function(e){return new(e||SpiceAttachmentsCount)(m.Y36(y.Pu),m.Y36(r.H),m.Y36(r.H,12),m.Y36(u.d),m.Y36(g.o),m.Y36(m.sBO))};static ɵcmp=m.Xpm({type:SpiceAttachmentsCount,selectors:[["spice-attachments-count"]],features:[m._Bn([r.H])],decls:1,vars:1,consts:[["icon","attach","size","xx-small",4,"ngIf"],["icon","attach","size","xx-small"]],template:function(e,t){1&e&&m.YNc(0,$,1,0,"system-utility-icon",0),2&e&&m.Q6J("ngIf",t.count>0)},dependencies:[i.O5,G.r],encapsulation:2,changeDetection:0})}return SpiceAttachmentsCount})();var X=s(61810),V=s(83348),W=s(66367),ee=s(73208),te=s(23548);function se(e,t){if(1&e&&m._UZ(0,"field-label",3),2&e){const e=m.oxw();m.Q6J("fieldname",e.fieldname)("fieldconfig",e.fieldconfig)}}const ie=function(e,t){return{injector:e,componentset:t}};let le=(()=>{class fieldSpiceAttachmentsCount extends X.O{model;view;language;metadata;router;injector;constructor(e,t,s,i,l,a){super(e,t,s,i,l),this.model=e,this.view=t,this.language=s,this.metadata=i,this.router=l,this.injector=a}get popovercomponentset(){return this.fieldconfig.popovercomponentset}static ɵfac=function(e){return new(e||fieldSpiceAttachmentsCount)(m.Y36(g.o),m.Y36(b.e),m.Y36(u.d),m.Y36(y.Pu),m.Y36(V.F0),m.Y36(m.zs3))};static ɵcmp=m.Xpm({type:fieldSpiceAttachmentsCount,selectors:[["field-spice-attachments-count"]],features:[m.qOj],decls:4,vars:8,consts:[[3,"fieldname","fieldconfig",4,"ngIf"],[3,"fielddisplayclass","fieldconfig","editable"],[3,"system-pop-over"],[3,"fieldname","fieldconfig"]],template:function(e,t){1&e&&(m.YNc(0,se,1,2,"field-label",0),m.TgZ(1,"field-generic-display",1)(2,"div",2),m._UZ(3,"spice-attachments-count"),m.qZA()()),2&e&&(m.Q6J("ngIf",t.displayLabel),m.xp6(1),m.Q6J("fielddisplayclass",t.fielddisplayclass)("fieldconfig",t.fieldconfig)("editable",!1),m.xp6(1),m.Q6J("system-pop-over",m.WLB(5,ie,t.injector,t.popovercomponentset)))},dependencies:[i.O5,W.q,ee.D,te.K,K],encapsulation:2})}return fieldSpiceAttachmentsCount})();var ae=s(26625),ne=s(14505),oe=s(69503),de=s(88658),ce=s(50151);function me(e,t){if(1&e&&(m.TgZ(0,"div",20)(1,"system-checkbox-group-checkbox",21),m._UZ(2,"system-label",22),m.qZA()()),2&e){const e=t.$implicit;m.Q6J("system-title",e.label),m.xp6(1),m.Q6J("value",e.id),m.xp6(1),m.Q6J("label",e.label)}}let re=(()=>{class SpiceAttachmentsEditModal{configurationService;toast;language;model;backend;attachment={};inputData={};categories=[];self={};constructor(e,t,s,i,l){this.configurationService=e,this.toast=t,this.language=s,this.model=i,this.backend=l}ngOnInit(){if(this.configurationService.getData("spiceattachments_categories"))return this.categories=this.configurationService.getData("spiceattachments_categories");this.backend.getRequest("common/spiceattachments/categories/"+this.model.module).subscribe((e=>{e&&Array.isArray(e)&&(this.categories=e,this.configurationService.setData("spiceattachments_categories",e))}))}close(){this.self.destroy()}save(){const e={category_ids:this.inputData.category_ids.join(","),text:this.inputData.text,display_name:this.inputData.display_name?this.inputData.display_name:""};this.backend.postRequest("common/spiceattachments/"+this.attachment.id,{},e).subscribe((e=>{e&&e.success?(this.inputData.category_ids&&this.inputData.category_ids.join(",")!=this.attachment.category_ids&&(this.attachment.category_ids=this.inputData.category_ids.join(",")),this.inputData.text!=this.attachment.text&&(this.attachment.text=this.inputData.text),this.inputData.display_name!=this.attachment.display_name&&(this.attachment.display_name=this.inputData.display_name),this.toast.sendToast(this.language.getLabel("LBL_DATA_SAVED"),"success")):this.toast.sendToast(this.language.getLabel("ERR_FAILED_TO_EXECUTE"),"error"),this.self.destroy()}),(()=>{this.toast.sendToast(this.language.getLabel("ERR_NETWORK"),"error"),this.self.destroy()}))}static ɵfac=function(e){return new(e||SpiceAttachmentsEditModal)(m.Y36(ae.C),m.Y36(_.A),m.Y36(u.d),m.Y36(g.o),m.Y36(ne.y))};static ɵcmp=m.Xpm({type:SpiceAttachmentsEditModal,selectors:[["spice-attachments-edit-modal"]],decls:30,vars:5,consts:[[3,"close"],["label","LBL_EDIT"],[1,"slds-form-element"],[1,"slds-form-element__label"],["label","LBL_FILENAME"],[1,"slds-form-element__control"],["type","text","disabled","",1,"slds-input",3,"ngModel","ngModelChange"],["label","LBL_DISPLAY_NAME"],["type","text",1,"slds-input",3,"ngModel","ngModelChange"],[1,"slds-form-element","slds-p-horizontal--xx-small"],["label","LBL_CATEGORIES"],[3,"ngModel","ngModelChange"],["class","slds-large-size--1-of-3 slds-medium-size--1-of-1 slds-truncate",3,"system-title",4,"ngFor","ngForOf"],["label","LBL_TEXT"],[1,"slds-textarea","slds-scrollable--y","slds-m-vertical--xx-small",2,"height","250px",3,"ngModel","ngModelChange"],[1,"slds-grid"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--brand",3,"click"],["label","LBL_SAVE"],[1,"slds-large-size--1-of-3","slds-medium-size--1-of-1","slds-truncate",3,"system-title"],[3,"value"],[1,"slds-m-left--xx-small",3,"label"]],template:function(e,t){1&e&&(m.TgZ(0,"system-modal")(1,"system-modal-header",0),m.NdJ("close",(function(){return t.close()})),m._UZ(2,"system-label",1),m.qZA(),m.TgZ(3,"system-modal-content")(4,"div",2)(5,"label",3),m._UZ(6,"system-label",4),m.qZA(),m.TgZ(7,"div",5)(8,"input",6),m.NdJ("ngModelChange",(function(e){return t.attachment.filename=e})),m.qZA()()(),m.TgZ(9,"div",2)(10,"label",3),m._UZ(11,"system-label",7),m.qZA(),m.TgZ(12,"div",5)(13,"input",8),m.NdJ("ngModelChange",(function(e){return t.inputData.display_name=e})),m.qZA()()(),m.TgZ(14,"div",9)(15,"label",3),m._UZ(16,"system-label",10),m.qZA(),m.TgZ(17,"system-checkbox-group",11),m.NdJ("ngModelChange",(function(e){return t.inputData.category_ids=e})),m.YNc(18,me,3,3,"div",12),m.qZA()(),m.TgZ(19,"div",9)(20,"label",3),m._UZ(21,"system-label",13),m.qZA(),m.TgZ(22,"div",5)(23,"textarea",14),m.NdJ("ngModelChange",(function(e){return t.inputData.text=e})),m.qZA()()()(),m.TgZ(24,"system-modal-footer")(25,"div",15)(26,"button",16),m.NdJ("click",(function(){return t.close()})),m._UZ(27,"system-label",17),m.qZA(),m.TgZ(28,"button",18),m.NdJ("click",(function(){return t.save()})),m._UZ(29,"system-label",19),m.qZA()()()()),2&e&&(m.xp6(8),m.Q6J("ngModel",t.attachment.filename),m.xp6(5),m.Q6J("ngModel",t.inputData.display_name),m.xp6(4),m.Q6J("ngModel",t.inputData.category_ids),m.xp6(1),m.Q6J("ngForOf",t.categories),m.xp6(5),m.Q6J("ngModel",t.inputData.text))},dependencies:[i.sg,l.Fj,l.JJ,l.On,oe.L,de.m,v._,B.j,H.x,P.p,z.y,ce.S],encapsulation:2,changeDetection:0})}return SpiceAttachmentsEditModal})();var he=s(95698),pe=s(72656);function ue(e,t){if(1&e&&(m.TgZ(0,"tr")(1,"td")(2,"div",13),m._uU(3),m.qZA()(),m.TgZ(4,"td",20)(5,"div",13),m._uU(6),m.qZA()()()),2&e){const e=t.$implicit;m.xp6(3),m.Oqu(e.module),m.xp6(3),m.Oqu(e.count)}}function fe(e,t){if(1&e&&(m.TgZ(0,"tr")(1,"td")(2,"div",13),m._UZ(3,"system-label",24),m.qZA()(),m.TgZ(4,"td",20)(5,"div",13),m._uU(6),m.qZA()()()),2&e){const e=t.$implicit,s=m.oxw();m.xp6(3),m.Q6J("label",s.missingFiles[e].label),m.xp6(3),m.Oqu(s.missingFiles[e].count)}}let ge=(()=>{class SpiceAttachmentStats{backend;modal;analysisresults=[];missingFiles;missingFilesTotalcount=0;fileAreas=[];constructor(e,t){this.backend=e,this.modal=t,this.analyze(),this.getMissingFiles()}analyze(){this.analysisresults=[],this.backend.getRequest("common/spiceattachments/admin").pipe((0,he.q)(1)).subscribe((e=>{for(let t in e)this.analysisresults.push({module:t,count:e[t]})}))}get totalcount(){let e=0;for(let t of this.analysisresults)e+=parseInt(t.count,10);return e}delete(){this.modal.confirm("Are you sure you want to delete the data of all orphaned File Attachments?","Delete Orphaned Attachments?","warning").pipe((0,he.q)(1)).subscribe((e=>{e&&this.backend.postRequest("common/spiceattachments/admin/cleanup").pipe((0,he.q)(1)).subscribe((e=>{this.analyze()}))}))}getMissingFiles(){this.fileAreas=[],this.missingFilesTotalcount=0,this.backend.getRequest("common/spiceattachments/admin/missingfiles").pipe((0,he.q)(1)).subscribe((e=>{this.missingFiles=e;for(let e in this.missingFiles)this.fileAreas.push(e),this.missingFilesTotalcount+=this.missingFiles[e].count}))}static ɵfac=function(e){return new(e||SpiceAttachmentStats)(m.Y36(ne.y),m.Y36(f.o))};static ɵcmp=m.Xpm({type:SpiceAttachmentStats,selectors:[["spice-attachments-stats"]],decls:48,vars:4,consts:[[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--small"],[1,"slds-text-heading_medium"],["label","LBL_ATTACHMENTSTATISTICS"],[1,"slds-col--bump-left","slds-button","slds-button_icon","slds-button_icon-border-filled",3,"click"],["icon","delete"],[1,"slds-button","slds-button_icon","slds-button_icon-border-filled",3,"click"],["icon","refresh"],[1,"slds-border--top","system-to-bottom"],[1,"slds-text-heading--small","slds-p-around--small"],["label","LBL_SPICEATTACHMENTS_ORPHANED"],[1,"slds-table","slds-table_bordered","slds-table_cell-buffer","slds-table--header-fixed"],[1,"slds-text-title_caps"],["scope","col"],[1,"slds-truncate"],["label","LBL_MODULE"],["scope","col",1,"slds-text-align--right"],["label","LBL_RECORDS"],[4,"ngFor","ngForOf"],[1,"slds-theme--alt-inverse"],["label","LBL_TOTAL"],[1,"slds-text-align--right"],["label","LBL_MISSING_FILES"],["label","LBL_AREA"],["label","LBL_FILES"],[3,"label"]],template:function(e,t){1&e&&(m.TgZ(0,"div",0)(1,"h2",1),m._UZ(2,"system-label",2),m.qZA(),m.TgZ(3,"button",3),m.NdJ("click",(function(){return t.delete()})),m._UZ(4,"system-button-icon",4),m.qZA(),m.TgZ(5,"button",5),m.NdJ("click",(function(){return t.analyze(),t.getMissingFiles()})),m._UZ(6,"system-button-icon",6),m.qZA()(),m.TgZ(7,"div",7)(8,"h3",8),m._UZ(9,"system-label",9),m.qZA(),m.TgZ(10,"table",10)(11,"thead")(12,"tr",11)(13,"th",12)(14,"div",13),m._UZ(15,"system-label",14),m.qZA()(),m.TgZ(16,"th",15)(17,"div",13),m._UZ(18,"system-label",16),m.qZA()()()(),m.TgZ(19,"tbody"),m.YNc(20,ue,7,2,"tr",17),m.TgZ(21,"tr",18)(22,"td")(23,"div",13),m._UZ(24,"system-label",19),m.qZA()(),m.TgZ(25,"td",20)(26,"div",13),m._uU(27),m.qZA()()()()(),m.TgZ(28,"h3",8),m._UZ(29,"system-label",21),m.qZA(),m.TgZ(30,"table",10)(31,"thead")(32,"tr",11)(33,"th",12)(34,"div",13),m._UZ(35,"system-label",22),m.qZA()(),m.TgZ(36,"th",15)(37,"div",13),m._UZ(38,"system-label",23),m.qZA()()()(),m.TgZ(39,"tbody"),m.YNc(40,fe,7,2,"tr",17),m.TgZ(41,"tr",18)(42,"td")(43,"div",13),m._UZ(44,"system-label",19),m.qZA()(),m.TgZ(45,"td",20)(46,"div",13),m._uU(47),m.qZA()()()()()()),2&e&&(m.xp6(20),m.Q6J("ngForOf",t.analysisresults),m.xp6(7),m.Oqu(t.totalcount),m.xp6(13),m.Q6J("ngForOf",t.fileAreas),m.xp6(7),m.Oqu(t.missingFilesTotalcount))},dependencies:[i.sg,pe.J,v._],encapsulation:2})}return SpiceAttachmentStats})();var be=s(93441),_e=s(55638),ye=s(44561),xe=s(87693);const ve=["fileupload"];function Ae(e,t){if(1&e&&m._UZ(0,"field-label",3),2&e){const e=m.oxw();m.Q6J("fieldname",e.fieldname)("fieldconfig",e.fieldconfig)}}function Ze(e,t){if(1&e&&m._UZ(0,"system-file-icon",9),2&e){const e=m.oxw(2);m.Q6J("filemimetype",e.model.getField("file_mime_type"))("filename",e.value)}}function we(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"field-generic-display",4)(1,"div",5),m.YNc(2,Ze,1,2,"system-file-icon",6),m.TgZ(3,"div",7)(4,"a",8),m.NdJ("click",(function(t){m.CHM(e);const s=m.oxw();return m.KtG(s.previewFile(t))})),m._uU(5),m.qZA()()()()}if(2&e){const e=m.oxw();m.Q6J("fielddisplayclass",e.fielddisplayclass)("editable",e.isEditable())("fieldconfig",e.fieldconfig)("title",e.value)("fieldid",e.fieldid),m.xp6(2),m.Q6J("ngIf",e.value),m.xp6(3),m.Oqu(e.value)}}function Fe(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",15)(1,"div",16)(2,"span",17)(3,"span",18),m._UZ(4,"system-icon",19),m.qZA()(),m.TgZ(5,"a",20)(6,"span",21),m._uU(7),m.qZA()(),m.TgZ(8,"button",22),m.NdJ("click",(function(){m.CHM(e);const t=m.oxw(2);return m.KtG(t.removeFile())})),m._UZ(9,"system-button-icon",23),m.qZA()()()}if(2&e){const e=m.oxw(2);m.xp6(4),m.Q6J("icon",e.helper.determineFileIcon(e.mime_type)),m.xp6(3),m.Oqu(e.value)}}function Ce(e,t){if(1&e&&(m.TgZ(0,"div",24)(1,"div",25),m._UZ(2,"span",26),m.qZA(),m.TgZ(3,"div",27),m._uU(4),m.qZA()()),2&e){const e=m.oxw(2);m.xp6(2),m.Q6J("ngStyle",e.progressbarstyle),m.xp6(2),m.hij(" ",e.file.uploadprogress," % ")}}function Se(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",28)(1,"div",29),m.NdJ("system-drop-file",(function(t){m.CHM(e);const s=m.oxw(2);return m.KtG(s.onDrop(t))})),m.TgZ(2,"input",30,31),m.NdJ("click",(function(){m.CHM(e);const t=m.MAs(3);return m.KtG(t.value=null)}))("change",(function(){m.CHM(e);const t=m.oxw(2);return m.KtG(t.uploadFile())})),m.qZA(),m.TgZ(4,"label",32)(5,"span",33),m._UZ(6,"system-button-icon",34)(7,"system-label",35),m.qZA(),m.TgZ(8,"span",36),m._UZ(9,"system-label",37)(10,"system-label",38),m.qZA()()()()}if(2&e){const e=m.oxw(2);m.xp6(2),m.Q6J("id",e.fieldid),m.xp6(2),m.uIk("for",e.fieldid),m.xp6(2),m.Q6J("icon","upload")}}function Me(e,t){if(1&e&&(m.TgZ(0,"div",10),m.YNc(1,Fe,10,2,"div",11),m.YNc(2,Ce,5,2,"div",12),m.YNc(3,Se,11,3,"div",13),m._UZ(4,"field-messages",14),m.qZA()),2&e){const e=m.oxw();m.Q6J("ngClass",e.getFieldClass()),m.xp6(1),m.Q6J("ngIf",e.value),m.xp6(1),m.Q6J("ngIf",e.uploading),m.xp6(1),m.Q6J("ngIf",!e.value&&!e.uploading),m.xp6(1),m.Q6J("fieldname",e.fieldname)}}let Te=(()=>{class fieldModelAttachment extends X.O{model;view;language;metadata;router;injector;modelattachments;modal;helper;backend;fileupload;constructor(e,t,s,i,l,a,n,o,d,c){super(e,t,s,i,l),this.model=e,this.view=t,this.language=s,this.metadata=i,this.router=l,this.injector=a,this.modelattachments=n,this.modal=o,this.helper=d,this.backend=c}get file(){return this.modelattachments.files[0]}get uploading(){return this.file?.hasOwnProperty("uploadprogress")}get progressbarstyle(){return{width:this.file.uploadprogress+"%"}}get mime_type(){return this.model.getFieldValue(this.prefix+"_mime_type")}get prefix(){return"filename"==this.fieldname?"file":this.fieldname.substring(0,this.fieldname.length-5)}getAttachment(){let e=new R.x;return this.backend.getRequest(`common/spiceattachments/module/${this.model.module}/${this.model.id}/byfield/${this.prefix}`).subscribe((t=>{e.next(t.file),e.complete()}),(t=>{e.error(t),e.complete()})),e.asObservable()}previewFile(e){if(e.preventDefault(),e.stopPropagation(),this.mime_type){let e=this.mime_type.toLowerCase().split("/");switch(e[0].trim()){case"image":this.modal.openModal("SystemImagePreviewModal").subscribe((e=>{e.instance.imgname=this.value,e.instance.imgtype=this.mime_type.toLowerCase(),this.getAttachment().subscribe((t=>{e.instance.imgsrc="data:"+this.mime_type.toLowerCase()+";base64,"+t}),(t=>{e.instance.loadingerror=!0}))}));break;case"text":case"audio":case"video":this.modal.openModal("SystemObjectPreviewModal").subscribe((e=>{e.instance.name=this.value,e.instance.type=this.mime_type.toLowerCase(),this.getAttachment().subscribe((t=>{e.instance.data=atob(t)}),(t=>{e.instance.loadingerror=!0}))}));break;case"application":if("pdf"===e[1])this.modal.openModal("SystemObjectPreviewModal").subscribe((e=>{e.instance.name=this.value,e.instance.type=this.mime_type.toLowerCase(),this.getAttachment().subscribe((t=>{e.instance.data=atob(t)}),(t=>{e.instance.loadingerror=!0}))}));else this.downloadFile();break;default:this.downloadFile()}}else this.downloadFile()}removeFile(){this.modelattachments.files.length>0&&(this.modelattachments.files=[]);let e={};e[this.fieldname]=void 0,e[this.prefix+"_size"]=void 0,e[this.prefix+"_mime_type"]=void 0,e[this.prefix+"_md5"]=void 0,this.model.setFields(e)}onDrop(e){e&&e.length>=1&&this.doupload(e)}uploadFile(){let e=this.fileupload.element.nativeElement.files;this.doupload(e)}downloadFile(){this.modelattachments.downloadAttachmentForField(this.model.module,this.model.id,this.prefix,this.value)}doupload(e){this.modelattachments.uploadAttachmentsBase64(e).subscribe((e=>{}),(e=>{}),(()=>{let e=this.modelattachments.files[0],t={};t[this.fieldname]=e.filename,t[this.prefix+"_size"]=e.filesize,t[this.prefix+"_mime_type"]=e.file_mime_type,t[this.prefix+"_md5"]=e.filemd5,this.model.setFields(t)}))}static ɵfac=function(e){return new(e||fieldModelAttachment)(m.Y36(g.o),m.Y36(b.e),m.Y36(u.d),m.Y36(y.Pu),m.Y36(V.F0),m.Y36(m.zs3),m.Y36(r.H),m.Y36(f.o),m.Y36(be._),m.Y36(ne.y))};static ɵcmp=m.Xpm({type:fieldModelAttachment,selectors:[["field-model-attachment"]],viewQuery:function(e,t){if(1&e&&m.Gf(ve,5,m.s_b),2&e){let e;m.iGM(e=m.CRH())&&(t.fileupload=e.first)}},features:[m._Bn([r.H]),m.qOj],decls:3,vars:3,consts:[[3,"fieldname","fieldconfig",4,"ngIf"],[3,"fielddisplayclass","editable","fieldconfig","title","fieldid",4,"ngIf"],["class","slds-form-element__control slds-p-vertical--xxx-small",3,"ngClass",4,"ngIf"],[3,"fieldname","fieldconfig"],[3,"fielddisplayclass","editable","fieldconfig","title","fieldid"],[1,"slds-grid","slds-grid--vertical-align-center"],["divClass","slds-p-right--xx-small","size","x-small",3,"filemimetype","filename",4,"ngIf"],[1,"slds-truncate","slds-grow"],["href","javascript:void(0);",3,"click"],["divClass","slds-p-right--xx-small","size","x-small",3,"filemimetype","filename"],[1,"slds-form-element__control","slds-p-vertical--xxx-small",3,"ngClass"],["class","slds-pill_container slds-size--1-of-1 slds-m-vertical--xxx-small",4,"ngIf"],["class","slds-p-around--x-small slds-grid slds-grid_vertical-align-center slds-grid--align-spread slds-has-flexi-truncate",4,"ngIf"],["class","slds-file-selector slds-file-selector_files",4,"ngIf"],[3,"fieldname"],[1,"slds-pill_container","slds-size--1-of-1","slds-m-vertical--xxx-small"],[1,"slds-pill","slds-pill_link","slds-size--1-of-1"],[1,"slds-pill__icon_container"],["title","Account",1,"slds-icon_container","slds-icon-standard-account"],["divClass","","sprite","doctype","size","x-small",3,"icon"],["href","javascript:void(0);",1,"slds-pill__action"],[1,"slds-pill__label"],["title","Remove",1,"slds-button","slds-button_icon","slds-button_icon","slds-pill__remove",3,"click"],["icon","close"],[1,"slds-p-around--x-small","slds-grid","slds-grid_vertical-align-center","slds-grid--align-spread","slds-has-flexi-truncate"],[1,"slds-progress-bar"],[1,"slds-progress-bar__value",3,"ngStyle"],[1,"slds-text-align--right",2,"width","50px"],[1,"slds-file-selector","slds-file-selector_files"],[1,"slds-file-selector__dropzone",3,"system-drop-file"],["type","file",1,"slds-file-selector__input","slds-assistive-text",3,"id","click","change"],["fileupload",""],[1,"slds-file-selector__body"],[1,"slds-file-selector__button","slds-button","slds-button_neutral"],[3,"icon"],["label","LBL_UPLOAD_FILES"],[1,"slds-file-selector__text","slds-medium-show"],["label","LBL_OR"],["label","LBL_DROP_FILES"]],template:function(e,t){1&e&&(m.YNc(0,Ae,1,2,"field-label",0),m.YNc(1,we,6,7,"field-generic-display",1),m.YNc(2,Me,5,5,"div",2)),2&e&&(m.Q6J("ngIf",t.displayLabel),m.xp6(1),m.Q6J("ngIf",!t.isEditMode()),m.xp6(1),m.Q6J("ngIf",t.isEditable()&&t.isEditMode()))},dependencies:[i.mk,i.O5,i.PC,W.q,ee.D,_e.a,pe.J,ye.f,xe.T,v._,Z.M],encapsulation:2})}return fieldModelAttachment})();var Le=s(1148),Ie=s(66267);function qe(e,t){if(1&e&&m._UZ(0,"system-object-preview",4),2&e){const e=m.oxw(2);m.Q6J("data",e.blobFile)("type",e.type)}}function Je(e,t){if(1&e&&m._UZ(0,"system-image-preview",5),2&e){const e=m.oxw(2);m.Q6J("data",e.imgData)}}function Ye(e,t){if(1&e&&(m.ynx(0,1),m.YNc(1,qe,1,2,"system-object-preview",2),m.YNc(2,Je,1,1,"system-image-preview",3),m.BQk()),2&e){const e=m.oxw();m.Q6J("ngSwitch",e.fileType),m.xp6(1),m.Q6J("ngSwitchCase","notImage"),m.xp6(1),m.Q6J("ngSwitchCase","image")}}let Oe=(()=>{class SpiceAttachmentsContainer{navigationtab;modelattachments;helper;modal;module="";id="";loadingerror=!1;componentSubscriptions=new p.w0;file={};blobFile="";type;imgData;constructor(e,t,s,i){this.navigationtab=e,this.modelattachments=t,this.helper=s,this.modal=i,this.componentSubscriptions.add(this.navigationtab.activeRoute$.subscribe((e=>{this.initialize(e.params)})))}get fileType(){if(!this.type)return"";let e=this.type.split("/");return"image"===e[0]?e[0]:"notImage"}ngOnDestroy(){URL.revokeObjectURL(this.helper.blobUrl),this.componentSubscriptions.unsubscribe(),this.navigationtab.closeTab()}initialize(e){this.modelattachments.module=e.module,this.modelattachments.id=e.id,this.modelattachments.getAttachmentData(e.attachmentId).subscribe({next:e=>{this.file=e,this.type=this.file.file_mime_type.toLowerCase(),this.blobFile=atob(this.file.file),this.setTabTitle(),"image"==this.fileType&&(this.imgData="data:"+this.file.file_mime_type.toLowerCase()+";base64,"+this.file.file)},error:()=>{this.loadingerror=!0}})}setTabTitle(){const e={displayname:this.file.filename,displayicon:"attach"};this.navigationtab.setTabInfo(e)}static ɵfac=function(e){return new(e||SpiceAttachmentsContainer)(m.Y36(h.d),m.Y36(r.H),m.Y36(be._),m.Y36(f.o))};static ɵcmp=m.Xpm({type:SpiceAttachmentsContainer,selectors:[["spice-attachments-container"]],features:[m._Bn([r.H])],decls:1,vars:1,consts:[[3,"ngSwitch",4,"ngIf"],[3,"ngSwitch"],[3,"data","type",4,"ngSwitchCase"],[3,"data",4,"ngSwitchCase"],[3,"data","type"],[3,"data"]],template:function(e,t){1&e&&m.YNc(0,Ye,3,3,"ng-container",0),2&e&&m.Q6J("ngIf",t.type)},dependencies:[i.O5,i.RF,i.n9,Le.s,Ie.w],encapsulation:2})}return SpiceAttachmentsContainer})();var ke=s(7514),Ue=s(64730);function Ne(e,t){1&e&&(m.ynx(0),m.TgZ(1,"div",9)(2,"system-illustration-no-records"),m._UZ(3,"system-label",10),m.qZA()(),m.BQk())}const Qe=function(e){return{"slds-theme_shade":e}};function Ee(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",15),m.NdJ("click",(function(){const t=m.CHM(e).$implicit,s=m.oxw(2);return m.KtG(s.toggleSelectFile(t))})),m.TgZ(1,"div")(2,"system-checkbox",16),m.NdJ("click",(function(){const t=m.CHM(e).$implicit,s=m.oxw(2);return m.KtG(s.toggleSelectFile(t))})),m.qZA()(),m._UZ(3,"spice-attachment-file",17),m.qZA()}if(2&e){const e=t.$implicit,s=m.oxw(2);m.Q6J("ngClass",m.VKq(7,Qe,e.selected)),m.xp6(2),m.Q6J("ngModel",e.selected)("disabled",!1),m.xp6(1),m.Q6J("modelattachments",s.modelattachments)("file",e)("editmode",!1)("disabled",!0)}}function De(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div",11)(1,"system-checkbox",12),m.NdJ("ngModelChange",(function(t){m.CHM(e);const s=m.oxw();return m.KtG(s.selectAll=t)})),m._UZ(2,"system-label",13),m.qZA()(),m.YNc(3,Ee,4,9,"div",14)}if(2&e){const e=m.oxw();m.xp6(1),m.Q6J("ngModel",e.selectAll)("indeterminate",e.selectedFilesCount>0&&!e.selectAll),m.xp6(2),m.Q6J("ngForOf",e.modelattachments.files)}}let Re=(()=>{class SpiceAttachmentAddFromRecordModal{emailAttachments;modelattachments;language;model;backend;toast;modal;cdRef;broadcast;self;parent;selectedFilesCount=0;files=[];constructor(e,t,s,i,l,a,n,o,d){this.emailAttachments=e,this.modelattachments=t,this.language=s,this.model=i,this.backend=l,this.toast=a,this.modal=n,this.cdRef=o,this.broadcast=d}ngAfterViewInit(){this.setModelData(),this.loadFiles()}save(){this.modal.openModal("SystemLoadingModal").subscribe((e=>{const t=this.modelattachments.files.filter((e=>e.selected));this.cloneAttachmentsFromBean(this.parent,t).subscribe((t=>{this.emailAttachments.getAttachments().subscribe({next:()=>{e.instance.self.destroy(),this.close()}}),t?this.toast.sendToast("LBL_SUCCESS","success"):this.toast.sendToast("LBL_ERROR","error")}))}))}cloneAttachmentsFromBean(e,t,s){let i=new R.x;const l={categoryId:s,selectedFiles:t};return this.backend.postRequest(`common/spiceattachments/module/${this.parent.module}/${this.parent.id}/clone/${this.parent.data.parent_type}/${this.parent.data.parent_id}`,{},l,this.modelattachments.httpRequestsRefID).subscribe({next:e=>{for(let t in e)this.modelattachments.files.find((e=>e.id==t))||(e[t].date=new moment(e[t].date),this.files.push(e[t]));i.next(this.files),i.complete()},error:e=>{i.error(e),i.complete()}}),i.asObservable()}set selectAll(e){this.modelattachments.files.forEach((t=>t.selected=e)),this.selectedFilesCount=e?this.modelattachments.files.filter((e=>e.selected)).length:0}get selectAll(){return this.modelattachments.files.length==this.selectedFilesCount}loadFiles(){this.modelattachments.getAttachments().subscribe((e=>{this.cdRef.detectChanges(),this.files=e}))}setModelData(){this.modelattachments.module=this.parent.data.parent_type,this.modelattachments.id=this.parent.data.parent_id}close(){this.self.destroy()}toggleSelectFile(e){e.selected=!e.selected,e.selected?this.selectedFilesCount++:this.selectedFilesCount--}static ɵfac=function(e){return new(e||SpiceAttachmentAddFromRecordModal)(m.Y36(r.H,4),m.Y36(r.H),m.Y36(u.d),m.Y36(g.o),m.Y36(ne.y),m.Y36(_.A),m.Y36(f.o),m.Y36(m.sBO),m.Y36(x.f))};static ɵcmp=m.Xpm({type:SpiceAttachmentAddFromRecordModal,selectors:[["spice-attachment-add-from-record-modal"]],features:[m._Bn([r.H])],decls:12,vars:2,consts:[[3,"close"],["label","LBL_ADD_FROM_RECORD"],["margin","xx-small"],[4,"ngIf","ngIfElse"],["showAttachments",""],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-col--bump-left","slds-button","slds-button--brand",3,"click"],["label","LBL_SAVE"],[1,"slds-align--absolute-center","slds-p-around--small"],["label","LBL_NO_RECORDS_FOUND"],[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--xx-small"],[3,"ngModel","indeterminate","ngModelChange"],["label","LBL_SELECT_ALL"],["class","slds-grid slds-grid_vertical-align-center slds-p-around--xx-small",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"slds-grid","slds-grid_vertical-align-center","slds-p-around--xx-small",3,"ngClass","click"],[3,"ngModel","disabled","click"],[1,"slds-media",2,"pointer-events","none",3,"modelattachments","file","editmode","disabled"]],template:function(e,t){if(1&e&&(m.TgZ(0,"system-modal")(1,"system-modal-header",0),m.NdJ("close",(function(){return t.close()})),m._UZ(2,"system-label",1),m.qZA(),m.TgZ(3,"system-modal-content",2),m.YNc(4,Ne,4,0,"ng-container",3),m.YNc(5,De,4,3,"ng-template",null,4,m.W1O),m.qZA(),m.TgZ(7,"system-modal-footer")(8,"button",5),m.NdJ("click",(function(){return t.close()})),m._UZ(9,"system-label",6),m.qZA(),m.TgZ(10,"button",7),m.NdJ("click",(function(){return t.save()})),m._UZ(11,"system-label",8),m.qZA()()()),2&e){const e=m.MAs(6);m.xp6(4),m.Q6J("ngIf",0==t.modelattachments.files.length)("ngIfElse",e)}},dependencies:[i.mk,i.sg,i.O5,l.JJ,l.On,ke.U,Ue.C,v._,B.j,H.x,P.p,z.y,w.I],encapsulation:2,changeDetection:0})}return SpiceAttachmentAddFromRecordModal})(),Be=(()=>{class ModuleSpiceAttachments{static ɵfac=function(e){return new(e||ModuleSpiceAttachments)};static ɵmod=m.oAB({type:ModuleSpiceAttachments});static ɵinj=m.cJS({imports:[i.ez,l.u5,n.ObjectFields,o.GlobalComponents,d.ObjectComponents,c.SystemComponents,a.o]})}return ModuleSpiceAttachments})();("undefined"==typeof ngJitMode||ngJitMode)&&m.kYT(Be,{declarations:[J,O,w.I,j,N,E,K,le,re,ge,Te,Oe,Re],imports:[i.ez,l.u5,n.ObjectFields,o.GlobalComponents,d.ObjectComponents,c.SystemComponents,a.o],exports:[N,w.I]})}}]);