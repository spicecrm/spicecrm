/** 
 * Â© 2015 - 2021 aac services k.s. All rights reserved.
 * release: 2021.02.001
 * date: 2021-07-16 09:05:07
 * build: 2021.02.001.1626419107136
 **/
"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])})(e,t)};return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function s(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var l in t=arguments[s])Object.prototype.hasOwnProperty.call(t,l)&&(e[l]=t[l]);return e}).apply(this,arguments)},__decorate=this&&this.__decorate||function(e,t,s,i){var l,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var n=e.length-1;0<=n;n--)(l=e[n])&&(o=(a<3?l(o):3<a?l(t,s,o):l(t,s))||o);return 3<a&&o&&Object.defineProperty(t,s,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(s,i){return function(e,t){i(e,t,s)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleEmails=exports.fieldEmailActivityOpenness=exports.fieldEmailSubject=exports.EmailTemplatesPreview=exports.EmailTemplatesEditor=exports.EmailActionSetReadButton=exports.EmailSchedulesView=exports.EmailSchedulesRelatedModal=exports.EmailSchedulesRelatedButton=exports.EmailSchedulesModal=exports.EmailSchedulesButton=exports.EmailSendButton=exports.EmailForwardModal=exports.EmailForwardButton=exports.EmailReplyModal=exports.EmailReplyButton=exports.fieldEmailStatus=exports.EmailsPopoverBody=exports.EmailMSGPreviewModal=exports.EmailPreviewModal=exports.EmailToObjectButton=exports.EmailToObjectModal=exports.EmailToObjectEmailText=void 0;var common_1=require("@angular/common"),core_1=require("@angular/core"),forms_1=require("@angular/forms"),directives_1=require("../../directives/directives"),objectfields_1=require("../../objectfields/objectfields"),globalcomponents_1=require("../../globalcomponents/globalcomponents"),objectcomponents_1=require("../../objectcomponents/objectcomponents"),systemcomponents_1=require("../../systemcomponents/systemcomponents"),services_1=require("../../services/services"),platform_browser_1=require("@angular/platform-browser"),router_1=require("@angular/router"),rxjs_1=require("rxjs"),EmailToObjectEmailText=function(){function e(e,t,s,i){this.elementRef=e,this.renderer=t,this.language=s,this.metadata=i,this.text="",this.html="",this.target_module_name="",this.target_module_fields=[],this.setfield=new core_1.EventEmitter,this.clickListener=null,this.displayContextMenu=!1,this.displayContextCoordinates={top:0,left:0}}return Object.defineProperty(e.prototype,"content",{get:function(){return this.html||this.text},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"striped_content",{get:function(){return this._striped_content||(this.html?this._striped_content=this.html.replace(/<!--.*?-->/gs,"").replace(/<[^>]+>/g,"").replace(/[ ]{2,}/g," ").replace(/[\n\r]{3,}/g,"\n"):this._striped_content=this.text,this._striped_content)},enumerable:!1,configurable:!0}),e.prototype.ngOnInit=function(){if(!this.target_module_fields||0===this.target_module_fields.length){var e,t=["varchar","text"],s=this.metadata.getModuleFields(this.target_module_name);for(e in s)0<=t.indexOf(s[e].type)&&s[e].vname&&"id"!==s[e].name&&this.target_module_fields.push(e)}},e.prototype.ngOnDestroy=function(){this.clickListener&&this.clickListener()},e.prototype.showContextMenu=function(e){var t=this;this.selectedText&&(e.preventDefault(),this.displayContextMenu=!0,this.displayContextCoordinates.top=e.clientY,this.displayContextCoordinates.left=e.clientX,this.clickListener=this.renderer.listen("document","click",function(e){return t.onClick(e)}))},Object.defineProperty(e.prototype,"selectedText",{get:function(){var e=window.getSelection().toString();return e?e.trim():""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"contextMenuStyle",{get:function(){var e=this.elementRef.nativeElement.getBoundingClientRect();return{top:this.displayContextCoordinates.top-e.top+"px",left:this.displayContextCoordinates.left-e.left+"px"}},enumerable:!1,configurable:!0}),e.prototype.onClick=function(e){this.contextMenu.element.nativeElement.contains(e.target)||(this.displayContextMenu=!1,this.clickListener&&(this.clickListener(),this.clickListener=null))},e.prototype.setField=function(e){this.displayContextMenu=!1,this.clickListener&&(this.clickListener(),this.clickListener=null),this.setfield.emit({field:e,value:this.selectedText})},__decorate([core_1.ViewChild("contextMenu",{read:core_1.ViewContainerRef,static:!0}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"contextMenu",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"text",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"html",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"target_module_name",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"target_module_fields",void 0),__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"setfield",void 0),__decorate([core_1.Component({selector:"email-to-object-emailtext",template:'<div class="slds-form-element slds-is-relative" style="height: 100%;"><textarea class="slds-input" style="height: 100%; width: 100%; resize: none;" (contextmenu)="showContextMenu($event)">{{striped_content}}</textarea><div #contextMenu *ngIf="displayContextMenu" [ngStyle]="contextMenuStyle" class="slds-dropdown slds-dropdown_left slds-is-absolute"><ul class="slds-dropdown__list" role="menu"><li *ngFor="let field of target_module_fields" class="slds-dropdown__item" role="presentation"><a href="javascript:void(0);" role="menuitem" tabindex="0" (click)="setField(field)"><span class="slds-truncate"><system-label-fieldname [module]="target_module_name" [field]="field"></system-label-fieldname></span></a></li></ul></div></div>'}),__metadata("design:paramtypes",[core_1.ElementRef,core_1.Renderer2,services_1.language,services_1.metadata])],e)}();exports.EmailToObjectEmailText=EmailToObjectEmailText;var EmailToObjectModal=function(){function EmailToObjectModal(e,t,s,i,l){this.language=e,this.metadata=t,this.view=s,this.model=i,this.backend=l,this.email_model=null,this.self=null,this.componentRefs=[],this.save$=new core_1.EventEmitter,this.object_fields=[]}return EmailToObjectModal.prototype.ngOnInit=function(){if(this.model.module=this.object_module_name,this.model.initializeModel(this.email_model),this.object_predefined_fields)for(var e in this.object_predefined_fields)this.model.data[e]=this.object_predefined_fields[e];this.view.isEditable=!0,this.view.setEditMode()},EmailToObjectModal.prototype.ngAfterViewInit=function(){this.buildContainer()},EmailToObjectModal.prototype.close=function(){this.self.destroy()},EmailToObjectModal.prototype.buildContainer=function(){for(var s=this,e=0,t=this.componentRefs;e<t.length;e++)t[e].destroy();this.componentRefs=[];for(var i=this.metadata.getComponentConfig("ObjectRecordDetails",this.model.module),l=this,a=0,o=this.metadata.getComponentSetObjects(i.componentset);a<o.length;a++)!function(t){l.metadata.addComponent(t.component,l.detailcontainer).subscribe(function(e){e.instance.componentconfig=t.componentconfig,s.componentRefs.push(e)})}(o[a])},EmailToObjectModal.prototype.setField=function(e){this.model.setField(e.field,e.value)},EmailToObjectModal.prototype.save=function(){var t=this;this.model.validate()&&this.model.save().subscribe(function(e){t.object_relation_link_name?t.backend.postRequest("module/Emails/"+t.email_model.id+"/related/"+t.object_relation_link_name,[],[t.model.id]).subscribe(function(e){t.save$.emit(t.model.data),t.close()}):(t.save$.emit(t.model.data),t.close())})},__decorate([core_1.ViewChild("detailcontainer",{read:core_1.ViewContainerRef,static:!0}),__metadata("design:type",core_1.ViewContainerRef)],EmailToObjectModal.prototype,"detailcontainer",void 0),__decorate([core_1.Output(),__metadata("design:type",Object)],EmailToObjectModal.prototype,"save$",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],EmailToObjectModal.prototype,"object_module_name",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],EmailToObjectModal.prototype,"object_fields",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],EmailToObjectModal.prototype,"object_relation_link_name",void 0),__decorate([core_1.Input(),__metadata("design:type",Array)],EmailToObjectModal.prototype,"object_predefined_fields",void 0),__decorate([core_1.Component({selector:"email-to-object-modal",template:'<div role="dialog" tabindex="-1" class="slds-modal slds-modal_large slds-fade-in-open"><div class="slds-modal__container"><div class="slds-modal__header"><button class="slds-button slds-modal__close slds-button--icon-inverse" title="Close" (click)="close()"><system-button-icon [icon]="\'close\'"></system-button-icon></button><h2 class="slds-text-heading--medium"><system-label-modulename [module]="object_module_name" [singular]="true"></system-label-modulename></h2></div><div class="slds-modal__content"><div class="slds-grid" style="height: 80vh;"><div class="slds-size--1-of-2 slds-p-around--small" style="height: 100%;"><email-to-object-emailtext [target_module_name]="object_module_name" [text]="email_model.data.body" [html]="email_model.data.body" [target_module_fields]="object_fields" (setfield)="setField($event)"></email-to-object-emailtext></div><div class="slds-size--1-of-2 slds-scrollable" style="height: 100%;"><div #detailcontainer></div></div></div></div><div class="slds-modal__footer"><button class="slds-button slds-button--neutral" (click)="close()"><system-label label="LBL_CANCEL"></system-label></button> <button class="slds-button slds-button--brand" (click)="save()"><system-label label="LBL_SAVE"></system-label></button></div></div></div><div class="slds-backdrop slds-backdrop--open"></div>',providers:[services_1.model,services_1.view]}),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.view,services_1.model,services_1.backend])],EmailToObjectModal)}();exports.EmailToObjectModal=EmailToObjectModal;var EmailToObjectButton=function(){function EmailToObjectButton(e,t,s,i,l){this.language=e,this.model=t,this.metadata=s,this.modal=i,this.relatedmodels=l,this.actionemitter=new core_1.EventEmitter}return Object.defineProperty(EmailToObjectButton.prototype,"disabled",{get:function(){if(!this.metadata.checkModuleAcl(this.actionconfig.module,"create"))return!0;if(this.actionconfig.checklink){if(this.relatedmodels.isloading)return!0;if(0<this.relatedmodels.count)return!0}return!1},enumerable:!1,configurable:!0}),EmailToObjectButton.prototype.ngOnInit=function(){this.object_module_name=this.actionconfig.module,this.actionconfig.checklink&&this.subscribeToModel()},EmailToObjectButton.prototype.subscribeToModel=function(){var t=this;this.subscription=this.model.data$.subscribe(function(e){t.getRelatedData()})},EmailToObjectButton.prototype.ngOnDestroy=function(){var e;null!==(e=this.subscription)&&void 0!==e&&e.unsubscribe()},EmailToObjectButton.prototype.getRelatedData=function(){this.relatedmodels.module=this.model.module,this.relatedmodels.id=this.model.id,this.relatedmodels.relatedModule=this.actionconfig.module,this.relatedmodels.linkName=this.actionconfig.checklink,this.relatedmodels.getData()},EmailToObjectButton.prototype.execute=function(){var t=this;this.modal.openModal("EmailToObjectModal",!0).subscribe(function(e){e.instance.email_model=t.model,e.instance.object_module_name=t.object_module_name,e.instance.object_relation_link_name=t.actionconfig.relation_link_name,e.instance.object_predefined_fields=t.actionconfig.predefined_fields,e.instance.save$.subscribe(function(e){t.actionemitter.emit("save")})})},__decorate([core_1.Output(),__metadata("design:type",Object)],EmailToObjectButton.prototype,"actionemitter",void 0),__decorate([core_1.Component({selector:"email-to-object-button",template:'<span><system-label label="LBL_CONVERT_TO"></system-label> <system-label-modulename [module]="object_module_name" [singular]="true"></system-label-modulename></span>',providers:[services_1.relatedmodels]}),__metadata("design:paramtypes",[services_1.language,services_1.model,services_1.metadata,services_1.modal,services_1.relatedmodels])],EmailToObjectButton)}();exports.EmailToObjectButton=EmailToObjectButton;var EmailPreviewModal=function(){function EmailPreviewModal(e,t,s,i,l,a,o){this.language=e,this.metadata=t,this.sanitizer=s,this.backend=i,this.model=l,this.view=a,this.modelattachments=o,this.self={},this.type="",this.name="",this.isLoading=!0,this.model.module="Emails";o=this.metadata.getComponentConfig("EmailPreviewModal",this.model.module);this.fieldset=o.fieldset}return EmailPreviewModal.prototype.closeModal=function(){this.self.destroy()},EmailPreviewModal.prototype.ngOnInit=function(){var t=this;this.backend.getRequest("module/Emails/msg/"+this.file.id).subscribe(function(e){t.model.setFields(t.model.utils.backendModel2spice("Emails",e)),t.isLoading=!1})},EmailPreviewModal.prototype.download=function(){this.modelattachments.downloadAttachment(this.file.id,this.file.filename)},__decorate([core_1.Input(),__metadata("design:type",String)],EmailPreviewModal.prototype,"type",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],EmailPreviewModal.prototype,"name",void 0),__decorate([core_1.Component({template:'<system-modal size="large"><system-modal-header (close)="closeModal()"><system-label label="LBL_EMAIL"></system-label> <span *ngIf="!isLoading" class="slds-truncate">"{{model.data.name}}"</span></system-modal-header><system-modal-content margin="none"><div *ngIf="isLoading" style="height: 50vh;" class="slds-align--absolute-center"><div class="slds-grid_vertical"><system-spinner></system-spinner><div class="slds-p-around--small">... <system-label label="LBL_LOADING"></system-label> ...</div></div></div><object-record-fieldset *ngIf="!isLoading" [fieldset]="fieldset" direction="vertical"></object-record-fieldset></system-modal-content><system-modal-footer><button class="slds-button slds-button--icon slds-button--icon-border" [disabled]="isLoading" (click)="download()"><system-button-icon icon="download" size="small"></system-button-icon></button></system-modal-footer></system-modal>',providers:[services_1.model,services_1.view]}),__metadata("design:paramtypes",[services_1.language,services_1.metadata,platform_browser_1.DomSanitizer,services_1.backend,services_1.model,services_1.view,services_1.modelattachments])],EmailPreviewModal)}();exports.EmailPreviewModal=EmailPreviewModal;var EmailMSGPreviewModal=function(){function e(e,t,s){this.language=e,this.sanitizer=t,this.libloader=s,this.self={},this.type="",this.name="",this.libsloaded=!1}return e.prototype.closeModal=function(){this.self.destroy()},Object.defineProperty(e.prototype,"data",{set:function(e){this.libloader.loadLib("msgreader").subscribe(function(e){})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subject",{get:function(){return this.msgData?this.msgData.subject:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"body",{get:function(){return this.msgData?this.sanitizer.bypassSecurityTrustHtml(this.msgData.body.replace(/\n/g,"<br/>")):""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"objecttype",{get:function(){if(!this.type)return"";var e=this.type.split("/");switch(e[0]){case"audio":case"video":return e[0];default:return"object"}},enumerable:!1,configurable:!0}),e.prototype.download=function(){var e=document.createElement("a");document.body.appendChild(e),e.href=this.blobUrl,e.download=this.name,e.click(),e.remove()},e.prototype.datatoBlob=function(e,t,s){void 0===t&&(t=""),void 0===s&&(s=512);for(var i=[],l=0;l<e.length;l+=s){for(var a=e.slice(l,l+s),o=new Array(a.length),n=0;n<a.length;n++)o[n]=a.charCodeAt(n);var d=new Uint8Array(o);i.push(d)}return new Blob(i,{type:t})},__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"type",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"name",void 0),__decorate([core_1.Component({template:'<system-modal size="large"><system-modal-header (close)="closeModal()">Email Preview</system-modal-header><system-modal-content margin="none" [grow]="true"><div *ngIf="!msgData" style="height: 50vh;" class="slds-align--absolute-center"><system-spinner></system-spinner></div><div *ngIf="msgData" class="slds-p-around--small slds-text-align--center"><div>subject: {{subject}}</div><div [innerHTML]="body"></div></div></system-modal-content></system-modal>'}),__metadata("design:paramtypes",[services_1.language,platform_browser_1.DomSanitizer,services_1.libloader])],e)}();exports.EmailMSGPreviewModal=EmailMSGPreviewModal;var EmailsPopoverBody=function(){function EmailsPopoverBody(e,t,s){this.model=e,this.language=t,this.sanitized=s,this.fullValue=""}return Object.defineProperty(EmailsPopoverBody.prototype,"emailbody",{get:function(){return this.model.getFieldValue("body")},enumerable:!1,configurable:!0}),Object.defineProperty(EmailsPopoverBody.prototype,"sanitizedValue",{get:function(){return this.emailbody&&(this.emailbody.includes("</html>")?this.fullValue=this.emailbody:this.fullValue='<html><body class="spice">'+this.emailbody+"</body></html>"),this.fullValue!=this.fullValue_cached&&(this._sanitizedValue=this.sanitized.bypassSecurityTrustResourceUrl(this.fullValue?"data:text/html;charset=UTF-8,"+encodeURIComponent(this.fullValue):""),this.fullValue_cached=this.fullValue),this._sanitizedValue},enumerable:!1,configurable:!0}),__decorate([core_1.Component({template:'<iframe style="height: 400px;" [src]="sanitizedValue" width="100%" frameborder="0" seamless></iframe>'}),__metadata("design:paramtypes",[services_1.model,services_1.language,platform_browser_1.DomSanitizer])],EmailsPopoverBody)}();exports.EmailsPopoverBody=EmailsPopoverBody;var fieldEmailStatus=function(o){function fieldEmailStatus(e,t,s,i,l){var a=o.call(this,e,t,s,i,l)||this;return a.model=e,a.view=t,a.language=s,a.metadata=i,a.router=l,a}return __extends(fieldEmailStatus,o),Object.defineProperty(fieldEmailStatus.prototype,"statusicon",{get:function(){switch(this.value){case"opened":case"read":return"email_open";case"bounced":case"deferred":case"send_error":return"error";case"sent":return"send";default:return"email"}},enumerable:!1,configurable:!0}),__decorate([core_1.Component({template:'<field-label *ngIf="displayLabel" [fieldname]="fieldname" [fieldconfig]="fieldconfig"></field-label><field-generic-display [fielddisplayclass]="fielddisplayclass" [editable]="false" [fieldconfig]="fieldconfig" [fieldid]="fieldid"><system-utility-icon [title]="value" size="x-small" [icon]="statusicon"></system-utility-icon></field-generic-display>'}),__metadata("design:paramtypes",[services_1.model,services_1.view,services_1.language,services_1.metadata,router_1.Router])],fieldEmailStatus)}(objectfields_1.fieldGeneric);exports.fieldEmailStatus=fieldEmailStatus;var EmailReplyButton=function(){function EmailReplyButton(e,t,s,i){this.injector=e,this.model=t,this.metadata=s,this.modal=i}return Object.defineProperty(EmailReplyButton.prototype,"disabled",{get:function(){return!this.metadata.checkModuleAcl("Emails","create")},enumerable:!1,configurable:!0}),EmailReplyButton.prototype.execute=function(){this.modal.openModal("EmailReplyModal",!0,this.injector)},__decorate([core_1.Component({selector:"email-reply-button",template:'<span><system-label label="LBL_EMAIL_REPLY"></system-label></span>'}),__metadata("design:paramtypes",[core_1.Injector,services_1.model,services_1.metadata,services_1.modal])],EmailReplyButton)}();exports.EmailReplyButton=EmailReplyButton;var EmailReplyModal=function(){function EmailReplyModal(e,t,s,i,l,a,o,n,d,r){this.language=e,this.metadata=t,this.model=s,this.parent=i,this.view=l,this.prefs=a,this.modal=o,this.session=n,this.userpreferences=d,this.dockedcomposer=r,this.self=null,this.sending=!1,this.titlelabel="LBL_EMAIL_REPLY",this.mode="reply",this.mailsent=new core_1.EventEmitter,this.componentconfig={},this.model.module="Emails",this.view.isEditable=!0,this.view.setEditMode(),this.componentconfig=this.metadata.getComponentConfig("EmailReplyModal",this.model.module)}return EmailReplyModal.prototype.ngOnInit=function(){this.model.initializeModel(this.parent),this.model.startEdit(!1),this.model.data.recipient_addresses=[],this.model.data.reference_id=this.parent.id;for(var e=0,t=this.parent.data.recipient_addresses;e<t.length;e++){var s,i=t[e];"from"==i.address_type?((s=__assign({},i)).address_type="to",s.id="",this.model.data.recipient_addresses.push(s)):"from"!=i.address_type&&"to"!=i.address_type&&((i=__assign({},i)).id="",this.model.data.recipient_addresses.push(i))}this.model.setFields({name:this.language.getLabel("LBL_RE")+this.parent.getField("name"),body:"<br><br><br>"+this.buildHistoryText()})},EmailReplyModal.prototype.buildHistoryText=function(){var e=new moment.utc(this.parent.data.date_sent).tz(this.session.getSessionData("timezone")||moment.tz.guess(!0)),t=e?e.format(this.userpreferences.getDateFormat()):"",s=e?e.format(this.userpreferences.getTimeFormat()):"",e="";return e+="<div class='spicecrm_quote'>",e+="<div dir='ltr' class='crm_attr'>",e+="<b>"+this.language.getLabel("LBL_FROM")+":</b> <a href='mailto:"+this.parent.data.from_addr+"'>"+this.parent.data.from_addr+"</a>",e+="<br>",e+="<b>"+this.language.getLabel("LBL_DATE_SENT")+":</b> "+t+" "+s,e+="<br>",e+="<b>"+this.language.getLabel("LBL_TO")+":</b> "+this.parent.data.to_addrs,e+="<br>",e+="<b>"+this.language.getLabel("LBL_SUBJECT")+":</b> "+this.parent.data.name,e+="<br><br>",e+="</div>",e+='<blockquote class="crm_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex">',e+=this.parent.data.body.replace('data-signature=""',""),e+="</blockquote>",e+="</div>"},Object.defineProperty(EmailReplyModal.prototype,"isDisabled",{get:function(){var e=this.model.getFieldValue("recipient_addresses"),t=this.model.getFieldValue("mailbox_id"),s=this.model.getFieldValue("name"),i=this.model.getFieldValue("body"),l=e?e.find(function(e){return"to"==e.address_type}):void 0;return!(s&&i&&t&&e&&l)||this.sending},enumerable:!1,configurable:!0}),EmailReplyModal.prototype.close=function(){this.self.destroy()},EmailReplyModal.prototype.dock=function(){this.dockedcomposer.addComposer(this.model.module,this.model),this.close()},EmailReplyModal.prototype.sendEmail=function(){var s=this;this.modal.openModal("SystemLoadingModal",!1).subscribe(function(t){t.instance.messagelabel="LBL_SENDING",s.sending=!0,s.model.setFields({type:"outbound",to_be_sent:"1",from_addr:s.model.data.from_addr_name,to_addrs:s.model.data.to_addrs_names,cc_addrs:s.model.data.cc_addrs_names}),s.model.save().subscribe(function(e){t.instance.self.destroy(),s.mailsent.emit(!0),s.close()},function(e){t.instance.self.destroy(),s.sending=!1})})},EmailReplyModal.prototype.handleaction=function(e){this.close()},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],EmailReplyModal.prototype,"mailsent",void 0),__decorate([core_1.Component({selector:"email-reply-modal",template:'<system-modal size="large"><system-modal-header module="Emails" (close)="close()"><system-label [label]="titlelabel"></system-label><system-modal-header-right><button class="slds-button slds-button_icon" (click)="dock()" [title]="language.getLabel(\'LBL_DOCK\')"><system-button-icon icon="dock_panel"></system-button-icon><span class="slds-assistive-text"><system-label label="LBL_DOCK"></system-label></span></button></system-modal-header-right></system-modal-header><system-modal-content><system-componentset [componentset]="componentconfig.componentset"></system-componentset></system-modal-content><system-modal-footer><div class="slds-text-align_right"><object-action-container containerclass [actionset]="componentconfig.actionset" (actionemitter)="handleaction($event)"></object-action-container></div></system-modal-footer></system-modal>',providers:[services_1.view,services_1.model]}),__param(3,core_1.SkipSelf()),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.model,services_1.model,services_1.view,services_1.userpreferences,services_1.modal,services_1.session,services_1.userpreferences,services_1.dockedComposer])],EmailReplyModal)}();exports.EmailReplyModal=EmailReplyModal;var EmailForwardButton=function(){function EmailForwardButton(e,t,s,i){this.injector=e,this.model=t,this.metadata=s,this.modal=i}return Object.defineProperty(EmailForwardButton.prototype,"disabled",{get:function(){return!this.metadata.checkModuleAcl("Emails","create")},enumerable:!1,configurable:!0}),EmailForwardButton.prototype.execute=function(){this.modal.openModal("EmailForwardModal",!0,this.injector)},__decorate([core_1.Component({template:'<span><system-label label="LBL_EMAIL_FORWARD"></system-label></span>'}),__metadata("design:paramtypes",[core_1.Injector,services_1.model,services_1.metadata,services_1.modal])],EmailForwardButton)}();exports.EmailForwardButton=EmailForwardButton;var EmailForwardModal=function(p){function EmailForwardModal(e,t,s,i,l,a,o,n,d,r,c,m){var u=p.call(this,e,t,s,i,l,a,o,n,d,r)||this;return u.language=e,u.metadata=t,u.model=s,u.parent=i,u.view=l,u.prefs=a,u.modal=o,u.session=n,u.userpreferences=d,u.dockedcomposer=r,u.modelattachments=c,u.backend=m,u.titlelabel="LBL_EMAIL_FORWARD",u}return __extends(EmailForwardModal,p),EmailForwardModal.prototype.ngOnInit=function(){this.model.initializeModel(this.parent),this.model.startEdit(!1),this.model.data.recipient_addresses=[],this.model.data.reference_id=this.parent.id,this.model.setFields({name:this.language.getLabel("LBL_FW")+this.parent.getField("name"),body:"<br><br><br>"+this.buildHistoryText()}),this.loadParentAttachments()},EmailForwardModal.prototype.loadParentAttachments=function(){this.modelattachments.module="Emails",this.modelattachments.id=this.model.id,this.modelattachments.cloneAttachments(this.parent)},__decorate([core_1.Component({template:'<system-modal size="large"><system-modal-header module="Emails" (close)="close()"><system-label [label]="titlelabel"></system-label><system-modal-header-right><button class="slds-button slds-button_icon" (click)="dock()" [title]="language.getLabel(\'LBL_DOCK\')"><system-button-icon icon="dock_panel"></system-button-icon><span class="slds-assistive-text"><system-label label="LBL_DOCK"></system-label></span></button></system-modal-header-right></system-modal-header><system-modal-content><system-componentset [componentset]="componentconfig.componentset"></system-componentset></system-modal-content><system-modal-footer><div class="slds-text-align_right"><object-action-container containerclass [actionset]="componentconfig.actionset" (actionemitter)="handleaction($event)"></object-action-container></div></system-modal-footer></system-modal>',providers:[services_1.view,services_1.model,services_1.modelattachments]}),__param(3,core_1.SkipSelf()),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.model,services_1.model,services_1.view,services_1.userpreferences,services_1.modal,services_1.session,services_1.userpreferences,services_1.dockedComposer,services_1.modelattachments,services_1.backend])],EmailForwardModal)}(EmailReplyModal);exports.EmailForwardModal=EmailForwardModal;var EmailSendButton=function(){function EmailSendButton(e,t,s){this.model=e,this.metadata=t,this.modal=s,this.actionemitter=new core_1.EventEmitter,this.sending=!1}return Object.defineProperty(EmailSendButton.prototype,"disabled",{get:function(){var e=this.model.getFieldValue("recipient_addresses"),t=this.model.getFieldValue("mailbox_id"),s=this.model.getFieldValue("name"),i=this.model.getFieldValue("body"),l=e?e.find(function(e){return"to"==e.address_type}):void 0;return!(s&&i&&t&&e&&l)||this.sending},enumerable:!1,configurable:!0}),EmailSendButton.prototype.execute=function(){var s=this;this.modal.openModal("SystemLoadingModal",!1).subscribe(function(t){t.instance.messagelabel="LBL_SENDING",s.sending=!0,s.model.setField("type","out"),s.model.setField("to_be_sent",!0),s.model.setField("from_addr",s.model.data.from_addr_name),s.model.setField("to_addrs",s.model.data.to_addrs_names),s.model.setField("cc_addrs",s.model.data.cc_addrs_names),s.model.save().subscribe(function(e){t.instance.self.destroy(),s.actionemitter.emit("emailsent")},function(e){t.instance.self.destroy(),s.sending=!1})})},__decorate([core_1.Output(),__metadata("design:type",Object)],EmailSendButton.prototype,"actionemitter",void 0),__decorate([core_1.Component({selector:"email-send-button",template:'<span><system-label label="LBL_SEND"></system-label></span>'}),__metadata("design:paramtypes",[services_1.model,services_1.metadata,services_1.modal])],EmailSendButton)}();exports.EmailSendButton=EmailSendButton;var EmailSchedulesButton=function(){function EmailSchedulesButton(e,t,s,i,l,a,o){this.language=e,this.metadata=t,this.model=s,this.modellist=i,this.modal=l,this.injector=a,this.toast=o,this.hidden=!0}return EmailSchedulesButton.prototype.ngOnInit=function(){this.findEmailsLink()},Object.defineProperty(EmailSchedulesButton.prototype,"disabled",{get:function(){return 0==this.modellist.getSelectedCount()},enumerable:!1,configurable:!0}),Object.defineProperty(EmailSchedulesButton.prototype,"exportcount",{get:function(){var e=this.modellist.getSelectedCount();return e||this.modellist.listData.totalcount},enumerable:!1,configurable:!0}),EmailSchedulesButton.prototype.findEmailsLink=function(){if(this.metadata.checkModuleAcl("EmailSchedules","create")){var e,t=this.metadata.getModuleFields(this.model.module);for(e in t){var s=t[e];("emails"==e||"link"==s.type&&"Emails"==s.module)&&(this.hidden=!1)}}},EmailSchedulesButton.prototype.execute=function(){this.model.fields.hasOwnProperty("emails")?this.modal.openModal("EmailSchedulesModal",!0,this.injector):this.toast.sendToast(this.language.getLabel("LBL_ERROR"),"error")},__decorate([core_1.Component({selector:"email-schedules-button",template:'<span><system-label label="LBL_EMAIL_SCHEDULE"></system-label><span>({{exportcount}})</span></span>'}),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.model,services_1.modellist,services_1.modal,core_1.Injector,services_1.toast])],EmailSchedulesButton)}();exports.EmailSchedulesButton=EmailSchedulesButton;var EmailSchedulesModal=function(){function EmailSchedulesModal(e,t,s,i,l,a,o,n,d,r){this.language=e,this.model=t,this.parentModel=s,this.injector=i,this.view=l,this.modal=a,this.metadata=o,this.modellist=n,this.backend=d,this.toast=r,this.self={},this.view.isEditable=!0,this.view.setEditMode()}return EmailSchedulesModal.prototype.ngOnInit=function(){this.model.module="EmailSchedules",this.model.initialize(this.parentModel),this.model.data.parent_id=this.parentModel.id,this.model.data.parent_type=this.parentModel.module,this.model.startEdit(!1)},EmailSchedulesModal.prototype.close=function(){this.self.destroy()},Object.defineProperty(EmailSchedulesModal.prototype,"canSave",{get:function(){return this.model.getField("mailbox_id")&&this.model.getField("email_subject")&&this.model.getField("email_body")},enumerable:!1,configurable:!0}),EmailSchedulesModal.prototype.saveSchedule=function(){var s=this;this.modal.openModal("SystemLoadingModal").subscribe(function(t){t.instance.messagelabel="LBL_LOADING";var e=s.modellist.getSelectedIDs(),e={module:s.modellist.module,ids:e,data:s.model.data,modulefilter:s.modellist.modulefilter,searchterm:s.modellist.searchTerm,aggregates:s.modellist.selectedAggregates};s.backend.postRequest("module/EmailSchedules/"+s.model.id,{},e).subscribe(function(e){t.instance.self.destroy(),e.status?(s.toast.sendToast(s.language.getLabel("MSG_SUCCESSFULLY_EXECUTED"),"success"),s.close()):s.toast.sendToast(s.language.getLabel("LBL_ERROR"),"error")})})},__decorate([core_1.Component({selector:"email-schedules-modal",template:'<system-modal title="LBL_EMAIL_SCHEDULES"><system-modal-header (close)="close()"><system-label label="LBL_EMAIL_SCHEDULE"></system-label></system-modal-header><system-modal-content margin="none" [grow]="true"><system-dynamic-component component="CampaignTaskEmailPanel"></system-dynamic-component><system-dynamic-component component="SpiceAttachmentsPanel"></system-dynamic-component></system-modal-content><system-modal-footer><button class="slds-button slds-button--brand" [disabled]="!canSave" (click)="saveSchedule()"><system-label label="LBL_EMAIL_SCHEDULE"></system-label></button></system-modal-footer></system-modal>',providers:[services_1.model,services_1.view]}),__param(2,core_1.SkipSelf()),__metadata("design:paramtypes",[services_1.language,services_1.model,services_1.model,core_1.Injector,services_1.view,services_1.modal,services_1.metadata,services_1.modellist,services_1.backend,services_1.toast])],EmailSchedulesModal)}();exports.EmailSchedulesModal=EmailSchedulesModal;var EmailSchedulesRelatedButton=function(){function EmailSchedulesRelatedButton(e,t,s,i,l,a,o){this.language=e,this.metadata=t,this.model=s,this.modal=i,this.injector=l,this.backend=a,this.toast=o,this.linkedBeans=[]}return EmailSchedulesRelatedButton.prototype.execute=function(){var t=this,s=this.modal.await(this.language.getLabel("LBL_LOADING"));this.checkEmailsLink().subscribe(function(e){s.emit(!0),e&&t.modal.openModal("EmailSchedulesRelatedModal",!0,t.injector).subscribe(function(e){e.instance.linkedBeans=t.linkedBeans,e.instance.modelId=t.modelId,e.instance.currentModule=t.model.module})})},EmailSchedulesRelatedButton.prototype.checkEmailsLink=function(){var i=this,s=new rxjs_1.Subject,l=[];Object.keys(this.model.fields).forEach(function(e){if("link"==i.model.fields[e].type&&i.model.fields[e].hasOwnProperty("vname")&&!i.model.fields[e].hasOwnProperty("link_type")){var t,s=i.model.fields[e].name;for(t in i.metadata.fieldDefs)t.toLowerCase()==s&&l.push(t)}});var e,a=[],o=this;for(e in l)!function(e){var t=l[e];Object.keys(o.metadata.fieldDefs).forEach(function(e){null!=i.metadata.fieldDefs[e]&&e==t&&i.metadata.fieldDefs[e].hasOwnProperty("email")&&i.metadata.fieldDefs[e].hasOwnProperty("email1")&&a.push(t)})}(e);return this.backend.getRequest("module/EmailSchedules/"+this.model.module+"/"+this.model.id,{modules:a}).subscribe(function(e){for(var t in e.status?(i.linkedBeans=e.linkedBeans,i.modelId=e.beanId,s.next(e.status)):(s.next(!1),i.toast.sendToast(i.language.getLabel("LBL_ERROR"),"error")),i.linkedBeans){t=i.linkedBeans[t];t.vname=i.model.fields[t.link].vname}s.complete()}),s.asObservable()},__decorate([core_1.Component({selector:"email-schedules-related-button",template:'<span><system-label label="LBL_EMAIL_SCHEDULE"></system-label></span>'}),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.model,services_1.modal,core_1.Injector,services_1.backend,services_1.toast])],EmailSchedulesRelatedButton)}();exports.EmailSchedulesRelatedButton=EmailSchedulesRelatedButton;var EmailSchedulesRelatedModal=function(){function EmailSchedulesRelatedModal(e,t,s,i,l,a,o,n,d){this.language=e,this.model=t,this.parentModel=s,this.injector=i,this.view=l,this.modal=a,this.metadata=o,this.backend=n,this.toast=d,this.self={},this.activetab="recipients",this.linkedBeans=[],this.view.isEditable=!0,this.view.setEditMode()}return EmailSchedulesRelatedModal.prototype.ngOnInit=function(){this.model.module="EmailSchedules",this.model.initialize(this.parentModel),this.model.data.parent_id=this.parentModel.id,this.model.data.parent_type=this.parentModel.module,this.model.startEdit(!1),this.fiilterProspects()},EmailSchedulesRelatedModal.prototype.fiilterProspects=function(){this.linkedBeans=this.linkedBeans.map(function(e){return e.disabled=0==e.count,e.selected=!1,e})},EmailSchedulesRelatedModal.prototype.close=function(){this.self.destroy()},EmailSchedulesRelatedModal.prototype.saveSchedule=function(){var a=this;this.modal.openModal("SystemLoadingModal").subscribe(function(t){t.instance.messagelabel="LBL_LOADING";var e=a.linkedBeans.filter(function(e){return e.selected}).map(function(e){return e.module}),s={links:e,data:a.model.data},i=s.data.hasOwnProperty("mailbox_id"),l=s.data.hasOwnProperty("email_subject"),e=0<e.length;i&&l&&e?a.backend.postRequest("module/EmailSchedules/"+a.model.id+"/"+a.parentModel.module+"/"+a.parentModel.id,{},s).subscribe(function(e){t.instance.self.destroy(),e.status?(a.toast.sendToast(a.language.getLabel("MSG_SUCCESSFULLY_EXECUTED"),"success"),a.close()):a.toast.sendToast(a.language.getLabel("LBL_ERROR"),"error")}):(t.instance.self.destroy(),s="Following errors occured: ",i||(s+="Mailbox field is emtpy "),l||(s+="Email subject is missing "),e||(s+="No recipients selected "),a.toast.sendAlert(s,"warning"))})},__decorate([core_1.Component({selector:"email-schedules-related-modal",template:'<system-modal title="LBL_EMAIL_SCHEDULES"><system-modal-header (close)="close()"><system-label label="LBL_EMAIL_SCHEDULE"></system-label></system-modal-header><system-modal-content [grow]="true"><div class="slds-tabs_scoped"><ul class="slds-tabs_scoped__nav" role="tablist"><li class="slds-tabs_scoped__item" title="Emails" role="presentation" [ngClass]="{\'slds-is-active\': activetab==\'emails\'}"><a class="slds-tabs_scoped__link" href="javascript:void(0);" role="tab" (click)="activetab=\'emails\'">{{this.language.getLabel(\'LBL_EMAILS\')}}</a></li><li class="slds-tabs_scoped__item" title="Recipients" role="presentation" [ngClass]="{\'slds-is-active\': activetab==\'recipients\'}"><a class="slds-tabs_scoped__link" href="javascript:void(0);" role="tab" (click)="activetab=\'recipients\'">{{this.language.getLabel(\'LBL_RECIPIENTS\')}}</a></li></ul><div class="slds-tabs_scoped__content" [ngClass]="{\'slds-hide\': activetab!=\'emails\'}" role="tabpanel"><system-dynamic-component component="CampaignTaskEmailPanel"></system-dynamic-component><system-dynamic-component component="SpiceAttachmentsPanel"></system-dynamic-component></div><div class="slds-tabs_scoped__content" [ngClass]="{\'slds-hide\': activetab!=\'recipients\'}" role="tabpanel"><table class="slds-table slds-table_bordered slds-table_cell-buffer"><thead><tr class="slds-text-title_caps"><th scope="col" class="slds-resizable"><div class="slds-truncate"><system-label label="LBL_LINK"></system-label></div></th><th scope="col" class="slds-resizable"><div class="slds-truncate"><system-label label="LBL_COUNT"></system-label></div></th></tr></thead><tbody><tr *ngFor="let link of linkedBeans" [class.slds-disabled-text]="link.disabled"><td><div class="slds-grid slds-grid--vertical-align-center slds-p-around--xx-small"><system-checkbox [disabled]="link.disabled" [(ngModel)]="link.selected"></system-checkbox><div class="slds-truncate"><system-icon [addclasses]="link.disabled ? \'slds-icon_disabled\' : null" [size]="\'small\'" [module]="link.module"></system-icon></div><div class="slds-truncate"><system-label [label]="link.vname"></system-label></div></div></td><td><div class="slds-grid slds-grid--vertical-align-center slds-p-around--xx-small"><div class="slds-truncate">{{link.count}}</div></div></td></tr></tbody></table></div></div></system-modal-content><system-modal-footer><button (click)="saveSchedule()" class="slds-button slds-button--brand"><system-label label="LBL_EMAIL_SCHEDULE"></system-label></button></system-modal-footer></system-modal>',providers:[services_1.model,services_1.view]}),__param(2,core_1.SkipSelf()),__metadata("design:paramtypes",[services_1.language,services_1.model,services_1.model,core_1.Injector,services_1.view,services_1.modal,services_1.metadata,services_1.backend,services_1.toast])],EmailSchedulesRelatedModal)}();exports.EmailSchedulesRelatedModal=EmailSchedulesRelatedModal;var EmailSchedulesView=function(){function EmailSchedulesView(e,t,s,i,l){this.language=e,this.model=t,this.view=s,this.metadata=i,this.backend=l,this.emailschedules=[],this.locked=!1,this.isLoading=!1,this.getData()}return EmailSchedulesView.prototype.refresh=function(){this.getData()},EmailSchedulesView.prototype.getData=function(){var t=this;this.isLoading=!0,this.backend.getRequest("module/EmailSchedules/myopen/"+this.model.id).subscribe(function(e){e.status?(t.isLoading=!1,t.emailschedules=e.openschedules):t.locked=!0})},__decorate([core_1.Component({selector:"email-schedules-view",template:'<div [system-overlay-loading-spinner]="isLoading"><div class="slds-grid slds-p-around--small" style="align-items: center"><system-icon class="slds-col slds-grow-none" [module]="\'EmailSchedules\'" [title]="\'EmailSchedules\'"></system-icon><h2 class="slds-grow">{{language.getModuleName(\'EmailSchedules\')}}</h2><button class="slds-col--bump-left slds-button slds-button--icon slds-button--icon-border" (click)="getData()" [disabled]="isLoading"><system-button-icon icon="refresh"></system-button-icon></button></div><table *ngIf="emailschedules.length > 0" width="100%" class="slds-table slds-table_cell-buffer slds-table_bordered"><thead><tr class="slds-line-height_reset"><th><div class="slds-truncate">Id</div></th><th><div class="slds-truncate"><system-label label="LBL_SUBJECT"></system-label></div></th><th><div class="slds-truncate"><system-label label="LBL_STATUS"></system-label></div></th></tr></thead><tbody><tr *ngFor="let schedule of emailschedules" class="slds-hint-parent"><td><div class="slds-truncate">{{schedule.id}}</div></td><td><div class="slds-truncate">{{schedule.subject}}</div></td><td><div class="slds-truncate">{{schedule.status}}</div></td></tr></tbody></table><div *ngIf="emailschedules.length == 0 && !isLoading" class="slds-align--absolute-center slds-m-around--large"><system-illustration-no-records><system-label label="MSG_NO_RECORDS_FOUND"></system-label></system-illustration-no-records></div><div *ngIf="!isLoading && locked" class="slds-align--absolute-center slds-m-around--large"><system-illustration-no-access><system-label label="LBL_NO_ACCESS"></system-label></system-illustration-no-access></div></div>',providers:[services_1.view]}),__metadata("design:paramtypes",[services_1.language,services_1.model,services_1.view,services_1.metadata,services_1.backend])],EmailSchedulesView)}();exports.EmailSchedulesView=EmailSchedulesView;var EmailActionSetReadButton=function(){function e(e,t,s){this.language=e,this.metadata=t,this.model=s,this.displayasicon=!1}return Object.defineProperty(e.prototype,"hidden",{get:function(){return!("unread"==this.model.getFieldValue("status")||!this.model.isEditing)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"disabled",{get:function(){return!(!this.model.data.acl||this.model.checkAccess("edit"))||(this.model.isEditing||this.model.isSaving)},enumerable:!1,configurable:!0}),e.prototype.execute=function(){this.model.setField("status","read")},__decorate([core_1.Component({selector:"email-action-set-read-button",template:'<span *ngIf="!displayasicon"><system-label label="LBL_SET_READ"></system-label></span>'}),__metadata("design:paramtypes",[services_1.language,services_1.metadata,services_1.model])],e)}();exports.EmailActionSetReadButton=EmailActionSetReadButton;var EmailTemplatesEditor=function(){function EmailTemplatesEditor(e,t,s,i,l){this.model=e,this.cdRef=t,this.modal=s,this.injector=i,this.view=l,this.selectedTab="editor",this.fieldsNames={bodyHtmlField:"body_html",bodySPBField:"body_spb"},this.iframeHeight=250,this.subscription=new rxjs_1.Subscription}return Object.defineProperty(EmailTemplatesEditor.prototype,"isHidden",{get:function(){return this.componentconfig.requiredmodelstate&&!this.model.checkModelState(this.componentconfig.requiredmodelstate)},enumerable:!1,configurable:!0}),EmailTemplatesEditor.prototype.ngAfterViewInit=function(){this.setActiveEditor(this.model.data[this.fieldsNames.bodyHtmlField],this.model.data[this.fieldsNames.bodySPBField]),this.subscribeToModelChanges()},EmailTemplatesEditor.prototype.ngOnInit=function(){this.setBodyFieldsName(),this.setIframeHeight()},EmailTemplatesEditor.prototype.ngOnDestroy=function(){this.subscription.unsubscribe()},EmailTemplatesEditor.prototype.setEditMode=function(){this.model.startEdit(),this.view.setEditMode(),this.cdRef.detectChanges()},EmailTemplatesEditor.prototype.setIframeHeight=function(){var e=parseInt(this.componentconfig.previewInitialHeight,10);e&&!isNaN(e)&&(this.iframeHeight=e)},EmailTemplatesEditor.prototype.setBodyFieldsName=function(){this.componentconfig.bodyHtmlField&&(this.fieldsNames.bodyHtmlField=this.componentconfig.bodyHtmlField),this.componentconfig.bodySPBField&&(this.fieldsNames.bodySPBField=this.componentconfig.bodySPBField),this.componentconfig.subjectField&&(this.fieldsNames.subjectField=this.componentconfig.subjectField),this.componentconfig.mailboxField&&(this.fieldsNames.mailboxField=this.componentconfig.mailboxField),this.componentconfig.previewForBean&&(this.fieldsNames.previewForBean=this.componentconfig.previewForBean)},EmailTemplatesEditor.prototype.subscribeToModelChanges=function(){var t=this;this.subscription.add(this.model.data$.subscribe(function(e){return t.setActiveEditor(e[t.fieldsNames.bodyHtmlField],e[t.fieldsNames.bodySPBField])})),this.subscription.add(this.view.mode$.subscribe(function(){return t.cdRef.detectChanges()}))},EmailTemplatesEditor.prototype.setActiveEditor=function(e,t){this.activeEditor=e?!t||_.isEmpty(t)?"richText":"pageBuilder":void 0,this.model.data.via_spb="pageBuilder"==this.activeEditor,this.cdRef.detectChanges()},EmailTemplatesEditor.prototype.setSelectedTab=function(e){"preview"==e&&!this.model.data[this.fieldsNames.bodyHtmlField]||(this.selectedTab=e)},EmailTemplatesEditor.prototype.copyFromTemplate=function(){var s=this;this.modal.openModal("ObjectModalModuleLookup",!0,this.injector).subscribe(function(e){e.instance.module="EmailTemplates",e.instance.multiselect=!1,e.instance.selectedItems.subscribe(function(e){var t;e.length&&s.model.setFields(((t={})[s.fieldsNames.bodyHtmlField]=e[0].body_html,t[s.fieldsNames.bodySPBField]=e[0].body_spb,t))})})},__decorate([core_1.Component({selector:"email-templates-editor",template:'<system-collapsable-tab *ngIf="!isHidden" tabtitle="LBL_CONTENT"><div class="slds-tabs_scoped slds-p-around--x-small"><ul class="slds-tabs_scoped__nav" role="tablist"><li class="slds-tabs_scoped__item" [class.slds-is-active]="selectedTab == \'editor\'" system-title="LBL_EDITOR" (click)="setSelectedTab(\'editor\')" role="presentation"><a class="slds-tabs_scoped__link" href="javascript:void(0);" role="tab"><system-label label="LBL_EDITOR"></system-label></a></li><li *ngIf="!!fieldsNames.previewForBean" class="slds-tabs_scoped__item" [ngClass]="{\'slds-is-active\': selectedTab == \'preview\', \'slds-text-color--inverse-weak\': !model.data[fieldsNames.bodyHtmlField]}" system-title="LBL_PREVIEW" (click)="setSelectedTab(\'preview\')" role="presentation"><a [class.slds-text-color--inverse-weak]="!model.data[fieldsNames.bodyHtmlField]" class="slds-tabs_scoped__link" href="javascript:void(0);" role="tab"><system-label label="LBL_PREVIEW"></system-label></a></li></ul><div class="slds-tabs_scoped__content" [ngClass]="{\'slds-show\': selectedTab == \'editor\', \'slds-hide\': selectedTab != \'editor\'}" role="tabpanel"><div *ngIf="!view.isEditMode() && !model.data[fieldsNames.bodyHtmlField]; else contentEditingContainer" (dblclick)="setEditMode()" class="slds-grid slds-grid--vertical-align-start slds-grid--align-end" style="min-height: 250px"><button class="slds-button slds-button--icon spice-hover-button" (click)="setEditMode()"><system-button-icon [icon]="\'edit\'"></system-button-icon></button></div><ng-template #contentEditingContainer><div class="slds-grid slds-m-bottom--xx-small"><field-container *ngIf="!!fieldsNames.subjectField" [field]="fieldsNames.subjectField" class="slds-grow slds-m-right--x-small" fielddisplayclass="slds-has-divider--bottom slds-p-vertical--x-small"></field-container><field-container *ngIf="!!fieldsNames.mailboxField" [field]="fieldsNames.mailboxField" [fieldconfig]="{fieldtype: \'mailboxes\', scope: \'outboundmass\'}" fielddisplayclass="slds-has-divider--bottom slds-p-vertical--x-small" class="slds-m-right--x-small"></field-container><div class="slds-align-bottom slds-col--bump-left slds-p-bottom--xx-small"><button [disabled]="!view.isEditMode()" (click)="copyFromTemplate()" class="slds-button slds-button--neutral"><system-button-icon icon="copy" position="left"></system-button-icon><system-label label="LBL_COPY_TEMPLATE"></system-label></button></div></div><div [ngSwitch]="activeEditor" class="slds-grid slds-grid--align-center slds-grid--vertical-align-center" style="min-height: 250px"><field-container *ngSwitchCase="\'richText\'" [field]="fieldsNames.bodyHtmlField" [fieldconfig]="{fieldtype: \'richtext\', hidelabel: true}" class="slds-size--1-of-1"></field-container><field-container *ngSwitchCase="\'pageBuilder\'" [field]="fieldsNames.bodyHtmlField" [fieldconfig]="{fieldtype: \'pagebuilder\', hidelabel: true, bodySPBField: fieldsNames.bodySPBField}" class="slds-size--1-of-1"></field-container><div *ngSwitchDefault><system-label label="LBL_EDIT_WITH" class="slds-m-right--xx-small"></system-label> <button class="slds-button slds-button--neutral spice-hover-button" (click)="activeEditor = \'richText\'"><system-label label="LBL_RICH_TEXT_EDITOR"></system-label></button> <system-label label="LBL_OR" class="slds-m-horizontal--xx-small"></system-label> <button class="slds-button slds-button--neutral spice-hover-button slds-m-lef" (click)="activeEditor = \'pageBuilder\'"><system-label label="LBL_PAGE_BUILDER"></system-label></button></div></div></ng-template></div><div *ngIf="!!fieldsNames.previewForBean" class="slds-tabs_scoped__content" [ngClass]="{\'slds-show\': selectedTab == \'preview\', \'slds-hide\': selectedTab != \'preview\'}" role="tabpanel"><email-templates-preview [previewForBean]="fieldsNames.previewForBean" [bodyHtmlField]="fieldsNames.bodyHtmlField" [iframeHeight]="iframeHeight"></email-templates-preview></div></div></system-collapsable-tab>',changeDetection:core_1.ChangeDetectionStrategy.OnPush}),__metadata("design:paramtypes",[services_1.model,core_1.ChangeDetectorRef,services_1.modal,core_1.Injector,services_1.view])],EmailTemplatesEditor)}();exports.EmailTemplatesEditor=EmailTemplatesEditor;var EmailTemplatesPreview=function(){function e(e,t,s,i,l,a,o,n){this.language=e,this.backend=t,this.metadata=s,this.model=i,this.modal=l,this.toast=a,this.sanitizer=o,this.cdRef=n,this.viewTypeOptions=[{title:"LBL_DESKTOP",icon:"desktop",value:"desktop",width:1024},{title:"LBL_TABLET",icon:"tablet_portrait",value:"tablet",width:768},{title:"LBL_MOBILE",icon:"phone_portrait",value:"mobile",width:320}],this.viewType={title:"LBL_DESKTOP",icon:"desktop",value:"desktop",width:1024},this.subscription=new rxjs_1.Subscription,this.bodyHtmlField="body_html",this.iframeHeight=250}return e.prototype.ngAfterViewInit=function(){this.subscribeToModelChanges()},e.prototype.ngOnDestroy=function(){this.subscription.unsubscribe()},e.prototype.subscribeToModelChanges=function(){var e=this;this.subscription.add(this.model.data$.subscribe(function(){e.setPlaceholder(),e.selectedItem&&e.selectedItem.module==e.previewForBean||e.clearSelectedItem()}))},e.prototype.setPlaceholder=function(){this.placeholder=this.previewForBean?this.language.getModuleCombinedLabel("LBL_SEARCH",this.previewForBean):this.language.getLabel("LBL_SEARCH"),this.cdRef.detectChanges()},e.prototype.searchWithModal=function(){var t=this;this.previewForBean&&this.modal.openModal("ObjectModalModuleLookup").subscribe(function(e){e.instance.module=t.previewForBean,e.instance.multiselect=!1,t.subscription.add(e.instance.selectedItems.subscribe(function(e){e&&e.length&&(t.selectedItem={id:e[0].id,text:e[0].summary_text,module:t.previewForBean},t.compileBody())}))})},e.prototype.clearSelectedItem=function(){this.selectedItem=void 0,this.parsedHtml=void 0,this.cdRef.detectChanges()},e.prototype.compileBody=function(){var t,e,s=this;this.model.id&&(t=this.modal.await("LBL_PARSING_HTML"),e={html:this.model.data[this.bodyHtmlField]},this.backend.postRequest("module/"+this.model.module+"/"+this.model.id+"/livecompile/"+this.previewForBean+"/"+this.selectedItem.id,{},e).subscribe(function(e){return e&&e.html?(s.parsedHtml=s.sanitizer.bypassSecurityTrustResourceUrl("data:text/html;charset=UTF-8,"+encodeURIComponent(e.html)),s.cdRef.detectChanges(),t.emit(!0),void t.unsubscribe()):(t.emit(!1),t.unsubscribe())},function(){s.toast.sendToast(s.language.getLabel("ERR_FAILED_TO_EXECUTE"),"error"),t.emit(!1),t.unsubscribe()}))},e.prototype.setViewType=function(t){this.viewType=this.viewTypeOptions.find(function(e){return e.value==t})},__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"bodyHtmlField",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],e.prototype,"previewForBean",void 0),__decorate([core_1.Input(),__metadata("design:type",Number)],e.prototype,"iframeHeight",void 0),__decorate([core_1.Component({selector:"email-templates-preview",template:'<div class="slds-grid slds-grid--vertical-align-end slds-gutters_direct-xx-small"><div class="slds-col slds-grow slds-form-element"><label class="slds-form-element__label"><system-label label="LBL_RECORD"></system-label></label><div class="slds-form-element__control"><div class="slds-combobox_container"><div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click" aria-expanded="false" aria-haspopup="listbox" role="combobox"><div class="slds-form-element__control slds-box--border"><div *ngIf="selectedItem" class="slds-form-element__control"><div class="slds-pill_container"><span class="slds-pill slds-size--1-of-1"><span class="slds-icon_container slds-icon-standard-account slds-pill__icon_container"><system-icon [module]="previewForBean" size="small"></system-icon></span> <span class="slds-pill__label">{{selectedItem.text}}</span> <button class="slds-button slds-button--icon slds-pill__remove" (click)="clearSelectedItem()"><system-button-icon [icon]="\'close\'"></system-button-icon></button></span></div></div><div *ngIf="!selectedItem" class="slds-input-has-icon slds-input-has-icon--right slds-grow" (click)="searchWithModal()"><input [disabled]="!previewForBean" type="text" class="slds-lookup__search-input slds-input--bare" [placeholder]="placeholder" role="combobox"> <button class="slds-button slds-button_icon slds-input__icon slds-input__icon_right" [disabled]="!previewForBean"><system-button-icon icon="search"></system-button-icon></button></div></div></div></div></div></div><button (click)="compileBody()" [disabled]="!selectedItem" class="slds-button slds-button--icon-border slds-m-horizontal--xx-small"><system-button-icon icon="refresh"></system-button-icon></button><div class="slds-form-element"><label class="slds-form-element__label"><system-label label="LBL_DISPLAY"></system-label></label><div class="slds-form-element__control slds-p-top--xx-small"><system-input-radio-button-group [ngModel]="viewType.value" (ngModelChange)="setViewType($event)" [inputOptions]="viewTypeOptions"></system-input-radio-button-group></div></div></div><div class="slds-m-top--small slds-border--top slds-border--right slds-border--left slds-border--bottom slds-grid slds-p-around--xx-small slds-grid slds-grid--align-center" [style.min-height.px]="iframeHeight"><div *ngIf="parsedHtml" [style.width.px]="viewType.width"><div class="slds-size--1-of-1 slds-grid slds-grid--vertical-align-center slds-is-relative slds-m-vertical--xx-small" style="height: 16px; border-left: 1px solid #aaa; border-right: 1px solid #aaa;"><div style="height: 1px; width: 100%; background: #aaa"></div><span class="slds-theme--default slds-p-horizontal--xx-small slds-is-absolute" style="left: 50%; transform: translateX(-50%);">{{viewType.width}}px</span></div><iframe [src]="parsedHtml" [style.height.px]="iframeHeight" style="border: 0; resize: vertical" class="slds-size--1-of-1"></iframe></div><div *ngIf="!selectedItem" class="slds-align--absolute-center slds-height_full"><system-label label="MSG_NO_RECORD_SELECTED"></system-label></div></div>',changeDetection:core_1.ChangeDetectionStrategy.OnPush}),__metadata("design:paramtypes",[services_1.language,services_1.backend,services_1.metadata,services_1.model,services_1.modal,services_1.toast,platform_browser_1.DomSanitizer,core_1.ChangeDetectorRef])],e)}();exports.EmailTemplatesPreview=EmailTemplatesPreview;var fieldEmailSubject=function(h){function fieldEmailSubject(e,t,s,i,l,a,o,n,d,r,c,m,u){var p=h.call(this,e,t,s,i,o)||this;return p.model=e,p.view=t,p.language=s,p.metadata=i,p.backend=l,p.toast=a,p.router=o,p.injector=n,p.broadcast=d,p.configurationService=r,p.modal=c,p.cdRef=m,p.sanitized=u,p}return __extends(fieldEmailSubject,h),Object.defineProperty(fieldEmailSubject.prototype,"statusIcon",{get:function(){switch(this.model.data.status){case"opened":case"read":return"email_open";case"bounced":case"deferred":case"send_error":return"error";case"sent":return"send";default:return"email"}},enumerable:!1,configurable:!0}),Object.defineProperty(fieldEmailSubject.prototype,"statusLabel",{get:function(){switch(this.model.data.status){case"opened":case"read":return"LBL_OPEN";case"bounced":case"deferred":case"send_error":return"LBL_ERROR";case"sent":return"LBL_OUTBOUND";default:return"LBL_UNREAD"}},enumerable:!1,configurable:!0}),__decorate([core_1.Component({selector:"field-email-subject",template:'<field-label *ngIf="displayLabel" [fieldname]="fieldname" [fieldconfig]="fieldconfig"></field-label><field-generic-display *ngIf="!isEditMode()" [fielddisplayclass]="fielddisplayclass" [editable]="isEditable()" [fieldconfig]="fieldconfig" [fieldid]="fieldid"><div class="slds-grid slds-grid--vertical-align-center"><div [system-title]="statusLabel" class="slds-m-right--x-small"><system-utility-icon [icon]="statusIcon" size="x-small"></system-utility-icon></div><div [title]="value" [ngStyle]="{\'text-decoration\': model.data.openness == \'user_closed\' || model.data.openness == \'system_closed\' ? \'line-through\' : \'initial\', \'font-weight\': model.data.status == \'unread\' ? \'bold\' : \'initial\'}" class="slds-truncate">{{value}}</div></div></field-generic-display><div *ngIf="isEditable() && isEditMode()" class="slds-form-element__control slds-is-relative" [ngClass]="getFieldClass()" style="position:relative;"><input system-placeholder type="text" class="slds-input" [(ngModel)]="value" [maxlength]="fieldlength" [autocomplete]="fieldid" [ngModelOptions]="modelOptions"><field-messages [fieldname]="fieldname"></field-messages></div>'}),__metadata("design:paramtypes",[services_1.model,services_1.view,services_1.language,services_1.metadata,services_1.backend,services_1.toast,router_1.Router,core_1.Injector,services_1.broadcast,services_1.configurationService,services_1.modal,core_1.ChangeDetectorRef,platform_browser_1.DomSanitizer])],fieldEmailSubject)}(objectfields_1.fieldGeneric);exports.fieldEmailSubject=fieldEmailSubject;var fieldEmailActivityOpenness=function(d){function fieldEmailActivityOpenness(e,t,s,i,l,a,o){var n=d.call(this,e,t,s,i,o)||this;return n.model=e,n.view=t,n.language=s,n.metadata=i,n.backend=l,n.toast=a,n.router=o,n}return __extends(fieldEmailActivityOpenness,d),fieldEmailActivityOpenness.prototype.setOpenness=function(t){var s=this;this.model.setField("openness",t),this.backend.postRequest("module/"+this.model.module+"/"+this.model.id+"/openness",null,{openness:t}).subscribe(function(e){},function(e){s.toast.sendAlert("Cannot change openness to "+t)})},__decorate([core_1.Component({selector:"field-email-activity-openness",template:'<field-label *ngIf="displayLabel" [fieldname]="fieldname" [fieldconfig]="fieldconfig"></field-label><div [ngClass]="getFieldClass()"><button class="slds-button slds-button--icon slds-button_icon-border-filled" [disabled]="!model.checkAccess(\'edit\')" *ngIf="model.data.openness == \'open\'" (click)="setOpenness(\'user_closed\')" [title]="language.getLabel(\'LBL_MARK_USER_CLOSED\')"><system-button-icon icon="unlock"></system-button-icon></button> <button class="slds-button slds-button--icon slds-button_icon-border-filled" [disabled]="!model.checkAccess(\'edit\')" *ngIf="model.data.openness == \'user_closed\' || model.data.openness == \'system_closed\'" (click)="setOpenness(\'open\')" [title]="language.getLabel(\'LBL_REOPEN\')"><system-button-icon icon="lock"></system-button-icon></button><field-messages [fieldname]="fieldname"></field-messages></div>'}),__metadata("design:paramtypes",[services_1.model,services_1.view,services_1.language,services_1.metadata,services_1.backend,services_1.toast,router_1.Router])],fieldEmailActivityOpenness)}(objectfields_1.fieldGeneric);exports.fieldEmailActivityOpenness=fieldEmailActivityOpenness;var ModuleEmails=function(){function ModuleEmails(){}return __decorate([core_1.NgModule({imports:[common_1.CommonModule,forms_1.FormsModule,objectfields_1.ObjectFields,globalcomponents_1.GlobalComponents,objectcomponents_1.ObjectComponents,systemcomponents_1.SystemComponents,directives_1.DirectivesModule],declarations:[EmailToObjectButton,EmailToObjectEmailText,EmailToObjectModal,EmailPreviewModal,EmailMSGPreviewModal,EmailsPopoverBody,fieldEmailStatus,EmailReplyButton,EmailReplyModal,EmailSendButton,EmailForwardButton,EmailForwardModal,EmailSchedulesButton,EmailSchedulesModal,EmailSchedulesRelatedButton,EmailSchedulesRelatedModal,EmailSchedulesView,EmailActionSetReadButton,EmailTemplatesEditor,EmailTemplatesPreview,fieldEmailSubject,fieldEmailActivityOpenness]})],ModuleEmails)}();exports.ModuleEmails=ModuleEmails;