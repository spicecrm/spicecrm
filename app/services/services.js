/*
SpiceUI 2018.10.001

Copyright (c) 2016-present, aac services.k.s - All rights reserved.
Redistribution and use in source and binary forms, without modification, are permitted provided that the following conditions are met:
- Redistributions of source code must retain this copyright and license notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- If used the SpiceCRM Logo needs to be displayed in the upper left corner of the screen in a minimum dimension of 31x31 pixels and be clearly visible, the icon needs to provide a link to http://www.spicecrm.io
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

*/

/** 
 * Â© 2015 - 2021 aac services k.s. All rights reserved.
 * release: 2021.02.001
 * date: 2021-06-24 11:36:53
 * build: 2021.02.001.1624527413323
 **/
"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},__decorate=this&&this.__decorate||function(t,e,i,s){var a,o=arguments.length,n=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;0<=r;r--)(a=t[r])&&(n=(o<3?a(n):3<o?a(e,i,n):a(e,i))||n);return 3<o&&n&&Object.defineProperty(e,i,n),n},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(i,s){return function(t,e){s(t,e,i)}},__awaiter=this&&this.__awaiter||function(t,n,r,c){return new(r=r||Promise)(function(e,i){function s(t){try{o(c.next(t))}catch(t){i(t)}}function a(t){try{o(c.throw(t))}catch(t){i(t)}}function o(t){t.done?e(t.value):function(e){return e instanceof r?e:new r(function(t){t(e)})}(t.value).then(s,a)}o((c=c.apply(t,n||[])).next())})},__generator=this&&this.__generator||function(i,s){var a,o,n,t,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;r;)try{if(a=1,o&&(n=2&e[0]?o.return:e[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,e[1])).done)return n;switch(o=0,n&&(e=[2&e[0],n.value]),e[0]){case 0:case 1:n=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++,o=e[1],e=[0];continue;case 7:e=r.ops.pop(),r.trys.pop();continue;default:if(!(n=0<(n=r.trys).length&&n[n.length-1])&&(6===e[0]||2===e[0])){r=0;continue}if(3===e[0]&&(!n||e[1]>n[0]&&e[1]<n[3])){r.label=e[1];break}if(6===e[0]&&r.label<n[1]){r.label=n[1],n=e;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(e);break}n[2]&&r.ops.pop(),r.trys.pop();continue}e=s.call(i,r)}catch(t){e=[6,t],o=0}finally{a=n=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.subscription=exports.assistant=exports.notification=exports.fielderrorgrouping=exports.activitiytimeline=exports.relatedmodels=exports.view=exports.popup=exports.modellist=exports.modelattachments=exports.mediafiles=exports.model=exports.navigationtab=exports.canNavigateAway=exports.navigation=exports.socket=exports.fts=exports.dockedComposer=exports.loginCheck=exports.loginService=exports.loader=exports.currency=exports.reminder=exports.favorite=exports.territories=exports.userpreferences=exports.recent=exports.backend=exports.libloader=exports.googleapiloader=exports.helper=exports.modal=exports.modalwindow=exports.toast=exports.modelutilities=exports.language=exports.noBack=exports.aclCheck=exports.metadata=exports.layout=exports.configurationService=exports.footer=exports.session=exports.telephony=exports.broadcast=exports.cookie=exports.MathExpressionCompilerService=exports.loggerService=void 0;var core_1=require("@angular/core"),platform_browser_1=require("@angular/platform-browser"),common_1=require("@angular/common"),operators_1=require("rxjs/operators"),ts_md5_1=require("ts-md5"),router_1=require("@angular/router"),rxjs_1=require("rxjs"),http_1=require("@angular/common/http"),noop=function(){},loggerService=function(){function t(){}return Object.defineProperty(t.prototype,"info",{get:function(){return this.isDev()?console.info.bind(console):noop},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"warn",{get:function(){return this.isDev()?console.warn.bind(console):noop},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"log",{get:function(){return this.isDev()?console.log.bind(console):noop},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"error",{get:function(){return this.isDev()?console.error.bind(console):noop},enumerable:!1,configurable:!0}),t.prototype.isDev=function(){return core_1.isDevMode()||this.sessionService&&this.sessionService.isDev},t.prototype.setSession=function(t){this.sessionService=t},t=__decorate([core_1.Injectable()],t)}();exports.loggerService=loggerService;var MathExpressionCompilerService=function(){function t(){}return t.prototype.do=function(t){return this.evaluate(this.parse(this.lex(t)))},t.prototype.lex=function(t){for(var e=function(t){return/[+\-*\/\^%=(),]/.test(t)},i=function(t){return/[0-9]/.test(t)},s=function(t){return/\s/.test(t)},a=function(t){return"string"==typeof t&&!e(t)&&!i(t)&&!s(t)},o=[],n=0,r=function(){return t[++n]},c=function(t,e){o.push({type:t,value:e})};n<t.length;){var u=t[n];if(s(u))r();else if(e(u))c(u),r();else if(i(u)){for(var l="";l+=u,u=r(),i(u););if("."===u)for(;l+=u,u=r(),i(u););var d=parseFloat(l);if(!isFinite(d))throw"Number is too large or too small for a 64-bit double.";c("number",d)}else{if(!a(u))throw"Unrecognized token: "+u+" at "+n;for(var h=u;a(r());)h+=u;c("identifier",h)}}return c("(end)"),o},t.prototype.parse=function(i){function a(t,e,i,s){var a=o[t]||{};o[t]={lbp:a.lbp||i,nud:a.nud||e,led:a.led||s}}var o={};a("(",function(){var t=u(2);if(")"!==r().type)throw"Expected closing parenthesis ')'";return c(),t}),a("number",function(t){return t}),a("identifier",function(t){if("("!==r().type)return t;var e=[];if(")"===i[n+1].type)c();else{for(;c(),e.push(u(2)),","===r().type;);if(")"!==r().type)throw"Expected closing parenthesis ')'"}return c(),{type:"call",args:e,name:t.value}}),a(","),a(")"),a("(end)");function t(e,t,i,s){i=i||t,a(e,null,t,s||function(t){return{type:e,left:t,right:u(i)}})}var e,s,n=0,r=function(){return function(t){var e=Object.create(o[t.type]);return e.type=t.type,e.value=t.value,e}(i[n])},c=function(){return n++,r()},u=function(t){var e,i=r();if(c(),!i.nud)throw"Unexpected token: "+i.type;for(e=i.nud(i);t<r().lbp;){if(i=r(),c(),!i.led)throw"Unexpected token: "+i.type;e=i.led(e)}return e};s=7,a(e="-",function(){return{type:e,right:u(s)}}),t("^",6,5),t("*",4),t("/",4),t("%",4),t("+",3),t("-",3),t("=",1,2,function(t){if("call"===t.type){for(var e=0;e<t.args.length;e++)if("identifier"!==t.args[e].type)throw"Invalid argument name";return{type:"function",name:t.name,args:t.args,value:u(2)}}if("identifier"===t.type)return{type:"assign",name:t.value,value:u(2)};throw"Invalid lvalue"});for(var l=[];"(end)"!==r().type;)l.push(u(0));return l},t.prototype.evaluate=function(t){for(var s={"+":function(t,e){return t+e},"-":function(t,e){return t-e},"*":function(t,e){return t*e},"/":function(t,e){return t/e},"%":function(t,e){return t%e},"^":function(t,e){return Math.pow(t,e)}},a={pi:Math.PI,e:Math.E},o={sin:Math.sin,cos:Math.cos,tan:Math.cos,asin:Math.asin,acos:Math.acos,atan:Math.atan,abs:Math.abs,round:Math.round,ceil:Math.ceil,floor:Math.floor,log:Math.log,exp:Math.exp,sqrt:Math.sqrt,max:Math.max,min:Math.min,random:Math.random},n={},r=function(i){if("number"===i.type)return i.value;if(s[i.type])return i.left?s[i.type](r(i.left),r(i.right)):s[i.type](r(i.right));if("identifier"===i.type){var t=n.hasOwnProperty(i.value)?n[i.value]:a[i.value];if(void 0===t)throw i.value+" is undefined";return t}if("assign"===i.type)a[i.name]=r(i.value);else{if("call"===i.type){for(var e=0;e<i.args.length;e++)i.args[e]=r(i.args[e]);return o[i.name].apply(null,i.args)}"function"===i.type&&(o[i.name]=function(){for(var t=0;t<i.args.length;t++)n[i.args[t].value]=arguments[t];var e=r(i.value);return n={},e})}},e="",i=0;i<t.length;i++){var c=r(t[i]);void 0!==c&&(e+=c+"\n")}return e},t=__decorate([core_1.Injectable()],t)}();exports.MathExpressionCompilerService=MathExpressionCompilerService;var cookie=function(){function t(){}return t.prototype.getValue=function(t){for(var e=t+"=",i=decodeURIComponent(document.cookie).split(";"),s=0;s<i.length;s++){for(var a=i[s];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(e))return a.substring(e.length,a.length)}return""},t.prototype.setValue=function(t,e,i){void 0===i&&(i=365);var s=new Date;s.setTime(s.getTime()+24*i*60*60*1e3);var a="expires="+s.toUTCString();document.cookie=t+"="+e+";"+a+";path=/"},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],t)}();exports.cookie=cookie;var broadcast=function(){function t(){this.message$=new core_1.EventEmitter}return t.prototype.broadcastMessage=function(t,e){void 0===e&&(e={}),this.message$.emit({messagetype:t,messagedata:e})},t=__decorate([core_1.Injectable()],t)}();exports.broadcast=broadcast;var telephony=function(){function t(t){var e=this;this.broadcast=t,this.isActive=!1,this.calls=[],this.initiateCall$=new core_1.EventEmitter,this.terminateCall$=new core_1.EventEmitter,this.broadcast.message$.subscribe(function(t){return e.handleLogout(t)})}return t.prototype.handleLogout=function(t){"logout"==t.messagetype&&(this.calls=[],this.isActive=!1)},t.prototype.initiateCall=function(t,e){this.initiateCall$.emit({msisdn:t,relatedid:e.relatedid,relatedmodule:e.relatedmodule,relateddata:e.relateddata})},t.prototype.terminateCall=function(e){var t=this.calls.find(function(t){return t.id==e||t.callid==e});t&&this.terminateCall$.emit(t)},t.prototype.removeCallById=function(e){var t=this.calls.findIndex(function(t){return t.id==e||t.callid==e});0<=t&&this.calls.splice(t,1)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[broadcast])],t)}();exports.telephony=telephony;var session=function(){function t(t,e){this.logger=t,this.broadcast=e,this.authData={sessionId:null,loaded:!1,userId:null,userName:"",first_name:"",last_name:"",display_name:"",email:"",password:"",admin:!1,dev:!1,portalOnly:!1,googleToken:"",userimage:"",companycode_id:"",tenant_id:"",tenant_name:"",obtainGDPRconsent:!1,canchangepassword:!1},this.sessionData={},this.logger.setSession(this)}return t.prototype.getSessionHeader=function(){var t=new http_1.HttpHeaders;return t=(t=t.set("OAuth-Token",this.authData.sessionId)).set("OAuth-Issuer","SpiceCRM")},t.prototype.setSessionData=function(t,e,i){void 0===i&&(i=!0),this.sessionData[t]=e,i&&sessionStorage.setItem(window.btoa(t+this.authData.sessionId),window.btoa(encodeURIComponent(JSON.stringify(e))))},t.prototype.clearSessionData=function(t){sessionStorage.removeItem(t)},t.prototype.getSessionData=function(t,e){if(void 0===e&&(e=!0),this.sessionData[t])return this.sessionData[t];try{return JSON.parse(decodeURIComponent(window.atob(sessionStorage.getItem(window.btoa(t+this.authData.sessionId)))))}catch(t){return!!e&&{}}},t.prototype.existsData=function(t){try{return sessionStorage[window.btoa(t+this.authData.sessionId)]&&0<sessionStorage[window.btoa(t+this.authData.sessionId)].length}catch(t){return!1}},t.prototype.endSession=function(){this.authData.sessionId=null,this.authData.userId=null,this.authData.loaded=!1,this.authData.userName="",this.authData.first_name="",this.authData.last_name="",this.authData.display_name="",this.authData.email="",this.authData.userimage="",this.authData.password="",this.authData.admin=!1,this.authData.dev=!1,this.authData.companycode_id="",this.authData.obtainGDPRconsent=!1,this.authData.canchangepassword=!1,this.sessionData={},sessionStorage.clear()},Object.defineProperty(t.prototype,"isAdmin",{get:function(){return this.authData.admin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDev",{get:function(){return this.authData.dev},enumerable:!1,configurable:!0}),t.prototype.setTimezone=function(t){this.getSessionData("timezone")!==t&&(this.setSessionData("timezone",t,!1),moment.tz.setDefault(t),this.broadcast.broadcastMessage("timezone.changed",t))},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[loggerService,broadcast])],t)}();exports.session=session;var footer=function(){function t(){this.footercontainer=null,this.modalcontainer=null,this.modalbackdrop=null,this.visibleFooterHeight=0}return t=__decorate([core_1.Injectable()],t)}();exports.footer=footer;var configurationService=function(){function t(t,e,i,s,a,o){var r=this;this.http=t,this.cookie=e,this.session=i,this.broadcast=s,this.title=a,this.router=o,this.initialized=!1,this.reloading=!1,this.sites=[],this.data={backendUrl:"api",backendextensions:{},systemparameters:{},theme:{},name:"SpiceCRM"},this.appdata={},this.datachanged$=new core_1.EventEmitter,this.loaded$=new rxjs_1.BehaviorSubject(!1),this.locationHash=ts_md5_1.Md5.hashStr("spiceuisites"+window.location.origin+window.location.pathname).toString();var n=localStorage.getItem(this.locationHash);if(n){this.sites=JSON.parse(atob(n));var c=ts_md5_1.Md5.hashStr("spiceuibackend"+window.location.origin+window.location.pathname).toString(),u=sessionStorage.getItem(c),l=!1;this.sites.some(function(t){if(t.id==u)return r.setSiteID(t.id),l=!0}),l||this.setSiteID(this.sites[0].id),this.broadcast.message$.subscribe(function(t){return r.handleLogout(t)})}this.loaded$.subscribe(function(){return r.updateThemeColors()}),t.get("config/sites/").subscribe(function(t){var e=t,i=e.sites;for(var s in 0==i.length&&r.router.navigate(["/install"]),e.general)r.data[s]=e.general[s];if(0<i.length&&(r.sites=i,localStorage.setItem(r.locationHash,btoa(JSON.stringify(i))),!r.data.id)){var a=ts_md5_1.Md5.hashStr("spiceuibackend"+window.location.origin+window.location.pathname).toString(),o=sessionStorage.getItem(a),n=!1;r.sites.some(function(t){if(t.id==o)return r.setSiteID(t.id),n=!0}),n||r.setSiteID(i[0].id)}})}var e,i,s;return t.prototype.handleLogout=function(t){"logout"==t.messagetype&&this.reset()},t.prototype.reset=function(){this.appdata={}},t.prototype.setSiteData=function(t){for(var e in this.sites.push(t),t)this.data[e]=t[e];localStorage.setItem(this.locationHash,btoa(JSON.stringify(this.sites))),this.getSysinfo()},t.prototype.setSiteID=function(s){var a=this;return this.sites.some(function(t){if(t.id==s){for(var e in t)a.data[e]=t[e];var i=ts_md5_1.Md5.hashStr("spiceuibackend"+window.location.origin+window.location.pathname).toString();return sessionStorage.setItem(i,s),!0}}),this.getSysinfo(),this.data},t.prototype.getSiteId=function(){return this.data.id},t.prototype.getBackendUrl=function(){return this.data.backendUrl},t.prototype.getFrontendUrl=function(){return void 0!==this.data.frontendUrl?this.data.frontendUrl:""},t.prototype.getUser=function(){return this.data.user},t.prototype.getPassword=function(){return this.data.password},Object.defineProperty(t.prototype,"systemName",{get:function(){return this.data.name?this.data.name:"SpiceCRM"},enumerable:!1,configurable:!0}),t.prototype.getSysinfo=function(){var e=this;this.reloading=!0;var t=this.http.get(this.getBackendUrl()+"/sysinfo");return t.subscribe(function(t){t&&(e.data.languages=t.languages,e.data.backendextensions=t.extensions,e.data.systemparameters=t.systemsettings,e.data.socket_frontend=t.socket_frontend,e.data.unique_key=t.unique_key,e.data.name=t.name?t.name:"SpiceCRM",e.loaded$.next(!0)),e.initialized=!0,e.reloading=!1,e.setFavIcon(),e.title.setTitle(e.systemName)},function(t){e.reloading=!1,e.initialized=!0,e.setFavIcon()}),t},t.prototype.getSystemParamater=function(t){try{return this.data.systemparameters[t]}catch(t){return!1}},t.prototype.checkCapability=function(t){return this.data.backendextensions&&this.data.backendextensions.hasOwnProperty(t)},t.prototype.getCapabilityConfig=function(t){try{return this.data.backendextensions[t]&&this.data.backendextensions[t].config?this.data.backendextensions[t].config:{}}catch(t){return{}}},t.prototype.hasCapabilityConfig=function(t){return this.data.backendextensions[t]&&this.data.backendextensions[t].config&&0<Object.keys(this.data.backendextensions[t].config).length},t.prototype.setData=function(t,e){this.appdata[t]=e,this.datachanged$.emit(t)},t.prototype.getData=function(t){return!!this.appdata[t]&&this.appdata[t]},t.prototype.updateThemeColors=function(){var e,t=this.getCapabilityConfig("theme");try{e=JSON.parse(t.colors)}catch(t){e={}}for(var i=0,s=["color-white","color-grey-3","color-grey-9","color-grey-13","brand-background-primary","brand-primary","brand-primary-active","brand-accessible","brand-accessible-active","brand-header-contrast-cool","brand-text-link","color-background-inverse","color-border-inverse","color-background-success","color-background-success-dark","color-text-link-active","color-progressbar_item-completed","brand-primary-transparent","color-background-alt-inverse","color-border-brand","sds-c-button-brand-color-background","sds-c-button-neutral-color-background-hover","sds-c-button-brand-color-border-hover","sds-c-button-brand-color-background-active","sds-c-button-brand-color-border-active","sds-c-button-brand-color-background-hover","sds-c-input-shadow-focus","sds-c-textarea-shadow-focus","sds-c-select-shadow-focus","sds-c-button-text-color-hover"];i<s.length;i++){var a=s[i];document.documentElement.style.setProperty("--"+a,e[a]?e[a]:null)}var o=document.documentElement.style.getPropertyValue("--brand-primary");o&&document.querySelector('meta[name="theme-color"]').setAttribute("content",o)},t.prototype.setFavIcon=function(){var t=document.querySelectorAll("link[ rel ~= 'icon' i]")[0];if(t){var e=this.getCapabilityConfig("theme");e.icon_image?t.setAttribute("href","data:"+e.icon_image):t.setAttribute("href","./config/favicon")}},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==http_1.HttpClient&&http_1.HttpClient)?e:Object,cookie,session,broadcast,"function"==typeof(i=void 0!==platform_browser_1.Title&&platform_browser_1.Title)?i:Object,"function"==typeof(s=void 0!==router_1.Router&&router_1.Router)?s:Object])],t)}();exports.configurationService=configurationService;var layout=function(){function t(){this.headerheight=90}return Object.defineProperty(t.prototype,"screenwidth",{get:function(){var t=window.innerWidth;return 1024<=t?"large":768<=t?"medium":"small"},enumerable:!1,configurable:!0}),t=__decorate([core_1.Injectable()],t)}();exports.layout=layout;var metadata=function(){function t(t,e,i,s,a,o,n,r,c){var u=this;this.NgModuleFactoryLoader=t,this.http=e,this.session=i,this.configuration=s,this.componentFactoryResolver=a,this.router=o,this.broadcast=n,this.compiler=r,this.Injector=c,this.componentFactories={},this.role="",this.broadcast.message$.subscribe(function(t){return u.handleMessage(t)})}var e,i,s,a,o,n;return Object.defineProperty(t.prototype,"actionSets",{get:function(){return this.configuration.getData("actionsets")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"componentDefaultConfigs",{get:function(){return this.configuration.getData("componentdefaultconfigs")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"componentModuleConfigs",{get:function(){return this.configuration.getData("componentmoduleconfigs")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"moduleDirectory",{get:function(){return this.configuration.getData("modules")?this.configuration.getData("modules"):{SpiceInstaller:{id:"766AADDE-FB86-4F9C-9939-9A7B03288CAE",module:"SpiceInstallerModule",path:"app/include/spiceinstaller/spiceinstallermodule"}}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"componentDirectory",{get:function(){return this.configuration.getData("components")?this.configuration.getData("components"):{SpiceInstaller:{component:"SpiceInstaller",componentconfig:[],deprecated:"0",module:"SpiceInstaller",path:"app/include/spiceinstaller/components/spiceinstaller"}}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"componentSets",{get:function(){return this.configuration.getData("componentsets")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"routes",{get:function(){return this.configuration.getData("routes")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scripts",{get:function(){return this.configuration.getData("scripts")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fieldSets",{get:function(){return this.configuration.getData("fieldsets")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"validationRules",{get:function(){return this.configuration.getData("validationrules")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fieldDefs",{get:function(){return this.configuration.getData("fielddefs")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fieldTypeMappings",{get:function(){return this.configuration.getData("fieldtypemappings")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fieldStatusNetworks",{get:function(){return this.configuration.getData("fieldstatusnetworks")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"moduleDefs",{get:function(){return this.configuration.getData("moduledefs")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"moduleFilters",{get:function(){return this.configuration.getData("modulefilters")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roles",{get:function(){return this.configuration.getData("roles")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rolemodules",{get:function(){return this.configuration.getData("rolemodules")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"copyrules",{get:function(){return this.configuration.getData("copyrules")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"htmlStyleData",{get:function(){return this.configuration.getData("htmlstyles")},enumerable:!1,configurable:!0}),t.prototype.addRoutes=function(){var a=this;System.import("app/systemcomponents/systemcomponents").then(function(t){return t.SystemComponents}).then(function(t){a.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){t.componentFactories.some(function(t){if("SystemNavigationCollector"===t.componentType.name){for(var e=0,i=a.routes;e<i.length;e++){var s=i[e];a.router.config.unshift({path:s.path,component:t.componentType,canActivate:[aclCheck]}),a.router.config.unshift({path:"tab/:tabid/"+s.path,component:t.componentType,canActivate:[aclCheck]})}return!0}})})})},t.prototype.addComponentDirect=function(s,a,o){var n=this,r=new rxjs_1.Subject;if(this.componentDirectory[s])if(this.componentDirectory[s].module){var e=this.componentDirectory[s].module;try{System.import(this.moduleDirectory[e].path).then(function(t){return t[n.moduleDirectory[e].module]}).then(function(t){n.moduleDirectory[e].factories={},n.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){var e=t.componentFactories.find(function(t){return t.componentType.name===s});if(e){var i=a.createComponent(e,void 0,o);i.instance.self=i,r.next(i),r.complete()}else r.error("Cannot find a factory for component "+s),r.complete()})})}catch(t){r.error(t),r.complete()}}else System.import(this.componentDirectory[s].path).then(function(t){return t[s]}).then(function(t){var e=n.componentFactoryResolver.resolveComponentFactory(t),i=a.createComponent(e,void 0,o);i.instance.self=i,r.next(i),r.complete()});else System.import("app/systemcomponents/systemcomponents").then(function(t){return t.SystemComponents}).then(function(t){n.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){t.componentFactories.some(function(t){if("SystemComponentMissing"===t.componentType.name){var e=a.createComponent(t,void 0,o);return e.instance.component=s,r.next(e),r.complete(),!0}})})});return r.asObservable()},t.prototype.checkComponent=function(t){return!!this.componentDirectory[t]},t.prototype.addComponent=function(o,n,r){var c=this,u=new rxjs_1.Subject;if(null!=n)return this.componentDirectory[o]?SystemJS.import("app/systemcomponents/systemcomponents").then(function(t){return t.SystemComponents}).then(function(t){c.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){var s=t.componentFactories.find(function(t){return"SystemComponentContainer"===t.componentType.name}),a=n.createComponent(s,void 0,r);return a.instance.containerComponent=o,a.changeDetectorRef.markForCheck(),a.instance.containerRef.subscribe(function(i){if(c.componentDirectory[o].module){var e=c.componentDirectory[o].module;SystemJS.import(c.moduleDirectory[e].path).then(function(t){return t[c.moduleDirectory[e].module]}).then(function(t){c.moduleDirectory[e].factories={},c.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){if(!(s=t.componentFactories.find(function(t){return t.componentType.name===o})))return console.error("Cannot find a factory for component "+o),!1;var e=i.createComponent(s);return e.instance.self=a,e.changeDetectorRef.markForCheck(),u.next(e),u.complete(),a.instance.loaded=!0})})}else System.import(c.componentDirectory[o].path).then(function(t){return t[o]}).then(function(t){var e=c.componentFactoryResolver.resolveComponentFactory(t),i=n.createComponent(e,void 0,r);i.instance.self=i,u.next(i),u.complete()})}),!0})}):SystemJS.import("app/systemcomponents/systemcomponents").then(function(t){return t.SystemComponents}).then(function(t){c.compiler.compileModuleAndAllComponentsAsync(t).then(function(t){t.componentFactories.some(function(t){if("SystemComponentMissing"===t.componentType.name){var e=n.createComponent(t,void 0,r);return e.instance.component=o,e.changeDetectorRef.markForCheck(),u.next(e),u.complete(),!0}})})}),u.asObservable();console.log("viewchild not defined")},t.prototype.getComponentSet=function(t){return this.componentSets[t]},t.prototype.getAllComponentsets=function(){try{return this.componentSets}catch(t){return""}},t.prototype.addComponentSet=function(t,e,i,s){void 0===s&&(s="custom"),this.componentSets[t]={name:i,module:e,type:s,items:[]}},t.prototype.getRawComponentSets=function(){return this.componentSets},t.prototype.getComponentSets=function(t){void 0===t&&(t="");var e=[];for(var i in this.componentSets)""!==t&&this.componentSets[i].module!==t||e.push({id:i,name:this.componentSets[i].name,module:this.componentSets[i].module,type:this.componentSets[i].type});return e.sort(function(t,e){return t.name?t.name.localeCompare(e.name):1}),e},t.prototype.getComponentSetObjects=function(t){try{return this.componentSets[t].items}catch(t){return[]}},t.prototype.addComponentToComponentset=function(t,e,i){this.componentSets[e].items.push({id:t,component:i,componentconfig:{},sequence:0});for(var s=0,a=0,o=this.componentSets[e].items;a<o.length;a++){o[a].sequence=s,s++}},t.prototype.getRawFieldSets=function(){return this.fieldSets},t.prototype.getFieldSets=function(t,e){void 0===t&&(t=""),void 0===e&&(e="");var i=[];for(var s in this.fieldSets)""!==t&&this.fieldSets[s].module!==t||i.push({id:s,name:this.fieldSets[s].name,module:this.fieldSets[s].module,type:this.fieldSets[s].type});return i.sort(function(t,e){return t.name>e.name?1:-1}),i},t.prototype.getFieldset=function(t){try{return this.fieldSets[t]}catch(t){return""}},t.prototype.getAllFieldsets=function(){try{return this.fieldSets}catch(t){return""}},t.prototype.setFieldset=function(t,e){this.fieldSets[t].name=e.name,this.fieldSets[t].package=e.package},t.prototype.addFieldset=function(t,e,i,s,a){void 0===s&&(s="custom"),void 0===a&&(a=[]),this.fieldSets[t]={items:a,module:e,name:i,type:s}},t.prototype.addFieldsetToFieldset=function(t,e,i){this.fieldSets[e].items.push({id:t,fieldset:i,fieldconfig:{},sequence:0});for(var s=0,a=0,o=this.fieldSets[e].items;a<o.length;a++){o[a].sequence=s,s++}},t.prototype.addFieldToFieldset=function(t,e,i){this.fieldSets[e].items.push({id:t,field:i,fieldconfig:{},sequence:0});for(var s=0,a=0,o=this.fieldSets[e].items;a<o.length;a++){o[a].sequence=s,s++}},t.prototype.removeFieldsetItem=function(t,i){var s=!1;if(this.fieldSets[t].items.some(function(t,e){if(t.id==i.id)return s=e,!0}),!1===s)return!1;this.fieldSets[t].items.splice(s,1);for(var e=0,a=0,o=this.fieldSets[t].items;a<o.length;a++){o[a].sequence=e,e++}return!0},t.prototype.getFieldsetName=function(t){try{return this.fieldSets[t].name}catch(t){return""}},t.prototype.getFieldSetFields=function(t,e){if(void 0===e&&(e=""),this.fieldSets[t]){for(var i=[],s=0,a=this.fieldSets[t].items;s<a.length;s++){var o=a[s];o.field?i.push(o):o.fieldset&&e.indexOf(t)<0&&(i=i.concat(this.getFieldSetFields(o.fieldset,e+":"+t)))}return i}return[]},t.prototype.getFieldSetItems=function(t){return this.fieldSets[t]?this.fieldSets[t].items:[]},t.prototype.getFieldlabel=function(t,e){try{return this.fieldDefs[t][e].vname?this.fieldDefs[t][e].vname:e}catch(t){return e}},t.prototype.getFieldHelpText=function(t,e){try{return this.fieldDefs[t][e].popupHelp}catch(t){return null}},t.prototype.hasField=function(t,e){return this.fieldDefs[t]&&this.fieldDefs[t][e]},t.prototype.getAppModules=function(){var t=[];for(var e in this.moduleDirectory)this.moduleDirectory.hasOwnProperty(e)&&t.push(this.moduleDirectory[e]);return t},t.prototype.getModuleDefs=function(t){return this.moduleDefs[t]?this.moduleDefs[t]:this.moduleDefs[this.getModuleById(t)]},t.prototype.getModuleDuplicatecheck=function(t){try{return"1"===this.moduleDefs[t].duplicatecheck}catch(t){return!1}},t.prototype.getModules=function(){var t=[];for(var e in this.moduleDefs)t.push(e);return t},t.prototype.getGlobalSearchModules=function(){var t=[];for(var e in this.moduleDefs)this.moduleDefs[e].ftsglobalsearch&&t.push(e);return t},t.prototype.getModuleById=function(t){for(var e in this.moduleDefs)if(this.moduleDefs[e].id==t)return e;return""},t.prototype.getModuleIcon=function(t){try{return this.moduleDefs[t].icon}catch(t){return!1}},t.prototype.getModuleSingular=function(e){try{return this.moduleDefs[e].singular}catch(t){return e}},t.prototype.getModuleFromSingular=function(t){var e="";for(var i in this.moduleDefs)this.moduleDefs[i].singular==t&&(e=i);return e},t.prototype.getModuleTrackflag=function(t){try{return!!parseInt(this.moduleDefs[t].track,10)}catch(t){return!1}},t.prototype.getModuleFields=function(t){try{return this.fieldDefs[t]?this.fieldDefs[t]:[]}catch(t){return[]}},t.prototype.getModuleDuplicateCheckFields=function(t){var e=[],i=this.getModuleFields(t);for(var s in i)i[s].duplicatecheck&&e.push(s);return e},t.prototype.getModuleValidations=function(t){try{return this.validationRules[t].validations}catch(t){return[]}},t.prototype.getModuleMenu=function(t){try{var e=[];return this.moduleDefs[t].actionset&&(e=this.getActionSetItems(this.moduleDefs[t].actionset)),e}catch(t){return[]}},t.prototype.getModuleListTypes=function(t){try{return this.moduleDefs[t].listtypes}catch(t){return[]}},t.prototype.addModuleListType=function(t,e){this.moduleDefs[t].listtypes.push(e)},t.prototype.updateModuleListType=function(t,i){this.moduleDefs[t].listtypes.some(function(t){if(t.id==i.id){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return!0}})},t.prototype.deleteModuleListType=function(t,e){var i=this.moduleDefs[t].listtypes.findIndex(function(t){return t.id==e});return 0<=i&&this.moduleDefs[t].listtypes.splice(i,1),this.moduleDefs[t].listtypes},t.prototype.getModuleAggregates=function(t){return this.moduleDefs[t].ftsaggregates},t.prototype.getFieldDefs=function(t,e){try{return this.fieldDefs[t][e]}catch(t){return"varchar"}},t.prototype.checkStatusManaged=function(t){for(var e in this.fieldDefs[t])if(this.getFieldDefs(t,e).options&&this.fieldStatusNetworks[this.getFieldDefs(t,e).options])return{statusField:this.getFieldDefs(t,e).name,statusNetwork:this.fieldStatusNetworks[this.getFieldDefs(t,e).options]};return!1},t.prototype.getFieldType=function(t,e){try{return this.fieldDefs[t][e].type}catch(t){return"varchar"}},t.prototype.getFieldSource=function(t,e){try{return this.fieldDefs[t][e].source}catch(t){return""}},t.prototype.getFieldOptions=function(t,e){try{return this.fieldDefs[t][e].options}catch(t){return!1}},t.prototype.getFieldRequired=function(t,e){try{return this.fieldDefs[t][e].required}catch(t){return!1}},t.prototype.getSystemModules=function(){var t=[];for(var e in this.moduleDirectory)t.push(this.moduleDirectory[e]);return t.sort(function(t,e){return t.module>e.module?1:-1}),t},t.prototype.getSystemModuleByComponent=function(t){for(var e in this.componentDirectory)if(e==t)return this.componentDirectory[e].module;return null},t.prototype.getSystemComponents=function(t){var e=[];for(var i in this.componentDirectory)t&&t!=this.componentDirectory[i].module||e.push(this.componentDirectory[i]);return e.sort(function(t,e){return t.component>e.component?1:-1}),e},t.prototype.getComponentConfigOptions=function(t){try{return this.componentDirectory[t].componentconfig}catch(t){return{}}},t.prototype.getComponentConfigurations=function(t){return void 0===t&&(t="*"),"*"===t?this.componentDefaultConfigs:this.componentModuleConfigs[t]?this.componentModuleConfigs[t]:{}},t.prototype.getComponentConfig=function(t,e,i){return void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=""),""===i&&(i=this.role?this.role:"*"),""!=e&&this.componentModuleConfigs[e]&&this.componentModuleConfigs[e][t]&&this.componentModuleConfigs[e][t][i]?this.componentModuleConfigs[e][t][i]:""!=e&&this.componentModuleConfigs[e]&&this.componentModuleConfigs[e][t]&&this.componentModuleConfigs[e][t]["*"]?this.componentModuleConfigs[e][t]["*"]:this.componentDefaultConfigs[t]&&this.componentDefaultConfigs[t][i]?this.componentDefaultConfigs[t][i]:this.componentDefaultConfigs[t]&&this.componentDefaultConfigs[t]["*"]?this.componentDefaultConfigs[t]["*"]:{}},t.prototype.getModuleDefaultComponentConfigByUsage=function(t,e){var i="";switch(e){case"list":i="ObjectList";break;case"details":i="ObjectRecordDetails"}return this.getComponentConfig(i,t)},t.prototype.getRawActionSets=function(){return this.actionSets},t.prototype.getActionSets=function(t){void 0===t&&(t="");var e=[];for(var i in this.actionSets)""!==t&&this.actionSets[i].module!==t||e.push({id:i,name:this.actionSets[i].name,module:this.actionSets[i].module,type:this.actionSets[i].type,package:this.actionSets[i].package,actions:this.actionSets[i].actions});return e.sort(function(t,e){return t.name>e.name?1:-1}),e},t.prototype.getActionSet=function(t){return this.actionSets[t]},t.prototype.getActionSetItems=function(t){try{return this.actionSets[t].actions}catch(t){return[]}},t.prototype.setActionset=function(t,e){this.actionSets[t].name=e.name,this.actionSets[t].package=e.package},t.prototype.setActionSet=function(t,e){this.actionSets[t]={id:t,module:e.module,name:e.name,package:e.package,version:e.version,actions:e.actions,type:e.type}},t.prototype.setActionSetItems=function(t,e){this.actionSets[t].actions=e},t.prototype.addActionset=function(t,e,i,s,a){void 0===s&&(s="custom"),void 0===a&&(a=[]),this.actionSets[t]={items:a,module:e,name:i,type:s}},t.prototype.removeActionset=function(t){delete this.actionSets[t]},t.prototype.removeActionsetItem=function(t,i){var s=!1;if(this.actionSets[t].items.some(function(t,e){if(t.id==i.id)return s=e,!0}),!1===s)return!1;this.actionSets[t].items.splice(s,1);for(var e=0,a=0,o=this.actionSets[t].items;a<o.length;a++){o[a].sequence=e,e++}return!0},t.prototype.getActionsetName=function(t){try{return this.actionSets[t].name}catch(t){return""}},t.prototype.getModuleFilters=function(t){void 0===t&&(t="");var e=[];for(var i in this.moduleFilters)if(this.moduleFilters.hasOwnProperty(i)){if(""!==t&&this.moduleFilters[i].module!==t)continue;e.push(this.moduleFilters[i])}return e.sort(function(t,e){return t.name-e.name}),e},t.prototype.getModuleFilter=function(t){try{return this.moduleFilters[t]}catch(t){return""}},t.prototype.setModuleFilter=function(t,e,i,s){void 0===s&&(s="custom"),this.moduleFilters||this.configuration.setData("moduleFilters",{}),this.moduleFilters[t]={id:t,name:e,module:i,type:s}},t.prototype.removeModuleFilter=function(t){delete this.moduleFilters[t]},t.prototype.checkModuleAcl=function(t,e){try{return e?this.moduleDefs[t].acl[e]:!!this.moduleDefs[t]}catch(t){return!1}},t.prototype.getRoles=function(){return this.roles},t.prototype.getActiveRole=function(){var e=this,i={};return this.roles&&this.roles.some(function(t){if(e.role==t.id)return i=t,!0}),i},t.prototype.setActiveRole=function(t){this.role=t},t.prototype.getRoleModules=function(t){void 0===t&&(t=!1);var e=[];if(this.rolemodules[this.role])for(var i=0,s=this.rolemodules[this.role];i<s.length;i++){var a=s[i];(!1===t||null!==a.sequence)&&this.moduleDefs[a.module]&&this.moduleDefs[a.module].visible&&(!this.moduleDefs[a.module].visibleaclaction||this.moduleDefs[a.module].visibleaclaction&&this.checkModuleAcl(a.module,this.moduleDefs[a.module].visibleaclaction))&&this.moduleDefs[a.module].acl.list&&e.push(a.module)}return e},t.prototype.getCopyRules=function(t,e){var i=this.copyrules[t]&&this.copyrules[t][e]?this.copyrules[t][e]:[];return i.forEach(function(e){if(e.params&&!_.isObject(e.params))try{e.params=JSON.parse(e.params)}catch(t){e.params={}}}),i},t.prototype.getFieldTypes=function(){var t=[];for(var e in this.fieldTypeMappings)t.push(e);return t},t.prototype.getFieldTypeComponent=function(t){return this.fieldTypeMappings[t]},t.prototype.getRouteDetails=function(o){var t;return null===(t=this.routes)||void 0===t?void 0:t.find(function(t){if(t.path==o)return!0;if(o.split("/").length==t.path.split("/").length){for(var e=o.split("/"),i=t.path.split("/"),s=!0,a=0;a<e.length&&s;)":"!==i[a].substr(0,1)&&i[a]!==e[a]&&(s=!1),a++;if(s)return!0}})},t.prototype.getRouteComponent=function(o){var t;return!!this.routes&&(null===(t=this.routes.find(function(t){if(t.path==o)return!0;if(o.split("/").length==t.path.split("/").length){for(var e=o.split("/"),i=t.path.split("/"),s=!0,a=0;a<e.length&&s;)":"!==i[a].substr(0,1)&&i[a]!==e[a]&&(s=!1),a++;if(s)return!0}}))||void 0===t?void 0:t.component)},t.prototype.checkTagging=function(t){try{return!!this.moduleDefs[t].tagging}catch(t){return!1}},t.prototype.loadLibs=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var s=[];t.forEach(function(t){s.push(e.loadLib(t))});for(var a=new rxjs_1.Subject,o=0,n=0,r=s;n<r.length;n++){r[n].subscribe(function(t){o++},function(t){o++,console.error(t),a.error(t)},function(){o==s.length&&(a.next(),a.complete())})}return o==s.length?rxjs_1.of(a):a.asObservable()},t.prototype.isLibLoaded=function(t){if(this.scripts[t]){for(var e=0,i=this.scripts[t];e<i.length;e++){if(!i[e].loaded)return!1}return!0}return!1},t.prototype.getHtmlStylesheetCode=function(t){return _.isObject(this.htmlStyleData.stylesheets[t])&&_.isString(this.htmlStyleData.stylesheets[t].csscode)?this.htmlStyleData.stylesheets[t].csscode:""},t.prototype.getHtmlFormats=function(t){return _.isObject(this.htmlStyleData.stylesheets[t])?(_.isArray(this.htmlStyleData.stylesheets[t].formats)||(this.htmlStyleData.stylesheets[t].formats=[]),this.htmlStyleData.stylesheets[t].stylesDecoded||this.htmlStylesToObjects(t),this.htmlStyleData.stylesheets[t].formats):(console.log("HTML Styling: Unknown style sheet with ID "+t+"."),[])},t.prototype.getHtmlStylesheetNames=function(){var t=[];for(var e in this.htmlStyleData.stylesheets)t.push({id:this.htmlStyleData.stylesheets[e].id,name:this.htmlStyleData.stylesheets[e].name});return _.sortBy(t,"name")},t.prototype.getHtmlStylesheetToUse=function(t,e){return _.isObject(this.htmlStyleData.stylesheetsToUse[t])&&this.htmlStyleData.stylesheetsToUse[t][e]?this.htmlStyleData.stylesheetsToUse[t][e]:""},t.prototype.handleMessage=function(t){var e=this;switch(t.messagetype){case"loader.completed":"loadRepository"==t.messagedata&&this.addRoutes(),"loadModules"==t.messagedata&&(this.roles.some(function(t){if(1==t.defaultrole)return e.role=t.id,!0}),""===this.role&&0<this.roles.length&&(this.role=this.roles[0].id));break;case"metadata.updatefieldsets":for(var i in t.messagedata.add)this.fieldSets[i]=t.messagedata.add[i];for(var i in t.messagedata.update)this.fieldSets[i]=t.messagedata.update[i];for(var i in t.messagedata.delete)delete this.fieldSets[i];break;case"metadata.updatecomponentsets":for(var s in t.messagedata.add)this.componentSets[s]=t.messagedata.add[s];for(var s in t.messagedata.update)this.componentSets[s]=t.messagedata.update[s];for(var s in t.messagedata.delete)delete this.componentSets[s]}},t.prototype.loadLib=function(e){var i=this,s=new rxjs_1.Subject;if(!this.scripts[e])return rxjs_1.of({script:e,loaded:!1,status:"Unknown"});if(this.isLibLoaded(e))return rxjs_1.of({script:e,loaded:!0,status:"Already Loaded"});if(this.isLibLoading(e))for(var t=0,a=this.scripts[e];t<a.length;t++){var o=a[t];if(o.loading)return o.loading$.subscribe(function(t){return i.loadLib(e).subscribe(function(t){s.next(t),s.complete()})}),s.asObservable()}else{for(var n=0,r=this.scripts[e];n<r.length;n++){var c=r[n];if(!c.loaded)return this.loadScript(c).subscribe(function(t){i.loadLib(e).subscribe(function(t){s.next(t),s.complete()})}),s.asObservable()}s.next({script:e,loaded:!0,status:"Loaded"}),s.complete()}return s.asObservable()},t.prototype.loadScript=function(e){var i=new rxjs_1.Subject;e.loading=!0,e.loading$=new core_1.EventEmitter;var t={};return e.src.endsWith(".css")?((t=document.createElement("link")).rel="stylesheet",t.href=e.src):((t=document.createElement("script")).type="text/javascript",t.src=e.src),t.readyState?t.onreadystatechange=function(){"loaded"!==t.readyState&&"complete"!==t.readyState||(t.onreadystatechange=null,e.loaded=!0,e.loading=!1,i.next({script:e.src,loaded:!0,status:"Loaded"}),i.complete(),e.loading$.emit("loaded"))}:t.onload=function(){e.loaded=!0,e.loading=!1,i.next({script:e.src,loaded:!0,status:"Loaded"}),i.complete(),e.loading$.emit("loaded")},t.onerror=function(t){e.loading=!1,i.error({script:e.src,loaded:!1,status:"Failed"}),e.loading$.emit("failed")},document.getElementsByTagName("head")[0].appendChild(t),i.asObservable()},t.prototype.isLibLoading=function(t){if(this.scripts[t]){for(var e=0,i=this.scripts[t];e<i.length;e++){if(i[e].loading)return!0}return!1}return!1},t.prototype.htmlStylesToObjects=function(t){for(var e=0,i=this.htmlStyleData.stylesheets[t].formats;e<i.length;e++){var s=i[e],a=void 0;if(_.isEmpty(s.styles))s.styles=null;else{try{a=JSON.parse(s.styles)}catch(t){console.log("HTML Styling: Malformed style specification in table sysuihtmlformats (format id: "+s.id+")."),a={}}s.styles=a}}this.htmlStyleData.stylesheets[t].stylesDecoded=!0},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==core_1.NgModuleFactoryLoader&&core_1.NgModuleFactoryLoader)?e:Object,"function"==typeof(i=void 0!==http_1.HttpClient&&http_1.HttpClient)?i:Object,session,configurationService,"function"==typeof(s=void 0!==core_1.ComponentFactoryResolver&&core_1.ComponentFactoryResolver)?s:Object,"function"==typeof(a=void 0!==router_1.Router&&router_1.Router)?a:Object,broadcast,"function"==typeof(o=void 0!==core_1.Compiler&&core_1.Compiler)?o:Object,"function"==typeof(n=void 0!==core_1.Injector&&core_1.Injector)?n:Object])],t)}();exports.metadata=metadata;var aclCheck=function(){function t(t,e,i,s){this.metadata=t,this.router=e,this.session=i,this.configurationService=s}var e;return t.prototype.canActivate=function(t,e){if(!this.session||!this.session.authData.sessionId)return!1;var i=this.configurationService.getSystemParamater("aclcontroller");return!(i&&"spiceacl"!=i&&!("Users"!==t.params.module||t.params.id&&t.params.id==this.session.authData.userId||this.session.authData.admin))&&(!(t.params.module&&"Home"!=t.params.module&&!this.metadata.checkModuleAcl(t.params.module,t.data.aclaction))||(this.router.navigate(["/modules/Home"]),!1))},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,"function"==typeof(e=void 0!==router_1.Router&&router_1.Router)?e:Object,session,configurationService])],t)}();exports.aclCheck=aclCheck;var noBack=function(){function t(t,e){var i=this;this.location=t,this.broadcast=e,this.navigatingBack=!1,this.location.onPopState(function(){i.navigatingBack=!0})}var e;return t.prototype.canDeactivate=function(){return!this.navigatingBack||(this.navigatingBack=!1,history.pushState(null,document.title,location.href),!1)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==common_1.LocationStrategy&&common_1.LocationStrategy)?e:Object,broadcast])],t)}();exports.noBack=noBack;var language=function(){function t(t,e,i,s,a){this.http=t,this.configurationService=e,this.session=i,this.metadata=s,this.cookie=a,this.languagedata={},this._currentlanguage="",this.currentlanguage$=new core_1.EventEmitter,this.inlineEditEnabled=!1}var e;return Object.defineProperty(t.prototype,"currentlanguage",{get:function(){return this._currentlanguage},set:function(t){"string"==typeof t&&null!==t||(t=this.getDefaultLanguage()),this._currentlanguage=t,this.cookie.setValue("spiceuilanguage",t)},enumerable:!1,configurable:!0}),t.prototype.getLanguage=function(t){if(sessionStorage[window.btoa("languageData"+this.session.authData.sessionId)]&&0<sessionStorage[window.btoa("languageData"+this.session.authData.sessionId)].length&&!this.configurationService.data.developerMode){var e=this.session.getSessionData("languageData");this.languagedata=e,""==this.currentlanguage&&(this.currentlanguage=e.languages.default),t.next("getLanguage")}else this.loadLanguage().subscribe(function(){t.next("getLanguage")})},t.prototype.loadLanguage=function(){var i=this,s=new rxjs_1.Subject;""==this.currentlanguage&&this.cookie.getValue("spiceuilanguage")&&(this.currentlanguage=this.cookie.getValue("spiceuilanguage"));var t=this.configurationService.getBackendUrl()+"/system/language";return this.currentlanguage&&(t+="/"+this.currentlanguage),this.http.get(t,{headers:this.session.getSessionHeader(),observe:"response",params:{setPreferences:"1"}}).subscribe(function(t){var e=t.body;i.session.setSessionData("languageData",e),i.languagedata=e,""==i.currentlanguage&&(i.currentlanguage=e.languages.default),i.currentlanguage$.emit(i.currentlanguage),s.next(!0),s.complete()}),s.asObservable()},t.prototype.getLabel=function(e,t,i){void 0===t&&(t=""),void 0===i&&(i="default");try{return""!=t&&void 0!==this.languagedata.mod&&null!=this.languagedata.mod[t]&&this.languagedata.mod[t][e]?this.languagedata.mod[t][e]||e:this.getAppLanglabel(e,i)}catch(t){return e}},t.prototype.getAppLanglabel=function(t,e){return void 0===e&&(e="default"),this.languagedata.applang[t]?"object"==typeof this.languagedata.applang[t]&&this.languagedata.applang[t][e]?this.getNestedLabel(t,e):this.getNestedLabel(t):t},t.prototype.getNestedLabel=function(t,e){var i;if(void 0===e&&(e="default"),this.languagedata.applang[t]&&(_.isObject(this.languagedata.applang[t])?i=this.languagedata.applang[t][e]?this.languagedata.applang[t][e]:this.languagedata.applang[t].default:_.isString(this.languagedata.applang[t])&&(i=this.languagedata.applang[t])),i){var s=this.getNestedTags(i);if(s)for(var a=0,o=s;a<o.length;a++){var n=o[a];i=i.replace("{LABEL:"+n+"}",this.getNestedLabel(n,e))}}return i||t},t.prototype.getNestedTags=function(t){for(var e=t.indexOf("{LABEL:"),i=[];0<=e;)if(0<=e){var s=t.indexOf("}",e);e=0<=s?(i.push(t.substring(e+7,s)),t.indexOf("{LABEL:",s)):-1}return i},t.prototype.getLabelFormatted=function(t,e,i){var s;void 0===i&&(i="default"),s=Array.isArray(e)?e:new Array(e);var a=0;return this.getLabel(t,"",i).replace(/%(s|%)/g,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"s"===t[1]?s[a++]:"%"===t[1]?"%":t[0]})},t.prototype.getModuleName=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i="default");try{var s=this.metadata.getModuleDefs(e);if(t){if(s.singular_label)return this.getLabel(s.singular_label,"",i);if(this.languagedata.applist.moduleListSingular[e])return this.languagedata.applist.moduleListSingular[e]||e}else if(s.module_label)return this.getLabel(s.module_label,"",i);return this.languagedata.applist.moduleList[e]||e}catch(t){return e}},t.prototype.getModuleCombinedLabel=function(t,e){return e?this.languagedata.applang[t+"_"+e.toUpperCase()]?this.getLabel(t+"_"+e.toUpperCase()):this.getLabel(t)+" "+this.getModuleName(e):"no module defined"},t.prototype.getFieldDisplayName=function(t,e,i,s){void 0===i&&(i={}),void 0===s&&(s="default");var a="";if(i.label)if(0<i.label.indexOf(":")){var o=i.label.split(":");a=this.getLabel(o[1],o[0])}else a=this.getLabel(i.label,t,s);else a=this.getLabel(this.metadata.getFieldlabel(t,e),t,s);return""===a?i.label?i.label:e:a},t.prototype.getFieldHelpText=function(t,e,i){void 0===i&&(i={});var s="";if(i.popupHelp)if(0<i.popupHelp.indexOf(":")){var a=i.popupHelp.split(":");s=this.getLabel(a[1],a[0],"default")}else s=this.getLabel(i.popupHelp,t,"default");else s=this.getLabel(this.metadata.getFieldHelpText(t,e),t,"default");return""===s?i.popupHelp?i.popupHelp:e:s},t.prototype.getFieldDisplayOptions=function(t,e,i){void 0===i&&(i=!1);var s=this.metadata.getFieldOptions(t,e);if(!1===s)return[];try{var a=this.languagedata.applist[s];if(i){var o=a;for(var n in a=[],o)a.push({value:n,display:o[n]})}return a}catch(t){return[]}},t.prototype.getDisplayOptions=function(t,e){void 0===e&&(e=!1);var i=this.languagedata.applist[t];if(e){var s=i;for(var a in i=[],s)i.push({value:a,display:s[a]})}return i},t.prototype.getFieldDisplayOptionValue=function(t,e,i){var s=this.metadata.getFieldOptions(t,e);if(!1===s)return i;try{return this.languagedata.applist[s][i]?this.languagedata.applist[s][i]:i}catch(t){return i}},t.prototype.getAvialableLanguages=function(t){void 0===t&&(t=!1);for(var e=[],i=0,s=this.languagedata.languages.available;i<s.length;i++){var a=s[i];(!t||a.system_language&&0!=a.system_language)&&e.push({language:a.language_code,text:a.language_name,system_language:a.system_language,communication_language:a.communication_language,default_language:a.language_code==this.languagedata.languages.default})}return e},t.prototype.addAvailableLanguage=function(e){var i=this,s=!1;this.languagedata.languages.available.some(function(t){if(t.language_code==e.language_code)return t.system_language=e.system_language,t.default_language=e.default_language,e.default_language&&i.setDefaultLanguage(e.language_code),s=!0}),s||this.languagedata.languages.available.push(e)},t.prototype.removeAvailableLanguage=function(t){this.languagedata.languages.available.some(function(t){if(t.language_code==t)return!(t.system_language=!1)})},t.prototype.getDefaultLanguage=function(){return this.languagedata.languages.default},t.prototype.setDefaultLanguage=function(e){var i=this;this.http.post(this.configurationService.getBackendUrl()+"/configuration/syslanguages/setdefault/"+e,{},{headers:this.session.getSessionHeader(),observe:"response"}).subscribe(function(t){t.body.success&&(i.languagedata.languages.default=e)})},t.prototype.getLangText=function(e){var i=e;return this.languagedata.languages.available.some(function(t){if(t.language_code==e)return i=t.language_name,!0}),i},t.prototype.searchLabel=function(t,e){void 0===e&&(e=10);var i=[],s=t.toLowerCase().split(" ");for(var a in this.languagedata.applang){for(var o=!0,n=0,r=s;n<r.length;n++){var c=r[n];if(a.toLocaleLowerCase().indexOf(c)<0){o=!1;break}}if(o&&i.push({label:a,translation:this.getAppLanglabel(a)}),i.length>=e)break}return i},t.prototype.addLabel=function(t,e,i,s){void 0===e&&(e=""),void 0===i&&(i=""),void 0===s&&(s=""),this.languagedata.applang[t]={default:e,long:s,short:i}},t.prototype.compareStrings=function(t,e){return t.localeCompare(e,this._currentlanguage.slice(0,2))},t.prototype.sortArray=function(t,i){var s=this;void 0===i&&(i=!1),t.sort(function(t,e){return s.compareStrings(t,e)*(i?-1:1)})},t.prototype.sortObjects=function(t,i,s){var a=this;void 0===s&&(s=!1),t.sort(function(t,e){return a.compareStrings(t[i],e[i])*(s?-1:1)})},t.prototype.ucFirst=function(t){return t.charAt(0).toLocaleUpperCase(this._currentlanguage.slice(0,2))+t.slice(1)},t.prototype.lcFirst=function(t){return t.charAt(0).toLocaleLowerCase(this._currentlanguage.slice(0,2))+t.slice(1)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==http_1.HttpClient&&http_1.HttpClient)?e:Object,configurationService,session,metadata,cookie])],t)}();exports.language=language,moment.defaultFormat="YYYY-MM-DD HH:mm:ss";var modelutilities=function(){function t(t,e,i){this.metadata=t,this.mathcomp=e,this.session=i}var i;return(i=t).prototype.getRand=function(){return Math.random()},t.prototype.S4=function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},t.prototype.generateGuid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},t.prototype.backendModel2spice=function(t,e){var i=this.metadata.getModuleFields(t);for(var s in i)e[s]&&(e[s]=this.backend2spice(t,s,e[s]));return e},t.prototype.backend2spice=function(t,e,i){var s=this.metadata.getFieldDefs(t,e);if(!s||!s.type)return i;switch(s.type){case"date":if(moment.isMoment(i))return i;var a=moment(i);return a.isValid()?a:null;case"datetime":case"datetimecombo":if(moment.isMoment(i))return i;var o=this.session.getSessionData("timezone")||moment.tz.guess(!0),n="string"==typeof o&&0<o.length?moment.utc(i).tz(o):moment(i);return n.isValid()?n:null;case"double":case"currency":return i?parseFloat(i):0;case"int":return i?parseInt(i,10):0;case"bool":case"boolean":return"1"==i||0<i||1==i;case"json":try{return _.isObject(i)?i:i?JSON.parse(i):{}}catch(t){return{}}case"link":if(_.isObject(i)&&i.beans&&s.module)for(var r in i.beans)i.beans[r]=this.backendModel2spice(s.module,i.beans[r]);return i;default:return i}},t.prototype.spiceModel2backend=function(t,e){var i=__assign({},e),s=this.metadata.getModuleFields(t);for(var a in s)e.hasOwnProperty(a)&&(i[a]=this.spice2backend(t,a,e[a]));return i},t.prototype.spice2backend=function(t,e,i){var s=this.metadata.getFieldDefs(t,e);if(!s||!s.type)return i;switch(s.type){case"date":if("string"!=typeof i)return i&&i._isAMomentObject&&i.isValid()?i.format("YYYY-MM-DD"):"";var a=moment(i);return a.isValid()?a.format("YYYY-MM-DD"):"";case"datetime":case"datetimecombo":if("string"!=typeof i)return i&&i._isAMomentObject&&i.isValid()?moment(i).utc().format("YYYY-MM-DD HH:mm:ss"):"";var o=this.session.getSessionData("timezone")||moment.tz.guess(!0),n="string"==typeof o&&0<o.length?moment(i).tz(o):moment(i);return n.isValid()?n.utc().format("YYYY-MM-DD HH:mm:ss"):"";case"json":return i?JSON.stringify(i):"";case"link":if(_.isObject(i)&&i.beans&&s.module)for(var r in i.beans)i.beans[r]=this.spiceModel2backend(s.module,i.beans[r]);return i;case"bool":case"boolean":return i&&("1"==i||0<i||!0===i)?"1":"0";default:return i}},t.prototype.formatDate=function(t){return moment(t).format("YYYY-MM-DD")},t.prototype.cleanAccountName=function(t){for(var e=t.toLowerCase(),i=(e=e.replace(/[^\w\s]/gi,"")).split(" "),s=0,a=["ag","gmbh","gesmbh","corp","inc"];s<a.length;s++){var o=a[s],n=i.indexOf(o);0<=n&&i.splice(n,1)}return i.join(" ")},t.compare=function(t,e,i){switch(e){case"in":case"between":break;case"empty":return!(0<t.length);case"nempty":return 0<t.length;case"notnull":return null!==t;case"null":return null===t;case"contain":return-1!==t.indexOf(i);case"ncontain":return!(-1!==t.indexOf(i));case"greaterequal":return i<=t;case"greater":return i<t;case"lesserequal":return t<=i;case"lesser":return t<i;case"unequal":return t!=i;case"regex":return new RegExp(i).test(t);case"notregex":return!new RegExp(i).test(t);case"equal":default:return t==i}},t.strtobool=function(t){if("string"!=typeof t)return!1;switch(t.toLowerCase().trim()){case"false":case"no":case"0":case"":return!1;default:return!0}},t.strtomoment=function(t,e){return moment(i.strtotime(t,e),"X")},t.strtotime=function(t,e){var i,s,a,o,n,r,c,u,l,d;if(!t)return!1;t=t.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/[\t\r\n]/g,"").toLowerCase();var h=new RegExp(["^(\\d{1,4})","([\\-\\.\\/:])","(\\d{1,2})","([\\-\\.\\/:])","(\\d{1,4})","(?:\\s(\\d{1,2}):(\\d{2})?:?(\\d{2})?)?","(?:\\s([A-Z]+)?)?$"].join(""));if((s=t.match(h))&&s[2]===s[4])if(1901<s[1])switch(s[2]){case"-":return!(12<s[3]||31<s[5])&&new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3;case".":return!1;case"/":return!(12<s[3]||31<s[5])&&new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3}else if(1901<s[5])switch(s[2]){case"-":case".":return!(12<s[3]||31<s[1])&&new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3;case"/":return!(12<s[1]||31<s[3])&&new Date(s[5],parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3}else switch(s[2]){case"-":return!(12<s[3]||31<s[5]||s[1]<70&&38<s[1])&&(o=0<=s[1]&&s[1]<=38?+s[1]+2e3:s[1],new Date(o,parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3);case".":return 70<=s[5]?!(12<s[3]||31<s[1])&&new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3:s[5]<60&&!s[6]&&(!(23<s[1]||59<s[3])&&(a=new Date,new Date(a.getFullYear(),a.getMonth(),a.getDate(),s[1]||0,s[3]||0,s[5]||0,s[9]||0).getTime()/1e3));case"/":return!(12<s[1]||31<s[3]||s[5]<70&&38<s[5])&&(o=0<=s[5]&&s[5]<=38?+s[5]+2e3:s[5],new Date(o,parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3);case":":return!(23<s[1]||59<s[3]||59<s[5])&&(a=new Date,new Date(a.getFullYear(),a.getMonth(),a.getDate(),s[1]||0,s[3]||0,s[5]||0).getTime()/1e3)}if("now"===t)return null===e||isNaN(e)?(new Date).getTime()/1e3|0:0|e;if(!isNaN(i=Date.parse(t)))return i/1e3|0;if(h=new RegExp(["^([0-9]{4}-[0-9]{2}-[0-9]{2})","[ t]","([0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]+)?)","([\\+-][0-9]{2}(:[0-9]{2})?|z)"].join("")),(s=t.match(h))&&("z"===s[4]?s[4]="Z":s[4].match(/^([+-][0-9]{2})$/)&&(s[4]=s[4]+":00"),!isNaN(i=Date.parse(s[1]+"T"+s[2]+s[4]))))return i/1e3|0;function p(t){var e=t.split(" "),i=e[0],s=e[1].substring(0,3),a=/\d+/.test(i),o=("last"===i?-1:1)*("ago"===e[2]?-1:1);if(a&&(o*=parseInt(i,10)),c.hasOwnProperty(s)&&!e[1].match(/^mon(day|\.)?$/i))return n["set"+c[s]](n["get"+c[s]]()+o);if("wee"===s)return n.setDate(n.getDate()+7*o);if("next"===i||"last"===i)!function(t,e,i){var s,a=r[e];void 0!==a&&(0===(s=a-n.getDay())?s=7*i:0<s&&"last"===t?s-=7:s<0&&"next"===t&&(s+=7),n.setDate(n.getDate()+s))}(i,s,o);else if(!a)return!1;return!0}if(n=e?new Date(1e3*e):new Date,r={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6},c={yea:"FullYear",mon:"Month",day:"Date",hou:"Hours",min:"Minutes",sec:"Seconds"},"([+-]?\\d+\\s"+(l="(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)")+"|(last|next)\\s"+l+")(\\sago)?",!(s=t.match(new RegExp("([+-]?\\d+\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)|(last|next)\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?))(\\sago)?","gi"))))return!1;for(d=0,u=s.length;d<u;d++)if(!p(s[d]))return!1;return n.getTime()/1e3},t.prototype.http_build_query=function(t,e,i){void 0===e&&(e=""),void 0===i&&(i="&");var s=[],o=function(t,e,i){var s=[];if(!0===e?e="1":!1===e&&(e="0"),null===e)return"";if("object"==typeof e){for(var a in e)null!==e[a]&&s.push(o(t+"["+a+"]",e[a],i));return s.join(i)}if("function"!=typeof e)return encodeURIComponent(t)+"="+encodeURIComponent(e);throw new Error("There was an error processing for http_build_query().")};for(var a in i=i||"&",t){var n=t[a];e&&!isNaN(parseFloat(a))&&(a=String(e)+a);var r=o(a,n,i);""!==r&&s.push(r)}return s.join(i)},t.prototype.compileMathExpression=function(t){try{return this.mathcomp.do(t)}catch(t){return console.warn(t),!1}},t.prototype.timezoneChanged=function(t,e){for(var i in t)if(_.isObject(t[i]))if(t[i]&&t[i]._isAMomentObject)t[i]._isUTC&&t[i].tz(e);else if(t[i].beans&&_.isObject(t[i].beans))for(var s in t[i].beans)this.timezoneChanged(t[i].beans[s],e)},t=i=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,MathExpressionCompilerService,session])],t)}();exports.modelutilities=modelutilities;var toast=function(){function t(t,e){this.modelutilities=t,this.appref=e,this.activeToasts=[]}var e;return t.prototype.sendToast=function(t,e,i,s,a){return void 0===e&&(e="default"),void 0===i&&(i=""),void 0===s&&(s=!0),this.addToast(t,"toast",e,i,s,a)},t.prototype.sendAlert=function(t,e,i,s,a){return void 0===e&&(e="default"),void 0===i&&(i=""),void 0===s&&(s=!0),this.addToast(t,"alert",e,i,s,a)},t.prototype.addToast=function(t,e,i,s,a,o){var n=this;if(void 0===e&&(e="toast"),void 0===i&&(i="default"),void 0===s&&(s=""),void 0===a&&(a=!0),o&&0<this.activeToasts.filter(function(t){return t.code==o}).length)return"";"error"===i&&(a=!1),!0===a&&(a=5);var r=this.modelutilities.generateGuid();return this.activeToasts.push({id:r,type:i,theme:e,text:t,description:s,code:o}),this.appref.tick(),a&&window.setTimeout(function(){return n.clearToast(r)},1e3*a),r},t.prototype.clearToast=function(i){var s=this;i&&this.activeToasts.some(function(t,e){if(t.id===i)return s.activeToasts.splice(e,1),s.appref.tick(),!0})},t.prototype.clearAll=function(){this.activeToasts=[],this.appref.tick()},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,"function"==typeof(e=void 0!==core_1.ApplicationRef&&core_1.ApplicationRef)?e:Object])],t)}();exports.toast=toast;var modalwindow=function(){function t(){}return t=__decorate([core_1.Injectable()],t)}();exports.modalwindow=modalwindow;var modal=function(){function t(t,e,i,s){var a=this;this.metadata=t,this.footer=e,this.toast=i,this.language=s,this.modalsArray=[],this.modalsObject={},window.addEventListener("keyup",function(t){if(27===t.keyCode&&a.modalsArray.length){t.stopImmediatePropagation();var e=a.modalsArray[a.modalsArray.length-1].wrapper;!e.instance.escKey||e.instance.childComponent.instance.onModalEscX&&!1===e.instance.childComponent.instance.onModalEscX()||e.destroy()}})}return t.prototype.openModal=function(s,t,a,o){var n=this;if(void 0===t&&(t=!0),this.metadata.checkComponent(s)){var r=new rxjs_1.Subject;return this.metadata.addComponentDirect("SystemModalWrapper",this.footer.modalcontainer).subscribe(function(e){var i={};i.wrapper=e,i.blurBackdrop=o,e.instance.escKey=t,n.modalsArray.push(i),n.modalsObject[i.modalId]=i,n.metadata.addComponentDirect(s,e.instance.target,a).subscribe(function(t){t.instance.self=e,i.component=t,e.instance.childComponent=t,r.next(t),r.complete()},function(t){n.removeModal(e),n.sendError(s),r.error(t),r.complete()}),e.instance.zIndex=2*n.modalsArray.length+1}),r.asObservable()}return this.sendError(s),rxjs_1.of(!1)},t.prototype.sendError=function(t){this.toast.sendToast('Component "'+t+'" not found.',"error","Misconfiguration on the system as the component should have been opened in a modal but is not available. Please contact your system administrator.")},t.prototype.removeModal=function(t){for(var e=0;e<this.modalsArray.length;e++)if(this.modalsArray[e].wrapper===t){this.modalsArray.splice(e,1);break}},t.prototype.closeModal=function(t){if("number"==typeof t)this.modalsArray[t]&&this.modalsArray[t].wrapper.destroy();else for(var e=0;e<this.modalsArray.length;e++)if(this.modalsArray[e].wrapper===t){this.modalsArray.splice(e,1);break}},t.prototype.closeAllModals=function(){for(var t=this.modalsArray.length-1;0<=t;t--)this.modalsArray[t].wrapper.destroy()},Object.defineProperty(t.prototype,"backdropVisible",{get:function(){return 0!==this.modalsArray.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"backdropZindex",{get:function(){return 2*this.modalsArray.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"backdropBlurred",{get:function(){return 0<this.modalsArray.length&&!0===this.modalsArray[this.modalsArray.length-1].blurBackdrop?"blur(4px)":"none"},enumerable:!1,configurable:!0}),t.prototype.prompt=function(e,i,s,a,o,n,r){void 0===s&&(s=null),void 0===a&&(a="shade"),void 0===o&&(o=null),void 0===n&&(n=null);var c=new rxjs_1.Subject;return this.openModal("SystemPrompt").subscribe(function(t){t.instance.type=e,t.instance.text=i,t.instance.headertext=s,t.instance.theme=a,t.instance.value=o,t.instance.options=n,t.instance.optionsAsRadio=r,t.instance.answer.subscribe(function(t){c.next(t),c.complete()})}),c.asObservable()},t.prototype.confirm=function(t,e,i){return void 0===e&&(e=null),void 0===i&&(i=null),this.prompt("confirm",t,e,i)},t.prototype.confirmDeleteRecord=function(){return this.prompt("confirm",this.language.getLabel("LBL_DELETE_RECORD","","long"),this.language.getLabel("LBL_DELETE_RECORD"))},t.prototype.input=function(t,e,i,s){return void 0===e&&(e=null),void 0===i&&(i=null),void 0===s&&(s=null),this.prompt("input",t,e,i,s)},t.prototype.info=function(t,e,i){return void 0===e&&(e=null),void 0===i&&(i=null),this.prompt("info",t,e,i)},t.prototype.await=function(e){void 0===e&&(e=null);var i=new core_1.EventEmitter;return this.openModal("SystemLoadingModal",!1).subscribe(function(t){t.instance.messagelabel=e,i.subscribe(function(){t.instance.self.destroy()})}),i},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,footer,toast,language])],t)}();exports.modal=modal;var helper=function(){function t(t){this.modalservice=t,this.dialog=null,this._base64_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}return t.prototype.getRand=function(){return Math.random()},t.prototype.S4=function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},t.prototype.generateGuid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},t.prototype.confirm=function(t,e){var i=new rxjs_1.Subject;return this.modalservice.confirm(e,t).subscribe(function(t){i.next(t),i.complete()}),i.asObservable()},t.prototype.shuffle=function(t){for(var e,i,s=t.length;s;)i=Math.floor(Math.random()*s--),e=t[s],t[s]=t[i],t[i]=e;return t},t.prototype.encodeBase64=function(t){var e,i,s,a,o,n,r,c="",u=0;for(t=this._utf8_encodeBase64(t);u<t.length;)a=(e=t.charCodeAt(u++))>>2,o=(3&e)<<4|(i=t.charCodeAt(u++))>>4,n=(15&i)<<2|(s=t.charCodeAt(u++))>>6,r=63&s,isNaN(i)?n=r=64:isNaN(s)&&(r=64),c=c+this._base64_keyStr.charAt(a)+this._base64_keyStr.charAt(o)+this._base64_keyStr.charAt(n)+this._base64_keyStr.charAt(r);return c},t.prototype.decodeBase64=function(t){var e,i,s,a,o,n,r="",c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)e=this._base64_keyStr.indexOf(t.charAt(c++))<<2|(a=this._base64_keyStr.indexOf(t.charAt(c++)))>>4,i=(15&a)<<4|(o=this._base64_keyStr.indexOf(t.charAt(c++)))>>2,s=(3&o)<<6|(n=this._base64_keyStr.indexOf(t.charAt(c++))),r+=String.fromCharCode(e),64!=o&&(r+=String.fromCharCode(i)),64!=n&&(r+=String.fromCharCode(s));return r=this._utf8_decodeBase64(r)},t.prototype._utf8_encodeBase64=function(t){var e="";t=t.replace(/\r\n/g,"\n");for(var i=0;i<t.length;i++){var s=t.charCodeAt(i);s<128?e+=String.fromCharCode(s):(127<s&&s<2048?e+=String.fromCharCode(s>>6|192):(e+=String.fromCharCode(s>>12|224),e+=String.fromCharCode(s>>6&63|128)),e+=String.fromCharCode(63&s|128))}return e},t.prototype._utf8_decodeBase64=function(t){for(var e="",i=0,s=0,a=0,o=0;i<t.length;)(s=t.charCodeAt(i))<128?(e+=String.fromCharCode(s),i++):191<s&&s<224?(a=t.charCodeAt(i+1),e+=String.fromCharCode((31&s)<<6|63&a),i+=2):(a=t.charCodeAt(i+1),o=t.charCodeAt(i+2),e+=String.fromCharCode((15&s)<<12|(63&a)<<6|63&o),i+=3);return e},t.prototype.determineFileIcon=function(t){var e;if(t){var i,s;if(i=(e=t.split("/"))[0],s=e[1],!i)return"unknown";switch(i){case"image":case"png":case"jpeg":return"image";case"text":switch(s){case"html":return"html";default:return"txt"}case"audio":return"audio";case"video":return"video"}switch(s){case"xml":return"xml";case"pdf":return"pdf";case"vnd.ms-excel":case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":return"excel";case"vnd.openxmlformats-officedocument.wordprocessingml.document":case"vnd.oasis.opendocument.text":return"word";case"vnd.oasis.opendocument.presentation":case"vnd.openxmlformats-officedocument.presentationml.presentation":return"ppt";case"x-zip-compressed":return"zip";case"x-msdownload":return"exe"}}return"unknown"},t.prototype.humanFileSize=function(t){var e=t;if(Math.abs(t)<1024)return e+" B";for(var i=["kB","MB","GB","TB","PB","EB","ZB","YB"],s=-1;e/=1024,++s,1024<=Math.abs(e)&&s<i.length-1;);return e.toFixed(1)+" "+i[s]},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modal])],t)}();exports.helper=helper;var googleapiloader=function(){function t(t,e){this.broadcast=t,this.configuration=e,this.apis=[]}return t.prototype._loadScript=function(){var t=document.createElement("script");t.async=!0,t.defer=!0,t.src="https://maps.googleapis.com/maps/api/js?callback=__onGoogleLoaded&key="+this.configuration.data.googleAPI,t.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(t)},t.prototype.isApiLoaded=function(){return!(!window.google||!window.google.maps)},t.prototype.loadApi=function(){var i=this;this._apiLoadingPromise||(this._apiLoadingPromise=new Promise(function(e){window.__onGoogleLoaded=function(t){e("google maps api loaded"),i.broadcast.broadcastMessage("googleapiloader.maps")},i._loadScript()}))},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[broadcast,configurationService])],t)}();exports.googleapiloader=googleapiloader;var libloader=function(){function t(t){this.configuration=t,this.loadedLibs=[],this.loadedLibs$=new core_1.EventEmitter,this.loadedDirect=[]}return Object.defineProperty(t.prototype,"scripts",{get:function(){return this.configuration.getData("scripts")},enumerable:!1,configurable:!0}),t.prototype.loadLibs=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var s=[];t.forEach(function(t){s.push(e.loadLib(t))});for(var a=new rxjs_1.Subject,o=0,n=0,r=s;n<r.length;n++){r[n].subscribe(function(t){++o==s.length&&(a.next(),a.complete())},function(t){o++,a.error(t)})}return o==s.length?rxjs_1.of(a):a.asObservable()},t.prototype.loadLib=function(e){var i=this;if(this.scripts[e]){if(this.isLibLoaded(e))return rxjs_1.of({script:e,loaded:!0,status:"Already Loaded"});if(this.isLibLoading(e))return this.loadedLibs$;this.loadedLibs.push({name:e,status:"loading"});var s=new rxjs_1.Subject;return this.loadScriptsDirect(this.scripts[e]).then(function(t){s.next({script:e,loaded:!0,status:"Loaded"}),s.complete(),i.loadedLibs.find(function(t){return t.name==e}).status="loaded",i.loadedLibs$.emit({script:e,loaded:!0,status:"Loaded"})},function(t){s.error({script:e,loaded:!1,status:"error"}),s.complete(),i.loadedLibs.find(function(t){return t.name==e}).status="error",i.loadedLibs$.emit({script:e,loaded:!0,status:"error"})}),s.asObservable()}return rxjs_1.of({script:e,loaded:!1,status:"Unknown"})},t.prototype.loadScriptsDirect=function(n){return __awaiter(this,void 0,void 0,function(){var e,i,s,a,o;return __generator(this,function(t){switch(t.label){case 0:e=new rxjs_1.Subject,s=i=0,a=n,t.label=1;case 1:return s<a.length?(o=a[s],[4,this.loadScriptDirect(o.src).then(function(t){++i==n.length&&(e.next({script:name,loaded:!0,status:"Loaded"}),e.complete())},function(t){e.error({script:name,loaded:!1,status:"error"}),e.complete()})]):[3,4];case 2:t.sent(),t.label=3;case 3:return s++,[3,1];case 4:return[2,e.toPromise()]}})})},t.prototype.loadFromSource=function(e){for(var i=new rxjs_1.Subject,s=0,t=0,a=e;t<a.length;t++){var o=a[t];this.loadScriptDirect(o).then(function(t){++s==e.length&&(i.next(!0),i.complete())},function(t){i.error(!1),i.complete()})}return i.asObservable()},t.prototype.loadScriptDirect=function(s){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(t){return-1!=this.loadedDirect.indexOf(s)?[2,rxjs_1.of(!0).toPromise()]:(e=new rxjs_1.Subject,i={},s.endsWith(".css")?((i=document.createElement("link")).rel="stylesheet",i.href=s):((i=document.createElement("script")).type="text/javascript",i.src=s),i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,e.next(!0),e.complete())}:i.onload=function(){e.next(!0),e.complete()},i.onerror=function(t){e.error(!1),e.complete()},document.getElementsByTagName("head")[0].appendChild(i),[2,e.toPromise()])})})},t.prototype.isLibLoaded=function(e){return!!this.loadedLibs.find(function(t){return t.name==e&&"loaded"==t.status})},t.prototype.isLibLoading=function(e){return!!this.loadedLibs.find(function(t){return t.name==e&&"loading"==t.status})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService])],t)}();exports.libloader=libloader;var backend=function(){function t(t,e,i,s,a,o,n,r,c,u){this.toast=t,this.http=e,this.sanitizer=i,this.configurationService=s,this.session=a,this.metadata=o,this.router=n,this.modelutilities=r,this.modalservice=c,this.language=u,this.autoLogout={},this.reLogin=!1,this.reConnecting=!1,this.stageRequests=!1,this.stagedRequests=[],this.httpErrorsToReport=[],this.httpErrorReporting=!1,this.httpErrorReportingRetryTime=1e4}var e,i,s;return t.prototype.getHeaders=function(){var t=this.session.getSessionHeader();return t=t.set("Accept","application/json")},t.prototype.prepareParams=function(i){var s=new http_1.HttpParams;return i&&Object.keys(i).forEach(function(t){var e=i[t];null!=e&&(s="object"==typeof e?s.append(t,JSON.stringify(e)):"boolean"==typeof e?s.append(t,!0===e?"1":"0"):"number"==typeof e?s.append(t,e+""):s.append(t,e.toString()))}),s},t.prototype.getRequest=function(e,i,s){var a=this;return void 0===e&&(e=""),void 0===i&&(i={}),s=s||new rxjs_1.Subject,this.stageRequests?this.stageRequest("GET",e,{getParams:i},s):this.http.get(this.configurationService.getBackendUrl()+"/"+encodeURI(e),{headers:this.getHeaders(),observe:"response",params:this.prepareParams(i)}).subscribe(function(t){s.next(t.body),s.complete()},function(t){0==a.handleError(t,e,"GET",{getParams:i},s)&&s.error(t)}),s.asObservable()},t.prototype.getRawRequest=function(t,e,i,s){void 0===t&&(t=""),void 0===e&&(e={}),void 0===i&&(i="blob"),void 0===s&&(s={});var a=this.session.getSessionHeader();for(var o in s)a=a.set(o,s[o]);return this.http.get(this.configurationService.getBackendUrl()+"/"+t,{headers:a,params:this.prepareParams(e),responseType:"blob"})},t.prototype.postRequest=function(e,i,s,a){var o=this;if(void 0===e&&(e=""),void 0===i&&(i={}),void 0===s&&(s={}),a=a||new rxjs_1.Subject,this.stageRequests)this.stageRequest("GET",e,{getParams:i,body:s},a);else{var t=this.getHeaders();t=s?t.set("Content-Type","application/json"):t.set("Content-Type","application/x-www-form-urlencoded"),this.http.post(this.configurationService.getBackendUrl()+"/"+encodeURI(e),s,{headers:t,observe:"response",params:this.prepareParams(i)}).subscribe(function(t){a.next(t.body),a.complete()},function(t){o.handleError(t,e,"POST",{getParams:i,body:s},a)||a.error(t)})}return a.asObservable()},t.prototype.patchRequest=function(e,i,s,a){var o=this;if(void 0===e&&(e=""),void 0===i&&(i={}),void 0===s&&(s={}),a=a||new rxjs_1.Subject,this.stageRequests)this.stageRequest("PATCH",e,{getParams:i,body:s},a);else{var t=this.getHeaders();t=s?t.set("Content-Type","application/json"):t.set("Content-Type","application/x-www-form-urlencoded"),this.http.patch(this.configurationService.getBackendUrl()+"/"+encodeURI(e),s,{headers:t,observe:"response",params:this.prepareParams(i)}).subscribe(function(t){a.next(t.body),a.complete()},function(t){o.handleError(t,e,"POST",{getParams:i,body:s},a)||a.error(t)})}return a.asObservable()},t.prototype.postRequestWithProgress=function(e,i,s,a,o){var n=this;if(void 0===e&&(e=""),void 0===i&&(i={}),void 0===s&&(s={}),void 0===a&&(a=null),o=o||new rxjs_1.Subject,this.stageRequests)this.stageRequest("POSTWITHPROGRESS",e,{getParams:i,body:s,progress:a},o);else{var t=this.getHeaders();t=s?t.set("Content-Type","application/json"):t.set("Content-Type","application/x-www-form-urlencoded"),null!==a&&a.next(0),this.http.post(this.configurationService.getBackendUrl()+"/"+encodeURI(e),s,{headers:t,observe:"events",params:this.prepareParams(i),reportProgress:!!a}).subscribe(function(t){t.type===http_1.HttpEventType.UploadProgress?a.next(100*t.loaded/t.total):t.type===http_1.HttpEventType.Response&&(o.next(t.body),o.complete())},function(t){n.handleError(t,e,"POSTWITHPROGRESS",{getParams:i,body:s,progress:a},o)||o.error(t)})}return o.asObservable()},t.prototype.getDownloadPostRequestFile=function(i,s,a){var o=this;void 0===i&&(i=""),void 0===s&&(s={}),void 0===a&&(a={});var n=new rxjs_1.Subject,t=this.getHeaders();return t=t.set("Accept","*/*"),this.http.post(this.configurationService.getBackendUrl()+"/"+i,a,{headers:t,observe:"response",params:this.prepareParams(s),responseType:"blob"}).subscribe(function(t){var e=window.URL.createObjectURL(t.body);n.next(e),n.complete()},function(t){o.handleError(t,i,"POST",{getParams:s,body:a});var e=new FileReader;e.readAsText(t.error),e.onloadend=function(t){n.error(JSON.parse(e.result.toString()))}}),n.asObservable()},t.prototype.getLinkToDownload=function(e,i,s,a,t){var o=this;void 0===i&&(i="GET"),void 0===s&&(s=null),void 0===a&&(a=null),void 0===t&&(t=null);var n=new rxjs_1.Subject,r=this.getHeaders();return r=r.set("Accept","*/*"),this.http.request(i,this.configurationService.getBackendUrl()+"/"+e,{body:a,headers:r,observe:"response",params:this.prepareParams(s),responseType:"blob"}).subscribe(function(t){if(200==t.status){var e=window.URL.createObjectURL(t.body);n.next(e),n.complete()}else n.error(t.statusText)},function(t){o.handleError(t,e,i,{getParams:s,body:a}),n.error(t)}),n.asObservable()},t.prototype.downloadFile=function(t,s,a){void 0===s&&(s=null),void 0===a&&(a=null);var o=new rxjs_1.Subject;return this.getLinkToDownload(t.route,t.method,t.params,t.body,t.headers).subscribe(function(t){var e=t,i=document.createElement("a");document.body.appendChild(i),i.href=e,a&&(i.type=a),i.download=s,i.click(),i.remove(),o.next(),o.complete()},function(t){return o.error(t)}),o.asObservable()},t.prototype.putRequest=function(e,i,s,a){var o=this;return void 0===e&&(e=""),void 0===i&&(i={}),void 0===s&&(s={}),a=a||new rxjs_1.Subject,this.stageRequests?this.stageRequest("PUT",e,{getParams:i,body:s},a):this.http.put(this.configurationService.getBackendUrl()+"/"+e,s,{headers:this.getHeaders(),observe:"response",params:this.prepareParams(i)}).subscribe(function(t){a.next(t.body),a.complete()},function(t){o.handleError(t,e,"PUT",{getParams:i,body:s},a)||a.error(t)}),a.asObservable()},t.prototype.deleteRequest=function(e,i,s){var a=this;return void 0===e&&(e=""),void 0===i&&(i={}),s=s||new rxjs_1.Subject,this.stageRequests?this.stageRequest("DELETE",e,{getParams:i},s):this.http.delete(this.configurationService.getBackendUrl()+"/"+e,{headers:this.getHeaders(),params:this.prepareParams(i)}).subscribe(function(t){s.next(t||!0),s.complete()},function(t){a.handleError(t,e,"DELETE",{getParams:i},s),s.error(t)}),s.asObservable()},t.prototype.handleError=function(t,e,i,s,a){var o=this;switch(void 0===s&&(s=null),t.status){case 401:return this.stageRequest(i,e,s,a),this.stageRequests=!0,this.reLogin||(this.reLogin=!0,this.modalservice.openModal("GlobalReLogin",!1,null,!0).subscribe(function(t){t.instance.loggedin.subscribe(function(t){t&&(o.reLogin=!1,o.stageRequests=!1,o.processStagedRequests())})})),!0;case 0:return this.stageRequest(i,e,s,a),this.stageRequests=!0,this.reConnecting||(this.reConnecting=!0,this.modalservice.openModal("GlobalReConnect",!1,null,!0).subscribe(function(t){t.instance.connected.subscribe(function(t){t&&(o.reConnecting=!1,o.stageRequests=!1,o.processStagedRequests())})})),!0}return!1},t.prototype.stageRequest=function(t,e,i,s){this.stagedRequests.push({method:t,route:e,data:i,responseSubject:s})},t.prototype.processStagedRequests=function(){for(var t=0,e=this.stagedRequests;t<e.length;t++){var i=e[t];switch(i.method){case"GET":this.getRequest(i.route,i.data.getParams,i.responseSubject);break;case"POST":this.postRequest(i.route,i.data.getParams,i.data.body,i.responseSubject);break;case"PATCH":this.patchRequest(i.route,i.data.getParams,i.data.body,i.responseSubject);break;case"POSTWITHPROGRESS":this.postRequestWithProgress(i.route,i.data.getParams,i.data.body,i.data.progress,i.responseSubject);break;case"PUT":this.putRequest(i.route,i.data.getParams,i.data.body,i.responseSubject);break;case"DELETE":this.deleteRequest(i.route,i.data.getParams,i.responseSubject)}}this.stagedRequests=[]},t.prototype.reportError=function(t,e,i,s){var a=this;this.httpErrorsToReport.push({clientTime:(new Date).toISOString(),clientInfo:{sessionId:this.session.authData.sessionId,userId:this.session.authData.userId,userName:this.session.authData.userName},route:e,method:i,getParams:s.getParams?s.getParams:null,error:t,body:s.body?s.body:null}),this.httpErrorReporting||(this.httpErrorReporting=!0,window.setTimeout(function(){return a.errorsToBackend()},this.httpErrorReportingRetryTime))},t.prototype.errorsToBackend=function(){var e=this;this.httpErrorsToReport.length&&this.postRequest("system/httperrors",null,{errors:this.httpErrorsToReport}).subscribe(function(){e.httpErrorsToReport.length=0,e.httpErrorReporting=!1},function(t){e.httpErrorReporting=!0,window.setTimeout(function(){return e.errorsToBackend()},e.httpErrorReportingRetryTime)})},t.prototype.get=function(i,t,e){var s=this;void 0===e&&(e="");var a=new rxjs_1.Subject,o={};return e&&(o.trackaction=e),this.getRequest("module/"+i+"/"+t,o).subscribe(function(t){for(var e in t)t[e]=s.backend2spice(i,e,t[e]);a.next(t),a.complete()},function(t){a.error(t),a.complete()}),a.asObservable()},t.prototype.getDuplicates=function(t,e){var i=new rxjs_1.Subject;return this.getRequest("module/"+t+"/"+e+"/duplicates").subscribe(function(t){i.next(t),i.complete()}),i.asObservable()},t.prototype.checkDuplicates=function(t,e){var i=new rxjs_1.Subject;return this.postRequest("module/"+t+"/duplicates",{},e).subscribe(function(t){i.next(t),i.complete()}),i.asObservable()},t.prototype.getList=function(s,t,e){var a=this;void 0===t&&(t=[]),void 0===e&&(e={});var o=new rxjs_1.Subject,i=(e.start&&e.start,e.limit&&e.limit,e);return i.searchfields=e.searchfields,i.offset=e.start?e.start:0,i.limit=e.limit?e.limit:25,e.listid&&(i.listid=e.listid),0<t.length&&(i.sortfields=t),this.getRequest("module/"+s,i).subscribe(function(t){try{for(var e in t.list)for(var i in t.list[e])t.list[e][i]=a.backend2spice(s,i,t.list[e][i])}catch(t){o.next([]),o.complete()}o.next(t),o.complete()},function(t){o.error(t),o.complete()}),o.asObservable()},t.prototype.save=function(e,t,i,s,a){var o=this;void 0===s&&(s=null),void 0===a&&(a=null);var n=new rxjs_1.Subject;return this.postRequestWithProgress("module/"+e+"/"+t,{templateId:a},this.modelutilities.spiceModel2backend(e,i),s).subscribe(function(t){n.next(o.modelutilities.backendModel2spice(e,t)),n.complete()},function(t){n.error(t),n.complete()}),n.asObservable()},t.prototype.backend2spice=function(t,e,i){return this.modelutilities.backend2spice(t,e,i)},t.prototype.spice2backend=function(t,e,i){return this.modelutilities.spice2backend(t,e,i)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[toast,"function"==typeof(e=void 0!==http_1.HttpClient&&http_1.HttpClient)?e:Object,"function"==typeof(i=void 0!==platform_browser_1.DomSanitizer&&platform_browser_1.DomSanitizer)?i:Object,configurationService,session,metadata,"function"==typeof(s=void 0!==router_1.Router&&router_1.Router)?s:Object,modelutilities,modal,language])],t)}();exports.backend=backend;var recent=function(){function t(t,e,i,s){var a=this;this.backend=t,this.broadcast=e,this.configuration=i,this.session=s,this.moduleItems={},this.broadcast.message$.subscribe(function(t){return a.handleMessage(t)})}return Object.defineProperty(t.prototype,"items",{get:function(){var t=this.configuration.getData("recentitmes");return t||[]},enumerable:!1,configurable:!0}),t.prototype.handleMessage=function(e){switch(e.messagetype){case"model.save":var t=this.items.find(function(t){return t.module_name==e.messagedata.module&&t.item_id==e.messagedata.id});if(t&&(t.data=e.messagedata.data,t.item_summary=e.messagedata.data.summary_text),this.moduleItems[e.messagedata.module]){var i=this.moduleItems[e.messagedata.module].find(function(t){return t.module_name==e.messagedata.module&&t.item_id==e.messagedata.id});i&&(i.data=e.messagedata.data,i.item_summary=e.messagedata.data.summary_text)}break;case"model.delete":var s=this.items.findIndex(function(t){return t.module_name==e.messagedata.module&&t.item_id==e.messagedata.id});if(s&&this.items.splice(s,1),this.moduleItems[e.messagedata.module]){var a=this.moduleItems[e.messagedata.module].findIndex(function(t){return t.module_name==e.messagedata.module&&t.item_id==e.messagedata.id});a&&this.items.splice(a,1)}}},t.prototype.trackItem=function(i,s,t){var a=this;for(this.items.some(function(t,e){if(t.module_name===i&&t.item_id==s)return a.items.splice(e,1),!0}),this.items.splice(0,0,{item_id:s,module_name:i,item_summary:t.summary_text,data:t});50<this.items.length;)this.items.pop();if(this.moduleItems[i])for(this.moduleItems[i].some(function(t,e){if(t.item_id==s)return a.moduleItems[i].splice(e,1),!0}),this.moduleItems[i].splice(0,0,{item_id:s,module_name:i,item_summary:t.summary_text,data:t});5<this.moduleItems[i].length;)this.moduleItems[i].pop()},t.prototype.getModuleRecent=function(a){var o=this;if("Home"==a)return rxjs_1.of(this.items.slice(0,5));if(this.moduleItems[a])return rxjs_1.of(this.moduleItems[a]);var n=new rxjs_1.Subject;return this.moduleItems[a]||this.backend.getRequest("module/Trackers/recent",{module:a,limit:5}).subscribe(function(t){o.moduleItems[a]=[];for(var e=0,i=t;e<i.length;e++){var s=i[e];o.moduleItems[a].push(s)}n.next(o.moduleItems[a]),n.complete()}),n.asObservable()},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],t)}();exports.recent=recent;var userpreferences=function(){function t(t,e,i,s,a,o,n){var r=this;this.backend=t,this.toast=e,this.configuration=i,this.language=s,this.broadcast=a,this.modalservice=o,this.session=n,this.preferences={global:{}},this.unchangedPreferences={global:{}},this.preferencesComplete=!0,this.defaults={currency:-99,datef:"d.m.Y",dec_sep:",",num_grp_sep:".",timef:"H:i",timezone:"Europe/Vienna",default_currency_significant_digits:2,default_locale_name_format:"l, f",week_day_start:0,navigation_paradigm:"simple",distance_unit_system:"METRIC"},this.formats={nameFormats:[],loaded:!1},this.preferences$=new core_1.EventEmitter,this.toUse=this.preferences.global,this.broadcast.message$.subscribe(function(t){"loader.completed"===t.messagetype&&"loadUserData"===t.messagedata&&r.retrievePrefsFromConfigService()})}return t.prototype.retrievePrefsFromConfigService=function(){var t=this.configuration.getData("globaluserpreferences");this.preferences.global=_.extendOwn(this.preferences.global,t),this.unchangedPreferences.global=_.clone(t),this.defaults=_.extendOwn(this.defaults,this.configuration.getData("defaultuserpreferences")),this.askForMissingPreferences(),this.completePreferencesWithDefaults(),this.session.setTimezone(this.toUse.timezone)},t.prototype.getPreferences=function(e){this.loadPreferences().subscribe(function(t){e.next("getPreferences")})},t.prototype.loadPreferences=function(e){var i=this;void 0===e&&(e="global");var s=new rxjs_1.Subject;return this.backend.getRequest("module/Users/"+this.session.authData.userId+"/preferences/"+e).subscribe(function(t){i.preferences[e]=_.extendOwn(i.preferences[e],t),"global"===e?(i.unchangedPreferences.global=_.clone(t),i.completePreferencesWithDefaults(),i.session.setTimezone(i.toUse.timezone)):i.unchangedPreferences[e]=_.clone(t),s.next(t)}),s.asObservable()},t.prototype.completePreferencesWithDefaults=function(){var i=this,s=!1;_.each(this.defaults,function(t,e){"string"==typeof i.preferences.global[e]?i.preferences.global[e]||(i.preferences.global[e]=t,s=!0):void 0!==i.preferences.global[e]&&null!==i.preferences.global[e]||(i.preferences.global[e]=t,s=!0)}),this.preferencesComplete=!s},t.prototype.getPreference=function(t,e){void 0===e&&(e="global");try{return this.preferences[e][t]}catch(t){return!1}},t.prototype.setPreference=function(e,i,t,s){var a=this;if(void 0===t&&(t=!0),void 0===s&&(s="global"),t){var o={};o[e]=i;var n=new rxjs_1.Subject;return this.backend.postRequest("module/Users/"+this.session.authData.userId+"/preferences/"+s,{},o).subscribe(function(t){a.preferences[s]||(a.preferences[s]={}),a.preferences[s][e]=i,a.unchangedPreferences[s]||(a.unchangedPreferences[s]={}),a.unchangedPreferences[s][e]=i,a.completePreferencesWithDefaults(),"global"===s&&"timezone"===e&&a.session.setTimezone(a.toUse.timezone),n.next(t),a.preferences$.emit(o)},function(t){n.error(t)}),n}return this.preferences[s]||(this.preferences[s]={}),this.preferences[s][e]=i,this.completePreferencesWithDefaults(),"global"===s&&"timezone"===e&&this.session.setTimezone(this.toUse.timezone),null},t.prototype.setPreferences=function(i,s){var a=this;void 0===s&&(s="global");var o=new rxjs_1.Subject;return this.backend.postRequest("module/Users/"+this.session.authData.userId+"/preferences/"+s,{},i).subscribe(function(t){for(var e in a.preferences[s])t.hasOwnProperty(e)?a.preferences[s][e]=t[e]:delete a.preferences[s][e];a.unchangedPreferences[s]=t,a.completePreferencesWithDefaults(),a.session.setTimezone(a.toUse.timezone),o.next(!0),a.preferences$.emit(i)},function(t){o.error(t)}),o},t.prototype.getDateFormat=function(){if(this.toUse.datef){var t=this.toUse.datef;return this.jsDateFormat2momentDateFormat(t)}return"YYYY-MM-DD"},t.prototype.jsDateFormat2momentDateFormat=function(t){return t.replace("Y","YYYY").replace("m","MM").replace("d","DD")},t.prototype.getTimeFormat=function(){if(this.toUse.timef){var t=this.toUse.timef;return this.jsTimeFormat2momentTimeFormat(t)}return"hh:mm"},t.prototype.jsTimeFormat2momentTimeFormat=function(t){return t.replace("H","HH").replace("h","hh").replace("i","mm")},t.prototype.needFormats=function(){this.formats.loaded||this.loadFormats()},t.prototype.loadFormats=function(){var a=this,o=new rxjs_1.Subject;return this.formats.nameFormats.length=0,this.formats.loaded=!1,this.backend.getRequest("module/Users/preferencesformats").subscribe(function(t){if(Array.isArray(t.nameFormats))for(var e=0,i=t.nameFormats;e<i.length;e++){var s=i[e];a.formats.nameFormats.push({name:s,example:a.translateNameFormat(s)})}a.formats.loaded=!0,o.next(!0)}),o.asObservable()},t.prototype.translateNameFormat=function(t){for(var e="",i=0;i<t.length;i++)switch(t.charAt(i)){case"t":e+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_TITLE");break;case"f":e+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_FIRST");break;case"l":e+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_LAST");break;case"s":e+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_SALUTATION");break;default:e+=t.charAt(i)}return e},t.prototype.formatMoney=function(t,e,i,s,a){void 0===e&&(e=this.toUse.default_currency_significant_digits),void 0===i&&(i=3),void 0===s&&(s=this.toUse.num_grp_sep),void 0===a&&(a=this.toUse.dec_sep);var o="\\d(?=(\\d{"+i+"})+"+(0<e?"\\D":"$")+")";return t.toFixed(Math.max(0,~~e)).replace(".",a).replace(new RegExp(o,"g"),"$&"+s)},t.prototype.formatDate=function(t){if(moment.isMoment(t))return t.format(this.getDateFormat());var e=moment(t);return e.isValid()?e.format(this.getDateFormat()):t},t.prototype.formatDateTime=function(t){return moment.isMoment(t)?t.format(this.getDateFormat())+" "+t.format(this.getTimeFormat()):moment.utc(t).format(this.getDateFormat())+" "+moment.utc(t).format(this.getTimeFormat())},t.prototype.askForMissingPreferences=function(){var e=this.getNamesOfMissingImportantPrefs(),i=0;if(this.unchangedPreferences.global&&this.unchangedPreferences.global.timezone){var t=moment.tz(moment.tz.guess()).utcOffset(),s=moment.tz(this.unchangedPreferences.global.timezone).utcOffset();t!==s&&(i=(t*s<0?Math.abs(t)+Math.abs(s):Math.abs(t-s))/60)}0===e.length&&0===i||this.modalservice.openModal("GlobalObtainImportantPreferences").subscribe(function(t){t.instance.namesOfMissingPrefs=e,t.instance.timeshift=i})},t.prototype.getNamesOfMissingImportantPrefs=function(){for(var t=[],e=0,i=["timezone","datef","timef"];e<i.length;e++){var s=i[e];this.unchangedPreferences.global[s]||t.push(s)}return t},t.prototype.getPossibleDateFormats=function(){return[{name:moment().format(this.jsDateFormat2momentDateFormat("Y-m-d")),value:"Y-m-d"},{name:moment().format(this.jsDateFormat2momentDateFormat("m-d-Y")),value:"m-d-Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("d-m-Y")),value:"d-m-Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("Y/m/d")),value:"Y/m/d"},{name:moment().format(this.jsDateFormat2momentDateFormat("m/d/Y")),value:"m/d/Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("d/m/Y")),value:"d/m/Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("Y.m.d")),value:"Y.m.d"},{name:moment().format(this.jsDateFormat2momentDateFormat("d.m.Y")),value:"d.m.Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("m.d.Y")),value:"m.d.Y"}]},t.prototype.getPossibleTimeFormats=function(){return[{name:moment().format(this.jsTimeFormat2momentTimeFormat("H:i")),value:"H:i"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:ia")),value:"h:ia"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:iA")),value:"h:iA"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:i a")),value:"h:i a"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:i A")),value:"h:i A"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("H.i")),value:"H.i"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.ia")),value:"h.ia"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.iA")),value:"h.iA"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.i a")),value:"h.i a"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.i A")),value:"h.i A"}]},Object.defineProperty(t.prototype,"companyCodeId",{get:function(){return this.session.authData.companycode_id},enumerable:!1,configurable:!0}),t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,toast,configurationService,language,broadcast,modal,session])],t)}();exports.userpreferences=userpreferences;var territories=function(){function t(t,e,i,s){this.backend=t,this.metadata=e,this.configurationService=i,this.session=s,this.addTerritories={}}return t.prototype.checkModuleManaged=function(t){return!!this.getModuleParamaters(t)},t.prototype.getModuleParamaters=function(e){var t=this.configurationService.getData("aclterritorymoduletypes");return!!t&&t.find(function(t){return t.module==e})},Object.defineProperty(t.prototype,"userTerritories",{get:function(){return this.configurationService.getData("aclterritoryuserterritories")},enumerable:!1,configurable:!0}),t.prototype.getRecentTerritories=function(t,e,i){void 0===e&&(e=5);var s=this.userTerritories;if(!i||this.session.isAdmin)return s[t]&&0<s[t].length?s[t].slice(0,e):[];var a=s[t]&&0<s[t].length?s[t].filter(function(t){return-1!=t.actions.indexOf(i)}):[];return a&&0<a.length?a.slice(0,e):[]},t.prototype.loadTerritoryName=function(e){var i=this;this.addTerritories[e]="...",this.backend.getRequest("module/SpiceACLTerritories/"+e).subscribe(function(t){t.id===e?i.addTerritories[e]=t.name:i.addTerritories[e]="error"})},t.prototype.searchTerritories=function(t,e,i,s,a){void 0===i&&(i=5),void 0===s&&(s=[]);for(var o=[],n=0,r=this.userTerritories[t];n<r.length;n++){var c=r[n];if(0<=c.name.toLowerCase().indexOf(e.toLowerCase())&&s.indexOf(c.id)<0&&(this.session.isAdmin||!a||a&&-1!=c.actions.indexOf(a))&&o.push(c),o.length>=i)return o}return o},t.prototype.isUserTerritory=function(t,e){var i=!1;return this.userTerritories[t].some(function(t){if(t.id===e)return i=!0}),i},t.prototype.getTerritoryName=function(t,e){var i="";return this.userTerritories[t].some(function(t){if(t.id===e)return i=t.name,!0}),""===i&&(this.addTerritories[e]||this.loadTerritoryName(e),i=this.addTerritories[e]),i},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,metadata,configurationService,session])],t)}();exports.territories=territories;var favorite=function(){function t(t,e,i,s){var a=this;this.backend=t,this.broadcast=e,this.configuration=i,this.session=s,this.isEnabled=!1,this.module="",this.id="",this.broadcast.message$.subscribe(function(t){return a.handleMessage(t)})}return Object.defineProperty(t.prototype,"favorites",{get:function(){var t=this.configuration.getData("favorites");return t||[]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isFavorite",{get:function(){var e=this;return!!this.favorites.find(function(t){return t.module_name==e.module&&t.item_id==e.id})},enumerable:!1,configurable:!0}),t.prototype.handleMessage=function(i){var s=this;switch(i.messagetype){case"model.save":this.favorites.some(function(t,e){if(t.module_name===i.messagedata.module&&t.item_id==i.messagedata.id)return s.favorites[e].item_summary=i.messagedata.data.summary_text,!0})}},t.prototype.enable=function(t,e){this.isEnabled=!0,this.module=t,this.id=e},t.prototype.disable=function(){this.isEnabled=!1,this.module=void 0,this.id=void 0},t.prototype.getFavorites=function(t){for(var e=[],i=0,s=this.favorites;i<s.length;i++){var a=s[i];a.module_name===t&&e.push({item_id:a.item_id,item_summary:a.item_summary})}return e},t.prototype.setFavorite=function(){var e=this;this.backend.postRequest("common/spicefavorites/"+this.module+"/"+this.id).subscribe(function(t){e.favorites.splice(0,0,{item_id:t.id,module_name:t.module,item_summary:t.summary_text,data:t.data})})},t.prototype.deleteFavorite=function(i,s){var a=this;i=i||this.module,s=s||this.id,this.backend.deleteRequest("common/spicefavorites/"+i+"/"+s).subscribe(function(t){a.favorites.some(function(t,e){if(t.module_name===i&&t.item_id===s)return a.favorites.splice(e,1),!0})})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],t)}();exports.favorite=favorite;var reminder=function(){function t(t,e,i,s){var a=this;this.backend=t,this.broadcast=e,this.configuration=i,this.session=s,this.reminders=[],this.loaded=!1,this.loaded$=new core_1.EventEmitter,this.broadcast.message$.subscribe(function(t){return a.handleMessage(t)})}return t.prototype.handleMessage=function(i){var s=this;switch(i.messagetype){case"loader.completed":if("loadUserDataStep2"==i.messagedata){this.reminders=[];for(var t=0,e=this.configuration.getData("reminders");t<e.length;t++){var a=e[t];a.reminder_date=moment.utc(a.reminder_date),this.reminders.push(a)}this.loaded=!0,this.loaded$.emit(!0)}break;case"model.save":this.reminders.some(function(t,e){if(t.module_name===i.messagedata.module&&t.item_id==i.messagedata.id)return s.reminders[e].item_summary=i.messagedata.data.summary_text,!0})}},t.prototype.getReminder=function(e,i){var s=!1;return this.reminders.some(function(t){if(t.module_name===e&&t.item_id===i)return s=t.reminder_date,!0}),s},t.prototype.getReminders=function(){for(var t=[],e=0,i=this.reminders;e<i.length;e++){var s=i[e];s.module_name===module&&t.push({item_id:s.item_id,item_summary:s.item_summary})}return t},t.prototype.setReminder=function(e,i){var s=this;this.backend.postRequest("common/spicereminders/"+e.module+"/"+e.id+"/"+i.format("YYYY-MM-DD")).subscribe(function(t){s.reminders.splice(0,0,{item_id:e.id,module_name:e.module,item_summary:e.data.summary_text,reminder_date:i})})},t.prototype.deleteReminder=function(i,s){var a=this,e=new rxjs_1.Subject;return this.backend.deleteRequest("common/spicereminders/"+i+"/"+s).subscribe(function(t){a.reminders.some(function(t,e){if(t.module_name===i&&t.item_id===s)return a.reminders.splice(e,1),!0}),e.next(!0),e.complete()}),e.asObservable()},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],t)}();exports.reminder=reminder;var currency=function(){function t(t,e){this.configuration=t,this.backend=e,this.currenciesFromBackend=[]}return Object.defineProperty(t.prototype,"currencies",{get:function(){return this.configuration.getData("currencies")},enumerable:!1,configurable:!0}),t.prototype.getCurrencies=function(){for(var t=[],e=0,i=this.currencies;e<i.length;e++){var s=i[e];t.push({id:s.id,name:s.name,iso:s.iso,symbol:s.symbol})}return t},t.prototype.getCurrencySmbol=function(e){var t=this.currencies.find(function(t){return t.id==e});return t?t.symbol:""},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService,backend])],t)}();exports.currency=currency;var loader=function(){function t(t,e,i,s,a){var o=this;this.http=t,this.broadcast=e,this.configuration=i,this.session=s,this.language=a,this.module="",this.id="",this.data={},this.loaderHandler=new rxjs_1.Subject,this.start="",this.counterCompleted=0,this.progress=0,this.activeLoader="",this.loadPhase="system",this.loadElements={system:[{name:"getLanguage",display:"Language",status:"initial",sequence:35,action:function(t){t.language.getLanguage(t.loaderHandler)}}],primary:[],secondary:[]},this.loaderHandler.subscribe(function(t){return o.handleLoaderHandler()})}var e;return t.prototype.getLoadTasks=function(){var a=this,o=new rxjs_1.Subject;return this.http.get(this.configuration.getBackendUrl()+"/system/spiceui/core/loadtasks",{headers:this.session.getSessionHeader()}).subscribe(function(t){a.loadElements.primary=[],a.loadElements.secondary=[];for(var e=0,i=t;e<i.length;e++){var s=i[e];s.status="initial",a.loadElements[s.phase].push(s)}a.loadElements.primary.sort(function(t,e){return t.sequence>e.sequence?1:-1}),a.loadElements.secondary.sort(function(t,e){return t.sequence>e.sequence?1:-1}),o.next(!0),o.complete()}),o.asObservable()},t.prototype.load=function(){var e=this;return this.loadComplete=new rxjs_1.Subject,this.getLoadTasks().subscribe(function(t){e.resetLoader(),e.start=performance.now(),e.handleLoaderHandler()}),this.loadComplete.asObservable()},t.prototype.reloadPrimary=function(){this.loadComplete=new rxjs_1.Subject,this.loadPhase="primary",this.progress=0;for(var t=this.counterCompleted=0,e=this.loadElements.primary;t<e.length;t++){e[t].status="initial"}return this.start=performance.now(),this.handleLoaderHandler(),this.loadComplete.asObservable()},t.prototype.resetLoader=function(){this.counterCompleted=0,this.progress=0,this.loadPhase="system";for(var t=0,e=this.loadElements.system;t<e.length;t++){e[t].status="initial"}for(var i=0,s=this.loadElements.primary;i<s.length;i++){s[i].status="initial"}for(var a=0,o=this.loadElements.secondary;a<o.length;a++){o[a].status="initial"}},t.prototype.reset=function(){this.counterCompleted=0;for(var t=this.progress=0,e=this.loadElements;t<e.length;t++){e[t].status="initial"}},t.prototype.setComplete=function(){var t=this;500<performance.now()-this.start?this.complete():setTimeout(function(){return t.complete()},500)},t.prototype.complete=function(){this.loadComplete.next(!0),this.loadComplete.complete()},t.prototype.handleLoaderHandler=function(){for(var t=!1,e=0,i=this.loadElements[this.loadPhase];e<i.length;e++){var s=i[e];if("active"===s.status)s.status="completed",this.progress=++this.counterCompleted/(this.loadElements.primary.length+this.loadElements.system.length)*100,100<this.progress&&this.progress;else if("initial"===s.status){s.status="active",s.action?s.action(this):this.handleRouteElement(s),t=!0,this.activeLoader=s.display;break}}!1===t&&"system"==this.loadPhase?(this.loadPhase="primary",this.handleLoaderHandler()):!1===t&&"primary"==this.loadPhase&&(this.setComplete(),this.loadPhase="secondary",this.broadcast.broadcastMessage("loader.primarycompleted"),this.handleLoaderHandler())},t.prototype.handleRouteElement=function(i){var s=this,t=i.route?i.route:"/system/spiceui/core/loadtasks/"+i.id;this.http.get(this.configuration.getBackendUrl()+t,{headers:this.session.getSessionHeader()}).subscribe(function(t){for(var e in t)s.configuration.setData(e,t[e]);s.broadcast.broadcastMessage("loader.completed",i.name),s.loaderHandler.next(i.name)})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==http_1.HttpClient&&http_1.HttpClient)?e:Object,broadcast,configurationService,session,language])],t)}();exports.loader=loader;var loginService=function(){function t(t,e,i,s,a,o,n,r,c,u){var l=this;this.configurationService=t,this.http=e,this.router=i,this.loader=s,this.toast=a,this.helper=o,this.session=n,this.broadcast=r,this.modal=c,this.metadata=u,this.redirectUrl="",this.authData={userName:"",password:""},this.oauthToken="",this.oauthIssuer="",this.broadcast.message$.subscribe(function(t){"loader.completed"===t.messagetype&&"loadUserData"===t.messagedata&&l.session.authData.obtainGDPRconsent&&l.modal.openModal("GlobalObtainGDPRConsentContainer")})}var e,i;return t.prototype.login=function(){var t,i=this,s=new rxjs_1.Subject,e=this.configurationService.getBackendUrl()+"/authentication/login",a=new http_1.HttpHeaders;if(this.authData.userName&&this.authData.password){var o=this.authData.userName.indexOf("#as#");-1<o&&(t=this.authData.userName.slice(0,o),this.authData.userName=this.authData.userName.slice(o+4)),a=a.set("Authorization","Basic "+this.helper.encodeBase64(this.authData.userName+":"+this.authData.password))}else{if(!this.oauthToken)throw new Error("Cannot Log In");a=(a=a.set("OAuth-Token",this.oauthToken)).set("OAuth-Issuer",this.oauthIssuer)}var n={};return t&&(n.impersonationuser=encodeURIComponent(t)),this.http.get(e,{headers:a,params:n}).subscribe(function(t){0==t.result&&i.toast.sendToast("error authenticating","error",t.error);var e=t;i.session.authData.sessionId=e.id,i.session.authData.userId=e.userid,i.session.authData.companycode_id=e.companycode_id,i.session.authData.tenant_id=e.tenant_id,i.session.authData.tenant_name=e.tenant_name,i.session.authData.userName=e.user_name,i.session.authData.userimage=e.user_image,i.session.authData.first_name=e.first_name,i.session.authData.last_name=e.last_name,i.session.authData.display_name=e.display_name,i.session.authData.email=e.email,i.session.authData.admin=e.admin,i.session.authData.dev=e.dev,i.session.authData.portalOnly=e.portal_only,i.session.authData.googleToken=e.access_token,i.session.authData.obtainGDPRconsent=e.obtainGDPRconsent,i.session.authData.canchangepassword=e.canchangepassword,sessionStorage["OAuth-Token"]=i.session.authData.sessionId,sessionStorage[btoa(i.session.authData.sessionId+":backendurl")]=btoa(i.configurationService.getBackendUrl()),sessionStorage[btoa(i.session.authData.sessionId+":siteid")]=btoa(i.configurationService.getSiteId()),i.broadcast.broadcastMessage("login"),i.load(),s.next(!0),s.complete()},function(t){switch(t.status){case 401:s.error(t.error.error);break;default:i.toast.sendToast("Application Error","error","Error Authenticating"),s.error(t.statusText)}s.complete()}),s.asObservable()},t.prototype.relogin=function(t,e){var i=this,s=this.configurationService.getBackendUrl()+"/authentication/login",a=new rxjs_1.Subject,o=new http_1.HttpHeaders;return t?o=o.set("Authorization","Basic "+this.helper.encodeBase64(this.session.authData.userName+":"+t)):e&&(o=(o=o.set("OAuth-Token",e)).set("OAuth-Issuer",this.oauthIssuer)),this.http.get(s,{headers:o}).subscribe(function(t){var e=t;i.session.authData.sessionId=e.id,sessionStorage["OAuth-Token"]=i.session.authData.sessionId,a.next(!0),a.complete(),i.broadcast.broadcastMessage("relogin")},function(t){switch(t.status){case 401:a.error(t.error.error);break;default:i.toast.sendToast("Application Error","error","Error Authenticating"),a.error(t.statusText)}a.complete()}),a.asObservable()},t.prototype.renewPassword=function(t){var e=this.configurationService.getBackendUrl()+"/user/password/change";if(this.authData.userName&&this.authData.password){var i=new http_1.HttpHeaders;i=i.set("Authorization","Basic "+this.helper.encodeBase64(this.authData.userName+":"+this.authData.password)),this.http.post(e,{newpwd:t},{headers:i}).subscribe(function(t){})}},t.prototype.load=function(){var e=this;this.loader.load().subscribe(function(t){return e.redirect(t)})},t.prototype.redirect=function(t){!0===t&&(this.session.authData.loaded=!0,this.toast.clearAll(),this.redirectUrl?(this.router.navigate([this.redirectUrl]),this.redirectUrl=""):this.router.navigate(["/"]))},t.prototype.logout=function(t){void 0===t&&(t=!1),t||this.http.delete(this.configurationService.getBackendUrl()+"/authentication/login?session_id="+this.session.authData.sessionId),this.session.endSession(),this.loader.reset(),this.broadcast.broadcastMessage("logout"),this.router.navigate(["/login"])},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService,"function"==typeof(e=void 0!==http_1.HttpClient&&http_1.HttpClient)?e:Object,"function"==typeof(i=void 0!==router_1.Router&&router_1.Router)?i:Object,loader,toast,helper,session,broadcast,modal,metadata])],t)}();exports.loginService=loginService;var loginCheck=function(){function t(t,e,i,s,a){this.login=t,this.session=e,this.modal=i,this.router=s,this.loader=a}var e;return t.prototype.canActivate=function(t,e){return!(!this.session||!this.session.authData.sessionId)||("/"!=e.url&&(this.login.redirectUrl=e.url),this.router.navigate(["/login"]),!1)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[loginService,session,modal,"function"==typeof(e=void 0!==router_1.Router&&router_1.Router)?e:Object,loader])],t)}();exports.loginCheck=loginCheck;var dockedComposer=function(){function t(t,e){var i=this;this.modelutilities=t,this.broadcast=e,this.composers=[],this.hiddenComposers=[],this.broadcast.message$.subscribe(function(t){return i.handleLogout(t)})}return t.prototype.handleLogout=function(t){"logout"==t.messagetype&&(this.composers=[],this.hiddenComposers=[])},t.prototype.addComposer=function(t,e,i){e?this.composers.splice(0,0,{module:t,id:e.id,name:e.getField("summary_text"),model:{module:t,id:e.id,data:e.data},loadexpanded:i}):this.composers.splice(0,0,{module:t,id:this.modelutilities.generateGuid(),name:"",model:{},loadexpanded:i})},t.prototype.focusComposer=function(s){var a=this;this.composers.some(function(t,e){if(t.id==s){var i=a.composers.splice(e,1);return a.composers.unshift(i.shift()),!0}})},Object.defineProperty(t.prototype,"maxComposers",{get:function(){return Math.floor((window.innerWidth-70)/500)},enumerable:!1,configurable:!0}),t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,broadcast])],t)}();exports.dockedComposer=dockedComposer;var fts=function(){function t(t,e,i,s,a){this.backend=t,this.configurationService=e,this.session=i,this.modelutilities=s,this.metadata=a,this.hits=[],this.found=0,this.runningsearch=void 0,this.runningmodulesearch=void 0,this.searchTerm="",this.searchSort={},this.searchOwner=!1,this.searchGeo={},this.searchAggregates={},this.searchModules=[],this.modulefilter="",this.buckets={},this.moduleSearchresults=[],this.lastSearchParams={},this.gloablSearchResults={},this.getSearchModules()}return Object.defineProperty(t.prototype,"loadedSearchModules",{get:function(){var e=this;return this.searchModules.filter(function(t){return e.metadata.checkModuleAcl(t,"list")})},enumerable:!1,configurable:!0}),t.prototype.transformHits=function(t){for(var e=[],i=0,s=t;i<s.length;i++){var a=s[i];e.push(this.tranformHit(a))}return e},t.prototype.tranformHit=function(t){for(var e in t._source)t._source.hasOwnProperty(e)&&"string"==typeof t._source[e]&&(t._source[e]=t._source[e]);return t},t.prototype.search=function(t,e){var i=this;void 0===e&&(e=5),this.searchTerm=t,this.runningsearch&&this.runningsearch.unsubscribe(),this.resetData(),this.runningsearch=this.backend.postRequest("search",{},{size:e,searchterm:t,modules:this.loadedSearchModules.join(",")}).subscribe(function(t){i.hits=t.hits.hits,i.found=t.hits.total,i.runningsearch=void 0})},t.prototype.searchByModules=function(i){var s=this,a=new rxjs_1.Subject;return i.modules&&0!==i.modules.length||(i.modules=this.loadedSearchModules),i.searchterm&&-1!=i.searchterm.indexOf("%")&&(i.searchterm=i.searchterm.replace(/%/g,"*")),i.searchterm=i.searchterm.trim(),this.searchTerm=i.searchterm,this.searchAggregates=i.aggregates,this.searchSort=i.sortparams,this.searchGeo=i.searchgeo,this.searchOwner=i.owner,this.modulefilter=i.modulefilter,this.buckets=i.buckets,this.runningmodulesearch&&this.runningmodulesearch.unsubscribe(),this.runningmodulesearch=this.backend.postRequest("search",{},{modules:0<i.modules.length?i.modules.join(","):"",searchterm:i.searchterm,searchgeo:i.searchgeo,records:i.size,owner:i.owner,aggregates:this.searchAggregates,sort:this.searchSort,modulefilter:i.modulefilter,buckets:i.buckets}).subscribe(function(t){for(var e in s.moduleSearchresults=[],t)t.hasOwnProperty(e)&&s.moduleSearchresults.push({module:e,data:{hits:s.transformHits(t[e].hits),max_score:t[e].max_score,total:t[e].total}});s.moduleSearchresults.sort(function(t,e){var i=parseFloat(t.data.max_score),s=parseFloat(e.data.max_score);return isNaN(i)&&isNaN(s)?1:isNaN(s)?-1:isNaN(i)?1:i<s?1:-1}),s.lastSearchParams=i,s.runningmodulesearch=void 0,a.next(t),a.complete()}),a.asObservable()},t.prototype.export=function(t,e,i,s,a,o){void 0===s&&(s={}),void 0===a&&(a={}),void 0===o&&(o=!1);var n=new rxjs_1.Subject;return-1!=t.indexOf("%")&&(t=t.replace(/%/g,"*")),t=t.trim(),this.searchTerm=t,this.searchAggregates=s,this.searchSort=a,this.runningmodulesearch=this.backend.getDownloadPostRequestFile("search/export",{},{module:e,searchterm:t,fields:i,owner:o,aggregates:s,sort:this.searchSort}).subscribe(function(t){n.next(t),n.complete()}),n.asObservable()},t.prototype.loadMore=function(t){var n=this,r=new rxjs_1.Subject;if(!this.runningmodulesearch){if(t){for(var e=!1,i=0,s=t.bucketitems;i<s.length;i++){var a=s[i];(!a.total||a.total>a.items)&&(e=!0)}if(!e)return}else if(this.moduleSearchresults[0].data.hits.length>=this.moduleSearchresults[0].data.total)return;return this.runningmodulesearch=this.backend.postRequest("search",{},{modules:0<this.lastSearchParams.modules.length?this.lastSearchParams.modules.join(","):"",searchterm:this.lastSearchParams.searchterm,aggregates:this.searchAggregates,sort:this.searchSort,owner:this.searchOwner,records:this.lastSearchParams.size,start:this.moduleSearchresults[0].data.hits.length,modulefilter:this.modulefilter,buckets:t}).subscribe(function(t){for(var e=0,i=n.lastSearchParams.modules;e<i.length;e++)for(var s=0,a=t[i[e]].hits;s<a.length;s++){var o=a[s];n.moduleSearchresults[0].data.hits.push(n.tranformHit(o))}n.runningmodulesearch=void 0,r.next(t),r.complete()}),r.asObservable()}},t.prototype.getSearchModules=function(){this.searchModules=this.metadata.getGlobalSearchModules()},t.prototype.resetData=function(){this.found=0,this.hits=[]},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,configurationService,session,modelutilities,metadata])],t)}();exports.fts=fts;var socket=function(){function t(t,e,i){this.configuration=t,this.broadcast=e,this.session=i,this.sockets={}}return t.prototype.socketObject=function(t){return this.sockets[t]},Object.defineProperty(t.prototype,"connected",{get:function(){return!_.isEmpty(this.sockets)},enumerable:!1,configurable:!0}),t.prototype.disconnect=function(t){this.sockets[t]&&(this.sockets[t].instance.disconnect(),this.sockets[t].instance.destroy(),delete this.sockets[t])},t.prototype.initializeNamespace=function(t){return this.sockets[t]?this.sockets[t].event$:(this.setSocketData(),this.socketUrl&&this.socketId?(this.sockets[t]=this.initializeSocket(t),this.sockets[t].event$):rxjs_1.of({type:null,data:null}))},t.prototype.joinRoom=function(t,e){t&&e&&this.sockets[t]&&(e in this.sockets[t].rooms?this.sockets[t].rooms[e]++:(this.sockets[t].instance.emit("join:room",e),this.sockets[t].rooms[e]=1))},t.prototype.leaveRoom=function(t,e){t&&e&&this.sockets[t]&&this.sockets[t].rooms[e]&&(this.sockets[t].rooms[e]--,this.sockets[t].rooms[e]<1&&(this.sockets[t].instance.emit("leave:room",e),delete this.sockets[t].rooms[e]))},t.prototype.setSocketData=function(){var t=this.configuration.getCapabilityConfig("socket");this.socketUrl=t.socket_frontend,this.socketId=t.socket_id},t.prototype.initializeSocket=function(t){var i=this,s=new rxjs_1.Subject,e=t?"/ns-"+t:"/",a=io(this.socketUrl+e,{query:{token:this.session.authData.sessionId,sysId:this.socketId}});return a.on("connect",function(){return i.handleConnectEvent(t,s)}),a.onAny(function(t,e){e.token!=i.session.authData.sessionId&&i.handleCustomEvent(s,t,e.data)}),{instance:a,isConnected:function(){return a.connected},event$:s.asObservable(),rooms:{}}},t.prototype.handleConnectEvent=function(e,t){var i,s=this;(null===(i=this.sockets[e])||void 0===i?void 0:i.rooms)&&Object.keys(this.sockets[e].rooms).forEach(function(t){s.sockets[e].rooms[t]<1||s.sockets[e].instance.emit("join:room",t)})},t.prototype.handleCustomEvent=function(t,e,i){t.next({type:e,data:i})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService,broadcast,session])],t)}();exports.socket=socket;var navigation=function(){function t(t,e,i,s,a,o,n,r,c,u,l,d){var h=this;this.title=t,this.session=e,this.modal=i,this.language=s,this.broadcast=a,this.configurationService=o,this.metadata=n,this.helper=r,this.socket=c,this.backend=u,this.userpreferences=l,this.router=d,this.navigationparadigm="tabbed",this.enforcednavigationparadigm=!1,this.activeModule="Home",this.modelsEditing=[],this.modelregister=[],this.modelregisterCounter=0,this.activeObject="",this.maintab={path:void 0,params:void 0,id:"main",active:!0,pinned:!1,enablesubtabs:!1},this.objectTabs=[],this.objectTabsChange$=new core_1.EventEmitter,this.subscriptions=new rxjs_1.Subscription,this.activeModule$=new core_1.EventEmitter,this.broadcast.message$.subscribe(function(t){return h.handleMessage(t)}),window.setTimeout(function(){addEventListener("beforeunload",function(t){h.anyDirtyModel()&&(t.preventDefault(),t.returnValue="")})},1),this.activeTab$=new rxjs_1.BehaviorSubject("main"),this.setTabTitle()}var e,i;return t.prototype.setSessionData=function(){this.session.setSessionData("navigation",{main:this.maintab,tabs:this.objectTabs})},Object.defineProperty(t.prototype,"activeTabObject",{get:function(){return this.maintab.active?this.maintab:this.objectTabs.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"activeTab",{get:function(){var t;return this.maintab.active?"main":null===(t=this.objectTabs.find(function(t){return t.active}))||void 0===t?void 0:t.id},set:function(e){var t;this.maintab.active?this.maintab.active=!1:(t=this.objectTabs.find(function(t){return t.active}))&&(t.active=!1);"main"==e?(this.maintab.active=!0,this.activeTab$.next("main"),this.router.navigate([this.maintab.url])):(t=this.objectTabs.find(function(t){return t.id==e}))&&this.setTabActive(t);this.setSessionData()},enumerable:!1,configurable:!0}),t.prototype.setTabActive=function(t){t.active=!0,this.activeTab$.next(t.id),this.setTabTitle(),this.router.navigate([t.url])},t.prototype.getSubTabs=function(e){return e?this.objectTabs.filter(function(t){return t.parentid==e}):[]},Object.defineProperty(t.prototype,"displayTab",{get:function(){if(this.maintab.active)return"main";var t=this.objectTabs.find(function(t){return t.active});return null==t?void 0:t.id},enumerable:!1,configurable:!0}),t.prototype.setActiveModule=function(t,e,i){void 0===e&&(e=""),void 0===i&&(i=""),this.activeModule=t,this.activeModule$.emit(t),this.title.setTitle(this.systemName+" / "+(""!==i?i:t))},Object.defineProperty(t.prototype,"systemName",{get:function(){return this.configurationService.systemName},enumerable:!1,configurable:!0}),t.prototype.enforceNavigationParadigm=function(t){this.enforcednavigationparadigm=!0,this.navigationparadigm=t},t.prototype.handleMessage=function(e){var t,i=this;switch(e.messagetype){case"loader.completed":if(!this.enforcednavigationparadigm&&"loadUserData"==e.messagedata){var s=this.userpreferences.getPreference("navigation_paradigm");this.navigationparadigm=s||"tabbed",this.session.setSessionData("navigation_paradigm",this.navigationparadigm)}break;case"userpreferences.save":var a=this.userpreferences.getPreference("navigation_paradigm");!this.enforcednavigationparadigm&&a&&this.navigationparadigm!=a&&("simple"==a&&this.navigationparadigm!=a?(this.objectTabs=[],this.router.navigate(["module/Home"])):"simple"!=a&&this.navigationparadigm!=a&&this.router.navigate(["module/Home"]),this.navigationparadigm=a,this.session.setSessionData("navigation_paradigm",this.navigationparadigm));break;case"logout":this.objectTabs=[],this.maintab={path:void 0,params:void 0,id:"main",pinned:!1,active:!0,enablesubtabs:!1},this.subscriptions.unsubscribe();break;case"login":var o=this.session.getSessionData("navigation_paradigm");o&&(this.navigationparadigm=o);var n=this.session.getSessionData("navigation");_.isEmpty(n)||(this.maintab=n.main,this.objectTabs=n.tabs,(null===(t=this.maintab.params)||void 0===t?void 0:t.module)&&(this.activeModule=this.maintab.params.module),this.activeTab$.next(this.activeTab),this.setTabTitle()),this.subscriptions.add(this.socket.initializeNamespace("module").subscribe(function(t){return i.handleSocketEvents(t)}));break;case"model.delete":for(var r=0,c=this.objectTabs.filter(function(t){return t.params.module==e.messagedata.module&&t.params.id==e.messagedata.id});r<c.length;r++){var u=c[r];this.closeObjectTab(u.id,!0)}}},t.prototype.handleSocketEvents=function(a){var o=this;switch(a.type){case"update":a.data.sessionId!=ts_md5_1.Md5.hashStr(this.session.authData.sessionId)&&this.modelregister.find(function(t){return t.model.module==a.data.module&&t.model.id==a.data.id&&!t.model.isEditing})&&this.backend.get(a.data.module,a.data.id).subscribe(function(t){for(var e=0,i=o.modelregister.filter(function(t){return t.model.module==a.data.module&&t.model.id==a.data.id&&!t.model.isEditing});e<i.length;e++){var s=i[e];s.model.data=__assign({},t),s.model.data$.next(s.model.data)}o.broadcast.broadcastMessage("model.save",{id:a.data.id,module:a.data.module,data:t})})}},t.prototype.addModelEditing=function(t,e,i){this.modelsEditing.push({module:t,id:e,summary_text:i,tabid:this.activeTab})},t.prototype.removeModelEditing=function(e,i){var s=this,a=0;this.modelsEditing.some(function(t){if(t.id==i&&t.module==e)return s.modelsEditing.splice(a,1),!0;a++})},Object.defineProperty(t.prototype,"editing",{get:function(){return 0<this.modelsEditing.length},enumerable:!1,configurable:!0}),t.prototype.discardAllChanges=function(){this.modelsEditing=[]},t.prototype.registerModel=function(t){var e=++this.modelregisterCounter;return this.modelregister.push({id:e,model:t,tabid:this.activeTab}),this.socket.joinRoom("module",ts_md5_1.Md5.hashStr(t.module+":"+t.id).toString()),e},t.prototype.unregisterModel=function(e){var t=this.modelregister.findIndex(function(t){return t.id==e});if(0<=t){var i=this.modelregister[t].model.module,s=this.modelregister[t].model.id;0==this.modelregister.filter(function(t){return t.id!=s&&t.model.module==i&&t.model.id==s}).length&&this.socket.leaveRoom("module",ts_md5_1.Md5.hashStr(i+":"+s).toString()),this.modelregister.splice(t,1)}},t.prototype.getRegisteredModel=function(e,i){var t;return null===(t=this.modelregister.find(function(t){return t.model.id==e&&t.model.module==i}))||void 0===t?void 0:t.model},t.prototype.anyDirtyModel=function(e){var i=this;return!!this.modelregister.some(function(t){if(t.model.isDirty()&&(!e||e&&(t.tabid==e||i.parentTabId(e)==e)))return!0})},t.prototype.parentTabId=function(e){return"main"==e?null:this.objectTabs.find(function(t){return t.id==e}).parentid},t.prototype.matchPath=function(t,e){if(t.path.replace("tab/:tabid/","")==e.path)return!0;if(t.path.replace("tab/:tabid/","")==e.referencepath)return!0;var i=this.metadata.getRouteDetails(t.path.replace("tab/:tabid/",""));return!(!i.referencepath||i.referencepath!=e.path)||!(!i.referencepath||i.referencepath!=e.referencepath)},t.prototype.buildUrl=function(t){var e="";return t.forEach(function(t){""!=e&&(e+="/"),e+=t.path}),e},t.prototype.matchRouteParams=function(t,e){if(_.isEqual(t.params,e))return!0;if(e.tabid&&e.tabid==t.id){var i=__assign({},e);return delete i.tabid,_.isEqual(t.params,i)}return!1},t.prototype.handleNavigation=function(i,s,a){var o=this,t=this.metadata.getRouteDetails(s.path.replace("tab/:tabid/",""));if("M"==(null==t?void 0:t.target)||"simple"==this.navigationparadigm){if(this.maintab.path==s.path&&_.isEqual(this.maintab.params,i))return void(this.activeTab="main");this.mainTabChangeCheck().subscribe(function(t){var e;t?(o.maintab.path=s.path,o.maintab.params=__assign({},i),o.maintab.url=o.buildUrl(a.url),o.activeTab="main",(null===(e=o.maintab.params)||void 0===e?void 0:e.module)&&(o.activeModule=o.maintab.params.module)):o.router.navigate([o.maintab.url])})}else{for(var e=0,n=this.objectTabs;e<n.length;e++){var r=n[e];if(this.matchPath(r,t)&&this.matchRouteParams(r,i))return r.path!=s.path.replace("tab/:tabid/","")&&(r.path=s.path,r.url=this.buildUrl(a.url)),void(this.activeTab=r.id)}var c=void 0;"subtabbed"==this.navigationparadigm&&i.tabid&&(c=this.objectTabs.find(function(t){return t.id==i.tabid}));var u=this.helper.generateGuid();this.objectTabs.unshift({id:u,parentid:c&&c.enablesubtabs?c.id:void 0,path:s.path,url:this.buildUrl(a.url),params:__assign({},i),active:!1,pinned:!1,enablesubtabs:"1"==t.subtabs}),this.activeTab=u,this.objectTabsChange$.emit(!0)}},t.prototype.setActiveTab=function(t){this.activeTab=t,this.activeTab$.next(this.activeTab),this.setTabTitle()},t.prototype.setTabTitle=function(){var t=this.getTabById(this.activeTab),e="";t.displayname?e=t.displayname:t.displaymodule?e=this.language.getModuleName(t.displaymodule):this.activeModule&&(e=this.language.getModuleName(this.activeModule)),this.title.setTitle(this.systemName+(e?" / "+e:""))},t.prototype.cloneTab=function(t){var e=this.getTabById(t),i=this.helper.generateGuid();this.objectTabs.unshift({id:i,parentid:void 0,path:e.path,url:e.url,params:__assign({},e.params),active:!1,pinned:!1,enablesubtabs:e.enablesubtabs}),this.activeTab=i},t.prototype.settabinfo=function(t,e){if("main"==t)e.displaymodule&&this.setActiveModule(e.displaymodule);else{var i=this.getTabById(t);i&&(i.displayname=e.displayname,i.displaymodule=e.displaymodule,i.displayicon=e.displayicon,this.objectTabsChange$.emit(!0))}},t.prototype.getTabById=function(e){return"main"==e?this.maintab:this.objectTabs.find(function(t){return t.id==e})},t.prototype.mainTabChangeCheck=function(){if(this.anyDirtyModel("main")){var e=new rxjs_1.Subject;return this.modal.confirm(this.language.getLabel("MSG_NAVIGATIONSTOP","","long"),this.language.getLabel("MSG_NAVIGATIONSTOP")).subscribe(function(t){t?e.next(!0):e.next(!1),e.complete()}),e.asObservable()}return rxjs_1.of(!0)},t.prototype.closeObjectTab=function(e,t){var i=this;void 0===t&&(t=!1),"main"!=e&&(!t&&this.anyDirtyModel(e)?this.modal.confirm(this.language.getLabel("MSG_CLOSETAB","","long"),this.language.getLabel("MSG_CLOSETAB")).subscribe(function(t){t&&i.unsetObjectTab(e)}):this.unsetObjectTab(e))},t.prototype.unsetObjectTab=function(e){var t,i=this.objectTabs.findIndex(function(t){return t.id==e});if(0<=i){!this.objectTabs[i].active&&(null===(t=this.objectTabs.find(function(t){return t.active}))||void 0===t?void 0:t.parentid)!=e||(this.objectTabs[i].parentid?this.setActiveTab(this.objectTabs[i].parentid):this.setActiveTab("main")),this.objectTabs.splice(i,1);for(var s=-1;0<=(s=this.modelregister.findIndex(function(t){return t.tabid==e}));)this.modelregister.splice(s,1);for(i=this.objectTabs.length-1;0<=i;){if(this.objectTabs[i].parentid==e){this.objectTabs.splice(i,1);for(var a=-1;0<=(a=this.modelregister.findIndex(function(t){return t.tabid==e}));)this.modelregister.splice(a,1)}i--}this.objectTabsChange$.emit(!0),this.setSessionData()}},t.prototype.checkActiveRoute=function(t){return _.isEqual(t,this.activeRoute)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==platform_browser_1.Title&&platform_browser_1.Title)?e:Object,session,modal,language,broadcast,configurationService,metadata,helper,socket,backend,userpreferences,"function"==typeof(i=void 0!==router_1.Router&&router_1.Router)?i:Object])],t)}();exports.navigation=navigation;var canNavigateAway=function(){function t(t,e,i){this.navigation=t,this.modal=e,this.language=i}return t.prototype.canActivate=function(t,e){for(var i=this,s=!1,a=0,o=this.navigation.modelregister;a<o.length;a++){var n=o[a];if(!n.model.isGlobal&&n.model.isDirty()){s=!0;break}}if(s){var r=new rxjs_1.Subject;return this.modal.confirm(this.language.getLabel("MSG_NAVIGATIONSTOP","","long"),this.language.getLabel("MSG_NAVIGATIONSTOP")).subscribe(function(t){t&&i.navigation.discardAllChanges(),r.next(t),r.complete()}),r.asObservable()}return rxjs_1.of(!0)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[navigation,modal,language])],t)}();exports.canNavigateAway=canNavigateAway;var navigationtab=function(){function t(){this.activeRoute={params:void 0,path:void 0},this.tabinfo$=new core_1.EventEmitter,this.close$=new core_1.EventEmitter,this.activeRoute$=new rxjs_1.BehaviorSubject(this.activeRoute)}return t.prototype.setTabInfo=function(t){this.tabinfo$.emit(t)},t.prototype.closeTab=function(){this.close$.emit(!0)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],t)}();exports.navigationtab=navigationtab;var model=function(){function t(t,e,i,s,a,o,n,r,c,u,l,d,h,p){var m=this;this.backend=t,this.broadcast=e,this.metadata=i,this.utils=s,this.session=a,this.recent=o,this.router=n,this.toast=r,this.language=c,this.modal=u,this.navigation=l,this.configuration=d,this.injector=h,this.socket=p,this._module="",this._id="",this.acl={},this.data={acl:{edit:!0}},this.backupData={},this.field$=new rxjs_1.BehaviorSubject({field:null,value:null}),this.isSaving=!1,this.saved$=new core_1.EventEmitter,this.mode$=new core_1.EventEmitter,this.canceledit$=new core_1.EventEmitter,this.isValid=!1,this.isLoading=!1,this.isEditing=!1,this.isGlobal=!1,this.isNew=!1,this._fields_stati=[],this._fields_stati_tmp=[],this._model_stati_tmp=[],this._messages=[],this.reference="",this._fields=[],this.messageChange$=new core_1.EventEmitter,this.duplicate=!1,this.templateId=null,this.duplicateChecking=!1,this.duplicates=[],this.duplicatecount=0,this.savingProgress=new rxjs_1.BehaviorSubject(1),this.subscriptions=new rxjs_1.Subscription,this.loadingError=!1,this.data$=new rxjs_1.BehaviorSubject(this.data),this.subscriptions.add(this.broadcast.message$.subscribe(function(t){"timezone.changed"===t.messagetype&&(m.utils.timezoneChanged(m.data,t.messagedata),m.utils.timezoneChanged(m.backupData,t.messagedata))}))}var e,i;return t.prototype.registerModel=function(){var e=this;this.module&&this._id&&!this.navigation.modelregister.find(function(t){return t.model._id==e._id&&t.model.module==e.module})&&(this.modelRegisterId=this.navigation.registerModel(this))},Object.defineProperty(t.prototype,"messages",{get:function(){return this._messages},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"module",{get:function(){return this._module},set:function(t){this._module=t,this.initializeFieldsStati(),this.registerModel()},enumerable:!1,configurable:!0}),t.prototype.handleSocketEvents=function(t){switch(t.type){case"update":t.data.id==this.id&&t.data.module==this.module&&t.data.sessionId!=this.session.authData.sessionId&&(this.isEditing||this.getData(!1,"",!1))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.registerModel()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"displayname",{get:function(){return this.getFieldValue("summary_text")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fields",{get:function(){return!this.module||this._fields&&0!=this._fields.length||(this._fields=this.metadata.getModuleFields(this.module)),this._fields},enumerable:!1,configurable:!0}),t.prototype.generateGuid=function(){return this.utils.generateGuid()},t.prototype.isFieldRequired=function(t){switch(t){case"date_entered":case"date_modified":return!0;default:return this.metadata.getFieldRequired(this.module,t)}},t.prototype.isRequired=function(t){return this.isFieldRequired(t)},t.prototype.checkAccess=function(t){return!(!this.data||!this.data.acl)&&("detail"==t||"view"==t?this.data.acl.detail||this.data.acl.view:this.data.acl[t])},t.prototype.checkFieldAccess=function(t){return!(this.data&&this.data.acl_fieldcontrol&&this.data.acl_fieldcontrol[t]&&"1"==this.data.acl_fieldcontrol[t])},t.prototype.goDetail=function(t){if(!this.checkAccess("detail"))return!1;var e="/module/"+this.module+"/"+this.id;t&&(e="/tab/"+t+"/"+e),this.router.navigate([e])},t.prototype.goModule=function(){this.router.navigate(["/module/"+this.module])},t.prototype.getData=function(t,e,i,s){var a=this;void 0===t&&(t=!0),void 0===e&&(e=""),void 0===i&&(i=!0),void 0===s&&(s=!1);var o=new rxjs_1.Subject;return t&&this.resetData(),this.isLoading=i,this.backend.get(this.module,this.id,e).subscribe(function(t){a.data=t,""!=e&&a.recent.trackItem(a.module,a.id,a.data),a.initializeFieldsStati(),a.evaluateValidationRules(null,"init"),a.isLoading=!1,a.data$.next(t),a.broadcast.broadcastMessage("model.loaded",{id:a.id,module:a.module,data:a.data}),o.next(t),o.complete()},function(t){s&&401!=t.status&&(a.toast.sendToast(a.language.getLabel("LBL_ERROR_LOADING_RECORD"),"error"),a.router.navigate(["/module/"+a.module])),401==t.status&&(a.loadingError=!0),o.error(t)}),o.asObservable()},t.prototype.validate=function(t){for(var e in this.resetMessages(),this.isValid=!0,this.evaluateValidationRules(null,"change"),this.fields)"id"!==e&&this.getFieldStati(e).required&&(!this.data[e]&&0!==this.data[e]||0===String(this.data[e]).length)&&(this.isValid=!1,this.addMessage("error",this.language.getLabel("MSG_INPUT_REQUIRED")+"!",e)),this.getFieldStati(e).invalid&&(this.isValid=!1);return this.isValid||console.warn("validation failed:",this.messages),this.isValid},t.prototype.initializeFieldsStati=function(){var t=[];for(var e in this.fields)t[e]=this.evaluateFieldStati(e);this._fields_stati=t},t.prototype.getDefaultStati=function(){return{editable:this.checkAccess("edit"),invalid:!1,required:!1,incomplete:!1,disabled:!1,hidden:!1,readonly:!1}},t.prototype.evaluateFieldStati=function(t){var e=this.getDefaultStati();return this.data&&this.data.acl_fieldcontrol&&this.data.acl_fieldcontrol[t]&&parseInt(this.data.acl_fieldcontrol[t],10)<3&&(e.editable=!1),this.isRequired(t)&&(e.required=!0),e},t.prototype.resetFieldStati=function(t){this._fields_stati[t]=this.evaluateFieldStati(t),this._fields_stati_tmp[t]=__assign({},this._fields_stati[t]),this.getFieldMessages(t,"error")&&(this._fields_stati_tmp[t].invalid=!0)},t.prototype.setFieldStatus=function(t,e,i){void 0===i&&(i=!0);try{var s=this._fields_stati[t];return s[e]&&!i?(console.warn("could not set status "+e+" to "+i+" because it has to be: "+s[e]),!1):(this._fields_stati_tmp[t]||(this._fields_stati_tmp[t]=__assign({},s)),this._fields_stati_tmp[t][e]=i,!0)}catch(t){return console.warn(t),!1}},t.prototype.setFieldStati=function(t,e){for(var i in e){if(!this.setFieldStatus(t,i,e[i]))return!1}return!0},t.prototype.getFieldStati=function(t){var e=this._fields_stati_tmp[t];return(e=e||this._fields_stati[t])||(e=this.getDefaultStati(),this._fields_stati[t]=e),!(e=__assign({},e)).invalid&&this.getFieldMessages(t,"error")&&(e.invalid=!0),e},t.prototype.evaluateValidationRules=function(t,e){var i=this.metadata.getModuleValidations(this.module);if(!i)return!0;this._fields_stati_tmp=[],this._model_stati_tmp=[],this.resetMessages();for(var s=0,a=i;s<a.length;s++){var o=a[s],n=0,r=!0;if(!(o.onevents instanceof Array)||o.onevents.includes(e)){if(o.conditions instanceof Array)for(var c=0,u=o.conditions;c<u.length;c++){var l=u[c];if(0<(n+=(1!=l.onchange||!t||l.fieldname==t)&&this.evaluateCondition(l)?1:0)&&"or"==o.logicoperator){r=!0;break}}if(o.conditions&&1<o.conditions.length&&"and"==o.logicoperator?n<o.conditions.length&&(r=!1):0==n&&o.conditions&&(r=!1),r)for(var d=0,h=o.actions;d<h.length;d++){var p=h[d];this.executeValidationAction(p)||console.warn("Action "+p.action+" for "+p.fieldname+" failed!")}}}},t.prototype.evaluateCondition=function(t){if(void 0===this.data[t.fieldname])return!1;var e,i=this.data[t.fieldname];return e=t.comparator.match(/regex/g)?t.valuations:this.evaluateValidationParams(t.valuations),modelutilities.compare(i,t.comparator,e)},t.prototype.executeValidationAction=function(t){var e=this.evaluateValidationParams(t.params);switch(t.action){case"set_value":return this.data[t.fieldname]=e,!0;case"set_message":return e instanceof Object&&(this._messages.push(e),this.messageChange$.emit(!0),!0);case"error":return this.addMessage("error",e,t.fieldname);case"warning":return this.addMessage("warning",e,t.fieldname);case"notice":return this.addMessage("notice",e,t.fieldname);case"hide":return e="string"==typeof e?modelutilities.strtobool(e):e,this.setFieldStatus(t.fieldname,"hidden",e);case"show":return e=!("string"==typeof e?modelutilities.strtobool(e):e),this.setFieldStatus(t.fieldname,"hidden",e);case"require":return e="string"==typeof e?modelutilities.strtobool(e):e,this.setFieldStatus(t.fieldname,"required",e);case"set_stati":return e="string"==typeof e?JSON.parse(e):e,this.setFieldStati(t.fieldname,e);case"set_model_state":if(e instanceof Array)for(var i=0,s=e;i<s.length;i++){var a=s[i];this.checkModelState(a)||this._model_stati_tmp.push(a)}else this.checkModelState(e)||this._model_stati_tmp.push(e);return!0;default:return console.warn("action: "+t.action+" is not defined!"),!1}},t.prototype.evaluateValidationParams=function(t){if("string"==typeof t){if(/(\<[a-z\_]+\>)/.test(t))for(var e=0,i=t.match(/(\<[a-z\_]+\>)/g);e<i.length;e++){var s=i[e],a=s.replace("<","").replace(">",""),o=this.data[a]?this.data[a]:0;switch(this.metadata.getFieldDefs(this.module,a).type){case"datetimecombo":case"datetime":case"date":o=o&&o.format("YYYY-MM-DD HH:mm:ss")}t=t.replace(s,o)}if(/\d+[\.\-]\d+[\.\-]\d+/.test(t)&&/[\+\-]/.test(t))t=modelutilities.strtomoment(t)||t;else if(/\d+\s*[\+\-\*\/\^]\s*\d+/.test(t)){t=this.utils.compileMathExpression(t)||t}}return t},t.prototype.checkModelState=function(t){return this._model_stati_tmp.includes(t)},t.prototype.startEdit=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1),this.isEditing||(t&&!this.duplicate&&(this.backupData=this.buildBackup(this.data)),e||(this.isEditing=!0,this.mode$.emit("edit")),this.navigation.addModelEditing(this.module,this.id,this.getFieldValue("summary_text")))},t.prototype.getFieldValue=function(t){return this.data[t]},t.prototype.getField=function(t){return this.getFieldValue(t)},t.prototype.setFieldValue=function(t,e){return this.setField(t,e)},t.prototype.initializeField=function(t,e){if(!t)return!1;this.data[t]=e},t.prototype.setField=function(t,e){if(!t)return!1;this.data[t]!==e&&this.field$.next({field:t,value:e}),this.data[t]=e,this.data$.next(this.data),this.evaluateValidationRules(t,"change"),this.duplicateCheckOnChange([t])},t.prototype.observeFieldChanges=function(e){return this.fields[e]?this.field$.pipe(operators_1.filter(function(t){return t.field==e}),operators_1.map(function(t){return t.value})):rxjs_1.of(null)},t.prototype.setFields=function(t){var e=[];for(var i in t){var s=t[i];_.isString(s)&&(s=s.trim()),this.data[i]=s,e.push(i)}this.data$.next(this.data),this.evaluateValidationRules(null,"change"),this.duplicateCheckOnChange(e)},t.prototype.cancelEdit=function(){this.isEditing=!1,this.mode$.emit("display"),this.navigation.removeModelEditing(this.module,this.id),this.backupData&&(this.data=this.backupData,this.data$.next(this.data),this.backupData=null,this.resetMessages()),this.canceledit$.emit(!0)},t.prototype.endEdit=function(){this.backupData=null,this.isEditing=!1,this.mode$.emit("display"),this.navigation.removeModelEditing(this.module,this.id)},t.prototype.getDirtyFields=function(){var t={};for(var e in this.data)e&&(!this.backupData||_.isObject(this.data[e])||_.isArray(this.data[e])||!_.isEqual(this.data[e],this.backupData[e])||this.isFieldARelationLink(e))&&(t[e]=this.data[e]);return t},t.prototype.save=function(i){var s=this;void 0===i&&(i=!1);var t,a=new rxjs_1.Subject;for(var e in this.isSaving=!0,this.data)_.isString(this.data[e])&&(this.data[e]=this.data[e].trim());return this.isEditing&&!this.isNew?(t=this.getDirtyFields()).date_modified=this.data.date_modified:t=this.data,this.backend.save(this.module,this.id,t,this.savingProgress,this.templateId).subscribe(function(t){s.data=t,s.isNew=!1,s.data$.next(t),s.broadcast.broadcastMessage("model.save",{id:s.id,reference:s.reference,module:s.module,data:s.data,changed:s.getDirtyFields(),backupdata:s.backupData}),s.isSaving=!1,i&&s.toast.sendToast(s.language.getLabel("LBL_DATA_SAVED")+".","success"),s.saved$.emit({changed:s.getDirtyFields(),backupdata:s.backupData}),s.endEdit(),s.initializeFieldsStati(),a.next(!0),a.complete()},function(e){switch(e.status){case 409:s.modal.openModal("ObjectOptimisticLockingModal",!1,s.injector).subscribe(function(t){t.instance.conflicts=e.error.error.conflicts,t.instance.responseSubject=a});break;default:i&&s.toast.sendToast(s.language.getLabel("LBL_ERROR")+" "+e.status,"error",e.error.error.message),a.error(!0),a.complete()}s.isSaving=!1}),a.asObservable()},t.prototype.delete=function(){var t=this,e=new rxjs_1.Subject;return this.backend.deleteRequest("module/"+this.module+"/"+this.id).subscribe(function(){t.broadcast.broadcastMessage("model.delete",{id:t.id,module:t.module,data:_.clone(t.data)}),e.next(!0),e.complete()}),e.asObservable()},t.prototype.reset=function(){this.id=null,this.module=null,this._fields_stati_tmp=this._fields_stati=[],this.isLoading=!1,this.isEditing=!1,this.mode$.emit("display"),this.resetMessages(),this.resetData()},t.prototype.clone=function(){return{module:this.module,id:this.id,data:__assign({},this.data)}},t.prototype.getAuditLog=function(t){void 0===t&&(t={});var e=new rxjs_1.Subject;return this.backend.getRequest("module/"+this.module+"/"+this.id+"/auditlog",t).subscribe(function(t){e.next(t),e.complete()},function(t){e.next(t),e.complete()}),e.asObservable()},t.prototype.resetData=function(){this.isValid=!0,this.data={}},t.prototype.initialize=function(t){return void 0===t&&(t=null),this.initializeModel(t)},t.prototype.initializeModel=function(t){void 0===t&&(t=null),this.id||(this.id=this.generateGuid(),this.isNew=!0),this.duplicates=[],this.data={},this.data.assigned_user_id=this.session.authData.userId,this.data.assigned_user_name=this.session.authData.userName,this.data.modified_by_id=this.session.authData.userId,this.data.modified_by_name=this.session.authData.userName,this.data.created_by_id=this.session.authData.userId,this.data.created_by_name=this.session.authData.userName,this.data.date_entered=new moment,this.data.date_modified=new moment,this.executeCopyRules(t),this.setFieldsDefaultValues(),this.evaluateValidationRules(),this.data.acl={create:!0,edit:!0,detail:!0},this.initializeFieldsStati(),this.evaluateValidationRules(null,"init"),this.parentmodel=t},t.prototype.addModel=function(t,e,i,s){var a=this;void 0===t&&(t=""),void 0===e&&(e=null),void 0===i&&(i={}),void 0===s&&(s=!1);var o=new rxjs_1.Subject;if(this.metadata.checkModuleAcl(this.module,"create")){for(var n in this.initializeModel(e),this.reference=t,i)this.data[n]=i[n];this.modal.openModal("ObjectEditModal",!1,this.injector).subscribe(function(t){t&&(t.instance.model.isNew=!0,t.instance.reference=a.reference,t.instance.preventGoingToRecord=s,t.instance.action$.subscribe(function(t){"save"!=t&&"savegodetail"!=t||(o.next(a.data),a.recent.trackItem(a.module,a.id,a.data)),o.complete()}))})}else this.toast.sendToast(this.language.getLabel("MSG_NOT_AUTHORIZED_TO_CREATE")+" "+this.language.getModuleName(this.module),"error"),window.setTimeout(function(){o.complete()},100);return o.asObservable()},t.prototype.executeCopyRules=function(t){if(t)if(_.isArray(t))for(var e=0,i=t;e<i.length;e++){var s=i[e];s.data&&this.executeCopyRulesParent(s)}else t.data&&this.executeCopyRulesParent(t);this.executeCopyRulesGeneric()},t.prototype.setFieldsDefaultValues=function(){var e=this,t=this.metadata.getModuleFields(this.module);t&&_.each(t,function(t){"default"in t&&null==e.data[t.name]&&"link"!=t.type&&"non-db"!=t.source&&e.setFixedValue(t.name,t.default)})},t.prototype.executeCopyRulesGeneric=function(){for(var t=0,e=this.metadata.getCopyRules("*",this.module);t<e.length;t++){var i=e[t];i.tofield&&i.fixedvalue?this.setFixedValue(i.tofield,i.fixedvalue):i.tofield&&i.calculatedvalue&&this.setField(i.tofield,this.getCalculatedValue(i))}},t.prototype.executeCopyRulesParent=function(t){t.data.id||(t.data.id=t.id);for(var e=0,i=this.metadata.getCopyRules(t.module,this.module);e<i.length;e++){var s=i[e];s.tofield&&(s.fromfield?this.copyValue(s.tofield,t.data[s.fromfield],s.params):s.fixedvalue&&this.setFixedValue(s.tofield,s.fixedvalue),s.calculatedvalue&&this.setField(s.tofield,this.getCalculatedValue(s,t.data[s.fromfield])))}},t.prototype.copyValue=function(t,e,i){void 0===i&&(i={});var s=this.metadata.getFieldDefs(this.module,t);if(s)switch(s.type){case"link":if((null==i?void 0:i.generatenewid)&&_.isObject(e)&&e.beans){var a={beans:{}};for(var o in e.beans)if(e.beans.hasOwnProperty(o)){var n=this.utils.generateGuid();a.beans[n]=__assign({},e.beans[o]),a.beans[n].id=n}this.setField(t,a)}break;default:this.setField(t,e)}else this.setField(t,e)},t.prototype.setFixedValue=function(t,e){var i=this.metadata.getFieldDefs(this.module,t);if(i&&(!i||i.type)||this.setField(t,e),i&&i.type)switch(i.type){case"bool":this.setField(t,"true"===e||"1"===e||"false"!==e&&"0"!==e&&null);break;default:this.setField(t,e)}},t.prototype.getCalculatedValue=function(t,e){var i=this.session.getSessionData("timezone")||moment.tz.guess(!0);switch(t.calculatedvalue){case"now":return(new moment.utc).tz(i);case"nextfullhour":var s=(new moment.utc).tz(i);return 0!=s.minute()&&(s.minute(0),s.add(1,"h")),t.params.number&&t.params.unit&&s.add(t.params.number,t.params.unit),s;case"addDate":var a=moment.isMoment(e)?new moment(e):(new moment.utc).tz(i);return t.params.number&&t.params.unit?a.add(t.params.number,t.params.unit):a}return""},t.prototype.edit=function(e,i){if(void 0===e&&(e=!1),void 0===i&&(i=""),!this.checkAccess("edit"))return rxjs_1.of(!1);var s=new rxjs_1.Subject;return this.modal.openModal("ObjectEditModal",!1,this.injector).subscribe(function(t){t&&(i&&""!=i&&(t.instance.componentSet=i),e&&t.instance.model.getData(!1,"editview",!1),t.instance.actionSubject.subscribe(function(t){s.next(t),s.complete()}))}),s.asObservable()},t.prototype.duplicateCheckOnChange=function(t){var e=this;if(this.isNew&&this.metadata.getModuleDuplicatecheck(this.module)){var i=this.metadata.getModuleDuplicateCheckFields(this.module);if(0==i.length)return;for(var s=!1,a=!1,o=0,n=i;o<n.length;o++){var r=n[o];a=a||0<=t.indexOf(r),s=s||this.getField(r)}if(s&&a){var c=new rxjs_1.Subject;return this.duplicateCheck(!0).subscribe(function(t){e.duplicates=t.records,e.duplicatecount=t.count,c.next(!0),c.complete()},function(){c.next(!1),c.complete()}),c.asObservable()}a&&!s&&(this.duplicates=[])}return rxjs_1.of(!1)},t.prototype.duplicateCheck=function(t){var e=this;if(void 0===t&&(t=!1),this.metadata.getModuleDuplicatecheck(this.module)){this.duplicateChecking=!0;var i=new rxjs_1.Subject;if(t){var s=this.data;s.id=this.id,this.backend.checkDuplicates(this.module,s).subscribe(function(t){i.next(t),i.complete(),e.duplicateChecking=!1},function(){i.next([]),i.complete(),e.duplicateChecking=!1})}else this.backend.getDuplicates(this.module,this.id).subscribe(function(t){i.next(t),i.complete(),e.duplicateChecking=!1},function(){i.next([]),i.complete(),e.duplicateChecking=!1});return i.asObservable()}return rxjs_1.of([])},t.prototype.addMessage=function(t,e,i,s){return void 0===i&&(i=null),void 0===s&&(s="validation"),this._messages.push({type:t,message:e,reference:i,source:s}),"error"==t&&i&&this.setFieldStatus(i,"invalid",!0),this.messageChange$.emit(!0),!0},t.prototype.getMessages=function(){return this.messages},t.prototype.setFieldMessage=function(t,e,i,s){return this.resetFieldMessages(i,t,s),"error"==t&&this.setFieldStatus(i,"invalid",!0),this.addMessage(t,e,i,s)},t.prototype.getFieldMessages=function(e,i){var t=this._messages.filter(function(t){return t.reference==e&&(!i||t.type==i)});return 0<t.length&&t},t.prototype.resetFieldMessages=function(t,e,i){if(0==this._messages.length)return!0;for(var s=this._messages.length-1;0<=s;s--){var a=this._messages[s];a.reference!=t||e&&a.type!=e||i&&a.source!=i||(this._messages.splice(s,1),this.messageChange$.emit(!0))}return this.resetFieldStati(t),!0},t.prototype.resetMessages=function(t,e){if(void 0===e&&(e="validation"),0==this._messages.length)return!0;for(var i=this._messages.length-1;0<=i;i--){var s=this._messages[i];t&&s.type!=t||e&&s.source!=e||(this._messages.splice(i,1),this.messageChange$.emit(!0)),this.resetFieldStati(s.reference)}return!0},t.prototype.isFieldARelationLink=function(t){try{return"link"==this.fields[t].type}catch(t){return!1}},t.prototype.getRelatedRecords=function(t){var e=[];if(!this.isFieldARelationLink(t))return e;if(!this.data[t])return e;for(var i in this.data[t].beans)e.push(this.data[t].beans[i]);return e},t.prototype.setRelatedRecords=function(t,e){return void 0===e&&(e=null),!!this.isFieldARelationLink(t)&&(this.data[t]={beans:{}},e?this.addRelatedRecords(t,e):void 0)},t.prototype.addRelatedRecords=function(t,e,i){if(void 0===i&&(i=!0),!this.isFieldARelationLink(t))return!1;this.data[t]||(this.data[t]={beans:{}});for(var s=0,a=e;s<a.length;s++){var o=a[s];!i&&this.data[t].beans[o.id]||(this.data[t].beans[o.id]=o)}return!0},t.prototype.removeRelatedRecords=function(t,e){if(!this.isFieldARelationLink(t))return!1;this.data[t]||(this.data[t]={beans:[]});for(var i=0,s=e;i<s.length;i++){var a=s[i];for(var o in this.data[t].beans)a==o&&(delete this.data[t].beans[o],this.data[t].beans_relations_to_delete[o]=a)}return!0},t.prototype.ngOnDestroy=function(){this.modelRegisterId&&this.navigation.unregisterModel(this.modelRegisterId),this.subscriptions.unsubscribe()},t.prototype.isDirty=function(){return this.isEditing&&_.values(this.getDirtyFields()).length},t.prototype.checkModuleFilterMatch=function(t){var e=this.configuration.getData("modulefilters");if(!e[t]||!e[t].filterdefs)return!1;var i=e[t].filterdefs;return i="string"==typeof i?JSON.parse(i):i,!!e&&this.checkModuleFilterGroupMatch(i)},t.prototype.checkModuleFilterGroupMatch=function(e){var i=this;if("own"==e.groupscope&&this.data.assigned_user_id!=this.session.authData.userId)return!1;var s=!1;return!(!e||!e.conditions)&&(e.conditions.forEach(function(t){return s=t.conditions?i.checkModuleFilterGroupMatch(t):i.checkModuleFilterConditionMatch(t),!("AND"==e.logicaloperator&&!s)&&(!!s||void 0)}),s)},t.prototype.checkModuleFilterConditionMatch=function(t){switch(t.operator){case"empty":return""==this.getFieldValue(t.field)||null==this.getFieldValue(t.field);case"equals":return this.getFieldValue(t.field)==t.filtervalue;case"oneof":return-1<(t.filtervalue instanceof Array?t.filtervalue:t.filtervalue.split(",")).indexOf(this.getFieldValue(t.field));case"true":return 1==this.getFieldValue(t.field);case"false":return 0==this.getFieldValue(t.field);case"starts":return 0==this.getFieldValue(t.field).indexOf(t.filtervalue);case"contains":return this.getFieldValue(t.field).includes(t.filtervalue);case"ncontains":return!this.getFieldValue(t.field).includes(t.filtervalue);case"greater":return this.getFieldValue(t.field)>t.filtervalue;case"gequal":return this.getFieldValue(t.field)>=t.filtervalue;case"less":return this.getFieldValue(t.field)<t.filtervalue;case"lequal":return this.getFieldValue(t.field)<=t.filtervalue;case"today":return moment(this.getFieldValue(t.field)).isSame(new moment,"days");case"past":return moment(this.getFieldValue(t.field)).isBefore(new moment);case"future":return moment(this.getFieldValue(t.field)).isAfter(new moment);case"thismonth":return moment(this.getFieldValue(t.field)).isSame(new moment,"month");case"nextmonth":return moment(this.getFieldValue(t.field)).isAfter(new moment,"month");case"thisyear":return moment(this.getFieldValue(t.field)).isSame(new moment,"year");case"nextyear":return moment(this.getFieldValue(t.field)).isAfter(new moment,"year");case"inndays":return moment(this.getFieldValue(t.field)).isSame((new moment).add(+t.filtervalue,"d"),"days");case"ndaysago":return moment(this.getFieldValue(t.field)).isSame((new moment).subtract(+t.filtervalue,"d"),"days");case"inlessthandays":return moment(this.getFieldValue(t.field)).isBefore((new moment).add(+t.filtervalue,"d"),"days");case"inmorethandays":return moment(this.getFieldValue(t.field)).isAfter((new moment).add(+t.filtervalue,"d"),"days")}},t.prototype.buildBackup=function(i){var s=this,a={};return _.each(i,function(t,e){_.isObject(t)?_.isArray(t)?a[e]=t.map(function(t){return s.buildBackup(t)}):moment.isMoment(t)?a[e]=moment(t):a[e]=s.buildBackup(t):a[e]=i[e]}),a},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,metadata,modelutilities,session,recent,"function"==typeof(e=void 0!==router_1.Router&&router_1.Router)?e:Object,toast,language,modal,navigation,configurationService,"function"==typeof(i=void 0!==core_1.Injector&&core_1.Injector)?i:Object,socket])],t)}();exports.model=model;var mediafiles=function(){function t(t,e,i,s,a,o,n,r,c,u){this.sanitizer=t,this.http=e,this.backend=i,this.configurationService=s,this.session=a,this.metadata=o,this.footer=n,this.toast=r,this.language=c,this.modalservice=u,this.categoriesLoaded=!1,this.categories={},this.categoriesSorted=[]}var e,i;return t.prototype._getImage=function(t,e){var i=this;void 0===e&&(e="");var s=new rxjs_1.Subject;return this.backend.getRawRequest("module/MediaFiles/"+t+"/file"+(""!=e?"/":"")+e,{},null,{}).subscribe(function(t){var e=URL.createObjectURL(t);s.next(i.sanitizer.bypassSecurityTrustUrl(e)),s.complete()}),s.asObservable()},t.prototype._getImageBase64=function(t){var e=new rxjs_1.Subject;return this.backend.getRequest("module/MediaFiles/"+t+"/base64").subscribe(function(t){e.next(t),e.complete()}),e.asObservable()},t.prototype.getImageVariant=function(t,e){return this._getImage(t,e)},t.prototype.getImage=function(t){return this._getImage(t,"")},t.prototype.getImageBase64=function(t){return this._getImageBase64(t)},t.prototype.getImageThumb=function(t,e){return this._getImage(t,"th/"+e)},t.prototype.getImageSquare=function(t,e){return this._getImage(t,"sq/"+e)},t.prototype.getMediaFile=function(t,e,i){var s=this;void 0===t&&(t=!1),void 0===e&&(e=!1);var a=new rxjs_1.Subject;return t?this.uploadMediaFile([],e,i).subscribe(function(t){t&&(a.next(t),a.complete())}):this.pickMediaFile().subscribe(function(t){t.id?(a.next(t.id),a.complete()):!0===t.upload&&s.uploadMediaFile([],e,i).subscribe(function(t){t&&(a.next(t),a.complete())})}),a.asObservable()},t.prototype.pickMediaFile=function(){var e=new rxjs_1.Subject;return this.modalservice.openModal("MediaFilePicker").subscribe(function(t){t.instance.answer.subscribe(function(t){e.next(t),e.complete()})}),e.asObservable()},t.prototype.uploadMediaFile=function(e,i,s){void 0===i&&(i=!1);var a=new rxjs_1.Subject;return this.modalservice.openModal("MediaFileUploader").subscribe(function(t){t.instance.acceptFileTypes=e,t.instance.noMetaData=i,t.instance.category=s,t.instance.answer.subscribe(function(t){a.next(t),a.complete()})}),a.asObservable()},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",["function"==typeof(e=void 0!==platform_browser_1.DomSanitizer&&platform_browser_1.DomSanitizer)?e:Object,"function"==typeof(i=void 0!==http_1.HttpClient&&http_1.HttpClient)?i:Object,backend,configurationService,session,metadata,footer,toast,language,modal])],t)}();exports.mediafiles=mediafiles;var modelattachments=function(){function t(t,e,i,s,a,o){this.backend=t,this.configurationService=e,this.session=i,this.toast=s,this.broadcast=a,this.language=o,this.count=0,this.files=[],this.loading=!1,this.loaded=!1,this.loaded$=new rxjs_1.BehaviorSubject(!1)}return t.prototype.getCount=function(t){var e=this,i=new rxjs_1.Subject;return this.backend.getRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/count",{categoryId:t}).subscribe(function(t){e.count=t.count,i.next(e.count),i.complete()},function(t){i.complete()}),i.asObservable()},t.prototype.broadcastAttachmentCount=function(){this.broadcast.broadcastMessage("attachments.loaded",{module:this.module,id:this.id,attachmentcount:this.count})},t.prototype.getAttachments=function(t){var s=this,a=new rxjs_1.Subject;return this.files=[],this.loading=!0,this.backend.getRequest("common/spiceattachments/module/"+this.module+"/"+this.id,{categoryId:t}).subscribe(function(t){function e(e){s.files.find(function(t){return t.id==e})||(t[e].date=new moment(t[e].date),s.files.push(t[e]))}for(var i in t)e(i);s.count=s.files.length,s.broadcastAttachmentCount(),s.loading=!1,a.next(s.files),a.complete(),s.loaded=!0,s.loaded$.next(!0)},function(t){s.loading=!1,a.error(t),a.complete()}),a.asObservable()},t.prototype.cloneAttachments=function(t,e){var s=this,a=new rxjs_1.Subject;return this.backend.postRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/clone/"+t.module+"/"+t.id,{},{categoryId:e}).subscribe(function(t){function e(e){s.files.find(function(t){return t.id==e})||(t[e].date=new moment(t[e].date),s.files.push(t[e]))}for(var i in t)e(i);s.count=s.files.length,s.broadcastAttachmentCount(),a.next(s.files),a.complete()},function(t){s.loading=!1,a.error(t),a.complete()}),a.asObservable()},t.prototype.humanFileSize=function(t){var e=t;if(Math.abs(t)<1024)return e+" B";for(var i=["kB","MB","GB","TB","PB","EB","ZB","YB"],s=-1;e/=1024,++s,1024<=Math.abs(e)&&s<i.length-1;);return e.toFixed(1)+" "+i[s]},t.prototype.uploadAttachmentsBase64=function(t,i){var s=this;if(0!==t.length){for(var a=new rxjs_1.Subject,o=this.configurationService.getSystemParamater("upload_maxsize"),e=function(t){if(o&&t.size>o)return n.toast.sendToast(n.language.getLabelFormatted("LBL_EXCEEDS_MAX_UPLOADFILESIZE",[t.name,n.humanFileSize(o)]),"error"),"continue";var e={date:new moment,file:"",file_mime_type:t.type?t.type:"application/octet-stream",filesize:t.size,filename:t.name,category_ids:i,filemd5:void 0,id:"",text:"",thumbnail:"",user_id:"1",user_name:"admin",uploadprogress:0};n.files.unshift(e),n.count++,n.broadcastAttachmentCount(),n.readFile(t).subscribe(function(){s.uploadForUploadAttachmentsBase64(e,a,t)})},n=this,r=0,c=t;r<c.length;r++){e(c[r])}return a.asObservable()}},t.prototype.uploadAttachmentsBase64FromArray=function(t){if(0!==t.length){for(var e=new rxjs_1.Subject,i=this.configurationService.getSystemParamater("upload_maxsize"),s=0,a=t;s<a.length;s++){var o=a[s];if(i&&o.size>i)this.toast.sendToast(this.language.getLabelFormatted("LBL_EXCEEDS_MAX_UPLOADFILESIZE",[o.name,this.humanFileSize(i)]),"error");else{var n={date:new moment,file:"",file_mime_type:o.type?o.type:"application/octet-stream",filesize:o.size,filename:o.name,filemd5:void 0,id:"",text:"",thumbnail:"",user_id:"1",user_name:"admin",uploadprogress:0};this.files.unshift(n),this.count++,this.broadcastAttachmentCount(),this.uploadForUploadAttachmentsBase64(n,e,o)}}return e.asObservable()}},t.prototype.uploadForUploadAttachmentsBase64=function(e,i,t){var s=new rxjs_1.BehaviorSubject(0);s.subscribe(function(t){e.uploadprogress=Math.floor(t)});var a={file:t.filecontent,filename:t.name,filemimetype:t.type?t.type:"application/octet-stream",category_ids:e.category_ids},o="common/spiceattachments";this.module&&this.id&&(o+="/module/"+this.module+"/"+this.id),this.backend.postRequestWithProgress(o,null,a,s).subscribe(function(t){e.id=t[0].id,e.thumbnail=t[0].thumbnail,e.filemd5=t[0].filemd5,e.user_id=t[0].user_id,e.user_name=t[0].user_name,delete e.uploadprogress,i.next({files:t}),i.complete()})},t.prototype.uploadFileBase64=function(t,e,i){var s=new rxjs_1.Subject,a=this.configurationService.getSystemParamater("upload_maxsize");if(!(a&&atob(t).length>a)){var o={date:new moment,file:"",file_mime_type:i||"application/octet-stream",filesize:atob(t).length,filename:e,filemd5:void 0,id:"",text:"",thumbnail:"",user_id:"1",user_name:"admin",uploadprogress:0};this.files.unshift(o),this.count++,this.broadcastAttachmentCount();var n=new rxjs_1.BehaviorSubject(0);n.subscribe(function(t){o.uploadprogress=Math.floor(t)});var r={file:t,filename:e,filemimetype:i||"application/octet-stream"},c="common/spiceattachments";return this.module&&this.id&&(c+="/module/"+this.module+"/"+this.id),this.backend.postRequestWithProgress(c,null,r,n).subscribe(function(t){o.id=t[0].id,o.thumbnail=t[0].thumbnail,o.filemd5=t[0].filemd5,o.user_id=t[0].user_id,o.user_name=t[0].user_name,delete o.uploadprogress,s.next({files:t}),s.complete()}),s.asObservable()}this.toast.sendToast(this.language.getLabelFormatted("LBL_EXCEEDS_MAX_UPLOADFILESIZE",[e,this.humanFileSize(a)]),"error")},t.prototype.readFile=function(t){var s=new rxjs_1.Subject,a=new FileReader;return a.file=t,a.onloadend=function(t){var e=a.result.toString();e=e.substring(e.indexOf("base64,")+7);var i=a.file;i.filecontent=e,s.next(i),s.complete()},a.readAsDataURL(t),s.asObservable()},t.prototype.deleteAttachment=function(i){var s=this;this.backend.deleteRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/"+i).subscribe(function(t){var e=s.files.findIndex(function(t){return t.id==i});s.files.splice(e,1),s.count--,s.broadcastAttachmentCount()},function(t){s.toast.sendToast("Cannot delete attachment.","error",t.error.error.message,!1)})},t.prototype.downloadAttachment=function(t,e){var a=this;this.backend.getRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/"+t).subscribe(function(t){var e=a.b64toBlob(t.file,t.file_mime_type),i=URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.href=i,s.download=t.filename,s.type=t.file_mime_type,s.click(),s.remove()})},t.prototype.downloadAttachmentForField=function(t,e,i,s){var a=this;this.backend.getRequest("common/spiceattachments/module/"+t+"/"+e+"/byfield/"+i).subscribe(function(t){var e=a.b64toBlob(t.file,t.file_mime_type),i=URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.href=i,s.download=t.filename,s.type=t.file_mime_type,s.click(),s.remove()})},t.prototype.getAttachment=function(t){var e=new rxjs_1.Subject;return this.backend.getRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/"+t).subscribe(function(t){e.next(t.file),e.complete()},function(t){e.error(t),e.complete()}),e.asObservable()},t.prototype.b64toBlob=function(t,e,i){void 0===e&&(e=""),void 0===i&&(i=512);for(var s=atob(t),a=[],o=0;o<s.length;o+=i){for(var n=s.slice(o,o+i),r=new Array(n.length),c=0;c<n.length;c++)r[c]=n.charCodeAt(c);var u=new Uint8Array(r);a.push(u)}return new Blob(a,{type:e})},t.prototype.openAttachment=function(t,e){var s=this;this.backend.getRequest("common/spiceattachments/module/"+this.module+"/"+this.id+"/"+t).subscribe(function(t){var e=s.b64toBlob(t.file,t.file_mime_type),i=URL.createObjectURL(e);window.open(i,"_blank")})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,configurationService,session,toast,broadcast,language])],t)}();exports.modelattachments=modelattachments;var modellist=function(){function t(t,e,i,s,a,o,n,r){this.broadcast=t,this.backend=e,this.metadata=i,this.language=s,this.userpreferences=a,this.session=o,this.configuration=n,this.toast=r,this.module="",this.listDataChanged$=new core_1.EventEmitter,this.listTypeComponent$=new core_1.EventEmitter,this.listData={list:[],totalcount:0},this.listSelected={type:"",items:[]},this.selectionChanged$=new core_1.EventEmitter,this.sortArray=[],this.lastLoad=new moment,this.loadlimit=50,this.isLoading=!1,this.searchTerm="",this.moduleAggregates=[],this.selectedAggregates=[],this.buckets={},this.useCache=!0,this.standardLists=[],this.serviceSubscriptions=new rxjs_1.Subscription,this.displayAggregates=!1,this.displayFilters=!1,this._listfields=[],this.listfield$=new core_1.EventEmitter,this.disableAutoloadListAll=!1,this.setDisableAutoloadListAll(),this.subscribeToBroadcast(),this.generateStandardLists(),this.listType$=new rxjs_1.BehaviorSubject(this.standardLists[0])}return t.prototype.subscribeToBroadcast=function(){var e=this;this.serviceSubscriptions.add(this.broadcast.message$.subscribe(function(t){e.handleMessage(t)}))},t.prototype.setDisableAutoloadListAll=function(){this.disableAutoloadListAll=!!this.configuration.getCapabilityConfig("module").disableAutoloadListAll},t.prototype.initialize=function(t,e){this.module=t,this.generateStandardLists(),this.embeddedByComponent=e,this.resetListData(),this.loadModuleAggregates();var i="all",s=this.userpreferences.getPreference(t);(null==s?void 0:s.lastListTypeId)&&this.listTypeExists(s.lastListTypeId)&&(i=s.lastListTypeId),this.setListType(i,!1)},t.prototype.loadModuleAggregates=function(){this.moduleAggregates=[];for(var t=0,e=this.metadata.getModuleAggregates(this.module);t<e.length;t++){var i=e[t];this.moduleAggregates.push(__assign({},i))}this.moduleAggregates.sort(function(t,e){return t.priority||e.priority?!t.priority||t.priority>e.priority?1:-1:0})},t.prototype.handleMessage=function(e){var i=this;if(e.messagedata.module===this.module)switch(e.messagetype){case"model.delete":var t=this.listData.list.findIndex(function(t){return t.id==e.messagedata.id});if(0<=t){if(this.listData.list.splice(t,1),this.listData.totalcount--,this.bucketfield){var s=[];if(this.bucketamountfield)for(var a=0,o=this.bucketamountfield;a<o.length;a++){var n=o[a];s.push({fieldname:n.name,value:e.messagedata.data[n.name]})}this.removeItemFromBucket(e.messagedata.data[this.bucketfield],s)}this.listDataChanged$.next(!0)}break;case"model.save":var r=this.listData.list.findIndex(function(t){return t.id==e.messagedata.id});if(0<=r){var c=this.listData.list[r].selected;if(this.listData.list[r]=e.messagedata.data,c&&(this.listData.list[r].selected=!0),this.bucketfield){if(e.messagedata.changed&&e.messagedata.changed[this.bucketfield]){s=[];for(var u=0,l=this.bucketamountfield;u<l.length;u++){n=l[u];s.push({fieldname:n.name,valuefrom:e.messagedata.backupdata[n.name],valueto:e.messagedata.data[n.name]})}this.updateBuckets(e.messagedata.backupdata[this.bucketfield],e.messagedata.data[this.bucketfield],s)}else if(this.bucketamountfield)for(var d=this.buckets.bucketitems.find(function(t){return t.bucket==e.messagedata.data[i.bucketfield]}),h=0,p=this.bucketamountfield;h<p.length;h++){n=p[h];e.messagedata.changed&&e.messagedata.changed[n.name]&&(d.values["_bucket_agg_"+n.name]+=e.messagedata.data[n.name]-e.messagedata.backupdata[n.name])}this.listDataChanged$.next(!0)}}else this.reLoadList()}},t.prototype.ngOnDestroy=function(){this.serviceSubscriptions.unsubscribe()},t.prototype.setSortField=function(e,t,i){if(void 0===i&&(i=!0),e&&!this.isLoading){var s=this.sortArray.findIndex(function(t){return t.sortfield==e});if(0<=s){var a=this.sortArray[s];"ASC"==a.sortdirection?a.sortdirection="DESC":this.sortArray.splice(s,1)}else this.sortArray.push({sortfield:e,sortdirection:t||"ASC"})}},t.prototype.getSortField=function(e){var t=this.sortArray.findIndex(function(t){return t.sortfield==e});return 0<=t&&{sortdirection:this.sortArray[t].sortdirection,sortindex:t,sortitems:this.sortArray.length}},t.prototype.getSortFields=function(){for(var t=[],e=0,i=this.sortArray;e<i.length;e++){var s=i[e];t.push(this.language.getFieldDisplayName(this.module,s.sortfield))}return t.join(", ")},Object.defineProperty(t.prototype,"isSorted",{get:function(){return 0<this.sortArray.length},enumerable:!1,configurable:!0}),t.prototype.addCustomListType=function(t){this.metadata.addModuleListType(this.module,t)},t.prototype.listTypeExists=function(e){return!!this.getListTypes().find(function(t){return t.id==e})},t.prototype.setListType=function(e,t,i){var s,a;if(void 0===t&&(t=!0),void 0===i&&(i=[]),e!=(null===(s=this.currentList)||void 0===s?void 0:s.id)){var o=null===(a=this.currentList)||void 0===a?void 0:a.listcomponent;if(this.displayAggregates=!1,this.displayFilters=!1,this.currentList=this.getListTypes().find(function(t){return t.id===e}),this.currentList){if(this.determineListFields(),t){var n=this.userpreferences.getPreference(this.module);(n=n||{}).lastListTypeId=e,this.userpreferences.setPreference(this.module,n)}this.currentList.aggregates?this.selectedAggregates=JSON.parse(atob(this.currentList.aggregates)):this.selectedAggregates=[],this.currentList.sortfields?this.sortArray=JSON.parse(atob(this.currentList.sortfields)):this.sortArray=i,this.emitListTypeChange(),this.currentList.listcomponent!=o&&this.emitListTypeComponentChange()}}},t.prototype.determineListFields=function(){this._listfields=[];for(var s=this.getFieldDefs(),t=this.embeddedByComponent||this.currentList.listcomponent,e=this.metadata.getComponentConfig(t,this.module),i=this.metadata.getFieldSetFields(e.fieldset),a=function(e){var t=s?s.find(function(t){return t.id==e.id}):void 0;s&&t?o._listfields.push({id:e.id,field:e.field,fieldconfig:e.fieldconfig,sort:t.sort,width:t.width}):s||!1===e.fieldconfig.default||o._listfields.push({id:e.id,field:e.field,fieldconfig:e.fieldconfig})},o=this,n=0,r=i;n<r.length;n++){a(r[n])}s&&this._listfields.sort(function(e,i){return s.findIndex(function(t){return t.id==e.id})>s.findIndex(function(t){return t.id==i.id})?1:-1})},t.prototype.isCustomList=function(e){return e=e||this.currentList.id,!this.standardLists.some(function(t){return t.id==e})},Object.defineProperty(t.prototype,"listfields",{get:function(){return this._listfields},set:function(t){var i=this;this._listfields=t;function e(e){s._listfields.find(function(t){return t.field==i.sortArray[e].sortfield})||s.sortArray.splice(parseInt(e,10),1)}var s=this;for(var a in this.sortArray)e(a);this.listfield$.emit(this._listfields)},enumerable:!1,configurable:!0}),t.prototype.canDelete=function(){try{return"all"!=this.currentList.id&&"owner"!=this.currentList.id}catch(t){return!1}},t.prototype.filterEnabled=function(){try{return"all"!=this.currentList.id&&"owner"!=this.currentList.id}catch(t){return!1}},t.prototype.aggregatesEnabled=function(){try{return!(!this.searchAggregates||_.isEmpty(this.searchAggregates))}catch(t){return!1}},t.prototype.setToSession=function(){this.useCache&&this.configuration.setData("lastlist_"+this.module,{listdata:this.listData,sortarray:this.sortArray,searchterm:this.searchTerm,searchaggregates:this.searchAggregates,selectedaggregates:this.selectedAggregates,buckets:this.buckets})},t.prototype.loadFromSession=function(){this.useCache=!0;var t=this.configuration.getData("lastlist_"+this.module);return!!t&&(this.listData=t.listdata,this.searchTerm=t.searchterm,this.searchAggregates=t.searchaggregates,this.selectedAggregates=t.selectedaggregates,this.sortArray=t.sortarray,this.buckets=t.buckets,!0)},t.prototype.getGlobal=function(){return"1"==this.currentList.global},t.prototype.getFieldDefs=function(){try{return JSON.parse(atob(this.currentList.fielddefs))}catch(t){return}},t.prototype.getFilterDefs=function(){try{return JSON.parse(this.currentList.filterdefs)}catch(t){return{logicaloperator:"and",groupscope:"all",conditions:[]}}},t.prototype.addListType=function(t){var e=this,i=new rxjs_1.Subject;return this.backend.postRequest("configuration/spiceui/core/modules/"+this.module+"/listtypes",{},JSON.stringify(t)).subscribe(function(t){e.addCustomListType(t),e.setListType(t.id),i.next(!0),i.complete()}),i.asObservable()},t.prototype.updateStandardListsComponent=function(t,e){this.standardLists[0].listcomponent!=e&&(this.standardLists.forEach(function(t){t.listcomponent=e}),this.determineListFields(),this.userpreferences.setPreference("defaultlisttype",e,!1,this.module),this.emitListTypeComponentChange())},t.prototype.updateListTypeComponent=function(t){var e;(null===(e=this.currentList)||void 0===e?void 0:e.listcomponent)!=t&&(this.metadata.updateModuleListType(this.module,{id:this.currentList.id,listcomponent:t}),this.currentList.listcomponent=t,this.determineListFields(),this.emitListTypeComponentChange())},t.prototype.emitListTypeComponentChange=function(){this.listTypeComponent$.next(this.currentList.listcomponent)},t.prototype.updateListType=function(i){var t,s=this,e=new rxjs_1.Subject;i=i||{};var a=null===(t=this.currentList)||void 0===t?void 0:t.listcomponent;return i.aggregates=btoa(JSON.stringify(this.selectedAggregates)),i.sortfields=btoa(JSON.stringify(this.sortArray)),i.fielddefs=btoa(JSON.stringify(this.listfields.map(function(t){return{id:t.id,width:t.width}}))),i.listcomponent||(i.listcomponent=this.currentList.listcomponent),this.backend.postRequest("configuration/spiceui/core/modules/"+this.module+"/listtypes/"+this.currentList.id,{},i).subscribe(function(t){s.metadata.getModuleListTypes(s.module).some(function(t){if(t.id==s.currentList.id){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return s.currentList=t,!0}}),i.id=s.currentList.id,s.metadata.updateModuleListType(s.module,i),s.emitListTypeChange(),s.currentList.listcomponent!=a&&s.emitListTypeComponentChange(),e.next(!0),e.complete()}),e.asObservable()},t.prototype.emitListTypeChange=function(){this.listType$.next(this.currentList)},t.prototype.deleteListType=function(e){var i=this;void 0===e&&(e=""),""===e&&(e=this.currentList.id),this.backend.deleteRequest("configuration/spiceui/core/modules/"+this.module+"/listtypes/"+e).subscribe(function(t){i.metadata.deleteModuleListType(i.module,e),i.setListType("all")},function(t){i.toast.sendToast(i.language.getLabel("LBL_ERROR"),"error")})},t.prototype.getLastLoadTime=function(){return this.lastLoad.format(this.userpreferences.getTimeFormat())},t.prototype.reLoadList=function(t){return void 0===t&&(t=!1),this.getListData(t)},t.prototype.resetListData=function(){if(this.buckets&&this.buckets.bucketitems)for(var t=0,e=this.buckets.bucketitems;t<e.length;t++){var i=e[t];i.count=0,i.items=0}this.listData={list:[],totalcount:0},this.listDataChanged$.next(!0)},t.prototype.getListTypes=function(t){return void 0===t&&(t=!0),t?this.standardLists.concat(this.metadata.getModuleListTypes(this.module)):this.metadata.getModuleListTypes(this.module)},t.prototype.generateStandardLists=function(){this.standardLists=[{id:"all",global:"1",name:this.language.getLabel("LBL_ALL")+" "+this.language.getModuleName(this.module),listcomponent:"ObjectList"}],this.metadata.getFieldDefs(this.module,"assigned_user_id")&&this.standardLists.push({id:"owner",global:"1",name:this.language.getLabel("LBL_MY")+" "+this.language.getModuleName(this.module),listcomponent:"ObjectList"})},Object.defineProperty(t.prototype,"hasAggregates",{get:function(){return 0<this.selectedAggregates.length},enumerable:!1,configurable:!0}),t.prototype.setAggregate=function(t,e){this.selectedAggregates.push(t+"::"+e)},t.prototype.getCheckedAggregateCount=function(e){return this.selectedAggregates.filter(function(t){return-1<t.indexOf(e+"::")}).length},t.prototype.checkAggregate=function(t,e){return-1<this.selectedAggregates.indexOf(t+"::"+e.trim())},t.prototype.removeAggregate=function(t,e){var i=this.selectedAggregates.indexOf(t+"::"+e);return!(i<0)&&(this.selectedAggregates.splice(i,1),!0)},t.prototype.removeAllAggregates=function(){this.selectedAggregates=[]},t.prototype.setAllSelected=function(){this.listSelected.type="all";for(var t=0,e=this.listData.list;t<e.length;t++){e[t].selected=!0}this.selectionChanged$.emit(!0)},t.prototype.setAllUnselected=function(){this.listSelected.type="none";for(var t=0,e=this.listData.list.filter(function(t){return 1==t.selected});t<e.length;t++){e[t].selected=!1}this.selectionChanged$.emit(!0)},t.prototype.setRangeSelected=function(t,e){for(var i=t;i<=e;i++)this.listData.list[i-1].selected=!0;this.selectionChanged$.emit(!0)},t.prototype.getSelectedCount=function(){return this.listData.list.filter(function(t){return 1==t.selected}).length},t.prototype.getSelectedIDs=function(){for(var t=[],e=0,i=this.listData.list;e<i.length;e++){var s=i[e];s.selected&&t.push(s.id)}return t},t.prototype.getSelectedItems=function(){return this.listData.list.filter(function(t){return t.selected})},t.prototype.checkAccess=function(t){if(!("edit"!=t&&"delete"!=t||"all"!=this.currentList.id&&"owner"!=this.currentList.id))return!1;if(!this.getGlobal())return!0;switch(t){case"delete":return this.canDelete()&&this.session.authData.admin;case"edit":return this.session.authData.admin;default:return!1}},t.prototype.getListData=function(t){var e,i=this;void 0===t&&(t=!1);var s=new rxjs_1.Subject;if(t){if(this.buckets&&this.buckets.bucketitems)for(var a=0,o=this.buckets.bucketitems;a<o.length;a++){o[a].items=0}}else this.isLoading=!0,this.resetListData();var n={};n[this.module]=this.selectedAggregates;var r={modulefilter:this.modulefilter,filtercontextbeanid:this.filtercontextbeanid,start:0,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:n,buckets:this.buckets,relatefilter:(null===(e=this.relatefilter)||void 0===e?void 0:e.active)?this.relatefilter:null};return this.backend.getList(this.module,this.sortArray,r).subscribe(function(t){i.listData=t,i.lastLoad=new moment,i.isLoading=!1,i.searchAggregates=t.aggregations,i.buckets=t.buckets,i.setToSession(),s.next(!0),s.complete(),i.listDataChanged$.next(!0)},function(t){i.toast.sendToast("error loading list"),i.isLoading=!1,s.error(t),s.complete()}),s.asObservable()},t.prototype.canLoadMore=function(){return!this.isLoading&&this.listData.list.length<this.listData.totalcount},t.prototype.loadMoreList=function(){var t,e=this;if(this.isLoading||this.listData.list.length>=this.listData.totalcount)return!1;this.isLoading=!0;var i={};i[this.module]=this.selectedAggregates,this.backend.getList(this.module,this.sortArray,{modulefilter:this.modulefilter,filtercontextbeanid:this.filtercontextbeanid,start:this.listData.list.length,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:i,buckets:this.buckets,relatefilter:(null===(t=this.relatefilter)||void 0===t?void 0:t.active)?this.relatefilter:null}).subscribe(function(t){e.listData.list=e.listData.list.concat(t.list),e.listDataChanged$.next(!0),e.lastLoad=new moment,e.isLoading=!1})},t.prototype.loadMoreBucketList=function(e){var t,i=this,s=this.buckets.bucketitems.find(function(t){return t.bucket==e});if(!s||this.isLoading||s.items>=s.items.total)return!1;this.isLoading=!0;var a={};a[this.module]=this.selectedAggregates,this.backend.getList(this.module,this.sortArray,{modulefilter:this.modulefilter,filtercontextbeanid:this.filtercontextbeanid,start:this.listData.list.length,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:a,buckets:{bucketfield:this.buckets.bucketfield,bucketitems:[s]},relatefilter:(null===(t=this.relatefilter)||void 0===t?void 0:t.active)?this.relatefilter:null}).subscribe(function(t){s.items=t.buckets.bucketitems[0].items,i.listData.list=i.listData.list.concat(t.list),i.lastLoad=new moment,i.listDataChanged$.next(!0),i.isLoading=!1})},t.prototype.exportList=function(t){var e=new rxjs_1.Subject,i=this.getSelectedIDs();if(0<i.length)this.backend.getLinkToDownload("module/"+this.module+"/export","POST",{},{ids:i,fields:t},{}).subscribe(function(t){e.next(t),e.complete()});else{var s={};s[this.module]=this.selectedAggregates,this.backend.getLinkToDownload("module/"+this.module+"/export","POST",{},{listid:this.currentList.id,modulefilter:this.modulefilter,sortfields:this.sortArray,fields:t,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:s}).subscribe(function(t){e.next(t),e.complete()})}return e.asObservable()},Object.defineProperty(t.prototype,"bucketfield",{get:function(){return this.buckets?this.buckets.bucketfield:""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bucketamountfield",{get:function(){return this.buckets?this.buckets.buckettotal:""},enumerable:!1,configurable:!0}),t.prototype.updateBuckets=function(e,i,t){void 0===t&&(t=[]);var s=this.buckets.bucketitems.find(function(t){return t.bucket==e});s.items--,s.total--;var a=this.buckets.bucketitems.find(function(t){return t.bucket==i});a.items++,a.total++;for(var o=0,n=this.buckets.buckettotal;o<n.length;o++)for(var r=n[o],c=0,u=t;c<u.length;c++){var l=u[c];"sum"==r.function&&r.name==l.fieldname&&(s.values["_bucket_agg_"+l.fieldname]-=l.valuefrom,a.values["_bucket_agg_"+l.fieldname]+=l.valueto)}},t.prototype.removeItemFromBucket=function(e,t){void 0===t&&(t=[]);var i=this.buckets.bucketitems.find(function(t){return t.bucket==e});i.items--,i.total--;for(var s=0,a=t;s<a.length;s++){var o=a[s];i.values["_bucket_agg_"+o.fieldname]-=o.value}},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[broadcast,backend,metadata,language,userpreferences,session,configurationService,toast])],t)}();exports.modellist=modellist;var popup=function(){function t(){this.closePopup$=new core_1.EventEmitter}return t.prototype.close=function(){this.closePopup$.emit(!0)},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],t)}();exports.popup=popup;var view=function(){function t(t,e){var i=this;this.model=t,this.layout=e,this.mode="view",this.isEditable=!1,this.displayLinks=!0,this.displayLabels=!0,this.editfieldid="",this.editfieldname="",this.labels="default",this._size="regular",this.linkedToModel=!1,this.isLoading=!1,this.mode$=new rxjs_1.BehaviorSubject(this.mode),this.model&&this.model.mode$.subscribe(function(t){i.linkedToModel&&"display"==t&&i.setViewMode()})}return Object.defineProperty(t.prototype,"size",{get:function(){return"small"==this.layout.screenwidth?"small":this._size},set:function(t){this._size=t},enumerable:!1,configurable:!0}),t.prototype.getMode=function(){return this.mode},t.prototype.isEditMode=function(){return"edit"===this.mode},t.prototype.setEditMode=function(t){void 0===t&&(t=""),this.mode="edit",this.editfieldid=t,this.mode$.next(this.mode)},t.prototype.setViewMode=function(){this.mode="view",this.mode$.next(this.mode)},t=__decorate([core_1.Injectable(),__param(0,core_1.Optional()),__metadata("design:paramtypes",[model,layout])],t)}();exports.view=view;var relatedmodels=function(){function t(t,e,i,s,a,o){var n=this;this.metadata=t,this.backend=e,this.broadcast=i,this.modelutilities=s,this.toast=a,this.language=o,this.module="",this.id="",this.relatedModule="",this.linkName="",this.modulefilter="",this.fieldfilters={},this.items=[],this.offset=0,this.count=0,this.loaditems=5,this.isloading=!1,this.isonlyfiltered=!1,this.sort={sortfield:"",sortdirection:"ASC"},this.lastLoad=new moment,this.sequencefield=null,this.serviceSubscriptions=[],this.serviceSubscriptions.push(this.broadcast.message$.subscribe(function(t){n.handleMessage(t)}))}return t.prototype.ngOnDestroy=function(){this.stopSubscriptions()},t.prototype.stopSubscriptions=function(){for(var t=0,e=this.serviceSubscriptions;t<e.length;t++){e[t].unsubscribe()}this.serviceSubscriptions=[]},Object.defineProperty(t.prototype,"sortfield",{get:function(){return this.sort.sortfield},set:function(t){this.sort.sortfield==t?this.sort.sortdirection="ASC"==this.sort.sortdirection?"DESC":"ASC":(this.sort.sortfield=t,this.sort.sortdirection="ASC"),this.getData()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_linkName",{get:function(){return""!=this.linkName?this.linkName:this.relatedModule.toLowerCase()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sortBySequencefield",{get:function(){return this.sequencefield&&!this.modulefilter&&!this.sort.sortfield},enumerable:!1,configurable:!0}),t.prototype.handleMessage=function(i){var s=this;if(-1!==i.messagetype.indexOf("model")&&i.messagedata.module===this.relatedModule)switch(i.messagetype){case"model.delete":this.items.some(function(t,e){if(t.id===i.messagedata.id)return s.items.splice(e,1),s.count--,!0});break;case"model.save":for(var t=!1,e=0,a=this.items;e<a.length;e++){var o=a[e];if(o.id===i.messagedata.id){for(var n in o)o.hasOwnProperty(n)&&i.messagedata.data.hasOwnProperty(n)&&(o[n]=i.messagedata.data[n]);t=!0,this.sortItems()}}!t||this.modulefilter?this.getData(!0):this.sortItems()}},t.prototype.getLastLoadTime=function(){return this.lastLoad.format("HH:mm")},t.prototype.getData=function(t){var i=this;void 0===t&&(t=!1);var s=new rxjs_1.Subject;if(!1===this.metadata.checkModuleAcl(this.relatedModule,"list")&&!1===this.metadata.checkModuleAcl(this.relatedModule,"listrelated"))return rxjs_1.of(!1);t||(this.resetData(),this.isloading=!0);var e={module:this.relatedModule,getcount:!0,offset:this.offset,limit:this.loaditems,fieldfilters:this.fieldfilters};this.modulefilter&&(e.modulefilter=this.modulefilter),this.sort.sortfield&&(e.sort=JSON.stringify(this.sort));var a="module/"+this.module+"/"+this.id+"/"+(this.linkEndPoint?this.linkEndPoint:"related/"+this._linkName);return this.backend.getRequest(a,e).subscribe(function(t){for(var e in i.items=[],i.count=parseInt(t.count,10),t.list)t.list.hasOwnProperty(e)&&(t.list[e].relid=e,t.list[e]=i.modelutilities.backendModel2spice(i.relatedModule,t.list[e]),i.items.push(t.list[e]));i.isloading=!1,i.sortItems(),i.lastLoad=new moment,s.next(!0),s.complete()},function(){i.isloading=!1}),s.asObservable()},Object.defineProperty(t.prototype,"canloadmore",{get:function(){return!this.isloading&&this.count&&0<this.count-this.items.length},enumerable:!1,configurable:!0}),t.prototype.getMoreData=function(t){var i=this;if(void 0===t&&(t=5),!1===this.metadata.checkModuleAcl(this.relatedModule,"list"))return rxjs_1.of(!0);this.isloading=!0;var e={module:this.relatedModule,getcount:!0,offset:this.items.length,limit:this.items.length+t};this.modulefilter&&(e.modulefilter=this.modulefilter),this.sort.sortfield&&(e.sort=JSON.stringify(this.sort));var s=new rxjs_1.Subject,a="module/"+this.module+"/"+this.id+"/"+(this.linkEndPoint?this.linkEndPoint:"related/"+this._linkName);return this.backend.getRequest(a,e).subscribe(function(t){for(var e in i.count=parseInt(t.count,10),t.list)t.list.hasOwnProperty(e)&&(t.list[e].relid=e,t.list[e]=i.modelutilities.backendModel2spice(i.relatedModule,t.list[e]),i.items.push(t.list[e]));i.sortItems(),i.lastLoad=new moment,i.isloading=!1,s.next(!0),s.complete()}),s.asObservable()},t.prototype.sortItems=function(){var s,a;this.sort.sortfield?(s=this.sort.sortfield,a=this.sort.sortdirection):this.sortBySequencefield&&(s=this.sequencefield,a="ASC"),s&&this.items.sort(function(t,e){var i;return i=isNaN(parseInt(t[s],10))||isNaN(parseInt(e[s],10))?t[s]>e[s]?1:-1:parseInt(t[s],10)>parseInt(e[s],10)?1:-1,"ASC"==a?i:-1*i})},t.prototype.resetData=function(){this.items=[]},t.prototype.addItems=function(s){var a=this;if(this.isonlyfiltered)this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_ADD"),"error");else{for(var t=[],e=0,i=s;e<i.length;e++){var o=i[e];t.push(o.id)}this.backend.postRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,[],t).subscribe(function(){for(var t=function(e){var i=!1;a.items.some(function(t){if(t.id==e.id)return i=!0}),i||(a.items.push(e),a.count++)},e=0,i=s;e<i.length;e++){t(i[e])}})}},t.prototype.setItem=function(t){if(this.isonlyfiltered)return this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_SET"),"error"),rxjs_1.of(!0);var e=new rxjs_1.Subject;return this.backend.putRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,[],this.modelutilities.spiceModel2backend(this.relatedModule,t)).subscribe(function(){e.next(!0),e.complete()},function(t){e.error(t),e.complete()}),e.asObservable()},t.prototype.deleteItem=function(i){var s=this;if(this.isonlyfiltered)this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_SET"),"error");else{var t=[];t.push(i);var e={relatedids:t};this.backend.deleteRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,e).subscribe(function(){s.items.some(function(t,e){if(t.id==i)return s.items.splice(e,1),s.count--,!0})})}},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,backend,broadcast,modelutilities,toast,language])],t)}();exports.relatedmodels=relatedmodels;var activitiytimeline=function(){function t(t,e,i,s,a,o){var n=this;this.metadata=t,this.backend=e,this.modelutilities=i,this.configurationService=s,this.session=a,this.broadcast=o,this.serviceSubscriptions=[],this.filters={searchterm:"",objectfilters:[],own:""},this.loading$=new core_1.EventEmitter,this.defaultLimit=5,this.modules=["Activities","History"],this.timelineModules=["Calls","Meetings","Tasks","Emails","Notes"],this.activeStates=["Planned","In Progress","Not Started","Pending Input"],this.activityObjects=["Tasks","Meetings","Calls","Notes","Emails"],this.sortDates={Calls:"date_start",Meetings:"date_start",Tasks:"date_due",Emails:"date_entered",Notes:"date_entered"},this.activities={Activities:{loading:!1,loadingmore:!1,list:[],totalcount:0,aggregates:[]},History:{loading:!1,loadingmore:!1,list:[],totalcount:0,aggregates:[]}},this.usefts=!1,this._openness=!1,this.serviceSubscriptions.push(this.broadcast.message$.subscribe(function(t){return n.handleMessage(t)})),this.openness$=new rxjs_1.BehaviorSubject(this._openness)}return Object.defineProperty(t.prototype,"openness",{get:function(){return this._openness},set:function(t){this._openness=t,this.openness$.next(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filterObjects",{get:function(){if(this.usefts){var t=[];for(var e in this.activities)t=t.concat(this.getAggregateObjects(e));return _.uniq(t)}return this.activityObjects},enumerable:!1,configurable:!0}),t.prototype.getAggregateObjects=function(t){try{for(var e=[],i=0,s=this.activities[t].aggregates.module;i<s.length;i++){var a=s[i];e.push(a.module)}return e}catch(t){return[]}},t.prototype.stopSubscriptions=function(){for(var t=0,e=this.serviceSubscriptions;t<e.length;t++){e[t].unsubscribe()}},t.prototype.handleMessage=function(s){var a=this,t=s.messagetype.split(".");if("model"===t[0])switch(t[1]){case"merge":this.parent&&s.messagedata.module==this.parent.module&&s.messagedata.id==this.parent.id&&(this.getTimeLineData("Activities",!0),this.getTimeLineData("History",!0));break;case"save":this.metadata.getModuleDefs(s.messagedata.module).ftsactivities.Activities&&this.getTimeLineData("Activities",!0),this.metadata.getModuleDefs(s.messagedata.module).ftsactivities.History&&this.getTimeLineData("History",!0);break;case"delete":var o=!1;if(0<=this.timelineModules.indexOf(s.messagedata.module))for(var e=function(i){if(n.activities[i].list.some(function(t,e){if(t.module,s.messagedata.module,t.id===s.messagedata.id)return a.activities[i].list.splice(e,1),a.getTimeLineData(i,!0),o=!0}),o)return{value:void 0}},n=this,i=0,r=this.modules;i<r.length;i++){var c=e(r[i]);if("object"==typeof c)return c.value}}},t.prototype.checkModuleActive=function(t){return 0==this.filters.objectfilters.length||0<=this.filters.objectfilters.indexOf(t)},t.prototype.toggleModuleFilter=function(t){0==this.filters.objectfilters.length?(this.filters.objectfilters=this.filterObjects,this.filters.objectfilters.splice(this.filters.objectfilters.indexOf(t),1)):0<=this.filters.objectfilters.indexOf(t)?this.filters.objectfilters.splice(this.filters.objectfilters.indexOf(t),1):(this.filters.objectfilters.push(t),this.filters.objectfilters.length==this.filterObjects.length&&(this.filters.objectfilters=[]))},t.prototype.reload=function(t){void 0===t&&(t=!1),this.loading$.emit(!0);for(var e=0,i=this.modules;e<i.length;e++){var s=i[e];this.getTimeLineData(s,t)}},t.prototype.getTimeLineData=function(a,t){var o=this;void 0===t&&(t=!1),t||(this.activities[a].loading=!0);var e={count:!0,limit:this.defaultLimit,objects:JSON.stringify(this.filters.objectfilters),own:this.filters.own,searchterm:this.filters.searchterm};this.backend.postRequest("module/"+a+"/fts/"+this.parent.module+"/"+this.parent.id,{},e).subscribe(function(t){if(t){o.resetListData(a);for(var e=0,i=t.items;e<i.length;e++){var s=i[e];s.data=o.modelutilities.backendModel2spice(s.module,s.data)}o.activities[a].list=t.items,o.activities[a].totalcount=parseInt(t.totalcount,10),o.activities[a].aggregates=t.aggregates?t.aggregates:[]}o.activities[a].loading=!1},function(t){o.activities[a].loading=!1})},t.prototype.getMoreTimeLineData=function(a,t){var o=this;if(!this.canLoadMore(a)||this.activities[a].loading)return rxjs_1.of(!0);var n=new rxjs_1.Subject,e={start:this.activities[a].list.length,limit:t||this.defaultLimit,objects:JSON.stringify(this.filters.objectfilters),own:this.filters.own,searchterm:this.filters.searchterm};return this.activities[a].loadingmore=!0,this.backend.postRequest("module/"+a+"/fts/"+this.parent.module+"/"+this.parent.id,{},e).subscribe(function(t){for(var e=0,i=t.items;e<i.length;e++){var s=i[e];s.data=o.modelutilities.backendModel2spice(s.module,s.data),o.activities[a].list.push(s)}o.activities[a].loadingmore=!1,n.next(!0),n.complete()},function(t){o.activities[a].loadingmore=!1,n.error(t),n.complete()}),n.asObservable()},t.prototype.resetListData=function(t){this.activities[t]={loading:!1,loadingmore:!1,list:[],totalcount:0}},t.prototype.canLoadMore=function(t){return this.activities[t].totalcount>this.activities[t].list.length&&!this.activities[t].loadingmore},t.prototype.sortListdata=function(a){var o=this;this.activities[a].list.sort(function(t,e){var i=new moment(t.data[o.sortDates[t.module]]),s=new moment(e.data[o.sortDates[e.module]]);return"Activities"!==a?i.isBefore(s):i.isAfter(s)})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,backend,modelutilities,configurationService,session,broadcast])],t)}();exports.activitiytimeline=activitiytimeline;var fielderrorgrouping=function(){function t(){this.fieldsWithErrors={},this.nrErrorsFields=0,this.change$=new core_1.EventEmitter}return t.prototype.setError=function(t,e){var i=!1;e?this.fieldsWithErrors[t]||(this.fieldsWithErrors[t]=!0,this.nrErrorsFields++,i=!0):this.fieldsWithErrors[t]&&(delete this.fieldsWithErrors[t],this.nrErrorsFields--,i=!0),i&&this.change$.emit(this.nrErrorsFields)},t.prototype.hasErrors=function(){return this.nrErrorsFields||!1},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],t)}();exports.fielderrorgrouping=fielderrorgrouping;var notification=function(){function t(t,e,i,s,a,o,n,r){var c=this;this.backend=t,this.broadcast=e,this.configuration=i,this.preferences=s,this.language=a,this.sanitizer=o,this.socket=n,this.session=r,this.unreadCount=0,this.totalCount=0,this.notifications=[],this.unreadNotifications=[],this.desktopNotifications=[],this.isLoading=!1,this.newNotifications=[],this.initializeDesktopNotification().then(function(){return c.loadNotifications()}),this.initializeSocket(),this.subscribeToBroadcast()}var e;return t.prototype.initializeDesktopNotification=function(){var e=this;return"Notification"in window?"default"===Notification.permission?Notification.requestPermission().then(function(t){e.preferences.setPreference("displayDesktopNotifications","granted"==t,!0)}):Promise.resolve(null):(window.console.error("This browser does not support desktop notification"),Promise.resolve(null))},t.prototype.markAsRead=function(e){var i=this;this.notifications.some(function(t){if(t.id==e)return t.notification_read=1,i.unreadCount--,!0}),this.unreadNotifications=this.unreadNotifications.filter(function(t){return t.id!==e}),this.unreadCount--,this.backend.postRequest("common/SpiceNotifications/"+e+"/markasread")},t.prototype.markAllAsRead=function(){this.notifications.forEach(function(t){t.notification_read=1}),this.unreadNotifications=[],this.unreadCount=0,this.backend.postRequest("common/SpiceNotifications/all/read")},t.prototype.loadNotifications=function(){var e=this;this.setInitialValues(this.configuration.getData("spicenotifications")),this.broadcast.message$.subscribe(function(t){"loader.completed"===t.messagetype&&"loadUserData"===t.messagedata&&e.setInitialValues(e.configuration.getData("spicenotifications"))})},t.prototype.reloadNotifications=function(){this.notifications=[],this.unreadNotifications=[],this.desktopNotifications=[],this.loadNotificationsFromBackend()},t.prototype.loadMoreNotifications=function(){this.isLoading||this.notifications.length>=this.totalCount||this.loadNotificationsFromBackend()},t.prototype.loadNotificationsFromBackend=function(){var e=this;this.isLoading=!0,this.backend.getRequest("common/SpiceNotifications",{offset:this.notifications.length}).subscribe(function(t){e.isLoading=!1,e.notifications=e.notifications.concat(t.records.map(function(t){return e.parseNotification(t)})),e.unreadNotifications=e.notifications.filter(function(t){return 1!=t.notification_read}),e.setUnreadCount()},function(){return e.isLoading=!1})},t.prototype.pushNotification=function(t){t=this.parseNotification(t),this.notifications.unshift(t),this.unreadNotifications.unshift(t),this.pushDesktopNotification(t),this.preferences.toUse.showRealtimeNotifications&&this.displayRealtimeNotification(t),this.unreadCount++},t.prototype.displayRealtimeNotification=function(t,e){var i=this;void 0===e&&(e=!0),this.newNotifications.push(t),this.pushDesktopNotification(t),e&&window.setTimeout(function(){return i.clearTempNotification(t)},1e4)},t.prototype.clearTempNotification=function(e){this.newNotifications=this.newNotifications.filter(function(t){return t!=e})},t.prototype.pushDesktopNotification=function(t){if(this.preferences.toUse.displayDesktopNotifications){var e=t?this.generateDesktopNotificationTitle(t):this.language.getLabel("MSG_NEW_NOTIFICATIONS");this.desktopNotifications.unshift(new Notification(this.configuration.systemName,{body:e,icon:"config/headerimage"}))}},t.prototype.setUnreadCount=function(){this.unreadCount=this.unreadNotifications.length},t.prototype.setInitialValues=function(t){var e=this;t&&Array.isArray(t.records)&&(this.totalCount=t.count,this.notifications=t.records.map(function(t){return e.parseNotification(t)}),this.unreadNotifications=this.notifications.filter(function(t){return 1!=t.notification_read}),this.setUnreadCount(),0<this.unreadCount&&this.pushDesktopNotification())},t.prototype.initializeSocket=function(){var e=this;this.socket.initializeNamespace("notifications").subscribe(function(t){return e.handleSocketEvents(t)}),this.socket.joinRoom("notifications",this.session.authData.userId)},t.prototype.generateDesktopNotificationTitle=function(t){switch(t.notification_type){case"reminder":return this.language.getLabel("LBL_REMINDER")+" "+t.bean_name+"\n"+t.notification_date;case"assign":return this.language.getLabel("LBL_ASSIGNED")+" "+t.bean_name+" "+this.language.getLabel("LBL_BY")+" "+t.created_by_name;case"change":return this.language.getLabel("LBL_CHANGED")+" "+t.bean_name+" "+this.language.getLabel("LBL_BY")+" "+t.created_by_name;case"delete":return this.language.getLabel("LBL_DELETED")+" "+t.bean_name+" "+this.language.getLabel("LBL_BY")+" "+t.created_by_name}},t.prototype.subscribeToBroadcast=function(){var e=this;this.broadcast.message$.subscribe(function(t){"login"===t.messagetype&&e.initializeSocket(),"logout"===t.messagetype&&e.socket.disconnect("notifications")})},t.prototype.handleSocketEvents=function(t){switch(t.type){case"new":t.data&&this.pushNotification(t.data)}},t.prototype.parseNotification=function(t){var e=this.session.getSessionData("timezone")||moment.tz.guess(!0),i=this.preferences.getDateFormat()+" "+this.preferences.getTimeFormat(),s="string"==typeof e&&0<e.length?moment.utc(t.notification_date).tz(e):moment(t.notification_date);return t.notification_date=s.isValid()?s.format(i):null,t.additional_infos&&"string"==typeof t.additional_infos&&(t.additional_infos=JSON.parse(t.additional_infos)),t},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,userpreferences,language,"function"==typeof(e=void 0!==platform_browser_1.DomSanitizer&&platform_browser_1.DomSanitizer)?e:Object,socket,session])],t)}();exports.notification=notification;var assistant=function(){function t(t,e,i,s,a){var o=this;this.modelutilities=t,this.backend=e,this.broadcast=i,this.session=s,this.notification=a,this.assistantModules=[],this.assitantItems=[],this.assistantFilters={objectfilters:[],timefilter:"all"},this.initialized=!1,this.loading=!0,this.reminder=null,this.broadcast.message$.subscribe(function(t){o.handleMessage(t)}),this.session.authData.sessionId&&this.initialize()}return t.prototype.handleMessage=function(t){switch(t.messagetype){case"logout":this.assitantItems=[],this.initialized=!1,this.reminder&&clearInterval(this.reminder);break;case"login":this.initialize();break;case"model.delete":case"model.save":0<=this.assistantModules.indexOf(t.messagedata.module)&&this.loadItems(!0)}},t.prototype.initialize=function(){var t=this;this.initialized||(this.initialized=!0,this.loadItems(),this.reminder=setInterval(function(){t.remind()},6e4))},t.prototype.remind=function(){for(var t=moment.utc(),e=0,i=this.assitantItems;e<i.length;e++){var s=i[e];if(s.data.reminder_time&&"-1"!=s.data.reminder_time){var a=new moment.utc(s.date_activity).subtract(parseInt(s.data.reminder_time,10),"seconds");if(t.format("YYYYMMDDHHmm")==a.format("YYYYMMDDHHmm")){var o={id:this.modelutilities.generateGuid(),bean_module:s.module,bean_id:s.data.id,created_by:s.data.created_by,created_by_name:s.data.created_by,user_id:s.data.created_by,notification_date:s.date_activity,notification_type:"reminder",notification_read:0,additional_infos:{},bean_name:s.data.summary_text};this.notification.displayRealtimeNotification(o,!1)}}}},t.prototype.loadItems=function(t){var o=this;void 0===t&&(t=!0),t||(this.loading=!0);var n=new rxjs_1.Subject;return this.backend.getRequest("module/Activities/assistant/list").subscribe(function(t){for(var e=[],i=0,s=t.items;i<s.length;i++){var a=s[i];e.push({id:a.id,module:a.module,date_activity:a.date_activity,data:o.modelutilities.backendModel2spice(a.module,a.data)})}o.assitantItems=e,o.assistantModules=t.modules,n.next(o.assitantItems),n.complete(),o.loading=!1}),n.asObservable()},Object.defineProperty(t.prototype,"filteredItems",{get:function(){var i=this;return"all"!=this.assistantFilters.timefilter||0<this.assistantFilters.objectfilters.length?this.assitantItems.filter(function(t){if(0<i.assistantFilters.objectfilters.length&&-1==i.assistantFilters.objectfilters.indexOf(t.module))return!1;if("all"!=i.assistantFilters.timefilter){var e=new moment.utc(t.date_activity);if("today"==i.assistantFilters.timefilter&&!e.isSame(moment.utc(),"day"))return!1;if("overdue"==i.assistantFilters.timefilter&&!e.isBefore(moment.utc(),"day"))return!1}return!0}):this.assitantItems},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"activityTypes",{get:function(){for(var t=[],e=0,i=this.assitantItems;e<i.length;e++){var s=i[e];-1==t.indexOf(s.module)&&t.push(s.module)}return t},enumerable:!1,configurable:!0}),t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,backend,broadcast,session,notification])],t)}();exports.assistant=assistant;var subscription=function(){function t(t,e,i,s,a,o,n){this.backend=t,this.broadcast=e,this.configuration=i,this.toast=s,this.session=a,this.metadata=o,this.language=n,this.subscriptions={},this.loadSubscriptions()}return t.prototype.hasSubscription=function(t){var e;return null===(e=this.subscriptions)||void 0===e?void 0:e[t]},t.prototype.subscribeBean=function(t,e){var i=this,s=new rxjs_1.Subject;return this.backend.postRequest("common/SpiceSubscriptions/"+e+"/"+t).subscribe(function(){i.subscriptions[t]={bean_id:t,bean_module:e,user_id:i.session.authData.userId},s.next(!0),s.complete()},function(){i.toast.sendToast(i.language.getLabel("MSG_FAILED_TO_SUBSCRIBE"),"error"),s.error("subscribe failed"),s.complete()}),s.asObservable()},t.prototype.unsubscribeBean=function(t,e){var i=this,s=new rxjs_1.Subject;return this.backend.deleteRequest("common/SpiceSubscriptions/"+e+"/"+t).subscribe(function(){delete i.subscriptions[t],s.next(!0),s.complete()},function(){i.toast.sendToast(i.language.getLabel("MSG_FAILED_TO_UNSUBSCRIBE"),"error"),s.error("subscribe failed"),s.complete()}),s.asObservable()},t.prototype.loadSubscriptions=function(){var e=this;this.subscriptions=this.configuration.getData("spicesubscriptions"),this.broadcast.message$.subscribe(function(t){"loader.completed"===t.messagetype&&"loadUserData"===t.messagedata&&(e.subscriptions=e.configuration.getData("spicesubscriptions"))})},t=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,toast,session,metadata,language])],t)}();exports.subscription=subscription;