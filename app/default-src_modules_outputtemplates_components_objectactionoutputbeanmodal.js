/*!
 * 
 *                     SpiceCRM
 *
 *                     release: 2024.01.001
 *
 *                     date: 2024-06-07 18:53:45
 *
 *                     build: 2024.01.001.1717779225604
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["default-src_modules_outputtemplates_components_objectactionoutputbeanmodal_ts"],{28679:(t,e,s)=>{s.d(e,{y:()=>A});var i=s(54438),l=s(41731),n=s(49969),a=s(64714),o=s(27863),d=s(69904),c=s(35911),m=s(83935),r=s(50531),u=s(49722),h=s(345),p=s(92462),f=s(60177),b=s(84341),_=s(44261),g=s(25863),k=s(32062),v=s(40713),j=s(25028),y=s(88418),R=s(83524),B=s(48717);function w(t,e){if(1&t&&(i.j41(0,"option",30),i.EFF(1),i.k0s()),2&t){const t=e.$implicit;i.Y8G("ngValue",t),i.R7$(),i.Lme("",t.name," (",t.language,")")}}function E(t,e){if(1&t){const t=i.RV6();i.qex(0),i.j41(1,"div",31)(2,"label",6),i.nrm(3,"system-label",32),i.k0s(),i.j41(4,"div",8)(5,"div",9)(6,"select",10),i.mxI("ngModelChange",(function(e){i.eBV(t);const s=i.XpG();return i.DH7(s.selected_format,e)||(s.selected_format=e),i.Njj(e)})),i.j41(7,"option",33),i.EFF(8,"HTML"),i.k0s(),i.j41(9,"option",34),i.EFF(10,"PDF"),i.k0s()()()()(),i.bVm()}if(2&t){const t=i.XpG();i.R7$(6),i.R50("ngModel",t.selected_format),i.Y8G("disabled",0==t.templates.length)}}const I=t=>({"slds-is-selected":t});function L(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",35),i.bIt("click",(function(){i.eBV(t);const e=i.XpG();return i.Njj(e.openEmailArea())})),i.nrm(1,"system-button-icon",36),i.k0s()}if(2&t){const t=i.XpG();i.Y8G("disabled",!t.selected_template||t.loading_output||"html"===t.selected_format)("ngClass",i.eq3(2,I,t.expanded))}}function F(t,e){if(1&t&&i.nrm(0,"iframe",37),2&t){const t=i.XpG();i.Y8G("srcdoc",t.sanitizedTemplated,i.npT)}}function M(t,e){if(1&t&&i.nrm(0,"object",38),2&t){const t=i.XpG();i.Y8G("data",t.blobUrl,i.f$h)}}function G(t,e){1&t&&(i.j41(0,"div",39),i.nrm(1,"system-spinner"),i.k0s())}function U(t,e){1&t&&(i.j41(0,"div",39),i.nrm(1,"system-label",40),i.k0s())}function O(t,e){if(1&t){const t=i.RV6();i.j41(0,"object-action-output-bean-modal-email-content",41,42),i.bIt("email_sent",(function(){i.eBV(t);const e=i.XpG();return i.Njj(e.emailSent())})),i.k0s()}if(2&t){const t=i.XpG();i.Y8G("fieldset",t.fieldset_email)("filelist",t.filelist)("parent",t.model)}}function D(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",43),i.bIt("click",(function(){i.eBV(t);const e=i.XpG();return i.Njj(e.create())})),i.EFF(1),i.k0s()}if(2&t){const t=i.XpG();i.Y8G("disabled",!t.selected_template||t.loading_output),i.R7$(),i.JRh(t.buttonText)}}function $(t,e){if(1&t){const t=i.RV6();i.j41(0,"button",43),i.bIt("click",(function(){i.eBV(t);const e=i.XpG();return i.Njj(e.sendEmail())})),i.EFF(1),i.k0s()}if(2&t){const t=i.XpG();i.Y8G("disabled",!t.selected_template||t.loading_output||!t.canSend),i.R7$(),i.JRh(t.language.getLabel("LBL_SENDEMAIL"))}}let A=(()=>{class ObjectActionOutputBeanModal{constructor(t,e,s,l,n,a,o,d,c,m){this.language=t,this.model=e,this.metadata=s,this.modal=l,this.view=n,this.backend=a,this.outputModalService=o,this.sanitizer=d,this.viewContainerRef=c,this.modelutilities=m,this.actionemitter=new i.bkB,this.noDownload=!1,this.liveCompile=!1,this.self=void 0,this.templates=[],this._selected_template=null,this._selected_format="pdf",this.compiled_selected_template="",this.loading_output=!1,this.fieldset_email="",this.filelist=[],this.showsendemail=!1,this.expanded=!1,this.emailInitialized=!1;let r=this.metadata.getComponentConfig("ObjectActionOutputBeanModal");this.fieldset_email=r.fieldset_email}ngOnInit(){this.setModalData(),this.setSelectedTemplate(),this.selected_template||1!=this.templates.length||(this.selected_template=this.templates[0])}setModalData(){this.modalTitle||(this.modalTitle=this.language.getLabel(this.language.getLabel("LBL_OUTPUT_TEMPLATE"))),this.buttonText||(this.buttonText=this.language.getLabel(this.noDownload?"LBL_OK":"LBL_DOWNLOAD")),this.forcedFormat&&(this._selected_format=this.forcedFormat)}get title(){return this.filename??this.modalTitle}setSelectedTemplate(){let t=this.metadata.getModuleFields(this.model.module);for(let e in t)if("relate"==t[e].type&&"OutputTemplates"==t[e].module){let s=this.templates.find((s=>s.id==this.model.getFieldValue(t[e].id_name)));s&&(this.selected_template=s);break}}set selected_template(t){this._selected_template=t,this.outputModalService.selectedTemplate=t,this.rendertemplate()}get selected_template(){return this._selected_template}get selected_format(){return this._selected_format}set selected_format(t){this._selected_format=t,this.expanded=!1,this.rendertemplate()}get sanitizedTemplated(){return this.sanitizer.bypassSecurityTrustHtml(this.compiled_selected_template)}rendertemplate(){switch(this.loading_output=!0,this.filename=null,this.blobUrl=null,this.compiled_selected_template=null,this.selected_format){case"pdf":const t={bean_data:this.liveCompile?this.modelutilities.spiceModel2backend(this.model.module,this.model.data):null};this.backend.postRequest(`module/OutputTemplates/${this.selected_template.id}/convert/${this.model.id}/to/pdf/base64`,null,t).subscribe({next:t=>{let e=this.datatoBlob(atob(t.content),"application/pdf");this.blobUrl=this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(e)),this.contentForHandBack=t.content,this.filename=t.filename,this.setEmailAttachmentData(),this.loading_output=!1},error:()=>{this.loading_output=!1}});break;case"html":this.backend.getRequest(`module/OutputTemplates/${this.selected_template.id}/compile/${this.model.id}`).subscribe({next:t=>{this.compiled_selected_template=t.content,this.contentForHandBack=t.content,this.setEmailAttachmentData(),this.loading_output=!1},error:()=>{this.loading_output=!1}})}}reload(){this.rendertemplate()}close(){this.outputModalService.modalResponse$.next("close"),this.outputModalService.modalResponse$.complete(),this.self.destroy()}create(){if(this.handBack&&this.handBack.emit({name:this.selected_template.name,content:this.contentForHandBack}),this.noDownload)this.close();else{let t=document.createElement("a");document.body.appendChild(t);let e=this.datatoBlob("pdf"==this.selected_format?atob(this.contentForHandBack):this.contentForHandBack);t.href=URL.createObjectURL(e),t.type="pdf"==this.selected_format?"application/pdf":"text/html",t.download=this.filename??this.model.module+"_"+this.model.getField("summary_text")+"."+this.selected_format,t.click(),t.remove()}}set data(t){let e=this.datatoBlob(t);this.blobUrl=this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(e))}datatoBlob(t,e="",s=512){let i=[];for(let e=0;e<t.length;e+=s){let l=t.slice(e,e+s),n=new Array(l.length);for(let t=0;t<l.length;t++)n[t]=l.charCodeAt(t);let a=new Uint8Array(n);i.push(a)}return new Blob(i,{type:e})}openEmailArea(){this.emailInitialized||(this.emailInitialized=!0,this.setEmailAttachmentData()),this.expanded=!this.expanded}setEmailAttachmentData(){this.emailInitialized&&(this.filelist=[{size:this.contentForHandBack.length,name:this.filename??this.model.module+"_"+this.model.getField("summary_text")+"."+this.selected_format,type:"application/"+this.selected_format,filecontent:this.contentForHandBack}])}emailSent(){this.close()}get canSend(){return this.emailContent&&!this.emailContent.disabled}sendEmail(){"Letters"==this.model.module&&this.backend.postRequest(`module/Letters/${this.model.id}/marksent/${this.selected_template.id}`,null,this.model.data).subscribe((t=>{this.actionemitter.emit({close:!0,name:"sent"})})),this.emailContent.sendEmail()}handleAction(t){this.outputModalService.modalResponse$.next(t.name),t.close&&(this.model.cancelEdit(),this.close())}static#t=this.ɵfac=function(t){return new(t||ObjectActionOutputBeanModal)(i.rXU(d.B),i.rXU(c.g),i.rXU(m.yu),i.rXU(r.y),i.rXU(l.U),i.rXU(u.H),i.rXU(o.c),i.rXU(h.up),i.rXU(i.c1b),i.rXU(p.g))};static#e=this.ɵcmp=i.VBU({type:ObjectActionOutputBeanModal,selectors:[["object-action-output-bean-modal"]],viewQuery:function(t,e){if(1&t&&i.GBs(a.z,5),2&t){let t;i.mGM(t=i.lsd())&&(e.emailContent=t.first)}},outputs:{actionemitter:"actionemitter"},features:[i.Jv_([l.U,o.c])],decls:34,vars:17,consts:[["size","large"],[3,"close"],["margin","none"],[1,"slds-modal__content"],[1,"slds-grid","slds-p-horizontal--x-small","slds-p-top--x-small"],[1,"slds-form-element","slds-grid","slds-grow"],[1,"slds-form-element__label"],["label","LBL_TEMPLATE"],[1,"slds-form-element__control","slds-grow"],[1,"slds-select_container"],[1,"slds-select",3,"ngModel","disabled","ngModelChange"],[3,"ngValue",4,"ngFor","ngForOf"],[4,"ngIf"],["class","slds-button slds-button--icon slds-button--icon-border slds-m-left--small",3,"disabled","ngClass","click",4,"ngIf"],[1,"slds-grid",2,"height","70vh"],[1,"slds-p-around--small",2,"height","100%","width","200%"],[1,"slds-m-top--small","slds-border--top","slds-border--right","slds-border--left","slds-border--bottom",2,"width","100%","height","calc(100% - 50px)"],["frameBorder","0","style","width: 100%;height: 100%;",3,"srcdoc",4,"ngIf"],["type","application/pdf","width","100%","height","100%",3,"data",4,"ngIf"],["class","slds-align--absolute-center","style","height: 100%;",4,"ngIf"],[1,"slds-scrollable",2,"height","100%"],[3,"fieldset","filelist","parent","email_sent",4,"ngIf"],[1,"slds-grid","slds-grid--vertical-align-center","slds-grid--align-end"],["role","group",1,"slds-button-group"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--neutral",3,"disabled","click"],["label","LBL_RELOAD"],["class","slds-button slds-button--brand",3,"disabled","click",4,"ngIf"],["containerclass","slds-button-group",1,"slds-m-left--x-small",2,"display","inline-flex",3,"actionset","actionemitter"],[3,"ngValue"],[1,"slds-form-element","slds-grid","slds-grow","slds-m-left--x-small"],["label","LBL_DISPLAY"],["value","html"],["value","pdf"],[1,"slds-button","slds-button--icon","slds-button--icon-border","slds-m-left--small",3,"disabled","ngClass","click"],["icon","email"],["frameBorder","0",2,"width","100%","height","100%",3,"srcdoc"],["type","application/pdf","width","100%","height","100%",3,"data"],[1,"slds-align--absolute-center",2,"height","100%"],["label","LBL_SELECT_TEMPLATE"],[3,"fieldset","filelist","parent","email_sent"],["emailcontent",""],[1,"slds-button","slds-button--brand",3,"disabled","click"]],template:function(t,e){1&t&&(i.j41(0,"system-modal",0)(1,"system-modal-header",1),i.bIt("close",(function(){return e.close()})),i.EFF(2),i.k0s(),i.j41(3,"system-modal-content",2)(4,"div",3)(5,"div",4)(6,"div",5)(7,"label",6),i.nrm(8,"system-label",7),i.k0s(),i.j41(9,"div",8)(10,"div",9)(11,"select",10),i.mxI("ngModelChange",(function(t){return i.DH7(e.selected_template,t)||(e.selected_template=t),t})),i.DNE(12,w,2,3,"option",11),i.k0s()()()(),i.DNE(13,E,11,2,"ng-container",12)(14,L,2,4,"button",13),i.k0s(),i.j41(15,"div",14)(16,"div",15)(17,"div",16),i.DNE(18,F,1,1,"iframe",17)(19,M,1,1,"object",18)(20,G,2,0,"div",19)(21,U,2,0,"div",19),i.k0s()(),i.j41(22,"div",20),i.DNE(23,O,2,3,"object-action-output-bean-modal-email-content",21),i.k0s()()()(),i.j41(24,"system-modal-footer")(25,"div",22)(26,"div",23)(27,"button",24),i.bIt("click",(function(){return e.close()})),i.nrm(28,"system-label",25),i.k0s(),i.j41(29,"button",26),i.bIt("click",(function(){return e.reload()})),i.nrm(30,"system-label",27),i.k0s(),i.DNE(31,D,2,2,"button",28)(32,$,2,2,"button",28),i.k0s(),i.j41(33,"object-action-container",29),i.bIt("actionemitter",(function(t){return e.handleAction(t)})),i.k0s()()()()),2&t&&(i.R7$(2),i.JRh(e.title),i.R7$(9),i.R50("ngModel",e.selected_template),i.Y8G("disabled",e.templates.length<=1),i.R7$(),i.Y8G("ngForOf",e.templates),i.R7$(),i.Y8G("ngIf",!e.forcedFormat),i.R7$(),i.Y8G("ngIf",e.metadata.checkModuleAcl("Emails","create")),i.R7$(2),i.Y8G("@slideInOut",e.expanded?"open":"closed"),i.R7$(2),i.Y8G("ngIf","html"===e.selected_format&&!e.loading_output&&e.selected_template),i.R7$(),i.Y8G("ngIf","pdf"===e.selected_format&&!e.loading_output&&e.blobUrl),i.R7$(),i.Y8G("ngIf",e.loading_output),i.R7$(),i.Y8G("ngIf",!e.selected_template&&!e.loading_output),i.R7$(),i.Y8G("@slideInOut2",e.expanded?"open":"closed"),i.R7$(),i.Y8G("ngIf",e.emailInitialized),i.R7$(6),i.Y8G("disabled",!e.selected_template||e.loading_output),i.R7$(2),i.Y8G("ngIf",!e.expanded),i.R7$(),i.Y8G("ngIf",e.expanded),i.R7$(),i.Y8G("actionset",e.customActionsetId))},dependencies:[f.YU,f.Sq,f.bT,b.xH,b.y7,b.wz,b.BC,b.vS,_.l,g.t,k.W,v.D,j.I,y.Q,R.C,B.P,a.z],encapsulation:2,data:{animation:[(0,n.hZ)("slideInOut",[(0,n.wk)("open",(0,n.iF)({width:"50%"})),(0,n.wk)("closed",(0,n.iF)({width:"100%"})),(0,n.kY)("open <=> closed",[(0,n.i0)("200ms")])]),(0,n.hZ)("slideInOut2",[(0,n.wk)("open",(0,n.iF)({width:"50%"})),(0,n.wk)("closed",(0,n.iF)({width:"0%"})),(0,n.kY)("open <=> closed",[(0,n.i0)("200ms")])])]}})}return ObjectActionOutputBeanModal})()},64714:(t,e,s)=>{s.d(e,{z:()=>h});var i=s(54438),l=s(35911),n=s(41731),a=s(69904),o=s(83935),d=s(50531),c=s(29994),m=s(3719),r=s(10650);const u=t=>({uploadfiles:t});let h=(()=>{class ObjectActionOutputBeanModalEmailContent{constructor(t,e,s,l,n,a){this.language=t,this.model=e,this.metadata=s,this.modal=l,this.view=n,this.session=a,this.fieldset=null,this.filelist={},this.parent={},this.email_sent=new i.bkB,this.sending=!1}ngOnInit(){this.setModelData(),this.setViewData()}ngOnChanges(t){t.filelist&&this.attachmentsPanelRef&&this.attachmentsPanelRef.instance.setUploadFiles(this.filelist)}setModelData(){this.model.module="Emails",this.model.initialize(this.parent);let t={};t.parent_type=this.parent.module,t.parent_id=this.parent.data.id,t.parent_name=this.parent.data.name,t.isNew=!0,t.assigned_user_id=this.session.authData.userId,t.assigned_user_name=this.session.authData.userName,t.modified_by_id=this.session.authData.userId,t.modified_by_name=this.session.authData.userName,t.date_entered=new Date,t.date_modified=new Date,this.model.setFields(t),this.model.startEdit()}setViewData(){this.view.setEditMode(),this.view.isEditable=!0}get disabled(){let t=this.model.getFieldValue("recipient_addresses"),e=this.model.getFieldValue("mailbox_id"),s=this.model.getFieldValue("name"),i=t?t.find((t=>"to"==t.address_type)):void 0;return!(s&&e&&t&&i)||this.sending}sendEmail(){this.modal.openModal("SystemLoadingModal",!1).subscribe((t=>{t.instance.messagelabel="LBL_SENDING",this.sending=!0,this.model.setFields({type:"out",to_be_sent:"1",from_addr:this.model.getField("from_addr_name"),to_addrs:this.model.getField("to_addrs_names")}),this.model.save().subscribe((e=>{t.instance.self.destroy(),this.email_sent.emit()}),(e=>{t.instance.self.destroy(),this.sending=!1}))}))}static#t=this.ɵfac=function(t){return new(t||ObjectActionOutputBeanModalEmailContent)(i.rXU(a.B),i.rXU(l.g),i.rXU(o.yu),i.rXU(d.y),i.rXU(n.U),i.rXU(c.d))};static#e=this.ɵcmp=i.VBU({type:ObjectActionOutputBeanModalEmailContent,selectors:[["object-action-output-bean-modal-email-content"]],inputs:{fieldset:"fieldset",filelist:"filelist",attachmentContent:"attachmentContent",parent:"parent"},outputs:{email_sent:"email_sent"},features:[i.Jv_([n.U,l.g]),i.OA$],decls:2,vars:4,consts:[["direction","vertical",3,"fieldset"],["component","SpiceAttachmentsPanel",3,"componentattributes","componentref"]],template:function(t,e){1&t&&(i.nrm(0,"object-record-fieldset",0),i.j41(1,"system-dynamic-component",1),i.bIt("componentref",(function(t){return e.attachmentsPanelRef=t})),i.k0s()),2&t&&(i.Y8G("fieldset",e.fieldset),i.R7$(),i.Y8G("componentattributes",i.eq3(2,u,e.filelist)))},dependencies:[m.D,r.s],encapsulation:2})}return ObjectActionOutputBeanModalEmailContent})()},27863:(t,e,s)=>{s.d(e,{c:()=>l});var i=s(54438);let l=(()=>{class outputModalService{constructor(){this.modalResponse$=new i.bkB}static#t=this.ɵfac=function(t){return new(t||outputModalService)};static#e=this.ɵprov=i.jDH({token:outputModalService,factory:outputModalService.ɵfac})}return outputModalService})()}}]);