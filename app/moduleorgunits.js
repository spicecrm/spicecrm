/*!
 * 
 *                     SpiceCRM
 *
 *                     release: 2024.01.001
 *
 *                     date: 2024-06-07 18:47:00
 *
 *                     build: 2024.01.001.1717778820753
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["src_modules_orgunits_moduleorgunits_ts"],{41815:(t,e,i)=>{i.r(e),i.d(e,{ModuleOrgunits:()=>H});var s=i(60177),n=i(84341),o=i(7745),r=i(12948),l=i(37328),d=i(70569),a=i(71341),c=i(54438),u=i(21413),g=i(35911),h=i(49722);let m=(()=>{class orgunitsViewService{constructor(t,e){this.model=t,this.backend=e,this.updated$=new c.bkB,this.orgunits=[],this.orgcharts=[],this.orgchartElements=[],this.connectors=[],this.loading=!0}loadOrgUnits(){let t=new u.B;return this.orgchartElements=[],this.orgunits=[],this.orgcharts=[],this.connectors=[],this.loading=!0,this.backend.getRequest(`module/OrgCharts/${this.model.id}/allOrgunits`).subscribe({next:e=>{this.orgunits=e.orgunits,this.orgcharts=e.orgcharts,window.setTimeout((()=>this.buildConnectors()),0),t.next(!0),t.complete(),this.loading=!1},error:e=>{this.loading=!1,t.error("could not load orgunits")}}),t.asObservable()}deleteOrgUnit(t){this.orgunits.splice(this.orgunits.findIndex((e=>e.id==t)),1),this.orgchartElements.splice(this.orgchartElements.findIndex((e=>e.id==t)),1),window.setTimeout((()=>this.buildConnectors()),0)}setNativeElement(t,e){let i=this.orgchartElements.find((e=>e.id==t));i?i.nativeElement=e:this.orgchartElements.push({id:t,nativeElement:e}),this.buildConnectors()}buildConnectors(){if(this.orgunits.length+this.orgcharts.length!=this.orgchartElements.length)return;this.connectors=[];let t=this.orgunits.find((t=>!t.parent_id));this.buildConnectorsForNode(t.id),this.updated$.emit(!0)}buildConnectorsForNode(t){let e=this.orgchartElements.find((e=>e.id==t)).nativeElement,i=this.viewport.getBoundingClientRect().top,s=this.viewport.getBoundingClientRect().left,n=(this.viewport.scrollWidth,this.viewport.scrollHeight,this.orgunits.filter((e=>e.parent_id==t)).map((t=>t.id)).concat(this.orgcharts.filter((e=>e.orgunit_id==t)).map((t=>t.id))));if(n.length>0){let t=e.getBoundingClientRect(),o=t.left+t.width/2-s,r=t.bottom-i,l=[],d=null,a=null,c=null;for(let t of n){let e=this.orgchartElements.find((e=>e.id==t)).nativeElement.getBoundingClientRect(),n=e.left+e.width/2-s,o=e.top-i;(!d||n>d)&&(d=n),(!c||n<c)&&(c=n),(!a||o<a)&&(a=o),l.push({cBoxX:n,cBoxY:o})}let u=r+(a-r)/2;this.connectors.push(`M ${o},${r} L ${o},${u}`),this.connectors.push(`M ${c},${u} L ${d},${u}`);for(let t of l)this.connectors.push(`M ${t.cBoxX},${u} L ${t.cBoxX},${t.cBoxY}`);for(let t of n)this.buildConnectorsForNode(t)}}static#t=this.ɵfac=function(t){return new(t||orgunitsViewService)(c.KVO(g.g),c.KVO(h.H))};static#e=this.ɵprov=c.jDH({token:orgunitsViewService,factory:orgunitsViewService.ɵfac})}return orgunitsViewService})();var p=i(25863),b=i(48717),v=i(52527),w=i(22465),f=i(33325),C=i(50531);let O=(()=>{class OrgunitsChartViewBoxAdd{constructor(t,e,i,s,n){this.oview=t,this.backend=e,this.modal=i,this.model=s,this.parent=n}add(){this.modal.openModal("OrgunitsChartViewBoxAddOptions").subscribe((t=>{t.instance.selection.subscribe({next:t=>{switch(t){case"addorgunit":this.model.module="OrgUnits",this.model.initialize(),this.model.addModel(null,this.parent,{parent_id:this.parent.id,parent_name:this.parent.getField("name"),orgchart_id:this.oview.orgChart.id,orgchart_name:this.oview.orgChart.getField("name")}).subscribe({next:t=>{this.oview.orgunits.push(t)}});break;case"addorgchart":this.model.module="OrgCharts",this.model.initialize(),this.model.addModel(null,this.parent,{parent_id:this.oview.orgChart.getField("parent_id"),parent_type:this.oview.orgChart.getField("parent_type"),parent_name:this.oview.orgChart.getField("parent_name"),orgchart_id:this.oview.orgChart.id,orgchart_name:this.oview.orgChart.getField("name"),orgunit_id:this.parent.id,orgunit_name:this.parent.getField("name")}).subscribe({next:t=>{this.oview.orgcharts.push(t)}});break;case"selectorgunit":this.modal.openModal("ObjectModalModuleLookup").subscribe((t=>{t.instance.module="OrgUnits",t.instance.multiselect=!1,t.instance.selectedItems.subscribe((t=>{let e=this.modal.await("LBL_LOADING");this.backend.putRequest(`module/OrgCharts/${this.oview.orgChart.id}/orgunit/${this.parent.id}/${t[0].id}`).subscribe({next:t=>{this.oview.loadOrgUnits().subscribe({next:t=>{e.emit(!0)},error:()=>{e.emit(!0)}})},error:()=>{e.emit(!0)}})}))}));break;case"selectorgchart":this.modal.openModal("ObjectModalModuleLookup").subscribe((t=>{t.instance.module="OrgCharts",t.instance.multiselect=!1,t.instance.selectedItems.subscribe((t=>{}))}))}}})}))}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartViewBoxAdd)(c.rXU(m),c.rXU(h.H),c.rXU(C.y),c.rXU(g.g),c.rXU(g.g,4))};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartViewBoxAdd,selectors:[["orgunits-chart-view-box-add"]],features:[c.Jv_([g.g])],decls:2,vars:0,consts:[[1,"slds-button","slds-button--icon",3,"click"],["icon","new",1,"slds-theme--inverse"]],template:function(t,e){1&t&&(c.j41(0,"button",0),c.bIt("click",(function(){return e.add()})),c.nrm(1,"system-button-icon",1),c.k0s())},dependencies:[p.t],encapsulation:2})}return OrgunitsChartViewBoxAdd})();const x=["box"],k=(t,e)=>({"slds-theme--alt-inverse":t,"slds-theme--info":e});function y(t,e){if(1&t){const t=c.RV6();c.j41(0,"div",7)(1,"button",8),c.bIt("click",(function(){c.eBV(t);const e=c.XpG();return c.Njj(e.edit())})),c.nrm(2,"system-button-icon",9),c.k0s()()}if(2&t){const t=c.XpG();c.R7$(2),c.Y8G("ngClass",c.l_i(1,k,"OrgUnits"==t.nodemodule,"OrgCharts"==t.nodemodule))}}function _(t,e){1&t&&(c.j41(0,"div",10),c.nrm(1,"orgunits-chart-view-box-add"),c.k0s())}let B=(()=>{class OrgunitsChartViewBox{constructor(t,e,i){this.oview=t,this.model=e,this.elementRef=i,this.nodemodule="OrgUnits",this.displayButtons=!1}ngOnInit(){this.model.module=this.nodemodule,this.model.id=this.nodeid,this.model.initialize();let t="OrgCharts"==this.nodemodule?this.oview.orgcharts.find((t=>t.id==this.nodeid)):this.oview.orgunits.find((t=>t.id==this.nodeid));this.model.setData(t,!0,!0)}ngAfterViewInit(){this.oview.setNativeElement(this.nodeid,this.boxElement.nativeElement)}edit(){this.model.edit(!1)}delete(){this.model.delete().subscribe({next:()=>{this.oview.deleteOrgUnit(this.nodeid)}})}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartViewBox)(c.rXU(m),c.rXU(g.g),c.rXU(c.aKT))};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartViewBox,selectors:[["orgunits-chart-view-box"]],viewQuery:function(t,e){if(1&t&&c.GBs(x,5),2&t){let t;c.mGM(t=c.lsd())&&(e.boxElement=t.first)}},inputs:{nodeid:"nodeid",nodemodule:"nodemodule"},features:[c.Jv_([g.g])],decls:8,vars:7,consts:[[1,"slds-is-relative",2,"margin","1rem auto","width","200px"],[1,"slds-p-around--small"],[1,"slds-box","slds-theme--alt-inverse","slds-align--absolute-center","slds-is-relative",3,"ngClass","mouseenter","mouseleave"],["box",""],["class","slds-is-absolute slds-grid","style","top: 5px; right: 5px;",4,"ngIf"],["system-model-popover","",1,"slds-m-around--small","slds-truncate"],["class","slds-is-absolute slds-grid","style","bottom: 3px; right: calc(50% - 8px);",4,"ngIf"],[1,"slds-is-absolute","slds-grid",2,"top","5px","right","5px"],[1,"slds-button","slds-button--icon",3,"click"],["icon","edit",3,"ngClass"],[1,"slds-is-absolute","slds-grid",2,"bottom","3px","right","calc(50% - 8px)"]],template:function(t,e){1&t&&(c.j41(0,"div",0)(1,"div",1)(2,"div",2,3),c.bIt("mouseenter",(function(){return e.displayButtons=!0}))("mouseleave",(function(){return e.displayButtons=!1})),c.DNE(4,y,3,4,"div",4),c.j41(5,"div",5),c.EFF(6),c.k0s(),c.DNE(7,_,2,0,"div",6),c.k0s()()()),2&t&&(c.R7$(2),c.Y8G("ngClass",c.l_i(4,k,"OrgUnits"==e.nodemodule,"OrgCharts"==e.nodemodule)),c.R7$(2),c.Y8G("ngIf",e.displayButtons),c.R7$(2),c.SpI(" ",e.model.data.name," "),c.R7$(),c.Y8G("ngIf",e.displayButtons&&"OrgUnits"==e.nodemodule))},dependencies:[s.YU,s.bT,p.t,f.j,O],encapsulation:2})}return OrgunitsChartViewBox})();function R(t,e){if(1&t&&c.nrm(0,"orgunits-chart-view-orgunit",7),2&t){const t=c.XpG().$implicit;c.Y8G("orgunitid",t.id)}}function $(t,e){if(1&t&&c.nrm(0,"orgunits-chart-view-box",8),2&t){const t=c.XpG().$implicit;c.Y8G("nodeid",t.id)}}function I(t,e){if(1&t&&(c.j41(0,"div"),c.DNE(1,R,1,1,"orgunits-chart-view-orgunit",5)(2,$,1,1,"orgunits-chart-view-box",6),c.k0s()),2&t){const t=e.$implicit;c.R7$(),c.Y8G("ngIf","OrgUnits"==t.module),c.R7$(),c.Y8G("ngIf","OrgCharts"==t.module)}}function M(t,e){if(1&t&&(c.qex(0),c.j41(1,"div",3),c.DNE(2,I,3,2,"div",4),c.k0s(),c.bVm()),2&t){const t=c.XpG();c.R7$(2),c.Y8G("ngForOf",t.subUnits)("ngForTrackBy",t.trackByFn)}}let V=(()=>{class OrgunitsChartOrgViewOrgunit{constructor(t){this.oview=t}get subUnits(){let t=this.oview.orgunits.filter((t=>t.parent_id==this.orgunitid)).map((t=>({module:"OrgUnits",id:t.id,name:t.name}))),e=this.oview.orgcharts.filter((t=>t.orgunit_id==this.orgunitid)).map((t=>({module:"OrgCharts",id:t.id,name:t.name})));return t.concat(e).sort(((t,e)=>t.name.localeCompare(e.name)))}get subOrgUnits(){return this.oview.orgunits.filter((t=>t.parent_id==this.orgunitid))}get subOrgCharts(){return this.oview.orgcharts.filter((t=>t.orgunit_id==this.orgunitid))}trackByFn(t,e){return e.id}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartOrgViewOrgunit)(c.rXU(m))};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartOrgViewOrgunit,selectors:[["orgunits-chart-view-orgunit"]],inputs:{orgunitid:"orgunitid"},decls:3,vars:2,consts:[[3,"nodeid"],["box",""],[4,"ngIf"],[1,"slds-grid","slds-grid--align-center"],[4,"ngFor","ngForOf","ngForTrackBy"],[3,"orgunitid",4,"ngIf"],["nodemodule","OrgCharts",3,"nodeid",4,"ngIf"],[3,"orgunitid"],["nodemodule","OrgCharts",3,"nodeid"]],template:function(t,e){1&t&&(c.nrm(0,"orgunits-chart-view-box",0,1),c.DNE(2,M,3,2,"ng-container",2)),2&t&&(c.Y8G("nodeid",e.orgunitid),c.R7$(2),c.Y8G("ngIf",e.subOrgUnits.length+e.subOrgCharts.length>0))},dependencies:[s.Sq,s.bT,OrgunitsChartOrgViewOrgunit,B],encapsulation:2})}return OrgunitsChartOrgViewOrgunit})();function G(t,e){if(1&t&&(c.qSk(),c.j41(0,"g"),c.nrm(1,"path",7),c.k0s()),2&t){const t=e.$implicit;c.R7$(),c.BMQ("d",t)}}function U(t,e){if(1&t&&(c.j41(0,"div",1),c.qSk(),c.j41(1,"svg",2)(2,"defs")(3,"filter",3),c.nrm(4,"feFlood",4)(5,"feComposite",5),c.k0s()(),c.DNE(6,G,2,1,"g",6),c.k0s()()),2&t){const t=c.XpG();c.R7$(),c.BMQ("height",t.oview.viewport.scrollHeight)("width",t.oview.viewport.scrollWidth),c.R7$(5),c.Y8G("ngForOf",t.oview.connectors)}}let j=(()=>{class OrgunitsChartConnector{constructor(t){this.oview=t}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartConnector)(c.rXU(m))};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartConnector,selectors:[["orgunits-chart-connector"]],decls:1,vars:1,consts:[["class","slds-is-absolute__top",4,"ngIf"],[1,"slds-is-absolute__top"],["xmlns","http://www.w3.org/2000/svg"],["x","0","y","0","width","1","height","1"],["flood-color","white"],["in","SourceGraphic"],[4,"ngFor","ngForOf"],["fill","none","stroke-dasharray","","stroke-linejoin","round","stroke-width","1","stroke","#555"]],template:function(t,e){1&t&&c.DNE(0,U,7,3,"div",0),2&t&&c.Y8G("ngIf",e.oview.connectors.length>0)},dependencies:[s.Sq,s.bT],encapsulation:2})}return OrgunitsChartConnector})();const E=["orgviewport"];function F(t,e){if(1&t&&(c.j41(0,"div"),c.nrm(1,"orgunits-chart-connector"),c.j41(2,"div",11),c.nrm(3,"orgunits-chart-view-orgunit",12),c.k0s()()),2&t){const t=c.XpG();c.R7$(2),c.Y8G("ngStyle",t.zoomedStyle),c.R7$(),c.Y8G("orgunitid",t.rootID)}}function z(t,e){1&t&&(c.j41(0,"div",13),c.nrm(1,"system-spinner",14),c.k0s())}let L=(()=>{class OrgunitsChartView{onResize(){this.oview.connectors=[],window.setTimeout((()=>this.oview.buildConnectors()),0)}constructor(t,e,i){this.model=t,this.oview=e,this.cdRef=i,this.zoomFactor=1,this.oview.updated$.subscribe((()=>{this.cdRef.detectChanges()})),this.oview.orgChart=this.model}ngAfterViewInit(){this.oview.viewport=this.orgViewPort?.nativeElement,this.oview.loadOrgUnits().subscribe({next:()=>{this.oview.viewport=this.orgViewPort?.nativeElement,this.oview.buildConnectors()}})}get rootID(){return this.oview.orgunits.find((t=>!t.parent_id)).id}get zoomedStyle(){return{transform:`scale(${this.zoomFactor})`}}zoomout(){this.zoomFactor>.1&&(this.zoomFactor-=.1),window.setTimeout((()=>this.oview.buildConnectors()),0)}zoomin(){this.zoomFactor<1&&(this.zoomFactor+=.1),window.setTimeout((()=>this.oview.buildConnectors()),0)}get zoom(){return 100*this.zoomFactor}set zoom(t){this.zoomFactor=t/100,window.setTimeout((()=>this.oview.buildConnectors()),0)}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartView)(c.rXU(g.g),c.rXU(m),c.rXU(c.gRc))};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartView,selectors:[["orgunits-chart-view"]],viewQuery:function(t,e){if(1&t&&c.GBs(E,5),2&t){let t;c.mGM(t=c.lsd())&&(e.orgViewPort=t.first)}},hostBindings:function(t,e){1&t&&c.bIt("resize",(function(){return e.onResize()}),!1,c.tSv)},features:[c.Jv_([m])],decls:13,vars:7,consts:[[1,"slds-size--1-of-1","slds-p-around--small"],[1,"slds-is-relative"],["orgviewport",""],[4,"ngIf"],["class","slds-size--1-of-1 slds-align--absolute-center","style","min-height: 300px",4,"ngIf"],[1,"slds-p-top--small","slds-grid","slds-grid--align-end","slds-grid--vertical-align-center"],["system-title","LBL_RELOAD",1,"slds-button","slds-button--icon",3,"disabled","click"],["icon","zoomout"],["min","10","max","100","step","10",1,"slds-p-horizontal--x-small",3,"displayValue","ngModel","ngModelChange"],["icon","zoomin"],["icon","refresh"],[3,"ngStyle"],[3,"orgunitid"],[1,"slds-size--1-of-1","slds-align--absolute-center",2,"min-height","300px"],["message","LBL_LOADING"]],template:function(t,e){1&t&&(c.j41(0,"div",0)(1,"div",1,2),c.DNE(3,F,4,2,"div",3),c.k0s(),c.DNE(4,z,2,0,"div",4),c.k0s(),c.j41(5,"div",5)(6,"button",6),c.bIt("click",(function(){return e.zoomout()})),c.nrm(7,"system-button-icon",7),c.k0s(),c.j41(8,"system-slider",8),c.mxI("ngModelChange",(function(t){return c.DH7(e.zoom,t)||(e.zoom=t),t})),c.k0s(),c.j41(9,"button",6),c.bIt("click",(function(){return e.zoomin()})),c.nrm(10,"system-button-icon",9),c.k0s(),c.j41(11,"button",6),c.bIt("click",(function(){return e.oview.loadOrgUnits()})),c.nrm(12,"system-button-icon",10),c.k0s()()),2&t&&(c.R7$(3),c.Y8G("ngIf",e.oview.orgunits.length>0),c.R7$(),c.Y8G("ngIf",0==e.oview.orgunits.length&&e.oview.loading),c.R7$(2),c.Y8G("disabled",e.oview.loading),c.R7$(2),c.Y8G("displayValue",!1),c.R50("ngModel",e.zoom),c.R7$(),c.Y8G("disabled",e.oview.loading),c.R7$(2),c.Y8G("disabled",e.oview.loading))},dependencies:[s.bT,s.B3,n.BC,n.vS,p.t,b.P,v.b,w.L,V,j],encapsulation:2})}return OrgunitsChartView})();var D=i(66589),Y=i(32062),N=i(40713),X=i(25028),S=i(88418),A=i(83524);let T=(()=>{class OrgunitsChartViewBoxAddOptions{constructor(){this.option="addorgunit",this.selection=new c.bkB}close(){this.self.destroy()}add(){this.selection.emit(this.option),this.self.destroy()}static#t=this.ɵfac=function(t){return new(t||OrgunitsChartViewBoxAddOptions)};static#e=this.ɵcmp=c.VBU({type:OrgunitsChartViewBoxAddOptions,selectors:[["orgunits-chart-view-box-add-options"]],decls:19,vars:4,consts:[["size","small"],["system-modal-header-noclose",""],["label","LBL_ACTION"],[1,"slds-align--absolute-center"],[1,"slds-grid","slds-grid--vertical"],["name","addoption","value","addorgunit",1,"slds-p-vertical--xx-small",3,"ngModel","ngModelChange"],["label","LBL_ADDORGUNIT"],["name","addoption","value","selectorgunit",1,"slds-p-vertical--xx-small",3,"ngModel","ngModelChange"],["label","LBL_SELECTORGUNIT"],["name","addoption","value","addorgchart",1,"slds-p-vertical--xx-small",3,"ngModel","ngModelChange"],["label","LBL_ADDORGCHART"],["name","addoption","value","selectorgchart",1,"slds-p-vertical--xx-small",3,"ngModel","ngModelChange"],["label","LBL_SELECTORGCHART"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--brand",3,"click"],["label","LBL_OK"]],template:function(t,e){1&t&&(c.j41(0,"system-modal",0)(1,"system-modal-header",1),c.nrm(2,"system-label",2),c.k0s(),c.j41(3,"system-modal-content")(4,"div",3)(5,"div",4)(6,"system-input-radio",5),c.mxI("ngModelChange",(function(t){return c.DH7(e.option,t)||(e.option=t),t})),c.nrm(7,"system-label",6),c.k0s(),c.j41(8,"system-input-radio",7),c.mxI("ngModelChange",(function(t){return c.DH7(e.option,t)||(e.option=t),t})),c.nrm(9,"system-label",8),c.k0s(),c.j41(10,"system-input-radio",9),c.mxI("ngModelChange",(function(t){return c.DH7(e.option,t)||(e.option=t),t})),c.nrm(11,"system-label",10),c.k0s(),c.j41(12,"system-input-radio",11),c.mxI("ngModelChange",(function(t){return c.DH7(e.option,t)||(e.option=t),t})),c.nrm(13,"system-label",12),c.k0s()()()(),c.j41(14,"system-modal-footer")(15,"button",13),c.bIt("click",(function(){return e.close()})),c.nrm(16,"system-label",14),c.k0s(),c.j41(17,"button",15),c.bIt("click",(function(){return e.add()})),c.nrm(18,"system-label",16),c.k0s()()()),2&t&&(c.R7$(6),c.R50("ngModel",e.option),c.R7$(2),c.R50("ngModel",e.option),c.R7$(2),c.R50("ngModel",e.option),c.R7$(2),c.R50("ngModel",e.option))},dependencies:[n.BC,n.vS,D.J,Y.W,N.D,X.I,S.Q,A.C],encapsulation:2})}return OrgunitsChartViewBoxAddOptions})(),H=(()=>{class ModuleOrgunits{static#t=this.ɵfac=function(t){return new(t||ModuleOrgunits)};static#e=this.ɵmod=c.$C({type:ModuleOrgunits});static#i=this.ɵinj=c.G2t({imports:[s.MD,n.YN,o.ObjectFields,r.GlobalComponents,l.ObjectComponents,d.SystemComponents,a.h]})}return ModuleOrgunits})();("undefined"==typeof ngJitMode||ngJitMode)&&c.Obh(H,{declarations:[L,V,B,O,T,j],imports:[s.MD,n.YN,o.ObjectFields,r.GlobalComponents,l.ObjectComponents,d.SystemComponents,a.h]})}}]);