/*!
 * 
 *                     SpiceCRM
 *
 *                     release: 2024.01.001
 *
 *                     date: 2024-05-28 17:40:40
 *
 *                     build: 2024.01.001.1716910840504
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["src_modules_folders_modulefolders_ts"],{40208:(e,t,s)=>{s.r(t),s.d(t,{ModuleFolders:()=>B});var i=s(60177),d=s(84341),l=s(7745),r=s(12948),o=s(37328),n=s(70569),c=s(71341),a=s(18039),m=s(54438),u=s(96697),h=s(49722),p=s(75103),g=s(69904),f=s(41081),b=s(50531),F=s(92462),D=s(13562),k=s(35911),_=s(25863),L=s(32062),T=s(28933),y=s(32130);function I(e,t){if(1&e){const e=m.RV6();m.j41(0,"button",11),m.bIt("click",(function(t){m.eBV(e);const s=m.XpG();return m.Njj(s.expand(s.item,t))})),m.nrm(1,"system-button-icon",12),m.k0s()}if(2&e){const e=m.XpG();m.R7$(),m.Y8G("icon",e.item.systemTreeDefs.expanded?"chevrondown":"chevronright")}}const v=e=>({visibility:e});let R=(()=>{class FolderViewTreeItems{constructor(e,t,s,i){this.language=e,this.backend=t,this.toast=s,this.modal=i,this.onFolderAdd=new m.bkB,this.doSort=new m.bkB,this.onFolderDelete=new m.bkB,this.toggleExpandedChange=new m.bkB}expand(e,t){this.toggleExpandedChange.emit(e.id),t&&t.stopPropagation&&t.stopPropagation()}deleteFolder(){this.backend.deleteRequest("module/Folders/"+this.item.id).pipe((0,u.s)(1)).subscribe((e=>{this.onFolderDelete.emit(),this.toast.sendToast(this.language.getLabel("MSG_SUCCESSFULLY_DELETED"),"success")}))}editFolderName(){this.modal.prompt("input",null,"Folder Name",null,this.item.name).pipe((0,u.s)(1)).subscribe((e=>{if(e=e.trim()){this.item.name=e;let t={name:this.item.name};this.backend.postRequest("module/Folders/"+this.item.id,{},t).pipe((0,u.s)(1)).subscribe((e=>{this.toast.sendToast(this.language.getLabel("MSG_FOLDERNAME_CHANGED"),"success"),this.doSort.emit()}),(e=>{this.toast.sendToast(this.language.getLabel("LBL_ERROR"),"error")}))}}))}static#e=this.ɵfac=function(e){return new(e||FolderViewTreeItems)(m.rXU(g.B),m.rXU(h.H),m.rXU(f.o),m.rXU(b.y))};static#t=this.ɵcmp=m.VBU({type:FolderViewTreeItems,selectors:[["folder-view-tree-item"]],inputs:{item:"item"},outputs:{onFolderAdd:"onFolderAdd",doSort:"doSort",onFolderDelete:"onFolderDelete",toggleExpandedChange:"toggleExpandedChange"},decls:14,vars:8,consts:[[1,"slds-tree__item"],[1,"slds-grid","slds-grid_vertical-align-center","slds-grow","slds-truncate"],[2,"min-width","20px"],["class","slds-button slds-button_icon slds-m-right--xx-small slds-m-top--none","aria-expanded","true","aria-hidden","true","tabindex","-1",3,"click",4,"ngIf"],[1,"slds-truncate"],[1,"slds-tree__item-label","slds-truncate"],[1,"slds-col_bump-left",3,"ngStyle"],["title","Edit Name",1,"slds-button","slds-button--icon",3,"click"],[3,"icon"],["title","Add Folder",1,"slds-button","slds-button--icon",3,"click"],["title","Delete folder",1,"slds-button","slds-button--icon","slds-p-right--x-small",3,"click"],["aria-expanded","true","aria-hidden","true","tabindex","-1",1,"slds-button","slds-button_icon","slds-m-right--xx-small","slds-m-top--none",3,"click"],["size","xx-small",3,"icon"]],template:function(e,t){1&e&&(m.j41(0,"div",0)(1,"div",1)(2,"div",2),m.DNE(3,I,2,1,"button",3),m.k0s(),m.j41(4,"div",4)(5,"span",5),m.EFF(6),m.k0s()(),m.j41(7,"div",6)(8,"button",7),m.bIt("click",(function(){return t.editFolderName()})),m.nrm(9,"system-button-icon",8),m.k0s(),m.j41(10,"button",9),m.bIt("click",(function(){return t.onFolderAdd.emit(t.item.id)})),m.nrm(11,"system-button-icon",8),m.k0s(),m.j41(12,"button",10),m.bIt("click",(function(){return t.deleteFolder()})),m.nrm(13,"system-button-icon",8),m.k0s()()()()),2&e&&(m.R7$(3),m.Y8G("ngIf",t.item.systemTreeDefs.hasChildren),m.R7$(3),m.JRh(t.item.name),m.R7$(),m.Y8G("ngStyle",m.eq3(6,v,t.item.systemTreeDefs.isSelected?"visible":"hidden")),m.R7$(2),m.Y8G("icon","edit"),m.R7$(2),m.Y8G("icon","new"),m.R7$(2),m.Y8G("icon","delete"))},dependencies:[i.bT,i.B3,_.t],encapsulation:2})}return FolderViewTreeItems})();function w(e,t){if(1&e){const e=m.RV6();m.j41(0,"li",15),m.bIt("cdkDropListDropped",(function(t){const s=m.eBV(e).$implicit,i=m.XpG(2);return m.Njj(i.drop(t,s))})),m.j41(1,"folder-view-tree-item",16),m.bIt("click",(function(){const t=m.eBV(e).$implicit,s=m.XpG(2);return m.Njj(s.handleClick(t.id))}))("toggleExpandedChange",(function(t){m.eBV(e);const s=m.XpG(2);return m.Njj(s.handleExpand(t))}))("onFolderDelete",(function(){const t=m.eBV(e).$implicit,s=m.XpG(2);return m.Njj(s.removeFolderFromList(t.id))}))("onFolderAdd",(function(t){const s=m.eBV(e).index,i=m.XpG(2);return m.Njj(i.addFolder(t,s))}))("doSort",(function(){m.eBV(e);const t=m.XpG(2);return m.Njj(t.buildTree())})),m.k0s()()}if(2&e){const e=t.$implicit;m.BMQ("aria-level",e.systemTreeDefs.level)("aria-selected",e.systemTreeDefs.isSelected),m.R7$(),m.Y8G("item",e)("title",e.name)}}function j(e,t){if(1&e&&(m.qex(0),m.DNE(1,w,2,4,"li",14),m.bVm()),2&e){const e=m.XpG();m.R7$(),m.Y8G("ngForOf",e.tree)("ngForTrackBy",e.trackByFn)}}let x=(()=>{class FolderViewTree{set selectedItem(e){this.folderId.emit(e),e!==this._selectedItem&&(this._selectedItem=e,this.setAggregate(e),this.model.setField("folder_id",e))}get selectedItem(){return this._selectedItem}constructor(e,t,s,i,d,l,r,o){this.backend=e,this.modellist=t,this.language=s,this.toast=i,this.modal=d,this.modelutilies=l,this.helper=r,this.model=o,this.folderId=new m.bkB,this._selectedItem=null,this.tree=[],this.sourceList=[],this.itemRelations=[],this.isLoading=!0,this.showTree=!0}ngOnInit(){this.backend.getRequest("module/Folders/Documents").pipe((0,u.s)(1)).subscribe((e=>{this.sourceList=e.list,this.buildTree(),this.isLoading=!1;let t=this.getFolderIdFromList();null!==t&&this.handleClick(t)}))}buildItemRelations(){this.itemRelations=[];let e={};this.sourceList.forEach(((t,s)=>e[t.id]=s)),this.sourceList.forEach(((t,s)=>{this.itemRelations[s]={parent:t.parent_id?e[t.parent_id]:null,childs:[]}})),this.sourceList.forEach(((e,t)=>{e.parent_id&&this.itemRelations[this.itemRelations[t].parent].childs.push(t)}))}buildTree(){this.tree=[],this.sortSourceList(),this.addTreeItem(),this.setHasChildren(),this.buildItemRelations()}sortSourceList(){this.language.sortObjects(this.sourceList,"name")}addTreeItem(e="",t=1){for(let s of this.sourceList)(!s.parent_id&&""==e||s.parent_id==e)&&(s.systemTreeDefs||(s.systemTreeDefs={}),s.systemTreeDefs.expanded=!!s.systemTreeDefs.expanded,s.systemTreeDefs.level=t,s.systemTreeDefs.isSelected=this.selectedItem==s.id,this.tree.push(s),s.systemTreeDefs.expanded&&this.addTreeItem(s.id,t+1))}setHasChildren(){this.tree.forEach((e=>{e.systemTreeDefs.hasChildren=this.sourceList.some((t=>t.parent_id==e.id))}))}handleExpand(e){this.sourceList.some((t=>{if(t.id==e)return t.systemTreeDefs.expanded=!t.systemTreeDefs.expanded,!0})),this.buildTree()}handleClick(e){this.tree.some((t=>{if(t.id===e)return t.systemTreeDefs?.isSelected||(t.systemTreeDefs.isSelected=!0,this.selectedItem=e),!0})),this.tree.some((t=>{if(t.id!=e&&t.systemTreeDefs?.isSelected)return t.systemTreeDefs.isSelected=!1,!0}))}unselectActiveTreeItem(){this.tree.some((e=>{if(e.systemTreeDefs?.isSelected)return e.systemTreeDefs.isSelected=!1,!0}))}setAggregate(e){e||(e="#not#set#");let t=this.helper.encodeBase64('{"key":"'+e+'","displayName":"'+e+'"}');this.modellist.checkAggregate("folder_id",t)||(this.modellist.removeAggregatesOfField("folder_id"),this.modellist.setAggregate("folder_id",t),this.modellist.scheduleReloadList())}getFolderIdFromList(){let e=null;return this.modellist.selectedAggregates.some((t=>{let s=t.split("::",2);if("folder_id"===s[0]){let t=JSON.parse(this.helper.decodeBase64(s[1]));e=t.key}})),"#not#set#"===e&&(e=""),e}removeAllAggregates(){this.modellist.removeAggregatesOfField("folder_id"),this.modellist.reLoadList()}trackByFn(e,t){return t.id}addFolder(e=null,t=null){this.modal.prompt("input",null,"Folder Name").pipe((0,u.s)(1)).subscribe((s=>{if(s&&(s=s.trim())){let i={name:s,parent_id:e||void 0,module:"Documents",id:this.modelutilies.generateGuid()};this.backend.postRequest("module/Folders/"+i.id,{},i).pipe((0,u.s)(1)).subscribe((()=>{this.toast.sendToast(this.language.getLabel("MSG_FOLDER_SUCCESSFULY_ADDED"),"success"),this.sourceList.push(i),null!==t&&this.tree[t]&&(this.tree[t].systemTreeDefs.expanded=!0),this.buildTree()}),(e=>{this.toast.sendToast(this.language.getLabel("LBL_ERROR"),"error")}))}}))}removeFolderFromList(e){let t=[];this.sourceList.find(((s,i)=>{if(s.id===e)return this.deleteItemsRecursive(i,t),!0})),t.sort().reverse().forEach(((e,s)=>{this.sourceList.splice(t[s],1),this.itemRelations.splice(t[s],1)})),this.buildTree()}deleteItemsRecursive(e,t){t.push(e),this.itemRelations[e].childs.forEach((e=>this.deleteItemsRecursive(e,t)))}selectOutsideFolders(){this.selectedItem="",this.unselectActiveTreeItem()}drop(e,t){this.backend.postRequest("module/Documents/"+e.item.data.id,{},{folder_id:t.id}).subscribe((e=>{window.setTimeout((()=>this.modellist.reLoadList(!0)),500)}))}toggleTree(){this.showTree=!this.showTree}static#e=this.ɵfac=function(e){return new(e||FolderViewTree)(m.rXU(h.H),m.rXU(p.K),m.rXU(g.B),m.rXU(f.o),m.rXU(b.y),m.rXU(F.g),m.rXU(D.d),m.rXU(k.g))};static#t=this.ɵcmp=m.VBU({type:FolderViewTree,selectors:[["folder-view-tree"]],outputs:{folderId:"folderId"},decls:14,vars:4,consts:[["system-to-bottom","",1,"slds-grid","slds-grid--vertical",3,"system-overlay-loading-spinner"],["role","tree",1,"slds-grow","slds-height_full","slds-scrollable--y"],["id","folderList","role","tree","aria-labelledby","treeheading",1,"slds-tree"],["cdkDropList","",1,"slds-border--bottom",3,"cdkDropListDropped"],[1,"slds-tree","slds-grow"],["role","treeitem",3,"click"],[1,"slds-tree__item","slds-p-vertical--x-small"],["size","xx-small",3,"icon","click"],[1,"slds-tree__item-label","slds-truncate","slds-p-left--x-small"],["label","LBL_CORE"],[4,"ngIf"],[1,"slds-text-align--right","slds-p-around--x-small","slds-border--top"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_ADD_FOLDER"],["role","treeitem","cdkDropList","",3,"cdkDropListDropped",4,"ngFor","ngForOf","ngForTrackBy"],["role","treeitem","cdkDropList","",3,"cdkDropListDropped"],[1,"slds-grid","slds-grid--vertical","slds-p-vertical--none","slds-tree__item",2,"width","100%",3,"item","title","click","toggleExpandedChange","onFolderDelete","onFolderAdd","doSort"]],template:function(e,t){1&e&&(m.j41(0,"div",0)(1,"div",1)(2,"ul",2)(3,"li",3),m.bIt("cdkDropListDropped",(function(e){return t.drop(e,{id:""})})),m.j41(4,"div",4)(5,"div",5),m.bIt("click",(function(){return t.selectOutsideFolders()})),m.j41(6,"div",6)(7,"system-button-icon",7),m.bIt("click",(function(){return t.toggleTree()})),m.k0s(),m.j41(8,"span",8),m.nrm(9,"system-label",9),m.k0s()()()()(),m.DNE(10,j,2,2,"ng-container",10),m.k0s()(),m.j41(11,"div",11)(12,"button",12),m.bIt("click",(function(){return t.addFolder()})),m.nrm(13,"system-label",13),m.k0s()()()),2&e&&(m.Y8G("system-overlay-loading-spinner",t.isLoading),m.R7$(5),m.BMQ("aria-selected",""===t.selectedItem),m.R7$(2),m.Y8G("icon",t.showTree?"chevrondown":"chevronright"),m.R7$(3),m.Y8G("ngIf",t.showTree))},dependencies:[i.Sq,i.bT,_.t,L.W,T.b,y.M,a.O7,R],encapsulation:2})}return FolderViewTree})();var E=s(64914);function S(e,t){1&e&&m.nrm(0,"object-list",6),2&e&&m.Y8G("dragAndDrop",!0)}let G=(()=>{class FolderObjectListView{constructor(){this.folderId=null}setFolderId(e){this.folderId=e}static#e=this.ɵfac=function(e){return new(e||FolderObjectListView)};static#t=this.ɵcmp=m.VBU({type:FolderObjectListView,selectors:[["folder-object-listview"]],decls:6,vars:1,consts:[["cdkDropListGroup","","system-to-bottom","",1,"slds-grid"],[1,"slds-size--1-of-3","slds-border_right","slds-height_full"],[3,"folderId"],[1,"slds-size--2-of-3","slds-height_full"],[1,"slds-m-top--xxx-small"],[3,"dragAndDrop",4,"ngIf"],[3,"dragAndDrop"]],template:function(e,t){1&e&&(m.j41(0,"div",0)(1,"div",1)(2,"folder-view-tree",2),m.bIt("folderId",(function(e){return t.setFolderId(e)})),m.k0s()(),m.j41(3,"div",3)(4,"div",4),m.DNE(5,S,1,1,"object-list",5),m.k0s()()()),2&e&&(m.R7$(5),m.Y8G("ngIf",null!==t.folderId))},dependencies:[i.bT,E.Y,T.b,a.RK,x],encapsulation:2})}return FolderObjectListView})(),B=(()=>{class ModuleFolders{static#e=this.ɵfac=function(e){return new(e||ModuleFolders)};static#t=this.ɵmod=m.$C({type:ModuleFolders});static#s=this.ɵinj=m.G2t({imports:[i.MD,d.YN,l.ObjectFields,r.GlobalComponents,o.ObjectComponents,n.SystemComponents,c.h,a.ad]})}return ModuleFolders})();("undefined"==typeof ngJitMode||ngJitMode)&&m.Obh(B,{declarations:[x,R,G],imports:[i.MD,d.YN,l.ObjectFields,r.GlobalComponents,o.ObjectComponents,n.SystemComponents,c.h,a.ad],exports:[x]})}}]);