/* * *******************************************************************************
* This file is part of KReporter. KReporter is an enhancement developed
* by aac services k.s.. All rights are (c) 2016 by aac services k.s.
*
* This Version of the KReporter is licensed software and may only be used in
* alignment with the License Agreement received with this Software.
* This Software is copyrighted and may not be further distributed without
* witten consent of aac services k.s.
*
* You can contact us at info@kreporter.org
******************************************************************************* */
Ext.define("SpiceCRM.FTSManager.model.ftsField",{extend:"Ext.data.Model",fields:[{name:"fieldid",mapping:"fieldid"},{name:"sequence",mapping:"sequence"},{name:"fieldname",mapping:"fieldname"},{name:"name",mapping:"name"},{name:"display",mapping:"display"},{name:"indextype",mapping:"indextype"},{name:"index",mapping:"index"},{name:"analyzer",mapping:"analyzer"},{name:"search",mapping:"search"},{name:"aggregate",mapping:"aggregate"},{name:"aggregateaddparams",mapping:"aggregateaddparams"},{name:"boost",mapping:"boost"},{name:"path",mapping:"path"},{name:"displaypath",mapping:"displaypath"},{name:"assigntovalue",mapping:"assigntovalue"},{name:"formulavalue",mapping:"formulavalue"},{name:"formulasequence",mapping:"formulasequence"},{name:"widget",mapping:"widget"},{name:"overridetype",mapping:"overridetype"},{name:"overridealignment",mapping:"overridealignment"},{name:"grouping",mapping:"grouping"}]}),Ext.define("SpiceCRM.FTSManager.model.module",{extend:"Ext.data.Model",alias:["widget.moduleModel"],fields:["module","name"]}),Ext.define("SpiceCRM.FTSManager.model.modulefield",{extend:"Ext.data.Model",fields:["name","text","type"]}),Ext.define("SpiceCRM.FTSManager.model.moduletree",{extend:"Ext.data.TreeModel",fields:["module","path","name","link","id"],getPath:function(){for(var a="",b=this,c="";b.parentNode;)a=b.get("path")+(""!==a?"::"+a:""),b.get("path")&&(c=b.get("module")+(""!==c?"->"+c:"")),b=b.parentNode;return{path:a,displayPath:c}}}),Ext.define("SpiceCRM.FTSManager.store.ftsFields",{extend:"Ext.data.Store",requires:["SpiceCRM.FTSManager.model.ftsField"],model:"SpiceCRM.FTSManager.model.ftsField",renumberSequence:function(){for(var a=0;a<this.getCount();){var b=a+1;b<10&&(b="0"+b),this.getAt(a).set("sequence",b),a++}},getMaxSequence:function(){for(var a=0,b=0;b<this.getCount();)this.getAt(b).data.sequence>a&&(a=this.getAt(b).data.sequence),b++;return parseInt(a,10)},getNextSequence:function(){var a=this.getMaxSequence()+1;return a<10&&(a="0"+a),a},addFromReportRecord:function(a){var b=[];Ext.each(a,function(a){a.id&&delete a.id,b.push(a)},this),this.add(b)}}),Ext.define("SpiceCRM.FTSManager.store.modulefields",{extend:"Ext.data.Store",requires:["SpiceCRM.FTSManager.model.modulefield"],model:"SpiceCRM.FTSManager.model.modulefield",proxy:{type:"ajax",url:"KREST/ftsmanager/core/fields",extraParams:{nodeid:""},reader:{type:"json"}},autoLoad:!1,listeners:{beforeload:function(a,b,c){return""!==a.getProxy().extraParams.nodeid}}}),Ext.define("SpiceCRM.FTSManager.store.modules",{extend:"Ext.data.Store",requires:["SpiceCRM.FTSManager.model.module"],model:"SpiceCRM.FTSManager.model.module",autoLoad:!0,proxy:{type:"ajax",url:"KREST/metadata/modules",reader:{type:"json"}}}),Ext.define("SpiceCRM.FTSManager.store.moduletree",{extend:"Ext.data.TreeStore",requires:["SpiceCRM.FTSManager.model.moduletree"],model:"SpiceCRM.FTSManager.model.moduletree",proxy:{type:"ajax",url:"KREST/ftsmanager/core/nodes",extraParams:{nodeid:""},reader:{type:"json"}},autoLoad:!1,listeners:{beforeload:function(a,b,c){return""!==a.getProxy().extraParams.nodeid},nodebeforeexpand:function(a){this.getProxy().extraParams.nodeid=a.getPath().path}}}),Ext.define("SpiceCRM.FTSManager.controller.Application",{extend:"Ext.app.Controller",doInit:function(){console.log("app controller initialized")},finishInit:function(){},onLaunch:function(){},getReportId:function(){},createGuId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}}),Ext.define("SpiceCRM.FTSManager.controller.ftsDetailsController",{extend:"Ext.app.ViewController",requires:[],module:null,alias:"controller.FTSManager.FTSDetailsController",config:{listen:{global:{mainModuleSelected:function(a){this.module=a,Ext.Ajax.request({url:"KREST/ftsmanager/"+a+"/settings",method:"GET",success:function(a,b){var c=Ext.decode(a.responseText);this.view.getForm().reset(),this.view.getForm().setValues(c)},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}}},control:{"#":{edit:function(){this.saveFields(this.module)}},"#ftsdetailssave":{click:function(){var a=this.view.getForm().getValues();Ext.Ajax.request({url:"KREST/ftsmanager/"+this.module,method:"POST",jsonData:Ext.encode({settings:a}),success:function(a,b){var c=Ext.decode(a.responseText);console.dir(c)},failure:function(a,b){console.log("server-side failure with status code "+a.status)}})}},"#ftsdeletemodule":{click:function(){Ext.Ajax.request({url:"KREST/ftsmanager/"+this.module,method:"DELETE",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}},"#ftsindexmodule":{click:function(){Ext.Ajax.request({url:"KREST/ftsmanager/"+this.module+"/index",method:"POST",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}},"#ftsresetindexmodule":{click:function(){Ext.Ajax.request({url:"KREST/ftsmanager/"+this.module+"/resetindex",method:"POST",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}},"#ftsmapmodule":{click:function(){Ext.Ajax.request({url:"KREST/ftsmanager/"+this.module+"/map",method:"POST",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}}}}}),Ext.define("SpiceCRM.FTSManager.controller.ftsFieldsController",{extend:"Ext.app.ViewController",requires:[],module:null,alias:"controller.FTSManager.FTSFieldsController",config:{listen:{global:{mainModuleSelected:function(a){this.module=a,this.view.getStore().removeAll(),Ext.Ajax.request({url:"KREST/ftsmanager/"+a+"/fields",method:"GET",success:function(a,b){var c=Ext.decode(a.responseText);Ext.each(c,function(a){this.view.getStore().add(a)},this)},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})}}},control:{"#":{edit:function(){this.saveFields(this.module)}},"#ftsfieldsdelete":{click:function(){this.view.getStore().remove(this.view.getSelection()),this.saveFields(this.module)}}}},onBeforeDrop:function(a,b,c,d,e,f){var g=this.view.store;if("SpiceCRM.FTSManager.model.modulefield"===b.records[0].$className){var h=Ext.ComponentQuery.query("ModuleTree")[0];h.getSelectionModel().getLastSelected();return Ext.each(b.records,function(a){var b=Ext.ComponentQuery.query("#ModuleTreeGrid")[0].controller.getRootPath(),e=g.indexOf(c);"after"==d&&e++;var f={id:SpiceCRM.FTSManager.Application.kGuid(),path:b.path+"::field:"+a.get("name"),displaypath:b.displayPath,fieldname:a.get("name"),name:a.get("text"),indextype:"string",index:"analyzed",search:!0,boost:1,fixedvalue:""};Ext.globalEvents.fireEvent("listFieldAdded",f),e==g.count()?g.add(f):g.insert(e,f)},this),e.cancelDrop(),this.saveFields(this.module),!0}e.cancelDrop()},base64Renderer:function(a){if(!a||""===a||null===a)return a;try{_tbfvalue=decodeURIComponent(atob(a))}catch(b){_tbfvalue=atob(a)}return Ext.util.Format.htmlEncode(_tbfvalue)},saveFields:function(a){var b=[];this.view.getStore().each(function(a){b.push(a.data)},this),Ext.Ajax.request({url:"KREST/ftsmanager/"+a,method:"POST",jsonData:Ext.encode({fields:b}),success:function(a,b){var c=Ext.decode(a.responseText);console.dir(c)},failure:function(a,b){console.log("server-side failure with status code "+a.status)}})}}),Ext.define("SpiceCRM.FTSManager.controller.MainController",{extend:"Ext.app.ViewController",requires:[],saving:!1,alias:"controller.FTSManagerMain",loadMask:void 0,config:{listen:{global:{}}}}),Ext.define("SpiceCRM.FTSManager.controller.MainToolbarController",{extend:"Ext.app.ViewController",requires:[],saving:!1,alias:"controller.FTSManagerMainToolbarController",loadMask:void 0,config:{listen:{global:{}},control:{"#initialize":{click:function(){Ext.Ajax.request({url:"KREST/languagemanager/initialize/labels",method:"POST",success:function(a,b){console.log("success")},failure:function(a,b){console.log("server-side failure with status code "+a.status)},timeout:3e5})}}}}}),Ext.define("SpiceCRM.FTSManager.controller.ModuleFieldsController",{extend:"Ext.app.ViewController",requires:[],alias:"controller.FTSManager.ModuleFieldsController",config:{listen:{global:{moduleSelected:"loadFields"}},control:{"#fieldFilter":{change:function(a,b){this.view.store.clearFilter(),""!==b&&this.view.store.filter("text",new RegExp(b,"i"))}}}},loadFields:function(a){if(a.getPath().path){var b=this.getView().getStore();b.removeAll(),b.getProxy().extraParams.nodeid=a.getPath().path,b.load()}}}),Ext.define("SpiceCRM.FTSManager.controller.ModuleTreeController",{extend:"Ext.app.ViewController",alias:"controller.FTSManager.ModuleTreeController",config:{listen:{global:{mainModuleSelected:function(a){this.setMainModuleNode({path:"root:"+a,module:a,name:"rootnode",expanded:!1,id:"root"})}}},control:{"#":{expand:function(){Ext.globalEvents.fireEvent("mainExpanded")},select:function(a,b){Ext.globalEvents.fireEvent("moduleSelected",b)}},"#mainModuleSelector":{initialize:function(a,b){a.setValue(b),a.disable(),Ext.globalEvents.fireEvent("mainModuleSelected",b)},select:function(a,b,c){Ext.globalEvents.fireEvent("mainModuleSelected",b.data.module)}}}},setMainModuleNode:function(a){this.view.getRootNode();var b=this.view.getRootNode().appendChild(a);this.view.getRootNode().expand(),this.view.setSelection(b),Ext.globalEvents.fireEvent("moduleSelected",Ext.create("SpiceCRM.FTSManager.model.moduletree",a))},getRootPath:function(){return this.view.getSelectionModel().getLastSelected().getPath()}}),Ext.define("SpiceCRM.FTSManager.view.ftsDetails",{extend:"Ext.form.Panel",require:["SpiceCRM.FTSManager.controller.ftsDetailsController"],itemId:"FTSManagerFTSDetails",controller:"FTSManager.FTSDetailsController",alias:["widget.FTSManagerftsDetails"],minHeight:350,height:"100%",title:"index Settings",icon:"themes/SpiceTheme/images/settingsmixer.png",items:[{xtype:"fieldset",title:"searchdefs",defaults:{width:"100%",labelWidth:200},items:[{xtype:"numberfield",fieldLabel:"index Priority",name:"index_priority"},{xtype:"numberfield",fieldLabel:"minimum_should_match",name:"minimum_should_match"},{xtype:"combo",name:"operator",fieldLabel:"operator",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"or",text:"or"},{value:"and",text:"and"}]}),valueField:"value",displayField:"text",value:"or"},{xtype:"combo",name:"globalsearch",fieldLabel:"global Search",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:0,text:"no"},{value:1,text:"yes"}]}),valueField:"value",displayField:"text",value:0}]}],dockedItems:[{xtype:"toolbar",dock:"top",defaults:{padding:"5px 2px"},items:[{text:"save",icon:"themes/SpiceTheme/images/save.png",itemId:"ftsdetailssave"},{text:"delete Index",icon:"themes/SpiceTheme/images/delete.png",itemId:"ftsdeletemodule"},{text:"put mapping",icon:"themes/SpiceTheme/images/mindmap.png",itemId:"ftsmapmodule"},{text:"reset index",icon:"themes/SpiceTheme/images/clear.png",itemId:"ftsresetindexmodule"},{text:"index",icon:"themes/SpiceTheme/images/ftsdoindex.png",itemId:"ftsindexmodule"}]}]}),Ext.define("SpiceCRM.FTSManager.view.editorWindow",{extend:"Ext.window.Window",modal:!0,height:200,width:400,layout:"fit",record:null,editedField:null,editedFieldText:null,title:"Editor",closeAction:"destroy",items:[{xtype:"textarea"}],buttons:[{text:"OK",handler:function(){var a=this.up("window");""!==a.down("textarea").getValue()?a.record.set(a.editedField,btoa(a.items.items[0].getValue())):a.record.set(a.editedField,""),a.close(),Ext.ComponentQuery.query("panel[itemId=FTSManagerFTSListFieldsGrid]")[0].fireEvent("edit")}},{text:"Cancel",handler:function(){var a=this.up("window");a.close()}}],listeners:{show:function(){if(this.record.get(this.editedField)){try{_editorvalue=decodeURIComponent(atob(this.record.get(this.editedField)))}catch(a){_editorvalue=atob(this.record.get(this.editedField))}this.items.items[0].setValue(_editorvalue)}else this.items.items[0].setValue("");this.setTitle(this.record.get("name")+" - "+this.editedFieldText)}}}),Ext.define("SpiceCRM.FTSManager.view.ftsFields",{extend:"Ext.grid.Panel",require:["SpiceCRM.FTSManager.controller.ftsFieldsController"],itemId:"FTSManagerFTSListFieldsGrid",controller:"FTSManager.FTSFieldsController",alias:["widget.FTSManagerftsFields"],store:Ext.create("SpiceCRM.FTSManager.store.ftsFields",{storeId:"FTSManagerFTSFieldsStore"}),minHeight:350,height:"100%",title:"indexed Fields",icon:"themes/SpiceTheme/images/list.gif",selModel:{mode:"MULTI"},columns:[{text:"technical Path",readOnly:!0,dataIndex:"path",flex:1,sortable:!0,hidden:!0},{text:"Path",readOnly:!0,dataIndex:"displaypath",width:150,sortable:!1},{text:"Fieldname",dataIndex:"fieldname",sortable:!0,width:150},{text:"Name",dataIndex:"name",sortable:!0,width:150,editor:{xtype:"textfield"}},{text:"Aggregate",dataIndex:"aggregate",sortable:!0,width:90,editor:{xtype:"combo",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"",text:"no"},{value:"term",text:"term"},{value:"range",text:"range"},{value:"datew",text:"date week"},{value:"datem",text:"date month"},{value:"dateq",text:"date quarter"},{value:"datey",text:"date year"}]}),valueField:"value",displayField:"text"},renderer:function(a){return a?a:"no"}},{text:"Aggregateparams",dataIndex:"aggregateaddparams",itemId:"aggregateaddparams",sortable:!0,width:150,editor:{xtype:"textfield"},renderer:function(a){if(!a||""===a||null===a)return a;try{_tbfvalue=decodeURIComponent(atob(a))}catch(b){_tbfvalue=atob(a)}return Ext.util.Format.htmlEncode(_tbfvalue)}},{text:"indextype",readOnly:!0,dataIndex:"indextype",width:90,sortable:!0,hidden:!1,editor:{xtype:"combo",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"string",text:"string"},{value:"date",text:"date"},{value:"double",text:"double"}]}),valueField:"value",displayField:"text"}},{text:"index",readOnly:!0,dataIndex:"index",width:90,sortable:!0,hidden:!1,editor:{xtype:"combo",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"analyzed",text:"analyzed"},{value:"not_analyzed",text:"not_analyzed"},{value:"no",text:"no"}]}),valueField:"value",displayField:"text"}},{text:"search",readOnly:!0,dataIndex:"search",width:60,sortable:!0,hidden:!1,editor:{xtype:"combo",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:!0,text:"yes"},{value:!1,text:"no"}]}),valueField:"value",displayField:"text"},renderer:function(a){return a?"yes":"no"}},{text:"boost",readOnly:!0,dataIndex:"boost",width:60,sortable:!0,hidden:!1,editor:{xtype:"numberfield"}},{text:"analyzer",readOnly:!0,dataIndex:"analyzer",width:100,sortable:!0,hidden:!1,editor:{xtype:"combo",listConfig:{minWidth:170},typeAhead:!0,triggerAction:"all",mode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"",text:"standard"},{value:"spice_ngram",text:"spice_ngram"},{value:"spice_edgengram",text:"spice_edgengram"},{value:"spice_email",text:"spice_email"}]}),valueField:"value",displayField:"text"}}],viewConfig:{markDirty:!1,plugins:{ptype:"gridviewdragdrop",dropGroup:"modulefields",enableDrag:!1,enableDrop:!0},listeners:{beforedrop:"onBeforeDrop",scope:"controller"}},plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{beforeedit:function(a,b){if("formulavalue"===b.column.itemId||"aggregateaddparams"===b.column.itemId){var c=Ext.create(SpiceCRM.FTSManager.view.editorWindow);return c.record=b.record,c.editedField=b.column.itemId,c.editedFieldText=b.column.text,c.show(),!1}}}})],dockedItems:[{xtype:"toolbar",dock:"top",defaults:{padding:"5px 2px"},items:[{text:"delete",icon:"themes/SpiceTheme/images/delete.png",itemId:"ftsfieldsdelete"}]}]}),Ext.define("SpiceCRM.FTSManager.view.main.Main",{extend:"Ext.container.Container",requires:["SpiceCRM.FTSManager.controller.MainController"],xtype:"app-main",renderTo:"languagemanager",height:"100%",width:"100%",border:!1,controller:"FTSManagerMain",layout:{type:"hbox"},style:{"background-color":"transparent"},items:[{xtype:"ftsModuleSelector",height:"100%",width:250,margin:"0 0 0 0",split:!0},{xtype:"tabpanel",flex:1,height:"100%",split:!0,items:[{xtype:"FTSManagerftsFields",flex:1,height:"100%"},{xtype:"FTSManagerftsDetails",flex:1,height:"100%"}]}]}),Ext.define("SpiceCRM.FTSManager.view.FTSManagerMainToolbar",{extend:"Ext.Toolbar",controller:"FTSManagerMainToolbarController",alias:["widget.FTSManagerMainToolbar"],items:[{xtype:"button",itemId:"save",text:"Save",icon:"modules/KReports/images/save.png",disabled:!1},{xtype:"button",itemId:"initialize",text:"Initialize",disabled:!1}]}),Ext.define("SpiceCRM.FTSManager.view.ftsModuleFields",{extend:"Ext.grid.Panel",alias:["widget.ftsModuleFields"],requires:["SpiceCRM.FTSManager.controller.ModuleFieldsController"],controller:"FTSManager.ModuleFieldsController",store:Ext.create("SpiceCRM.FTSManager.store.modulefields",{storeId:"FTSManagerFieldListStore"}),flex:1,height:"100%",columns:[{text:"Field",dataIndex:"name",flex:1},{text:"Name",dataIndex:"text",flex:1}],selModel:{mode:"MULTI"},viewConfig:{stripeRows:!0,copy:!0,plugins:{ptype:"gridviewdragdrop",dragGroup:"modulefields",enableDrop:!1}},tbar:[{xtype:"textfield",itemId:"fieldFilter",width:"100%"}]}),Ext.define("SpiceCRM.FTSManager.view.ftsmoduleSelector",{extend:"Ext.Panel",alias:["widget.ftsModuleSelector"],layout:"vbox",items:[{xtype:"ModuleTree",width:"100%",margin:"0 0 0 0",flex:2,split:!0},{xtype:"ftsModuleFields",width:"100%",flex:2,margin:"0 0 0 0",split:!0}]}),Ext.define("SpiceCRM.FTSManager.view.SubPanelFields.ModuleTreeGrid",{extend:"Ext.tree.Panel",alias:["widget.ModuleTree"],itemId:"ModuleTreeGrid",requires:["SpiceCRM.FTSManager.controller.ModuleTreeController"],controller:"FTSManager.ModuleTreeController",store:Ext.create("SpiceCRM.FTSManager.store.moduletree",{storeId:"moduletree"}),flex:1,height:"100%",width:"100%",border:!1,columns:[{xtype:"treecolumn",text:"module",dataIndex:"module",flex:1}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"combo",width:"100%",store:Ext.create("SpiceCRM.FTSManager.store.modules",{storeId:"FTSManagerModuleStore"}),displayField:"name",valueField:"module",text:"modules",forceSelection:!0,itemId:"mainModuleSelector",editable:!0,selectOnFocus:!0,typeAhead:!0,minChars:3,allowBlank:!1,emptyText:"Select a module",triggerAction:"all",valuePublishEvent:"select",queryMode:"local"}]}],bufferedRenderer:!1,rootVisible:!1,root:{name:"mainrootnode",expanded:!1,id:"mainrootnode"}}),Ext.define("SpiceCRM.FTSManager.Application",{namespaces:["SpiceCRM.FTSManager"],controllers:["Application"],extend:"Ext.app.Application",name:"SpiceCRM.FTSManager",thisMainView:null,launch:function(){SpiceCRM.FTSManager.Application=this,Ext.Ajax.request({url:"KREST/ftsmanager/core/index",method:"GET",success:function(a,b){Ext.decode(a.responseText)},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this}),this.render()},render:function(){console.log("rendering"),this.thisMainView=Ext.create("SpiceCRM.FTSManager.view.main.Main"),Ext.get(window).on({resize:function(){SpiceCRM.FTSManager.Application.thisMainView&&SpiceCRM.FTSManager.Application.thisMainView.updateLayout()}})},getRand:function(){return Math.random()},S4:function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},kGuid:function(){return"k"+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()}}),Ext.application({extend:"SpiceCRM.FTSManager.Application"}),Ext.onReady(function(){});